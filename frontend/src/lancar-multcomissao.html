<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Comissões - Múltiplos Lançamentos</title>
    <link rel="icon" type="image/png" href="assets/images/logo2.png">
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Realtime desativado nesta tela para depuração de logs -->
    <!-- <script src="scripts/config/realtime-config.js"></script> -->
    <!-- <script src="scripts/realtime-bus.js"></script> -->
    <!-- <script src="scripts/realtime-global.js"></script> -->
    <script src="scripts/config/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <style>
        :root{--brand:#1976D2;--brand-600:#1565C0;--brand-700:#0D47A1;--accent:#2196F3;--bg:#f5f7fb;--card:#ffffff;--muted:#6b7280;--border:#e5e7eb;--success:#10b981;--danger:#ef4444}
        body{background:var(--bg)}
        .main-content{padding-bottom:4px}
        @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
        .loader-overlay-multi{display:none;position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);backdrop-filter:saturate(1.2) blur(2px);z-index:10;justify-content:center;align-items:center;flex-direction:column;border-radius:12px}
        .spinner-main{border:8px solid #e3f2fd;border-top:8px solid var(--brand);border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite}
        .loading-text{margin-top:16px;color:var(--brand);font-size:1.05rem;font-weight:600;text-align:center}
        .form-comissao{background:var(--card);border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,0.06), 0 2px 6px rgba(2,6,23,0.04);padding:12px 12px;margin-bottom:0;display:flex;flex-direction:column;gap:4px;min-height:calc(100vh - 335px);border:1px solid var(--border)}
        .table-multiplos{width:100%;margin-bottom:0;position:relative;flex:1 1 auto;height:calc(100vh - 272px);overflow:visible}
        .table-multiplos-wrapper{width:100%;height:100%;overflow:auto;border-radius:8px;border:none;background:transparent}
        .table-multiplos table{width:100%;min-width:1000px;border-collapse:separate;border-spacing:0;table-layout:fixed}
        .table-multiplos thead tr{height:44px}
        .table-multiplos thead th{position:sticky;top:0;z-index:2;background:#f8fafc;color:#0f172a;font-weight:700;text-transform:uppercase;letter-spacing:.02em;font-size:11px;box-shadow:0 1px 0 rgba(2,6,23,0.05);padding:0 8px;height:44px;line-height:44px;white-space:nowrap}
        .table-multiplos th,.table-multiplos td{border-bottom:1px solid #eef2f7;padding:6px 6px;text-align:center;font-size:12px}
        .table-multiplos tbody tr:nth-child(even) td{background:#fcfdff}
        .table-multiplos tbody tr:hover td{background:#f1f7ff}
        .table-multiplos td{background:#fff;vertical-align:middle;min-height:40px;height:40px}
        /* CSS Individual por Campo */
        
        /* Cliente - Select com Choices */
        .table-multiplos td .input-cliente{width:100%;height:38px;padding:6px 10px;border:1px solid #dce3ea;border-radius:8px;outline:none;transition:border .15s, box-shadow .15s;background:#f8f9fa}
        .table-multiplos td .input-cliente:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(33,150,243,0.15);background:#f8f9fa}
        .table-multiplos td .choices{background:#f8f9fa;max-width:100%;width:100%;min-width:0;overflow:visible;box-sizing:border-box;display:block}
        .table-multiplos td .choices__inner{min-height:38px;height:38px;padding:4px 8px;border-radius:8px;border:1px solid #dce3ea;box-shadow:none;background:#f8f9fa;display:flex;align-items:center;overflow:hidden;width:100%;min-width:0;box-sizing:border-box}
        .table-multiplos td .choices.is-open .choices__inner{background:#f8f9fa}
        .table-multiplos td .choices.is-disabled .choices__inner{background:#f8f9fa}
        .table-multiplos td .choices__placeholder{opacity:1;color:#666}
        /* Truncar texto dos selects com reticências */
        .table-multiplos td .choices__list--single{width:100%;flex:1 1 auto;min-width:0;display:block}
        .table-multiplos td .choices__list--single .choices__item{display:block;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0}
        /* Caso algum select permita múltipla seleção, manter truncamento nos chips também */
        .table-multiplos td .choices__list--multiple{flex:1 1 auto;min-width:0;overflow:hidden}
        .table-multiplos td .choices__list--multiple .choices__item{max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .table-multiplos td .choices__list--dropdown .choices__item{white-space:nowrap}
        /* Fixar largura individual por campo (cliente, colaborador, item) e evitar crescimento */
        select.input-cliente + .choices, select.input-colaborador + .choices, select.input-item + .choices{display:block;width:100%;max-width:100%;overflow:hidden;box-sizing:border-box}
        select.input-cliente + .choices .choices__inner, select.input-colaborador + .choices .choices__inner, select.input-item + .choices .choices__inner{width:100%;box-sizing:border-box}
        
        /* Colaborador - Select com Choices */
        .table-multiplos td .input-colaborador{width:100%;height:38px;padding:6px 10px;border:1px solid #dce3ea;border-radius:8px;outline:none;transition:border .15s, box-shadow .15s;background:#f8f9fa}
        .table-multiplos td .input-colaborador:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(33,150,243,0.15);background:#f8f9fa}
        
        /* Item - Select com Choices */
        .table-multiplos td .input-item{width:100%;height:38px;padding:6px 10px;border:1px solid #dce3ea;border-radius:8px;outline:none;transition:border .15s, box-shadow .15s;background:#f8f9fa}
        .table-multiplos td .input-item:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(33,150,243,0.15);background:#f8f9fa}
        
        /* Descrição - Input Text */
        .table-multiplos td .input-descricao{width:100%;height:38px;padding:6px 10px;border:1px solid #dce3ea;border-radius:8px;outline:none;transition:border .15s, box-shadow .15s;background:#f8f9fa !important}
        .table-multiplos td .input-descricao:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(33,150,243,0.15);background:#f8f9fa !important}
        
        /* Valor Venda - Input Number */
        .table-multiplos td .input-valor{width:100%;height:38px;padding:6px 10px;border:1px solid #dce3ea;border-radius:8px;outline:none;transition:border .15s, box-shadow .15s;background:#f8f9fa;text-align:right}
        .table-multiplos td .input-valor:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(33,150,243,0.15);background:#f8f9fa}
        
        /* Percentual - Input Text */
        .table-multiplos td .input-percentual{width:100%;height:38px;padding:6px 10px;border:1px solid #dce3ea;border-radius:8px;outline:none;transition:border .15s, box-shadow .15s;background:#f8f9fa;text-align:center}
        .table-multiplos td .input-percentual:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(33,150,243,0.15);background:#f8f9fa}
        
        /* Comissão - Input Number (Readonly) */
        .table-multiplos td .input-comissao{width:100%;height:38px;padding:6px 10px;border:1px solid #dce3ea;border-radius:8px;outline:none;transition:border .15s, box-shadow .15s;background:#f8f9fa !important;text-align:right}
        .table-multiplos td .input-comissao:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(33,150,243,0.15);background:#f8f9fa}
        .choices__list--dropdown{z-index:2000}
        .table-multiplos td .btn-primary,.table-multiplos td .btn-secondary{padding:6px 10px;font-size:12px}
        /* Delimitação visual: apenas a grade de simulação com borda externa azul */
        .simulacao-titulos-multiplo{border:1.5px solid #90caf9;border-radius:8px;background:#ffffff}
        /* Botões seguem o padrão global do sistema (styles.css) */
        .btn-duplicar{background:#007bff;color:#fff;border:none;margin-right:4px;border-radius:5px;padding:6px 10px}
        .btn-duplicar:hover{background:#0056b3}
        .btn-deletar{background:#dc3545;color:#fff;border:none;border-radius:5px;padding:6px 10px}
        .btn-deletar:hover{background:#c82333}
        .duplicar-excluir-multiplos .btn-multiplos-acao i{font-size:13px}

        /* Toggle de Tipo (Produto/Serviço) */
        .tipo-toggle-multiplo{background:transparent;border:none;border-radius:0;padding:0;height:38px;align-items:center}
        .tipo-toggle-multiplo .btn-tipo{background:#fff;border:1px solid #dce3ea;color:#1f2937;padding:0 12px;border-radius:8px;font-weight:600;cursor:pointer;transition:background .15s,color .15s,border-color .15s;height:38px;line-height:normal;font-size:12px;display:inline-flex;align-items:center;justify-content:center;gap:6px;white-space:nowrap}
        .tipo-toggle-multiplo .btn-tipo:hover{background:#eaf2ff;color:#0f172a}
        .tipo-toggle-multiplo .btn-tipo.active{background:#007bff;color:#fff;border-color:#007bff}
        .tipo-toggle-multiplo .btn-tipo.active:hover{background:#0056b3;border-color:#0056b3}

        /* Barra inferior com totalizadores e botoes  */
        #barraInferiorMultiplo{position:static;display:grid;grid-template-columns:1fr auto;align-items:center;gap:16px;
            background:var(--card);border:1px solid var(--border);border-radius:8px;box-shadow:0 10px 30px rgba(2,6,23,0.06),0 2px 6px rgba(2,6,23,0.04);height:auto;min-height:51px;padding:8px 16px;margin:12px 0 4px 0;width:100%}
        #barraInferiorMultiplo strong{color:#0f172a;font-size:12px}
        #barraInferiorMultiplo span{display:inline-block;background:#f1f5f9;border:1px solid #e5e7eb;color:#0f172a;padding:3px 8px;border-radius:997px;margin-left:6px;font-weight:700;min-width:72px;text-align:center;font-size:12px}
        #barraInferiorMultiplo .resumos-barra{display:flex;gap:20px;align-items:center;margin:0}
        #barraInferiorMultiplo .acoes-barra{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin:0}
        #barraInferiorMultiplo .btn-primary,#barraInferiorMultiplo .btn-secondary{padding:6px 10px;font-size:12px;border-radius:6px}
        #barraInferiorMultiplo .btn-primary i,#barraInferiorMultiplo .btn-secondary i{font-size:12px}
        /* Garante botoes alinhados à direita mesmo sem classes utilitárias */
        #barraInferiorMultiplo > div:last-child{justify-self:end}

        /* Ícones/labels das ações por linha */
        .acao-multiplos .acoes-multiplos-wrapper{background:#f8fafc;border:1px dashed #e5e7eb;border-radius:10px;padding:6px}
        .acao-multiplos label{color:#475569}
        .checkbox-parcelado{width:16px;height:16px}
        .input-parcelas{height:38px;padding:6px 10px;border:1px solid #dce3ea;border-radius:8px;outline:none;transition:border .15s, box-shadow .15s;background:#f8f9fa}
        .input-parcelas:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(33,150,243,0.15);background:#f8f9fa}
        .input-valor-parcela{height:38px;padding:6px 10px;border:1px solid #dce3ea;border-radius:8px;outline:none;transition:border .15s, box-shadow .15s;background:#f8f9fa !important;text-align:right}
        .input-valor-parcela:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(33,150,243,0.15);background:#f8f9fa}
        /* Modal de lançamento */
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999}
        .modal-card{width:min(420px,92vw);background:#fff;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,.2);padding:20px;text-align:center}
        .modal-title{font-size:1.15rem;font-weight:700;margin-bottom:8px}
        .modal-sub{color:#555;font-size:.95rem;margin-bottom:14px}
        .spinner{width:42px;height:42px;border:4px solid #e8ecf4;border-top-color:#4f46e5;border-radius:50%;margin:10px auto 16px;animation:spin .9s linear infinite}
        .progressbar{width:100%;height:8px;background:#eef2f7;border-radius:999px;overflow:hidden;margin:10px 0 4px}
        .progressbar>div{height:100%;width:0%;background:var(--brand);transition:width .25s ease}
        .modal-actions{margin-top:14px;display:flex;gap:10px;justify-content:center}
        .btn-modal{padding:8px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
        .btn-ok{background:var(--brand);color:#fff}
        .btn-error{background:#ef4444;color:#fff}
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo" style="display:flex;align-items:center;justify-content:center;padding:15px 0;">
            <img src="assets/images/logo2.png" alt="BlueDev Logo" style="height:2.5em;margin-right:10px;">
            <h1><span class="orange">e-</span><span class="highlight">Gerente</span></h1>
        </div>
        <ul class="nav-menu">
            <li><a href="index.html"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-user-plus"></i><span>Cadastros</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="colaboradores.html"><i class="fas fa-users"></i><span>Colaboradores</span></a></li>
                    <li><a href="clientes.html"><i class="fas fa-user-tie"></i><span>Clientes</span></a></li>
                    <li><a href="produtos.html"><i class="fas fa-box"></i><span>Produtos</span></a></li>
                    <li><a href="servicos.html"><i class="fas fa-cogs"></i><span>Serviços</span></a></li>
                    <li><a href="perfil.html" data-perm="cadastros_perfis_ver"><i class="fas fa-user-shield"></i><span>Perfil</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-hand-holding-usd"></i><span>Comissões</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="lancar-comissao.html"><i class="fas fa-plus-circle"></i><span>Lançar (Comercial)</span></a></li>
                    <li><a href="lancar-multcomissao.html" class="active"><i class="fas fa-layer-group"></i><span>Lançar (Múltiplos)</span></a></li>
                    <li><a href="movimento-comissao.html"><i class="fas fa-exchange-alt"></i><span>Movimento</span></a></li>
                    <li><a href="consulta-comissao.html"><i class="fas fa-search"></i><span>Consulta</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-chart-bar"></i><span>Relatórios</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="recebimento.html"><i class="fas fa-money-bill-wave"></i><span>Recebimento</span></a></li>
                    <li><a href="conferencia.html"><i class="fas fa-check-circle"></i><span>Conferência</span></a></li>
                    <li><a href="dinamico.html"><i class="fas fa-chart-line"></i><span>Dinâmico</span><span class="beta-tag">beta</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-cog"></i><span>Configurações</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="manutencao-bd.html"><i class="fas fa-database"></i><span>Manutenção BD</span></a></li>
                    <li><a href="sincronizar.html"><i class="fas fa-sync"></i><span>Sincronizar</span></a></li>
                </ul>
            </li>
        </ul>
        <div class="logout-button">
            <a href="login.html" data-logout><i class="fas fa-sign-out-alt"></i><span>Sair</span></a>
        </div>
    </div>

    <div class="main-content">
        <div id="loader-multi" class="loader-overlay-multi">
            <div class="spinner-main"></div>
            <div class="loading-text">Carregando dados...</div>
        </div>

        <div class="header">
            <div class="welcome-text">
                <h1>Múltiplos Lançamentos</h1>
                <p>Registre várias comissões ao mesmo tempo</p>
            </div>
            <div class="user-info">
                <div class="notifications"><i class="fas fa-bell"></i><span class="badge">3</span></div>
                <div class="user-avatar">A</div>
            </div>
        </div>

        <div class="content">
            <form id="formMultiplo" class="form-comissao">
                <div class="table-multiplos">
                    <div class="table-multiplos-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:200px;min-width:180px;">Cliente</th>
                                    <th style="width:200px;min-width:180px;">Colaborador</th>
                                    <th style="width:100px;min-width:80px;">Tipo</th>
                                    <th style="width:150px;min-width:120px;">Produto/Serviço</th>
                                    <th style="width:120px;min-width:100px;">Descrição</th>
                                    <th style="width:100px;min-width:80px;">Valor Venda</th>
                                    <th style="width:80px;min-width:70px;">%</th>
                                    <th style="width:100px;min-width:80px;">Comissão</th>
                                    <th style="width:120px;min-width:100px;">Ações</th>
                                    <th style="width:80px;min-width:70px;">Duplicar/Excluir</th>
                                </tr>
                            </thead>
                            <tbody id="linhasMultiplo"></tbody>
                        </table>
                    </div>
                </div>
            </form>
        </div>

        <div id="barraInferiorMultiplo" class="filters-container" style="display:flex;">
            <div style="display:flex;gap:20px;align-items:center;">
                <div><strong>Total de Linhas:</strong> <span id="totalLinhas">0</span></div>
                <div><strong>Valor Total das Vendas:</strong> <span id="valorTotalVendas">R$ 0,00</span></div>
                <div><strong>Valor Total das Comissões:</strong> <span id="valorTotalComissoes">R$ 0,00</span></div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;margin-left:auto;">
                <button type="button" class="btn-primary" onclick="adicionarLinhaMultiplo()"><i class="fas fa-plus"></i> Adicionar Linha</button>
                <button type="button" class="btn-secondary" onclick="limparTodasLinhas()"><i class="fas fa-trash-alt"></i> Limpar Todas</button>
                <button type="reset" form="formMultiplo" class="btn-secondary"><i class="fas fa-times"></i> Cancelar</button>
                <button type="submit" form="formMultiplo" class="btn-primary"><i class="fas fa-save"></i> Salvar Todos</button>
            </div>
        </div>
        <!-- Modal Lançamento -->
        <div id="modalLancamento" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalLancamentoTitulo">
            <div class="modal-card">
                <div id="modalLancamentoTitulo" class="modal-title">Lançando títulos...</div>
                <div id="modalLancamentoSub" class="modal-sub">Preparando envios</div>
                <div class="spinner" id="modalLancamentoSpinner"></div>
                <div class="progressbar"><div id="modalLancamentoBar"></div></div>
                <div class="modal-actions" id="modalLancamentoActions" style="display:none">
                    <button type="button" class="btn-modal btn-ok" id="btnModalOk">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script src="scripts/navigation.js"></script>
    <script>
        function formatarMoedaBR(valor){return Number(valor).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}
        // Usando window.api direto para /movimento_comissoes
        function extrairNumeroBR(valor){if(!valor) return 0; const n=String(valor).replace(/[^0-9,.-]/g,'').replace(/\.(?=.*\.)/g,'').replace(',','.'); return parseFloat(n)||0}
        let produtos=[], servicos=[]; let colaboradoresCache=null, colaboradoresCallbacks=[];

        function resolveUsuarioLancamento(){
            try{
                if (window.authGuard && typeof window.authGuard.getCurrentUser === 'function'){
                    const u = window.authGuard.getCurrentUser();
                    if (u) return u.nome || u.email || u.codigo || u.id || 'admin';
                }
            }catch(_){ }
            try{
                const raw = sessionStorage.getItem('user') || localStorage.getItem('user');
                if (raw){ const u = JSON.parse(raw); return (u && (u.nome || u.email || u.codigo || u.id)) || 'admin'; }
            }catch(_){ }
            try{ if (window.usuarioLogado) return window.usuarioLogado }catch(_){ }
            try{ if (localStorage.getItem('usuarioLogado')) return localStorage.getItem('usuarioLogado') }catch(_){ }
            return 'admin';
        }
        // Modal helpers
        function abrirModalLancamento(total){
            try{
                const m=document.getElementById('modalLancamento');
                const t=document.getElementById('modalLancamentoTitulo');
                const s=document.getElementById('modalLancamentoSub');
                const bar=document.getElementById('modalLancamentoBar');
                const sp=document.getElementById('modalLancamentoSpinner');
                const act=document.getElementById('modalLancamentoActions');
                m.style.display='flex';
                t.textContent='Lançando títulos...';
                s.textContent=`Iniciando (0 de ${total})`;
                bar.style.width='0%';
                sp.style.display='block';
                act.style.display='none';
                const ok=document.getElementById('btnModalOk');
                ok.classList.remove('btn-error');
                ok.classList.add('btn-ok');
            }catch(_){}
        }
        function atualizarModalLancamento(processados,total){
            try{
                const s=document.getElementById('modalLancamentoSub');
                const bar=document.getElementById('modalLancamentoBar');
                const pct=Math.max(0,Math.min(100, Math.round((processados/Math.max(1,total))*100)));
                s.textContent=`Processando (${processados} de ${total})`;
                bar.style.width=pct+'%';
            }catch(_){}
        }
        function finalizarModalLancamentoSucesso(qtd){
            try{
                const t=document.getElementById('modalLancamentoTitulo');
                const s=document.getElementById('modalLancamentoSub');
                const sp=document.getElementById('modalLancamentoSpinner');
                const act=document.getElementById('modalLancamentoActions');
                const bar=document.getElementById('modalLancamentoBar');
                t.textContent='Títulos lançados com sucesso!';
                s.textContent=`${qtd} título(s) gerados e salvos.`;
                sp.style.display='none';
                bar.style.width='100%';
                act.style.display='flex';
            }catch(_){}
        }
        function finalizarModalLancamentoErro(msg){
            try{
                const m=document.getElementById('modalLancamento');
                const t=document.getElementById('modalLancamentoTitulo');
                const s=document.getElementById('modalLancamentoSub');
                const sp=document.getElementById('modalLancamentoSpinner');
                const act=document.getElementById('modalLancamentoActions');
                const ok=document.getElementById('btnModalOk');
                const bar=document.getElementById('modalLancamentoBar');
                t.textContent='Falha ao lançar títulos';
                s.textContent= msg || 'Tente novamente.';
                sp.style.display='none';
                bar.style.width='0%';
                act.style.display='flex';
                ok.classList.remove('btn-ok');
                ok.classList.add('btn-error');
                m.style.display='flex';
            }catch(_){}
        }
        (function bindModalOk(){ try{ document.getElementById('btnModalOk').addEventListener('click', ()=>{ try{ document.getElementById('modalLancamento').style.display='none' }catch(_){ } }) }catch(_){ } })();
        async function buscarColaboradores(){ if(colaboradoresCache) return colaboradoresCache; try{ colaboradoresCache=await api.get('/colaboradores'); colaboradoresCallbacks.forEach(cb=>cb(colaboradoresCache)); return colaboradoresCache;}catch(e){console.error('Erro ao buscar colaboradores:',e); return []}}
        function preencherSelectColaborador(select){ if(select.choicesInstance){select.choicesInstance.destroy();select.choicesInstance=null} select.innerHTML=''; buscarColaboradores().then(colabs=>{ if(select.choicesInstance){select.choicesInstance.destroy();select.choicesInstance=null} select.innerHTML=''; colabs.forEach(c=>{const o=document.createElement('option'); const codigo = (c.codigo ?? c.id ?? c.codigo_colaborador ?? c.matricula ?? ''); const codigoStr=String(codigo); const nome=(c.nome||c.descricao||''); o.value=codigoStr; o.textContent=(codigoStr && nome)? `${codigoStr} - ${nome}` : (nome || codigoStr); select.appendChild(o)}); select.choicesInstance=new Choices(select,{searchEnabled:true,itemSelectText:'',placeholder:true,placeholderValue:'Selecione...'}) }) }
        function preencherSelectClienteMultiplo(select){ if(select.choicesInstance){select.choicesInstance.destroy();select.choicesInstance=null} select.innerHTML=''; if(Array.isArray(window.clientes)){ window.clientes.forEach(c=>{ const codigo = (c && (c.codigo ?? c.id ?? c.codigo_crm ?? '')); if(!codigo){ return } const codigoStr = String(codigo).padStart(5,'0'); const nome=(c && (c.nome||c.razao||c.fantasia||'')) || ''; const o=document.createElement('option'); o.value=codigoStr; o.textContent=(nome? `${codigoStr} - ${nome}` : codigoStr); select.appendChild(o)}) } select.choicesInstance=new Choices(select,{searchEnabled:true,itemSelectText:'',placeholder:true,placeholderValue:'Selecione...'}) }
        function getItemPrimaryId(item){ return (item && (item.codigo ?? item.id ?? item.codigo_crm ?? item.cod ?? item.codigo_servico)) }
        function getItemName(item){ return (item && (item.nome ?? item.descricao ?? item.nome_servico ?? item.nomeProduto ?? item.nomeServico)) || 'Item'}
        function getItemPrice(item){ const price=(item && (item.preco ?? item.valor ?? item.preco_venda ?? item.precoServico ?? item.preco_servico)); const parsed=parseFloat(price); return isNaN(parsed)?0:parsed }

        function atualizarResumoMultiplo(){ const linhas=document.querySelectorAll('#linhasMultiplo tr.linha-lancamento-multiplo'); let totalVendas=0,totalComissoes=0; linhas.forEach(tr=>{ const vendaStr=tr.querySelector('input[name="valor_venda[]"]').value; const comissaoStr=tr.querySelector('input[name="valor_comissao[]"]').value; const valorVenda=extrairNumeroBR(vendaStr); const valorComissao=extrairNumeroBR(comissaoStr); totalVendas+=isNaN(valorVenda)?0:valorVenda; totalComissoes+=isNaN(valorComissao)?0:valorComissao }); document.getElementById('totalLinhas').textContent=linhas.length.toString(); document.getElementById('valorTotalVendas').textContent=formatarMoedaBR(totalVendas); document.getElementById('valorTotalComissoes').textContent=formatarMoedaBR(totalComissoes) }

        function calcularComissaoMultiplo(input, idx){ const tr=input.closest('tr'); const valorVenda=parseFloat(tr.querySelector('input[name="valor_venda[]"]').value)||0; const percentualStr=tr.querySelector('input[name="percentual[]"]').value||'0'; const percentualNumber=percentualStr.replace(/\./g,'').replace(',','.'); const used=parseFloat(percentualNumber)||0; const valorComissaoInput=tr.querySelector('input[name="valor_comissao[]"]').value= (valorVenda*used/100).toFixed(2); tr.dataset.simulado='false'; atualizarResumoMultiplo() }

        // Sanitiza percentual para 0..100 com duas casas e formata vírgula
        function sanitizarPercentualMultiplo(input){
            const maxPermitido=100;
            let raw=(input.value||'').replace(/[^\d,\.]/g,'');
            raw=raw.replace(/\./g,',');
            const firstComma=raw.indexOf(',');
            if(firstComma!==-1){
                let intPart=raw.slice(0,firstComma).replace(/,/g,''); if(intPart==='') intPart='0';
                let decPart=raw.slice(firstComma+1).replace(/,/g,''); decPart=decPart.slice(0,2);
                raw=intPart+(decPart.length?(','+decPart):',');
            } else { raw=raw.replace(/,/g,''); }
            const rawInt=raw.split(',')[0]; if(rawInt && parseInt(rawInt,10)>100) raw='100';
            let p=parseFloat(raw.replace(',','.')); if(isNaN(p)) p=0; const used=Math.min(maxPermitido, Math.max(0,p));
            input.value=String(Math.round(used*100)/100).replace('.',',');
            calcularComissaoMultiplo(input, 0);
        }

        function verificarDuplicidadeColaboradorGlobal(){
            const selects=[...document.querySelectorAll('#linhasMultiplo select[name="colaborador[]"]')];
            const valores=selects.map(s=>s.value).filter(Boolean);
            const set=new Set(); let duplicado=false;
            valores.forEach(v=>{ if(set.has(v)) duplicado=true; else set.add(v)});
            if(duplicado){ alert('Há colaboradores duplicados em linhas diferentes. Ajuste antes de salvar.'); }
            return !duplicado;
        }

        function validarLinhasAntesDeSalvar(){
            const linhas=[...document.querySelectorAll('#linhasMultiplo tr.linha-lancamento-multiplo')];
            let ok=true;
            linhas.forEach(tr=>{
                const selCliente=tr.querySelector('select[name="cliente[]"]');
                const selColab=tr.querySelector('select[name="colaborador[]"]');
                const selItem=tr.querySelector('select[name="item[]"]');
                const inpVenda=tr.querySelector('input[name="valor_venda[]"]');
                const inpPerc=tr.querySelector('input[name="percentual[]"]');
                const cliente=selCliente?selCliente.value:'';
                const colaborador=selColab?selColab.value:'';
                const item=selItem?selItem.value:'';
                const valorVenda=inpVenda? (parseFloat(inpVenda.value)||0) : 0;
                const percStr=(inpPerc && inpPerc.value? inpPerc.value : '0').replace(/\./g,'').replace(',','.');
                const perc=parseFloat(percStr)||0;
                const highlight=(el)=>{ if(el){ el.style.boxShadow='0 0 0 2px rgba(220,53,69,.2)'; el.style.borderColor='#dc3545'; setTimeout(()=>{el.style.boxShadow=''; el.style.borderColor='';}, 2000);} };
                if(!cliente||!colaborador||!item||!(valorVenda>0)){ ok=false; highlight(tr); }
                if(perc<0 || perc>100){ ok=false; const p=inpPerc; highlight(p); }
            });
            if(!ok) alert('Verifique os campos obrigatórios e se o percentual está entre 0 e 100.');
            if(ok) ok = verificarDuplicidadeColaboradorGlobal();
            return ok;
        }

        function obterDatasSimulacao(){
            const hoje=new Date();
            const ano=hoje.getFullYear(); const mes=String(hoje.getMonth()+1).padStart(2,'0'); const dia=String(hoje.getDate()).padStart(2,'0');
            const emissao=`${ano}-${mes}-${dia}`;
            const vencimentoBase=new Date(hoje.getFullYear(),hoje.getMonth()+1,hoje.getDate());
            const vAno=vencimentoBase.getFullYear(); const vMes=String(vencimentoBase.getMonth()+1).padStart(2,'0'); const vDia=String(vencimentoBase.getDate()).padStart(2,'0');
            const primeiroVenc=`${vAno}-${vMes}-${vDia}`;
            return { emissao, primeiroVenc };
        }

        function criarLinhaSimulacao(tr, parcelas, valorParcela){
            const tbody=document.getElementById('linhasMultiplo');
            const trSim=document.createElement('tr');
            trSim.classList.add('linha-simulacao-multiplo');
            const hoje=new Date();
            const dataHoje=hoje.toISOString().slice(0,10);
            let colSpan=10; // ocupar toda a linha abaixo
            let html = `<td colspan="${colSpan}" style="background:#f8fafc;">
                <div class='simulacao-titulos-multiplo' style='padding:8px;'>
                    <table style='width:100%;border-collapse:collapse;'>
                        <tr>
                            <th style='text-align:center;padding:6px;border-bottom:1px solid #e5e7eb;width:120px;'>Nº Título</th>
                            <th style='text-align:center;padding:6px;border-bottom:1px solid #e5e7eb;width:80px;'>Parcela</th>
                            <th style='text-align:center;padding:6px;border-bottom:1px solid #e5e7eb;width:120px;'>Valor</th>
                            <th style='text-align:center;padding:6px;border-bottom:1px solid #e5e7eb;width:160px;'>Data de Emissão</th>
                            <th style='text-align:center;padding:6px;border-bottom:1px solid #e5e7eb;width:160px;'>Data de Vencimento</th>
                        </tr>`;
            const valor = (typeof valorParcela === 'string') ? valorParcela : Number(valorParcela).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
            for(let i=1;i<=parcelas;i++){
                html += `<tr>
                    <td style='padding:6px;border-bottom:1px solid #f1f5f9;text-align:center;width:120px;'>Simulado-${i}/${parcelas}</td>
                    <td style='padding:6px;border-bottom:1px solid #f1f5f9;text-align:center;width:80px;'>${i}</td>
                    <td style='padding:6px;border-bottom:1px solid #f1f5f9;text-align:center;width:120px;'>R$ ${valor}</td>
                    <td style='padding:6px;border-bottom:1px solid #f1f5f9;text-align:center;width:160px;'><input type='date' class='simulacao-emissao-parcela' style='height:32px;width:150px;' value='${dataHoje}'></td>
                    <td style='padding:6px;border-bottom:1px solid #f1f5f9;text-align:center;width:160px;'><input type='date' class='simulacao-vencimento-parcela' style='height:32px;width:150px;'></td>
                </tr>`;
            }
            html += `</table>`;
            if(parcelas>1){
                html += `<div class='intervalo-vencimento-container' style='display:none; margin-top:8px;'>
                    <label style='font-weight:500;'>Intervalo entre títulos: </label>
                    <select class='intervalo-vencimento-select' style='margin-left:6px; padding:4px 8px; border-radius:6px; border:1px solid #cfd8dc; width:140px !important;'>
                        <option value='' selected disabled>Selecione...</option>
                        <option value='10'>10 dias</option>
                        <option value='20'>20 dias</option>
                        <option value='30'>30 dias</option>
                    </select>
                </div>`;
            }
            html += `</div></td>`;
            trSim.innerHTML = html;
            tbody.insertBefore(trSim, tr.nextElementSibling);

            // Eventos: exibir seletor de intervalo ao definir primeiro vencimento
            const simulacaoDiv = trSim.querySelector('.simulacao-titulos-multiplo');
            const vencInputs = simulacaoDiv.querySelectorAll('.simulacao-vencimento-parcela');
            const emissaoInputs = simulacaoDiv.querySelectorAll('.simulacao-emissao-parcela');
            const intervaloContainer = simulacaoDiv.querySelector('.intervalo-vencimento-container');
            const intervaloSelect = simulacaoDiv.querySelector('.intervalo-vencimento-select');
            if(vencInputs.length>1 && intervaloContainer && intervaloSelect){
                vencInputs[0].addEventListener('change', function(){ intervaloContainer.style.display='block'; });
                intervaloSelect.addEventListener('change', function(){
                    if(!this.value) return; const intervalo=parseInt(this.value); const primeira=vencInputs[0].value; if(!primeira) return;
                    let data=new Date(primeira); for(let i=1;i<vencInputs.length;i++){ data.setDate(data.getDate()+intervalo); vencInputs[i].value=data.toISOString().slice(0,10) }
                });
            }
            if(emissaoInputs.length>1){
                emissaoInputs[0].addEventListener('change', function(){ if(this.value){ for(let i=1;i<emissaoInputs.length;i++){ if(!emissaoInputs[i].value) emissaoInputs[i].value=this.value } } });
            }
        }

        function removerSimulacaoLinha(tr){ const next=tr.nextElementSibling; if(next && next.classList.contains('linha-simulacao-multiplo')) next.remove() }
        function atualizarSimulacaoLinha(tr){ const next=tr.nextElementSibling; if(!(next && next.classList.contains('linha-simulacao-multiplo'))) return; const inputValorParcela=tr.querySelector('.input-valor-parcela'); const parcelas=parseInt(tr.querySelector('.input-parcelas').value)||0; if(parcelas<=0 || !inputValorParcela.value){ next.remove(); return } const valorParcela=inputValorParcela.value; next.remove(); criarLinhaSimulacao(tr, parcelas, valorParcela) }
        function simularTitulosLinha(tr){ let parcelas=parseInt(tr.querySelector('.input-parcelas').value)||0; if(parcelas<=0){ parcelas=1 } let valorParcela=tr.querySelector('.input-valor-parcela').value; if(!valorParcela){ const v=parseFloat(tr.querySelector('input[name="valor_comissao[]"]').value)||0; if(!(v>0)){ alert('Informe o valor da comissão para simular.'); return } valorParcela=(v/parcelas).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2}) } removerSimulacaoLinha(tr); criarLinhaSimulacao(tr, parcelas, valorParcela) }

        function atualizarTipoMultiplo(select, idx){ let td,itemSelect,tipo; if(select.tagName==='SELECT'){ td=select.closest('td'); itemSelect=td.parentElement.querySelector('select[name="item[]"]'); tipo=select.value } else { td=select.parentElement().nextElementSibling; itemSelect=td.querySelector('select[name="item[]"]'); tipo=select.value }
            const inputValor=td.parentElement.querySelector('input[name="valor_venda[]"]'); itemSelect.disabled=true; if(itemSelect.choicesInstance){itemSelect.choicesInstance.destroy(); itemSelect.choicesInstance=null}
            // Ao alterar o tipo, invalida qualquer simulação existente da linha
            try{ const trRow=td.parentElement; removerSimulacaoLinha(trRow) }catch(_){ }
            if(!tipo){ itemSelect.innerHTML='<option value="" disabled selected hidden>Selecione...</option>'; itemSelect.choicesInstance=new Choices(itemSelect,{searchEnabled:true,itemSelectText:''}); return }
            let source = tipo==='produto'? produtos : servicos; const choices = (source||[]).map(it=>{ const primary = String(getItemPrimaryId(it)||''); const value = (typeof it.id!=='undefined')? String(it.id) : primary; const codigoPad = primary && /^\d+$/.test(primary) ? primary.padStart(5,'0') : primary; const nome = getItemName(it); const displayLabel = (codigoPad && nome) ? `${codigoPad} - ${nome}` : (nome || codigoPad || 'Item'); return { value: value, label: displayLabel, customProperties:{valor:getItemPrice(it)} } });
            itemSelect.innerHTML='';
            // Removido placeholder visível para não exibir "Selecione..."
            choices.forEach(c=>{ const o=document.createElement('option'); o.value=c.value; o.textContent=c.label; o.dataset.valor=c.customProperties.valor; itemSelect.appendChild(o) });
            itemSelect.disabled=false; itemSelect.value='';
            itemSelect.choicesInstance=new Choices(itemSelect,{searchEnabled:true,itemSelectText:'',placeholder:true,placeholderValue:'Selecione...'});
            itemSelect.addEventListener('change',function(){
                // Alterar o item invalida simulação
                try{ const trRow=td.parentElement; removerSimulacaoLinha(trRow) }catch(_){ }
                const selectedOptions=Array.from(this.selectedOptions).filter(opt=>opt.value); if(selectedOptions.length===1){ const val=parseFloat(selectedOptions[0].dataset.valor||'0'); if(val>0){ inputValor.value=val.toFixed(2); calcularComissaoMultiplo(inputValor, idx) } }
            }) }

        function toggleTipoMultiplo(btn, idx){ const container=btn.parentElement; const buttons=container.querySelectorAll('.btn-tipo'); buttons.forEach(b=>b.classList.remove('active')); btn.classList.add('active'); const tipo=btn.dataset.tipo; container.querySelector('input[name="tipo[]"]').value=tipo; const tr=btn.closest('tr'); atualizarTipoMultiplo({ value: tipo, parentElement: ()=>btn.closest('td'), closest: tr.closest.bind(tr) }, idx) }

        function verificarColaboradorDuplicadoMultiplo(select){ const tr=select.closest('tr'); const selects=tr.querySelectorAll('select[name="colaborador[]"]'); const valores=[...selects].map(s=>s.value).filter(Boolean); const temDup= new Set(valores).size!==valores.length; if(temDup){ alert('Colaborador já selecionado nesta linha.'); select.value=''; if(select.choicesInstance){select.choicesInstance.setChoiceByValue('')} select.dispatchEvent(new Event('change')) } }

        function adicionarLinhaMultiplo(valores=null){ const tbody=document.getElementById('linhasMultiplo'); const idx=tbody.children.length; const tr=document.createElement('tr'); tr.classList.add('linha-lancamento-multiplo'); tr.innerHTML=`
            <td style=\"width:200px;min-width:180px;\"><select name=\"cliente[]\" required class=\"input-cliente\" style=\"width:100%;min-width:180px;\"></select></td>
            <td style=\"width:200px;min-width:180px;\"><select name=\"colaborador[]\" required class=\"input-colaborador\" style=\"width:100%;min-width:180px;\"></select></td>
            <td>
                <div class=\"tipo-toggle-multiplo\" style=\"display:flex;gap:6px;justify-content:center;\">
                    <button type=\"button\" class=\"btn-tipo\" data-tipo=\"produto\" onclick=\"toggleTipoMultiplo(this, ${idx})\"><i class=\"fas fa-box\"></i> Produto</button>
                    <button type=\"button\" class=\"btn-tipo\" data-tipo=\"servico\" onclick=\"toggleTipoMultiplo(this, ${idx})\"><i class=\"fas fa-cogs\"></i> Serviço</button>
                    <input type=\"hidden\" name=\"tipo[]\" value=\"\">
                </div>
            </td>
            <td><select name=\"item[]\" required disabled class=\"input-item\"><option value=\"\" disabled selected hidden>Selecione...</option></select></td>
            <td><input type=\"text\" name=\"descricao[]\" maxlength=\"100\" placeholder=\"Descrição\" class=\"input-descricao\"></td>
            <td><input type=\"number\" name=\"valor_venda[]\" step=\"0.01\" min=\"0\" required placeholder=\"0.00\" class=\"input-valor\" oninput=\"calcularComissaoMultiplo(this, ${idx})\"></td>
            <td><input type=\"text\" name=\"percentual[]\" required placeholder=\"0,00\" inputmode=\"decimal\" class=\"input-percentual\" oninput=\"sanitizarPercentualMultiplo(this)\"></td>
            <td><input type=\"number\" name=\"valor_comissao[]\" step=\"0.01\" min=\"0\" readonly placeholder=\"0.00\" class=\"input-comissao\"></td>
            <td class=\"acao-multiplos\">
                <div class=\"acoes-multiplos-wrapper\" style=\"display:flex;gap:6px;align-items:center;justify-content:center;\">
                    <button type=\"button\" class=\"btn-parcelar btn-secondary\" title=\"Parcelar venda\" style=\"height:32px;\"><i class='fas fa-receipt'></i> Parcelar</button>
                    <div class=\"group-parcelas\" style=\"display:none;gap:6px;align-items:center;\">
                        <label style=\"font-size:0.95em;\"><i class='fas fa-list-ol'></i></label>
                        <input type='number' min='2' class='input-parcelas' style='width:60px;'>
                    </div>
                    <div class=\"group-valor-parcela\" style=\"display:none;\">
                        <input type='text' class='input-valor-parcela' style='width:80px;margin-left:2px;' readonly>
                    </div>
                    <button type=\"button\" class=\"btn-simular btn-secondary\" title=\"Simular títulos\" style=\"height:32px;\">Simular</button>
                </div>
            </td>
            <td class=\"duplicar-excluir-multiplos\" style=\"text-align:center;vertical-align:middle;\">
                <button type=\"button\" class=\"btn-duplicar btn-multiplos-acao\" title=\"Duplicar linha\" onclick=\"duplicarLinhaMultiplo(this)\"><i class=\"fas fa-copy\"></i></button>
                <button type=\"button\" class=\"btn-deletar btn-multiplos-acao\" title=\"Excluir linha\" onclick=\"excluirLinhaMultiplo(this)\"><i class=\"fas fa-trash\"></i></button>
            </td>`;
            tbody.appendChild(tr);
            const selectCliente=tr.querySelector('select[name=\"cliente[]\"]'); preencherSelectClienteMultiplo(selectCliente); selectCliente.addEventListener('change', ()=>{ removerSimulacaoLinha(tr) });
            const selectColaborador=tr.querySelector('select[name=\"colaborador[]\"]'); preencherSelectColaborador(selectColaborador); selectColaborador.addEventListener('change', function(){ verificarColaboradorDuplicadoMultiplo(this); removerSimulacaoLinha(tr) })
            const selectItem=tr.querySelector('select[name=\"item[]\"]'); if(selectItem.choicesInstance){selectItem.choicesInstance.destroy();selectItem.choicesInstance=null} selectItem.choicesInstance=new Choices(selectItem,{searchEnabled:true,itemSelectText:''}); selectItem.addEventListener('change', ()=>{ removerSimulacaoLinha(tr) });
            const grpParcelas=tr.querySelector('.group-parcelas'); const inputParcelas=tr.querySelector('.input-parcelas'); const inputValorComissao=tr.querySelector('input[name=\"valor_comissao[]\"]'); const inputValorParcela=tr.querySelector('.input-valor-parcela'); const grpValorParcela=tr.querySelector('.group-valor-parcela');
            const btnParcelar=tr.querySelector('.btn-parcelar'); btnParcelar.addEventListener('click',()=>{ const isOpen=grpParcelas.style.display==='flex'; if(isOpen){ grpParcelas.style.display='none'; grpValorParcela.style.display='none'; inputParcelas.value=''; inputValorParcela.value=''; removerSimulacaoLinha(tr) } else { grpParcelas.style.display='flex'; grpValorParcela.style.display='block'; inputParcelas.min='2'; inputParcelas.value='2'; atualizarValorParcela() } });
            function atualizarValorParcela(){ let p=parseInt(inputParcelas.value)||0; if(p<2){ p=2; inputParcelas.value='2'; } const v=parseFloat(inputValorComissao.value)||0; inputValorParcela.value=(v>0 && p>0)? (v/p).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2}) : ''; if(document.body.contains(tr.nextElementSibling) && tr.nextElementSibling && tr.nextElementSibling.classList.contains('linha-simulacao-multiplo')){ atualizarSimulacaoLinha(tr) } }
            inputParcelas.addEventListener('input', atualizarValorParcela); inputValorComissao.addEventListener('input', atualizarValorParcela);
            const btnSimular=tr.querySelector('.btn-simular'); btnSimular.addEventListener('click', ()=>{ simularTitulosLinha(tr) });
            // Alterações que impactam a simulação: valor de venda e percentual
            const inputValorVenda=tr.querySelector('input[name=\"valor_venda[]\"]'); inputValorVenda.addEventListener('input', ()=>{ removerSimulacaoLinha(tr) });
            const inputPercentual=tr.querySelector('input[name=\"percentual[]\"]'); inputPercentual.addEventListener('input', ()=>{ removerSimulacaoLinha(tr) });
            if(valores){ if(valores.cliente){selectCliente.value=valores.cliente; if(selectCliente.choicesInstance){selectCliente.choicesInstance.setChoiceByValue(String(valores.cliente))}} if(valores.colaborador){selectColaborador.value=valores.colaborador; if(selectColaborador.choicesInstance){selectColaborador.choicesInstance.setChoiceByValue(String(valores.colaborador))}} if(valores.tipo){ const container=tr.querySelector('.tipo-toggle-multiplo'); const btn=container.querySelector(`.btn-tipo[data-tipo=\'${valores.tipo}\']`); if(btn) btn.click(); } if(valores.item){ selectItem.value=valores.item; if(selectItem.choicesInstance){selectItem.choicesInstance.setChoiceByValue(String(valores.item))}} if(valores.descricao){ tr.querySelector('input[name=\"descricao[]\"]').value=valores.descricao } if(valores.valor_venda){ tr.querySelector('input[name=\"valor_venda[]\"]').value=valores.valor_venda } if(valores.percentual){ tr.querySelector('input[name=\"percentual[]\"]').value=valores.percentual } if(valores.valor_comissao){ tr.querySelector('input[name=\"valor_comissao[]\"]').value=valores.valor_comissao } }
            atualizarResumoMultiplo()
        }

        function duplicarLinhaMultiplo(btn){ const tr=btn.closest('tr'); const valores={ cliente: tr.querySelector('select[name=\"cliente[]\"]').value, colaborador: tr.querySelector('select[name=\"colaborador[]\"]').value, tipo: tr.querySelector('input[name=\"tipo[]\"]').value, item: tr.querySelector('select[name=\"item[]\"]').value, descricao: tr.querySelector('input[name=\"descricao[]\"]').value, valor_venda: tr.querySelector('input[name=\"valor_venda[]\"]').value, percentual: tr.querySelector('input[name=\"percentual[]\"]').value, valor_comissao: tr.querySelector('input[name=\"valor_comissao[]\"]').value }; adicionarLinhaMultiplo(valores) }
        function excluirLinhaMultiplo(btn){ const tr=btn.closest('tr'); const trSim=tr.nextElementSibling; tr.remove(); if(trSim && trSim.classList.contains('linha-simulacao-multiplo')) trSim.remove(); atualizarResumoMultiplo() }
        function limparTodasLinhas(){ document.getElementById('linhasMultiplo').innerHTML=''; atualizarResumoMultiplo() }

        async function salvarComissoesMultiplas(event) {
            event.preventDefault();
            const form = event.target;
            const linhas = document.querySelectorAll('#linhasMultiplo tr.linha-lancamento-multiplo');
            
            if (linhas.length === 0) {
                alert('Adicione pelo menos uma linha antes de salvar.');
                return;
            }
            
            const listaComissoes = [];
            let houveCampoFaltando = false;
            const motivos = [];
            
            linhas.forEach((tr, idx) => {
                const selCliente = tr.querySelector('select[name="cliente[]"]');
                const selColab = tr.querySelector('select[name="colaborador[]"]');
                const inpTipo = tr.querySelector('input[name="tipo[]"]');
                const selItem = tr.querySelector('select[name="item[]"]');
                const inpDesc = tr.querySelector('input[name="descricao[]"]');
                const inpVenda = tr.querySelector('input[name="valor_venda[]"]');
                const inpPerc = tr.querySelector('input[name="percentual[]"]');
                const inpValorCom = tr.querySelector('input[name="valor_comissao[]"]');
                
                const rawCliente = selCliente ? selCliente.value : '';
                const rawColab = selColab ? selColab.value : '';
                let tipo = inpTipo ? inpTipo.value : '';
                const rawItem = selItem ? selItem.value : '';
                const descricao = inpDesc ? inpDesc.value : '';
                const valorVenda = inpVenda ? (parseFloat(inpVenda.value) || 0) : 0;
                const percentualStr = (inpPerc && inpPerc.value ? inpPerc.value : '0').replace(/\./g, '').replace(',', '.');
                const percentual = parseFloat(percentualStr) || 0;
                const valorComissao = inpValorCom ? (parseFloat(inpValorCom.value) || 0) : 0;
                
                if (!rawCliente || !rawColab || !rawItem || !(valorVenda > 0)) {
                    houveCampoFaltando = true;
                    motivos.push(`Linha ${idx+1}: campos obrigatórios faltando (cliente/colaborador/item/valor).`);
                    return;
                }
                
                const clienteId = String(rawCliente).padStart(5,'0');
                const colaboradorId = String(rawColab);
                
                if (!clienteId || clienteId.length !== 5) {
                    houveCampoFaltando = true;
                    motivos.push(`Linha ${idx+1}: ID de cliente inválido.`);
                    return;
                }
                
                // Determinar tipo se não estiver definido
                if (!tipo) {
                    try {
                        if ((produtos || []).some(p => p.codigo === rawItem)) {
                            tipo = 'produto';
                        } else if ((servicos || []).some(s => s.codigo === rawItem)) {
                            tipo = 'servico';
                        }
                    } catch(_) {}
                    
                    if (!tipo) {
                        houveCampoFaltando = true;
                        motivos.push(`Linha ${idx+1}: tipo não definido (produto/serviço).`);
                        return;
                    }
                }
                
                // Preparar item_id no formato da aba comercial: código-nome
                let itemId = '';
                try {
                    const lista = tipo === 'produto' ? produtos : servicos;
                    const item = lista.find(i => i.codigo === rawItem);
                    if (item) {
                        itemId = `${item.codigo.padStart(5, '0')}-${item.nome}`;
                    }
                } catch(_) {}
                
                if (!itemId) {
                    houveCampoFaltando = true;
                    motivos.push(`Linha ${idx+1}: item não encontrado.`);
                    return;
                }
                
                // Verificar parcelamento
                let qtdParcelas = 1;
                const grp = tr.querySelector('.group-parcelas');
                if (grp && grp.style.display === 'flex') {
                    const ip = grp.querySelector('.input-parcelas');
                    if (ip && parseInt(ip.value) > 1) {
                        qtdParcelas = parseInt(ip.value);
                    }
                }
                
                // Capturar datas da simulação
                let emissaoInputs = null, vencInputs = null;
                const trSim = tr.nextElementSibling;
                if (trSim && trSim.classList.contains('linha-simulacao-multiplo')) {
                    emissaoInputs = trSim.querySelectorAll('input.simulacao-emissao-parcela');
                    vencInputs = trSim.querySelectorAll('input.simulacao-vencimento-parcela');
                }
                
                // Exigir data(s) de vencimento sempre: 1 parcela -> 1 data; N parcelas -> N datas
                if (qtdParcelas >= 1) {
                    const totalEsperado = qtdParcelas;
                    const temSimulacao = !!(tr.nextElementSibling && tr.nextElementSibling.classList.contains('linha-simulacao-multiplo'));
                    const totalInformado = (vencInputs && vencInputs.length) ? [...vencInputs].filter(inp => inp.value && inp.value.trim() !== '').length : 0;
                    if (!temSimulacao || totalInformado < totalEsperado) {
                        houveCampoFaltando = true;
                        // Buscar nome do colaborador para mensagem mais clara
                        let nomeColaborador = 'Colaborador';
                        try {
                            const colaboradorSelect = tr.querySelector('select[name="colaborador[]"]');
                            if (colaboradorSelect && colaboradorSelect.value) {
                                const colaboradorCodigo = colaboradorSelect.value;
                                const colaborador = (colaboradoresCache || []).find(c => 
                                    String(c.codigo) === String(colaboradorCodigo) || 
                                    String(c.id) === String(colaboradorCodigo) ||
                                    String(c.codigo_colaborador) === String(colaboradorCodigo) ||
                                    String(c.matricula) === String(colaboradorCodigo)
                                );
                                if (colaborador) {
                                    nomeColaborador = colaborador.nome || colaborador.descricao || nomeColaborador;
                                }
                            }
                        } catch(_) {}
                        motivos.push(`${nomeColaborador} sem data de vencimento.`);
                        return;
                    }
                }
                
                // Obter usuário de lançamento (preferir sessionStorage 'user')
                const usuarioLancamento = resolveUsuarioLancamento();
                
                // Criar registros para cada parcela
                for (let p = 0; p < qtdParcelas; p++) {
                    let dataGeracao = new Date().toISOString().slice(0, 10);
                    let dataVencimento = new Date().toISOString().slice(0, 10);
                    
                    if (emissaoInputs && emissaoInputs[p] && emissaoInputs[p].value) {
                        dataGeracao = emissaoInputs[p].value;
                    }
                    if (vencInputs && vencInputs[p] && vencInputs[p].value) {
                        dataVencimento = vencInputs[p].value;
                    }
                    
                    listaComissoes.push({
                        cliente_id: clienteId,
                        colaborador_id: colaboradorId,
                        tipo,
                        item_id: itemId,
                        valor_venda: valorVenda,
                        percentual_comissao: percentual,
                        valor: (valorComissao / Math.max(1, qtdParcelas)),
                        data_geracao: dataGeracao,
                        data_vencimento: dataVencimento,
                        status: 'PENDENTE',
                        usuario_lancamento: usuarioLancamento,
                        descricao
                    });
                }
            });
            
            if (listaComissoes.length === 0) {
                const msg = motivos.length ? motivos.join('\n') : 'Preencha os dados obrigatórios das linhas.';
                finalizarModalLancamentoErro(msg);
                return;
            }
            // Mostrar modal e progresso
            abrirModalLancamento(listaComissoes.length);
            let contador=0; let total=listaComissoes.length; let timer=null;
            try {
                timer=setInterval(()=>{ if(contador < total-1){ contador++; atualizarModalLancamento(contador,total) } }, 200);
                await window.api.post('/movimento_comissoes', listaComissoes);
                atualizarModalLancamento(total,total);
                finalizarModalLancamentoSucesso(total);
                form.reset();
                document.getElementById('linhasMultiplo').innerHTML = '';
                atualizarResumoMultiplo();
            } catch(e) {
                console.error(e);
                finalizarModalLancamentoErro(e?.data?.details || 'Erro ao salvar comissões. Tente novamente.');
            } finally {
                if(timer){ clearInterval(timer) }
            }
        }

        document.getElementById('formMultiplo').addEventListener('submit', function(e){
            e.preventDefault();
            e.stopPropagation();
            if(!validarLinhasAntesDeSalvar()){ return }
            try { salvarComissoesMultiplas(e) } catch(err){ console.error('Erro no envio múltiplos:', err) }
            return false;
        });

        document.addEventListener('DOMContentLoaded', async function(){ try{ document.getElementById('loader-multi').style.display='flex' }catch(_){}
            try{ window.clientes=await api.get('/clientes'); produtos=await api.get('/produtos'); servicos=await api.get('/servicos') }catch(e){ console.error('Falha ao carregar dados iniciais:', e) }
            adicionarLinhaMultiplo(); atualizarResumoMultiplo(); try{ document.getElementById('loader-multi').style.display='none' }catch(_){ }
        })
    </script>
</body>
</html>
