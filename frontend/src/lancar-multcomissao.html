<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Comissões - Múltiplos Lançamentos</title>
    <link rel="icon" type="image/png" href="assets/images/logo2.png">
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="scripts/config/realtime-config.js"></script>
    <script src="scripts/realtime-bus.js"></script>
    <script src="scripts/realtime-global.js"></script>
    <script src="scripts/config/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <style>
        :root{--brand:#1976D2;--brand-600:#1565C0;--brand-700:#0D47A1;--accent:#2196F3;--bg:#f5f7fb;--card:#ffffff;--muted:#6b7280;--border:#e5e7eb;--success:#10b981;--danger:#ef4444}
        body{background:var(--bg)}
        .main-content{padding-bottom:4px}
        @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
        .loader-overlay-multi{display:none;position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);backdrop-filter:saturate(1.2) blur(2px);z-index:10;justify-content:center;align-items:center;flex-direction:column;border-radius:12px}
        .spinner-main{border:8px solid #e3f2fd;border-top:8px solid var(--brand);border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite}
        .loading-text{margin-top:16px;color:var(--brand);font-size:1.05rem;font-weight:600;text-align:center}
        .form-comissao{background:var(--card);border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,0.06), 0 2px 6px rgba(2,6,23,0.04);padding:12px 12px;margin-bottom:0;display:flex;flex-direction:column;gap:4px;min-height:calc(100vh - 335px);border:1px solid var(--border)}
        .table-multiplos{width:100%;margin-bottom:0;position:relative;flex:1 1 auto;height:calc(100vh - 272px);overflow:visible}
        .table-multiplos-wrapper{width:100%;height:100%;overflow:auto;border-radius:8px;border:none;background:transparent}
        .table-multiplos table{width:100%;min-width:1000px;border-collapse:separate;border-spacing:0}
        .table-multiplos thead tr{height:44px}
        .table-multiplos thead th{position:sticky;top:0;z-index:2;background:#f8fafc;color:#0f172a;font-weight:70s0;text-transform:uppercase;letter-spacing:.02em;font-size:11px;box-shadow:0 1px 0 rgba(2,6,23,0.05);padding:0 8px;height:44px;line-height:44px;white-space:nowrap}
        .table-multiplos th,.table-multiplos td{border-bottom:1px solid #eef2f7;padding:6px 6px;text-align:center;font-size:12px}
        .table-multiplos tbody tr:nth-child(even) td{background:#fcfdff}
        .table-multiplos tbody tr:hover td{background:#f1f7ff}
        .table-multiplos td{background:#fff;vertical-align:middle;min-height:40px;height:40px}
        .table-multiplos td input,.table-multiplos td select{width:100%;height:38px;padding:6px 10px;border:1px solid #dce3ea;border-radius:8px;outline:none;transition:border .15s, box-shadow .15s;background:#f8f9fa}
        .table-multiplos td input:focus,.table-multiplos td select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(33,150,243,0.15);background:#f8f9fa}
        /* Força o cinza no campo descrição, sobrescrevendo estilos globais */
        .table-multiplos td input.input-descricao{background:#f8f9fa !important}
        .table-multiplos td input.input-descricao:focus{background:#f8f9fa !important}
        .table-multiplos td .choices{background:#f8f9fa}
        .table-multiplos td .choices__inner{min-height:38px;height:38px;padding:4px 8px;border-radius:8px;border:1px solid #dce3ea;box-shadow:none;background:#f8f9fa}
        .table-multiplos td .choices.is-open .choices__inner{background:#f8f9fa}
        .table-multiplos td .choices.is-disabled .choices__inner{background:#f8f9fa}
        .table-multiplos td .choices__placeholder{opacity:1;color:#666}
        .choices__list--dropdown{z-index:20}
        .table-multiplos td .btn-primary,.table-multiplos td .btn-secondary{padding:6px 10px;font-size:12px}
        /* Delimitação visual: apenas a grade de simulação com borda externa azul */
        .simulacao-titulos-multiplo{border:1.5px solid #90caf9;border-radius:8px;background:#ffffff}
        /* Botões seguem o padrão global do sistema (styles.css) */
        .btn-duplicar{background:#007bff;color:#fff;border:none;margin-right:4px;border-radius:5px;padding:6px 10px}
        .btn-duplicar:hover{background:#0056b3}
        .btn-deletar{background:#dc3545;color:#fff;border:none;border-radius:5px;padding:6px 10px}
        .btn-deletar:hover{background:#c82333}
        .duplicar-excluir-multiplos .btn-multiplos-acao i{font-size:13px}

        /* Toggle de Tipo (Produto/Serviço) */
        .tipo-toggle-multiplo{background:transparent;border:none;border-radius:0;padding:0;height:38px;align-items:center}
        .tipo-toggle-multiplo .btn-tipo{background:#fff;border:1px solid #dce3ea;color:#1f2937;padding:0 12px;border-radius:8px;font-weight:600;cursor:pointer;transition:background .15s,color .15s,border-color .15s;height:38px;line-height:normal;font-size:12px;display:inline-flex;align-items:center;justify-content:center;gap:6px;white-space:nowrap}
        .tipo-toggle-multiplo .btn-tipo:hover{background:#eaf2ff;color:#0f172a}
        .tipo-toggle-multiplo .btn-tipo.active{background:#007bff;color:#fff;border-color:#007bff}
        .tipo-toggle-multiplo .btn-tipo.active:hover{background:#0056b3;border-color:#0056b3}

        /* Barra inferior com totalizadores e botoes  */
        #barraInferiorMultiplo{position:static;display:grid;grid-template-columns:1fr auto;align-items:center;gap:16px;
            background:var(--card);border:1px solid var(--border);border-radius:8px;box-shadow:0 10px 30px rgba(2,6,23,0.06),0 2px 6px rgba(2,6,23,0.04);height:auto;min-height:51px;padding:8px 16px;margin:12px 0 4px 0;width:100%}
        #barraInferiorMultiplo strong{color:#0f172a;font-size:12px}
        #barraInferiorMultiplo span{display:inline-block;background:#f1f5f9;border:1px solid #e5e7eb;color:#0f172a;padding:3px 8px;border-radius:997px;margin-left:6px;font-weight:700;min-width:72px;text-align:center;font-size:12px}
        #barraInferiorMultiplo .resumos-barra{display:flex;gap:20px;align-items:center;margin:0}
        #barraInferiorMultiplo .acoes-barra{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin:0}
        #barraInferiorMultiplo .btn-primary,#barraInferiorMultiplo .btn-secondary{padding:6px 10px;font-size:12px;border-radius:6px}
        #barraInferiorMultiplo .btn-primary i,#barraInferiorMultiplo .btn-secondary i{font-size:12px}
        /* Garante botoes alinhados à direita mesmo sem classes utilitárias */
        #barraInferiorMultiplo > div:last-child{justify-self:end}

        /* Ícones/labels das ações por linha */
        .acao-multiplos .acoes-multiplos-wrapper{background:#f8fafc;border:1px dashed #e5e7eb;border-radius:10px;padding:6px}
        .acao-multiplos label{color:#475569}
        .checkbox-parcelado{width:16px;height:16px}
        .input-parcelas{border-radius:8px}
        .input-valor-parcela{border-radius:8px;background:#eef6ff;color:#0f172a}
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo" style="display:flex;align-items:center;justify-content:center;padding:15px 0;">
            <img src="assets/images/logo2.png" alt="BlueDev Logo" style="height:2.5em;margin-right:10px;">
            <h1><span class="orange">e-</span><span class="highlight">Gerente</span></h1>
        </div>
        <ul class="nav-menu">
            <li><a href="index.html"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-user-plus"></i><span>Cadastros</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="colaboradores.html"><i class="fas fa-users"></i><span>Colaboradores</span></a></li>
                    <li><a href="clientes.html"><i class="fas fa-user-tie"></i><span>Clientes</span></a></li>
                    <li><a href="produtos.html"><i class="fas fa-box"></i><span>Produtos</span></a></li>
                    <li><a href="servicos.html"><i class="fas fa-cogs"></i><span>Serviços</span></a></li>
                    <li><a href="perfil.html" data-perm="cadastros_perfis_ver"><i class="fas fa-user-shield"></i><span>Perfil</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-hand-holding-usd"></i><span>Comissões</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="lancar-comissao.html"><i class="fas fa-plus-circle"></i><span>Lançar (Comercial)</span></a></li>
                    <li><a href="lancar-multcomissao.html" class="active"><i class="fas fa-layer-group"></i><span>Lançar (Múltiplos)</span></a></li>
                    <li><a href="movimento-comissao.html"><i class="fas fa-exchange-alt"></i><span>Movimento</span></a></li>
                    <li><a href="consulta-comissao.html"><i class="fas fa-search"></i><span>Consulta</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-chart-bar"></i><span>Relatórios</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="recebimento.html"><i class="fas fa-money-bill-wave"></i><span>Recebimento</span></a></li>
                    <li><a href="conferencia.html"><i class="fas fa-check-circle"></i><span>Conferência</span></a></li>
                    <li><a href="dinamico.html"><i class="fas fa-chart-line"></i><span>Dinâmico</span><span class="beta-tag">beta</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-cog"></i><span>Configurações</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="manutencao-bd.html"><i class="fas fa-database"></i><span>Manutenção BD</span></a></li>
                    <li><a href="sincronizar.html"><i class="fas fa-sync"></i><span>Sincronizar</span></a></li>
                </ul>
            </li>
        </ul>
        <div class="logout-button">
            <a href="login.html" data-logout><i class="fas fa-sign-out-alt"></i><span>Sair</span></a>
        </div>
    </div>

    <div class="main-content">
        <div id="loader-multi" class="loader-overlay-multi">
            <div class="spinner-main"></div>
            <div class="loading-text">Carregando dados...</div>
        </div>

        <div class="header">
            <div class="welcome-text">
                <h1>Múltiplos Lançamentos</h1>
                <p>Registre várias comissões ao mesmo tempo</p>
            </div>
            <div class="user-info">
                <div class="notifications"><i class="fas fa-bell"></i><span class="badge">3</span></div>
                <div class="user-avatar">A</div>
            </div>
        </div>

        <div class="content">
            <form id="formMultiplo" class="form-comissao">
                <div class="table-multiplos">
                    <div class="table-multiplos-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:200px;min-width:180px;">Cliente</th>
                                    <th style="width:200px;min-width:180px;">Colaborador</th>
                                    <th style="width:100px;min-width:80px;">Tipo</th>
                                    <th style="width:150px;min-width:120px;">Produto/Serviço</th>
                                    <th style="width:120px;min-width:100px;">Descrição</th>
                                    <th style="width:100px;min-width:80px;">Valor Venda</th>
                                    <th style="width:80px;min-width:70px;">%</th>
                                    <th style="width:100px;min-width:80px;">Comissão</th>
                                    <th style="width:120px;min-width:100px;">Ações</th>
                                    <th style="width:80px;min-width:70px;">Duplicar/Excluir</th>
                                </tr>
                            </thead>
                            <tbody id="linhasMultiplo"></tbody>
                        </table>
                    </div>
                </div>
            </form>
        </div>

        <div id="barraInferiorMultiplo" class="filters-container" style="display:flex;">
            <div style="display:flex;gap:20px;align-items:center;">
                <div><strong>Total de Linhas:</strong> <span id="totalLinhas">0</span></div>
                <div><strong>Valor Total das Vendas:</strong> <span id="valorTotalVendas">R$ 0,00</span></div>
                <div><strong>Valor Total das Comissões:</strong> <span id="valorTotalComissoes">R$ 0,00</span></div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;margin-left:auto;">
                <button type="button" class="btn-primary" onclick="adicionarLinhaMultiplo()"><i class="fas fa-plus"></i> Adicionar Linha</button>
                <button type="button" class="btn-secondary" onclick="limparTodasLinhas()"><i class="fas fa-trash-alt"></i> Limpar Todas</button>
                <button type="reset" form="formMultiplo" class="btn-secondary"><i class="fas fa-times"></i> Cancelar</button>
                <button type="submit" form="formMultiplo" class="btn-primary"><i class="fas fa-save"></i> Salvar Todos</button>
            </div>
        </div>
    </div>

    <script src="scripts/navigation.js"></script>
    <script>
        function formatarMoedaBR(valor){return Number(valor).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}
        function extrairNumeroBR(valor){if(!valor) return 0; const n=String(valor).replace(/[^0-9,.-]/g,'').replace(/\.(?=.*\.)/g,'').replace(',','.'); return parseFloat(n)||0}
        let produtos=[], servicos=[]; let colaboradoresCache=null, colaboradoresCallbacks=[];
        async function buscarColaboradores(){ if(colaboradoresCache) return colaboradoresCache; try{ colaboradoresCache=await api.get('/colaboradores'); colaboradoresCallbacks.forEach(cb=>cb(colaboradoresCache)); return colaboradoresCache;}catch(e){console.error('Erro ao buscar colaboradores:',e); return []}}
        function preencherSelectColaborador(select){ if(select.choicesInstance){select.choicesInstance.destroy();select.choicesInstance=null} select.innerHTML='<option value="" disabled selected hidden>Selecione...</option>'; buscarColaboradores().then(colabs=>{ if(select.choicesInstance){select.choicesInstance.destroy();select.choicesInstance=null} select.innerHTML='<option value="" disabled selected hidden>Selecione...</option>'; colabs.forEach(c=>{const o=document.createElement('option'); o.value=c.id; o.textContent=c.nome; select.appendChild(o)}); select.choicesInstance=new Choices(select,{searchEnabled:true,itemSelectText:''}) }) }
        function preencherSelectClienteMultiplo(select){ if(select.choicesInstance){select.choicesInstance.destroy();select.choicesInstance=null} select.innerHTML='<option value="" disabled selected hidden>Selecione...</option>'; if(Array.isArray(window.clientes)){ window.clientes.forEach(c=>{const o=document.createElement('option'); o.value=c.id; o.textContent=c.nome; select.appendChild(o)}) } select.choicesInstance=new Choices(select,{searchEnabled:true,itemSelectText:''}) }
        function getItemPrimaryId(item){ return (item && (item.codigo ?? item.id ?? item.codigo_crm ?? item.cod ?? item.codigo_servico)) }
        function getItemName(item){ return (item && (item.nome ?? item.descricao ?? item.nome_servico ?? item.nomeProduto ?? item.nomeServico)) || 'Item'}
        function getItemPrice(item){ const price=(item && (item.preco ?? item.valor ?? item.preco_venda ?? item.precoServico ?? item.preco_servico)); const parsed=parseFloat(price); return isNaN(parsed)?0:parsed }

        function atualizarResumoMultiplo(){ const linhas=document.querySelectorAll('#linhasMultiplo tr.linha-lancamento-multiplo'); let totalVendas=0,totalComissoes=0; linhas.forEach(tr=>{ const vendaStr=tr.querySelector('input[name="valor_venda[]"]').value; const comissaoStr=tr.querySelector('input[name="valor_comissao[]"]').value; const valorVenda=extrairNumeroBR(vendaStr); const valorComissao=extrairNumeroBR(comissaoStr); totalVendas+=isNaN(valorVenda)?0:valorVenda; totalComissoes+=isNaN(valorComissao)?0:valorComissao }); document.getElementById('totalLinhas').textContent=linhas.length.toString(); document.getElementById('valorTotalVendas').textContent=formatarMoedaBR(totalVendas); document.getElementById('valorTotalComissoes').textContent=formatarMoedaBR(totalComissoes) }

        function calcularComissaoMultiplo(input, idx){ const tr=input.closest('tr'); const valorVenda=parseFloat(tr.querySelector('input[name="valor_venda[]"]').value)||0; const percentualStr=tr.querySelector('input[name="percentual[]"]').value||'0'; const percentualNumber=percentualStr.replace(/\./g,'').replace(',','.'); const used=parseFloat(percentualNumber)||0; const valorComissaoInput=tr.querySelector('input[name="valor_comissao[]"]').value= (valorVenda*used/100).toFixed(2); tr.dataset.simulado='false'; atualizarResumoMultiplo() }

        // Sanitiza percentual para 0..100 com duas casas e formata vírgula
        function sanitizarPercentualMultiplo(input){
            const maxPermitido=100;
            let raw=(input.value||'').replace(/[^\d,\.]/g,'');
            raw=raw.replace(/\./g,',');
            const firstComma=raw.indexOf(',');
            if(firstComma!==-1){
                let intPart=raw.slice(0,firstComma).replace(/,/g,''); if(intPart==='') intPart='0';
                let decPart=raw.slice(firstComma+1).replace(/,/g,''); decPart=decPart.slice(0,2);
                raw=intPart+(decPart.length?(','+decPart):',');
            } else { raw=raw.replace(/,/g,''); }
            const rawInt=raw.split(',')[0]; if(rawInt && parseInt(rawInt,10)>100) raw='100';
            let p=parseFloat(raw.replace(',','.')); if(isNaN(p)) p=0; const used=Math.min(maxPermitido, Math.max(0,p));
            input.value=String(Math.round(used*100)/100).replace('.',',');
            calcularComissaoMultiplo(input, 0);
        }

        function verificarDuplicidadeColaboradorGlobal(){
            const selects=[...document.querySelectorAll('#linhasMultiplo select[name="colaborador[]"]')];
            const valores=selects.map(s=>s.value).filter(Boolean);
            const set=new Set(); let duplicado=false;
            valores.forEach(v=>{ if(set.has(v)) duplicado=true; else set.add(v)});
            if(duplicado){ alert('Há colaboradores duplicados em linhas diferentes. Ajuste antes de salvar.'); }
            return !duplicado;
        }

        function validarLinhasAntesDeSalvar(){
            const linhas=[...document.querySelectorAll('#linhasMultiplo tr:not(.linha-simulacao-multiplo)')];
            let ok=true;
            linhas.forEach(tr=>{
                const cliente=tr.querySelector('select[name="cliente[]"]').value;
                const colaborador=tr.querySelector('select[name="colaborador[]"]').value;
                const tipo=tr.querySelector('input[name="tipo[]"]').value;
                const item=tr.querySelector('select[name="item[]"]').value;
                const valorVenda=parseFloat(tr.querySelector('input[name="valor_venda[]"]').value)||0;
                const percStr=(tr.querySelector('input[name="percentual[]"]').value||'0').replace(/\./g,'').replace(',','.');
                const perc=parseFloat(percStr)||0;
                const highlight=(el)=>{ if(el){ el.style.boxShadow='0 0 0 2px rgba(220,53,69,.2)'; el.style.borderColor='#dc3545'; setTimeout(()=>{el.style.boxShadow=''; el.style.borderColor='';}, 2000);} };
                if(!cliente||!colaborador||!tipo||!item||!(valorVenda>0)){ ok=false; highlight(tr); }
                if(perc<0 || perc>100){ ok=false; const p=tr.querySelector('input[name="percentual[]"]'); highlight(p); }
            });
            if(!ok) alert('Verifique os campos obrigatórios e se o percentual está entre 0 e 100.');
            if(ok) ok = verificarDuplicidadeColaboradorGlobal();
            return ok;
        }

        function obterDatasSimulacao(){
            const hoje=new Date();
            const ano=hoje.getFullYear(); const mes=String(hoje.getMonth()+1).padStart(2,'0'); const dia=String(hoje.getDate()).padStart(2,'0');
            const emissao=`${ano}-${mes}-${dia}`;
            const vencimentoBase=new Date(hoje.getFullYear(),hoje.getMonth()+1,hoje.getDate());
            const vAno=vencimentoBase.getFullYear(); const vMes=String(vencimentoBase.getMonth()+1).padStart(2,'0'); const vDia=String(vencimentoBase.getDate()).padStart(2,'0');
            const primeiroVenc=`${vAno}-${vMes}-${vDia}`;
            return { emissao, primeiroVenc };
        }

        function criarLinhaSimulacao(tr, parcelas, valorParcela){
            const tbody=document.getElementById('linhasMultiplo');
            const trSim=document.createElement('tr');
            trSim.classList.add('linha-simulacao-multiplo');
            const hoje=new Date();
            const dataHoje=hoje.toISOString().slice(0,10);
            let colSpan=10; // ocupar toda a linha abaixo
            let html = `<td colspan="${colSpan}" style="background:#f8fafc;">
                <div class='simulacao-titulos-multiplo' style='padding:8px;'>
                    <table style='width:100%;border-collapse:collapse;'>
                        <tr>
                            <th style='text-align:center;padding:6px;border-bottom:1px solid #e5e7eb;width:120px;'>Nº Título</th>
                            <th style='text-align:center;padding:6px;border-bottom:1px solid #e5e7eb;width:80px;'>Parcela</th>
                            <th style='text-align:center;padding:6px;border-bottom:1px solid #e5e7eb;width:120px;'>Valor</th>
                            <th style='text-align:center;padding:6px;border-bottom:1px solid #e5e7eb;width:160px;'>Data de Emissão</th>
                            <th style='text-align:center;padding:6px;border-bottom:1px solid #e5e7eb;width:160px;'>Data de Vencimento</th>
                        </tr>`;
            const valor = (typeof valorParcela === 'string') ? valorParcela : Number(valorParcela).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
            for(let i=1;i<=parcelas;i++){
                html += `<tr>
                    <td style='padding:6px;border-bottom:1px solid #f1f5f9;text-align:center;width:120px;'>Simulado-${i}/${parcelas}</td>
                    <td style='padding:6px;border-bottom:1px solid #f1f5f9;text-align:center;width:80px;'>${i}</td>
                    <td style='padding:6px;border-bottom:1px solid #f1f5f9;text-align:center;width:120px;'>R$ ${valor}</td>
                    <td style='padding:6px;border-bottom:1px solid #f1f5f9;text-align:center;width:160px;'><input type='date' class='simulacao-emissao-parcela' style='height:32px;width:150px;' value='${dataHoje}'></td>
                    <td style='padding:6px;border-bottom:1px solid #f1f5f9;text-align:center;width:160px;'><input type='date' class='simulacao-vencimento-parcela' style='height:32px;width:150px;'></td>
                </tr>`;
            }
            html += `</table>`;
            if(parcelas>1){
                html += `<div class='intervalo-vencimento-container' style='display:none; margin-top:8px;'>
                    <label style='font-weight:500;'>Intervalo entre títulos: </label>
                    <select class='intervalo-vencimento-select' style='margin-left:6px; padding:4px 8px; border-radius:6px; border:1px solid #cfd8dc; width:140px !important;'>
                        <option value='' selected disabled>Selecione...</option>
                        <option value='10'>10 dias</option>
                        <option value='20'>20 dias</option>
                        <option value='30'>30 dias</option>
                    </select>
                </div>`;
            }
            html += `</div></td>`;
            trSim.innerHTML = html;
            tbody.insertBefore(trSim, tr.nextElementSibling);

            // Eventos: exibir seletor de intervalo ao definir primeiro vencimento
            const simulacaoDiv = trSim.querySelector('.simulacao-titulos-multiplo');
            const vencInputs = simulacaoDiv.querySelectorAll('.simulacao-vencimento-parcela');
            const emissaoInputs = simulacaoDiv.querySelectorAll('.simulacao-emissao-parcela');
            const intervaloContainer = simulacaoDiv.querySelector('.intervalo-vencimento-container');
            const intervaloSelect = simulacaoDiv.querySelector('.intervalo-vencimento-select');
            if(vencInputs.length>1 && intervaloContainer && intervaloSelect){
                vencInputs[0].addEventListener('change', function(){ intervaloContainer.style.display='block'; });
                intervaloSelect.addEventListener('change', function(){
                    if(!this.value) return; const intervalo=parseInt(this.value); const primeira=vencInputs[0].value; if(!primeira) return;
                    let data=new Date(primeira); for(let i=1;i<vencInputs.length;i++){ data.setDate(data.getDate()+intervalo); vencInputs[i].value=data.toISOString().slice(0,10) }
                });
            }
            if(emissaoInputs.length>1){
                emissaoInputs[0].addEventListener('change', function(){ if(this.value){ for(let i=1;i<emissaoInputs.length;i++){ if(!emissaoInputs[i].value) emissaoInputs[i].value=this.value } } });
            }
        }

        function removerSimulacaoLinha(tr){ const next=tr.nextElementSibling; if(next && next.classList.contains('linha-simulacao-multiplo')) next.remove() }
        function atualizarSimulacaoLinha(tr){ const next=tr.nextElementSibling; if(!(next && next.classList.contains('linha-simulacao-multiplo'))) return; const inputValorParcela=tr.querySelector('.input-valor-parcela'); const parcelas=parseInt(tr.querySelector('.input-parcelas').value)||0; if(parcelas<=0 || !inputValorParcela.value){ next.remove(); return } const valorParcela=inputValorParcela.value; next.remove(); criarLinhaSimulacao(tr, parcelas, valorParcela) }
        function simularTitulosLinha(tr){ let parcelas=parseInt(tr.querySelector('.input-parcelas').value)||0; if(parcelas<=0){ parcelas=1 } let valorParcela=tr.querySelector('.input-valor-parcela').value; if(!valorParcela){ const v=parseFloat(tr.querySelector('input[name="valor_comissao[]"]').value)||0; if(!(v>0)){ alert('Informe o valor da comissão para simular.'); return } valorParcela=(v/parcelas).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2}) } removerSimulacaoLinha(tr); criarLinhaSimulacao(tr, parcelas, valorParcela) }

        function atualizarTipoMultiplo(select, idx){ let td,itemSelect,tipo; if(select.tagName==='SELECT'){ td=select.closest('td'); itemSelect=td.parentElement.querySelector('select[name="item[]"]'); tipo=select.value } else { td=select.parentElement().nextElementSibling; itemSelect=td.querySelector('select[name="item[]"]'); tipo=select.value }
            const inputValor=td.parentElement.querySelector('input[name="valor_venda[]"]'); itemSelect.disabled=true; if(itemSelect.choicesInstance){itemSelect.choicesInstance.destroy(); itemSelect.choicesInstance=null}
            // Ao alterar o tipo, invalida qualquer simulação existente da linha
            try{ const trRow=td.parentElement; removerSimulacaoLinha(trRow) }catch(_){ }
            if(!tipo){ itemSelect.innerHTML='<option value="" disabled selected hidden>Selecione...</option>'; itemSelect.choicesInstance=new Choices(itemSelect,{searchEnabled:true,itemSelectText:''}); return }
            let source = tipo==='produto'? produtos : servicos; const choices = (source||[]).map(it=>({value:String(getItemPrimaryId(it)), label:getItemName(it), customProperties:{valor:getItemPrice(it)}}));
            itemSelect.innerHTML='';
            const placeholderOption=document.createElement('option');
            placeholderOption.value=''; placeholderOption.textContent='Selecione...'; placeholderOption.selected=true; placeholderOption.disabled=true; placeholderOption.hidden=true;
            itemSelect.appendChild(placeholderOption);
            choices.forEach(c=>{ const o=document.createElement('option'); o.value=c.value; o.textContent=c.label; o.dataset.valor=c.customProperties.valor; itemSelect.appendChild(o) });
            itemSelect.disabled=false; itemSelect.value='';
            itemSelect.choicesInstance=new Choices(itemSelect,{searchEnabled:true,itemSelectText:'',placeholder:true,placeholderValue:'Selecione...'});
            itemSelect.addEventListener('change',function(){
                // Alterar o item invalida simulação
                try{ const trRow=td.parentElement; removerSimulacaoLinha(trRow) }catch(_){ }
                const selectedOptions=Array.from(this.selectedOptions).filter(opt=>opt.value); if(selectedOptions.length===1){ const val=parseFloat(selectedOptions[0].dataset.valor||'0'); if(val>0){ inputValor.value=val.toFixed(2); calcularComissaoMultiplo(inputValor, idx) } }
            }) }

        function toggleTipoMultiplo(btn, idx){ const container=btn.parentElement; const buttons=container.querySelectorAll('.btn-tipo'); buttons.forEach(b=>b.classList.remove('active')); btn.classList.add('active'); const tipo=btn.dataset.tipo; container.querySelector('input[name="tipo[]"]').value=tipo; const tr=btn.closest('tr'); atualizarTipoMultiplo({ value: tipo, parentElement: ()=>btn.closest('td'), closest: tr.closest.bind(tr) }, idx) }

        function verificarColaboradorDuplicadoMultiplo(select){ const tr=select.closest('tr'); const selects=tr.querySelectorAll('select[name="colaborador[]"]'); const valores=[...selects].map(s=>s.value).filter(Boolean); const temDup= new Set(valores).size!==valores.length; if(temDup){ alert('Colaborador já selecionado nesta linha.'); select.value=''; if(select.choicesInstance){select.choicesInstance.setChoiceByValue('')} select.dispatchEvent(new Event('change')) } }

        function adicionarLinhaMultiplo(valores=null){ const tbody=document.getElementById('linhasMultiplo'); const idx=tbody.children.length; const tr=document.createElement('tr'); tr.classList.add('linha-lancamento-multiplo'); tr.innerHTML=`
            <td style=\"width:200px;min-width:180px;\"><select name=\"cliente[]\" required class=\"input-cliente\" style=\"width:100%;min-width:180px;\"></select></td>
            <td style=\"width:200px;min-width:180px;\"><select name=\"colaborador[]\" required class=\"input-colaborador\" style=\"width:100%;min-width:180px;\"></select></td>
            <td>
                <div class=\"tipo-toggle-multiplo\" style=\"display:flex;gap:6px;justify-content:center;\">
                    <button type=\"button\" class=\"btn-tipo\" data-tipo=\"produto\" onclick=\"toggleTipoMultiplo(this, ${idx})\"><i class=\"fas fa-box\"></i> Produto</button>
                    <button type=\"button\" class=\"btn-tipo\" data-tipo=\"servico\" onclick=\"toggleTipoMultiplo(this, ${idx})\"><i class=\"fas fa-cogs\"></i> Serviço</button>
                    <input type=\"hidden\" name=\"tipo[]\" value=\"\">
                </div>
            </td>
            <td><select name=\"item[]\" required disabled class=\"input-item\"><option value=\"\" disabled selected hidden>Selecione...</option></select></td>
            <td><input type=\"text\" name=\"descricao[]\" maxlength=\"100\" placeholder=\"Descrição\" class=\"input-descricao\"></td>
            <td><input type=\"number\" name=\"valor_venda[]\" step=\"0.01\" min=\"0\" required placeholder=\"0.00\" class=\"input-valor\" oninput=\"calcularComissaoMultiplo(this, ${idx})\"></td>
            <td><input type=\"text\" name=\"percentual[]\" required placeholder=\"0,00\" inputmode=\"decimal\" class=\"input-percentual\" oninput=\"sanitizarPercentualMultiplo(this)\"></td>
            <td><input type=\"number\" name=\"valor_comissao[]\" step=\"0.01\" min=\"0\" readonly placeholder=\"0.00\" class=\"input-comissao\"></td>
            <td class=\"acao-multiplos\">
                <div class=\"acoes-multiplos-wrapper\" style=\"display:flex;gap:6px;align-items:center;justify-content:center;\">
                    <button type=\"button\" class=\"btn-parcelar btn-secondary\" title=\"Parcelar venda\" style=\"height:32px;\"><i class='fas fa-receipt'></i> Parcelar</button>
                    <div class=\"group-parcelas\" style=\"display:none;gap:6px;align-items:center;\">
                        <label style=\"font-size:0.95em;\"><i class='fas fa-list-ol'></i></label>
                        <input type='number' min='2' class='input-parcelas' style='width:60px;'>
                    </div>
                    <div class=\"group-valor-parcela\" style=\"display:none;\">
                        <input type='text' class='input-valor-parcela' style='width:80px;margin-left:2px;' readonly>
                    </div>
                    <button type=\"button\" class=\"btn-simular btn-secondary\" title=\"Simular títulos\" style=\"height:32px;\">Simular</button>
                </div>
            </td>
            <td class=\"duplicar-excluir-multiplos\" style=\"text-align:center;vertical-align:middle;\">
                <button type=\"button\" class=\"btn-duplicar btn-multiplos-acao\" title=\"Duplicar linha\" onclick=\"duplicarLinhaMultiplo(this)\"><i class=\"fas fa-copy\"></i></button>
                <button type=\"button\" class=\"btn-deletar btn-multiplos-acao\" title=\"Excluir linha\" onclick=\"excluirLinhaMultiplo(this)\"><i class=\"fas fa-trash\"></i></button>
            </td>`;
            tbody.appendChild(tr);
            const selectCliente=tr.querySelector('select[name=\"cliente[]\"]'); preencherSelectClienteMultiplo(selectCliente); selectCliente.addEventListener('change', ()=>{ removerSimulacaoLinha(tr) });
            const selectColaborador=tr.querySelector('select[name=\"colaborador[]\"]'); preencherSelectColaborador(selectColaborador); selectColaborador.addEventListener('change', function(){ verificarColaboradorDuplicadoMultiplo(this); removerSimulacaoLinha(tr) })
            const selectItem=tr.querySelector('select[name=\"item[]\"]'); if(selectItem.choicesInstance){selectItem.choicesInstance.destroy();selectItem.choicesInstance=null} selectItem.choicesInstance=new Choices(selectItem,{searchEnabled:true,itemSelectText:''}); selectItem.addEventListener('change', ()=>{ removerSimulacaoLinha(tr) });
            const grpParcelas=tr.querySelector('.group-parcelas'); const inputParcelas=tr.querySelector('.input-parcelas'); const inputValorComissao=tr.querySelector('input[name=\"valor_comissao[]\"]'); const inputValorParcela=tr.querySelector('.input-valor-parcela'); const grpValorParcela=tr.querySelector('.group-valor-parcela');
            const btnParcelar=tr.querySelector('.btn-parcelar'); btnParcelar.addEventListener('click',()=>{ const isOpen=grpParcelas.style.display==='flex'; if(isOpen){ grpParcelas.style.display='none'; grpValorParcela.style.display='none'; inputParcelas.value=''; inputValorParcela.value=''; removerSimulacaoLinha(tr) } else { grpParcelas.style.display='flex'; grpValorParcela.style.display='block'; inputParcelas.min='2'; inputParcelas.value='2'; atualizarValorParcela() } });
            function atualizarValorParcela(){ let p=parseInt(inputParcelas.value)||0; if(p<2){ p=2; inputParcelas.value='2'; } const v=parseFloat(inputValorComissao.value)||0; inputValorParcela.value=(v>0 && p>0)? (v/p).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2}) : ''; if(document.body.contains(tr.nextElementSibling) && tr.nextElementSibling && tr.nextElementSibling.classList.contains('linha-simulacao-multiplo')){ atualizarSimulacaoLinha(tr) } }
            inputParcelas.addEventListener('input', atualizarValorParcela); inputValorComissao.addEventListener('input', atualizarValorParcela);
            const btnSimular=tr.querySelector('.btn-simular'); btnSimular.addEventListener('click', ()=>{ simularTitulosLinha(tr) });
            // Alterações que impactam a simulação: valor de venda e percentual
            const inputValorVenda=tr.querySelector('input[name=\"valor_venda[]\"]'); inputValorVenda.addEventListener('input', ()=>{ removerSimulacaoLinha(tr) });
            const inputPercentual=tr.querySelector('input[name=\"percentual[]\"]'); inputPercentual.addEventListener('input', ()=>{ removerSimulacaoLinha(tr) });
            if(valores){ if(valores.cliente){selectCliente.value=valores.cliente; if(selectCliente.choicesInstance){selectCliente.choicesInstance.setChoiceByValue(String(valores.cliente))}} if(valores.colaborador){selectColaborador.value=valores.colaborador; if(selectColaborador.choicesInstance){selectColaborador.choicesInstance.setChoiceByValue(String(valores.colaborador))}} if(valores.tipo){ const container=tr.querySelector('.tipo-toggle-multiplo'); const btn=container.querySelector(`.btn-tipo[data-tipo=\'${valores.tipo}\']`); if(btn) btn.click(); } if(valores.item){ selectItem.value=valores.item; if(selectItem.choicesInstance){selectItem.choicesInstance.setChoiceByValue(String(valores.item))}} if(valores.descricao){ tr.querySelector('input[name=\"descricao[]\"]').value=valores.descricao } if(valores.valor_venda){ tr.querySelector('input[name=\"valor_venda[]\"]').value=valores.valor_venda } if(valores.percentual){ tr.querySelector('input[name=\"percentual[]\"]').value=valores.percentual } if(valores.valor_comissao){ tr.querySelector('input[name=\"valor_comissao[]\"]').value=valores.valor_comissao } }
            atualizarResumoMultiplo()
        }

        function duplicarLinhaMultiplo(btn){ const tr=btn.closest('tr'); const valores={ cliente: tr.querySelector('select[name=\"cliente[]\"]').value, colaborador: tr.querySelector('select[name=\"colaborador[]\"]').value, tipo: tr.querySelector('input[name=\"tipo[]\"]').value, item: tr.querySelector('select[name=\"item[]\"]').value, descricao: tr.querySelector('input[name=\"descricao[]\"]').value, valor_venda: tr.querySelector('input[name=\"valor_venda[]\"]').value, percentual: tr.querySelector('input[name=\"percentual[]\"]').value, valor_comissao: tr.querySelector('input[name=\"valor_comissao[]\"]').value }; adicionarLinhaMultiplo(valores) }
        function excluirLinhaMultiplo(btn){ const tr=btn.closest('tr'); const trSim=tr.nextElementSibling; tr.remove(); if(trSim && trSim.classList.contains('linha-simulacao-multiplo')) trSim.remove(); atualizarResumoMultiplo() }
        function limparTodasLinhas(){ document.getElementById('linhasMultiplo').innerHTML=''; atualizarResumoMultiplo() }

        async function salvarComissoesMultiplas(event){ event.preventDefault(); const form=event.target; const linhas=document.querySelectorAll('#linhasMultiplo tr:not(.linha-simulacao-multiplo)'); if(linhas.length===0){ alert('Adicione pelo menos uma linha antes de salvar.'); return }
            let proximoNumeroTitulo=1; try{ const ultimos=await window.api.get('/movimento_comissoes?order=numero_titulo.desc&limit=1'); if(ultimos && ultimos.length>0){ proximoNumeroTitulo=(parseInt(ultimos[0].numero_titulo)||0)+1 } }catch(e){ console.error(e) }
            const listaComissoes=[]; linhas.forEach(tr=>{ const clienteId=tr.querySelector('select[name=\"cliente[]\"]').value; const colaboradorId=tr.querySelector('select[name=\"colaborador[]\"]').value; const tipo=tr.querySelector('input[name=\"tipo[]\"]').value; const itemId=tr.querySelector('select[name=\"item[]\"]').value; const descricao=tr.querySelector('input[name=\"descricao[]\"]').value||null; const valorVenda=parseFloat(tr.querySelector('input[name=\"valor_venda[]\"]').value)||0; const percentualStr=tr.querySelector('input[name=\"percentual[]\"]').value||'0'; const percentual=parseFloat(percentualStr.replace(/\./g,'').replace(',','.'))||0; const valorComissao=parseFloat(tr.querySelector('input[name=\"valor_comissao[]\"]').value)||0; if(!clienteId||!colaboradorId||!tipo||!itemId||!(valorVenda>0)){ return }
                const numeroTitulo=String(proximoNumeroTitulo++).padStart(6,'0');
                listaComissoes.push({ cliente_id: clienteId, colaborador_id: colaboradorId, tipo, item_id: itemId, descricao, valor_venda: valorVenda, percentual_comissao: percentual, valor_comissao: valorComissao, numero_titulo: numeroTitulo }) });
            if(listaComissoes.length===0){ alert('Preencha os dados obrigatórios das linhas.'); return }
            try{ await window.api.post('/movimento_comissoes', listaComissoes); alert('Comissões salvas com sucesso!'); form.reset(); document.getElementById('linhasMultiplo').innerHTML=''; atualizarResumoMultiplo() }catch(e){ console.error(e); alert('Erro ao salvar comissões. Tente novamente.') }
        }

        document.getElementById('formMultiplo').addEventListener('submit', function(e){ if(!validarLinhasAntesDeSalvar()){ e.preventDefault(); return } salvarComissoesMultiplas(e) });

        document.addEventListener('DOMContentLoaded', async function(){ try{ document.getElementById('loader-multi').style.display='flex' }catch(_){}
            try{ window.clientes=await api.get('/clientes'); produtos=await api.get('/produtos'); servicos=await api.get('/servicos') }catch(e){ console.error('Falha ao carregar dados iniciais:', e) }
            adicionarLinhaMultiplo(); atualizarResumoMultiplo(); try{ document.getElementById('loader-multi').style.display='none' }catch(_){ }
        })
    </script>
</body>
</html>
