<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Comissões - Lançar Comissão</title>
    <link rel="icon" type="image/png" href="assets/images/logo2.png">
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="scripts/config/api.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo" style="display: flex; align-items: center; justify-content: center; padding: 15px 0;">
            <img src="assets/images/logo2.png" alt="BlueDev Logo" style="height: 2.5em; margin-right: 10px;">
            <h1><span class="orange">e-</span><span class="highlight">Gerente</span></h1>
        </div>
        <ul class="nav-menu">
            <li><a href="index.html"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-user-plus"></i><span>Cadastros</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="colaboradores.html"><i class="fas fa-users"></i><span>Colaboradores</span></a></li>
                    <li><a href="clientes.html"><i class="fas fa-user-tie"></i><span>Clientes</span></a></li>
                    <li><a href="produtos.html"><i class="fas fa-box"></i><span>Produtos</span></a></li>
                    <li><a href="servicos.html"><i class="fas fa-cogs"></i><span>Serviços</span></a></li>
                    <li><a href="usuarios.html"><i class="fas fa-user-shield"></i><span>Usuários</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-hand-holding-usd"></i><span>Comissões</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="lancar-comissao.html" class="active"><i class="fas fa-plus-circle"></i><span>Lançar</span></a></li>
                    <li><a href="movimento-comissao.html"><i class="fas fa-exchange-alt"></i><span>Movimento</span></a></li>
                    <li><a href="consulta-comissao.html"><i class="fas fa-search"></i><span>Consulta</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-chart-bar"></i><span>Relatórios</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="recebimento.html"><i class="fas fa-money-bill-wave"></i><span>Recebimento</span></a></li>
                    <li><a href="conferencia.html"><i class="fas fa-check-circle"></i><span>Conferência</span></a></li>
                    <li><a href="dinamico.html"><i class="fas fa-chart-line"></i><span>Dinâmico</span><span class="beta-tag">beta</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-cog"></i><span>Configurações</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="manutencao-bd.html"><i class="fas fa-database"></i><span>Manutenção BD</span></a></li>
                    <li><a href="sincronizar.html"><i class="fas fa-sync"></i><span>Sincronizar</span></a></li>
                </ul>
            </li>
        </ul>
        <div class="logout-button">
            <a href="index.html"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="welcome-text">
                <h1>Lançar Comissão</h1>
                <p>Registre novas comissões no sistema</p>
            </div>
            <div class="user-info">
                <div class="notifications">
                    <i class="fas fa-bell"></i>
                    <span class="badge">3</span>
                </div>
                <div class="user-avatar">A</div>
            </div>
        </div>

        <!-- Conteúdo da página -->
        <div class="content">
            <div class="tabs-comissao">
                <button id="tabUnico" class="tab-btn active" onclick="mostrarTabComissao('unico')">Lançamento Comercial</button>
                <button id="tabMultiplo" class="tab-btn" onclick="mostrarTabComissao('multiplo')">Múltiplos Lançamentos</button>
            </div>
            <div id="tabUnicoContent" class="tab-content active">
                <form id="formUnico" class="form-comissao">
                    <div class="form-row">
                        <div class="form-group" style="flex: 1.5;">
                            <label><i class="fas fa-user-tie"></i> Cliente</label>
                            <div class="choices-container-wrapper">
                                <select name="cliente" required></select>
                            </div>
                        </div>
                        <div class="form-group tipo-toggle-group" style="flex: 1;">
                            <label><i class="fas fa-cubes"></i> Tipo</label>
                            <div id="tipo-toggle">
                                <button type="button" class="btn-tipo" data-tipo="produto"><i class="fas fa-box"></i> Produto</button>
                                <button type="button" class="btn-tipo" data-tipo="servico"><i class="fas fa-cogs"></i> Serviço</button>
                            </div>
                            <input type="hidden" name="tipo" value="">
                        </div>
                        <div class="form-group produto-servico" style="flex: 2.5;">
                            <label id="labelItemUnico"><i class="fas fa-cubes"></i> Itens</label>
                            <div class="choices-container-wrapper">
                                <select name="item" multiple required></select>
                            </div>
                        </div>
                        <div class="form-group valor-venda-destaque" style="flex: 1.5;">
                            <label><i class="fas fa-dollar-sign"></i> Valor da Venda</label>
                            <input type="text" name="valor_venda" required class="valor-venda-destaque-input" readonly placeholder="R$ 0,00">
                        </div>
                    </div>
                    <div id="colaboradoresVinculados">
                        <!-- Colaboradores dinâmicos aqui -->
                    </div>
                    <div style="margin-bottom: 18px;">
                        <button type="button" class="btn-primary" onclick="adicionarColaboradorUnico()"><i class="fas fa-user-plus"></i> Adicionar Colaborador</button>
                    </div>
                    <div class="form-actions">
                        <button type="reset" class="btn-secondary"><i class="fas fa-times"></i> Cancelar</button>
                        <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Salvar Comissão</button>
                    </div>
                </form>
            </div>
            <div id="tabMultiploContent" class="tab-content">
                <form id="formMultiplo" class="form-comissao">
                    <div class="table-multiplos">
                        <table>
                            <thead>
                                <tr>
                                    <th>Colaborador</th>
                                    <th>Tipo</th>
                                    <th>Produto/Serviço</th>
                                    <th>Valor Venda</th>
                                    <th>% Comissão</th>
                                    <th>Valor Comissão</th>
                                    <th>Data</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="linhasMultiplo">
                                <!-- Linhas dinâmicas -->
                            </tbody>
                        </table>
                        <button type="button" class="btn-primary" onclick="adicionarLinhaMultiplo()"><i class="fas fa-plus"></i> Adicionar Linha</button>
                        <button type="button" class="btn-secondary" onclick="limparTodasLinhas()" style="margin-left: 10px;"><i class="fas fa-trash-alt"></i> Limpar Todas</button>
                    </div>
                    <div class="resumo-multiplo" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;"><i class="fas fa-chart-bar"></i> Resumo</h4>
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <div>
                                <strong>Total de Linhas:</strong> <span id="totalLinhas">0</span>
                            </div>
                            <div>
                                <strong>Valor Total das Vendas:</strong> <span id="valorTotalVendas">R$ 0,00</span>
                            </div>
                            <div>
                                <strong>Valor Total das Comissões:</strong> <span id="valorTotalComissoes">R$ 0,00</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="reset" class="btn-secondary"><i class="fas fa-times"></i> Cancelar</button>
                        <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Salvar Todos</button>
                    </div>
                </form>
            </div>
        </div>
        <style>
            .tabs-comissao {
                display: flex;
                gap: 8px;
                margin-bottom: 24px;
            }
            .tab-btn {
                background: #f5f5f5;
                color: #333;
                border: 1px solid #ddd;
                border-radius: 6px 6px 0 0;
                padding: 10px 28px;
                font-size: 1.1em;
                font-weight: 500;
                cursor: pointer;
                transition: background 0.2s, color 0.2s;
            }
            .tab-btn.active {
                background: #2196F3;
                color: #fff;
                border-bottom: 2px solid #2196F3;
            }
            .tab-content {
                display: none;
                animation: fadeIn 0.3s;
            }
            .tab-content.active {
                display: block;
            }
            .form-comissao {
                background: #fff;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.07);
                padding: 32px 24px;
                margin-bottom: 32px;
            }
            .form-row {
                display: flex;
                gap: 20px;
                margin-bottom: 20px;
                align-items: flex-start;
            }
            .form-group {
                flex: 1;
            }
            .form-group.tipo-toggle-group {
                min-width: 120px;
                max-width: 150px;
                margin-right: 0;
            }
            .form-group.produto-servico {
                margin-bottom: 18px;
            }
            .form-group label {
                display: block;
                margin-bottom: 8px;
                color: #555;
                font-weight: 500;
            }
            .form-group label i {
                margin-right: 5px;
                color: #2196F3;
            }
            .form-group input,
            .form-group select {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
                transition: border-color 0.3s;
            }
            .form-group input:focus,
            .form-group select:focus {
                border-color: #2196F3;
                outline: none;
                box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
            }
            .form-group input[readonly] {
                background-color: #f5f5f5;
                cursor: not-allowed;
            }
            .form-actions {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                margin-top: 30px;
                padding-top: 20px;
                border-top: 1px solid #eee;
            }
            .btn-primary,
            .btn-secondary {
                padding: 10px 20px;
                border-radius: 4px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: all 0.3s;
            }
            .btn-primary {
                background-color: #2196F3;
                color: white;
                border: none;
            }
            .btn-primary:hover {
                background-color: #1976D2;
            }
            .btn-secondary {
                background-color: #f5f5f5;
                color: #333;
                border: 1px solid #ddd;
            }
            .btn-secondary:hover {
                background-color: #e0e0e0;
            }
            .table-multiplos table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 16px;
            }
            .table-multiplos th, .table-multiplos td {
                border: 1px solid #eee;
                padding: 8px 6px;
                text-align: center;
            }
            .table-multiplos th {
                background: #f5f5f5;
                color: #333;
                font-weight: 600;
            }
            .table-multiplos td {
                background: #fff;
            }
            .table-multiplos .btn-primary {
                margin-top: 8px;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            #colaboradoresVinculados {
                display: flex;
                flex-direction: column;
                gap: 16px;
            }
            .colaborador-bloco {
                position: relative;
                padding-top: 18px;
                padding-right: 44px;
                padding-left: 22px;
                padding-bottom: 18px;
                margin-bottom: 22px;
                border: 2.5px solid #90caf9;
                border-radius: 12px;
                background: #f7fbff;
                box-shadow: 0 2px 10px rgba(33,150,243,0.06);
                transition: border 0.2s, box-shadow 0.2s, background 0.2s;
            }
            .btn-excluir-bloco {
                position: absolute;
                top: 10px;
                right: 14px;
                background: #fff;
                border: 2px solid #e53935;
                color: #e53935;
                border-radius: 50%;
                width: 26px;
                height: 26px;
                font-size: 1.05em;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(229,57,53,0.07);
                transition: background 0.18s, border 0.18s, color 0.18s, box-shadow 0.18s;
                z-index: 2;
            }
            .btn-excluir-bloco:hover {
                background: #ffebee;
                border-color: #b71c1c;
                color: #b71c1c;
                box-shadow: 0 4px 16px rgba(229,57,53,0.13);
            }
            .colaborador-bloco .form-row {
                margin-bottom: 0;
                gap: 20px;
                align-items: flex-end;
            }
            .colaborador-bloco .form-group {
                min-width: 160px;
                flex: 1;
            }
            .colaborador-bloco .form-group .btn-secondary {
                background-color: #dc3545;
                color: #fff;
                border: none;
                padding: 6px 10px;
                border-radius: 4px;
                font-size: 14px;
                min-width: unset;
                width: 28px;
                height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background 0.2s;
            }
            .colaborador-bloco .form-group .btn-secondary:hover {
                background-color: #b71c1c;
            }
            .colaborador-bloco .form-group .btn-secondary i {
                font-size: 14px;
            }
            .form-group.valor-venda-destaque input {
                background: #e3f2fd;
                border: 2px solid #2196F3;
                font-weight: 600;
                color: #1565c0;
                box-shadow: 0 2px 8px rgba(33,150,243,0.07);
                font-size: 1.15em;
            }
            .btn-parcelado {
                background: #fffbe6;
                border: 1.5px solid #fbc02d;
                color: #b8860b;
                font-weight: 600;
                border-radius: 16px;
                padding: 3px 10px;
                margin-top: 24px;
                margin-left: 4px;
                cursor: pointer;
                font-size: 0.92em;
                transition: background 0.2s, border 0.2s, box-shadow 0.2s;
                box-shadow: 0 1px 4px rgba(251,192,45,0.08);
            }
            .btn-parcelado.active {
                background: #ffe082;
                border-color: #fbc02d;
                box-shadow: 0 2px 8px rgba(251,192,45,0.18);
            }
            .btn-parcelado:hover {
                background: #fff8e1;
                border-color: #ffd54f;
            }
            .btn-simular {
                background: #e3f2fd;
                border: 1.5px solid #2196F3;
                color: #1565c0;
                font-weight: 600;
                border-radius: 16px;
                padding: 3px 12px;
                margin-top: 24px;
                margin-left: 4px;
                cursor: pointer;
                font-size: 0.92em;
                transition: background 0.2s, border 0.2s, box-shadow 0.2s;
                box-shadow: 0 1px 4px rgba(33,150,243,0.08);
            }
            .btn-simular:hover {
                background: #bbdefb;
                border-color: #1976d2;
            }
            .simulacao-titulos {
                margin-top: 10px;
                background: #f5f5f5;
                border-radius: 8px;
                padding: 10px 16px;
                border: 1px solid #e0e0e0;
                font-size: 0.98em;
            }
            .simulacao-titulos table {
                width: 100%;
                border-collapse: collapse;
            }
            .simulacao-titulos th, .simulacao-titulos td {
                padding: 4px 8px;
                text-align: left;
            }
            .simulacao-titulos th {
                background: #e3f2fd;
                color: #1565c0;
                font-weight: 700;
            }
            .simulacao-titulos tr:nth-child(even) {
                background: #fafafa;
            }
            .group-parcelas, .group-valor-parcela {
                min-width: 120px;
                margin-left: 4px;
            }
            .valor-venda-destaque-input {
                background: #fffde7;
                border: 3px solid #fbc02d;
                font-weight: 800;
                color: #b8860b;
                box-shadow: 0 4px 16px rgba(251,192,45,0.18);
                font-size: 1.35em;
                padding: 12px 18px;
                border-radius: 8px;
                outline: none;
                transition: box-shadow 0.2s, border 0.2s;
            }
            .valor-venda-destaque-input:focus {
                box-shadow: 0 6px 24px rgba(251,192,45,0.28);
                border-color: #ffb300;
            }
            .simulacao-titulos input[type='date'] {
                border: 1.5px solid #90caf9;
                border-radius: 8px;
                background: #f7fbff;
                padding: 5px 32px 5px 10px;
                font-size: 1em;
                color: #1565c0;
                transition: box-shadow 0.18s, border 0.18s;
                box-shadow: 0 1px 4px rgba(33,150,243,0.07);
                min-width: 160px;
                width: 160px;
                box-sizing: border-box;
            }
            .simulacao-titulos input[type='date']:focus {
                border-color: #1976d2;
                box-shadow: 0 2px 8px rgba(33,150,243,0.18);
                outline: none;
            }
            .btn-tipo {
                padding: 6px 10px;
                font-size: 0.88em;
                font-weight: 500;
                gap: 5px;
                border-radius: 6px;
                border: 1.5px solid #e0e0e0;
                background: #f9f9f9;
                transition: all 0.2s ease-in-out;
            }
            .btn-tipo.active {
                background-color: #2196F3;
                border-color: #2196F3;
                color: #fff;
                box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
            }
            .form-group.produto-servico {
                margin-bottom: 18px;
            }
            #labelItemUnico {
                font-size: 1.08em;
                font-weight: 600;
                color: #1976D2;
                margin-bottom: 6px;
                display: flex;
                align-items: center;
                gap: 6px;
            }
            select option[value=""] {
                color: #757575;
            }
            .choices__inner {
                min-height: 44px !important;
                border-radius: 8px !important;
                background: #fff !important;
                border: 2px solid #2196F3 !important;
                box-shadow: 0 2px 8px rgba(33,150,243,0.07) !important;
                font-size: 1em !important;
                padding: 7px 12px !important;
            }
            #tipo-toggle {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }
            .valor-venda-destaque {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 12px;
                text-align: center;
                height: 100%;
                box-sizing: border-box;
            }
            .valor-venda-destaque .valor-venda-destaque-input {
                font-size: 1.9em;
                font-weight: 700;
                color: #1565c0;
                text-align: center;
                background: transparent;
                border: none;
                padding: 10px 0 0 0;
                height: auto;
                box-shadow: none;
                pointer-events: none;
            }
            /* Botão duplicar azul */
            .btn-duplicar {
                background-color: #2196F3;
                color: #fff;
                border: none;
                margin-right: 4px;
            }
            .btn-duplicar:hover {
                background-color: #1976D2;
            }
            /* Botão deletar vermelho */
            .btn-deletar {
                background-color: #e53935;
                color: #fff;
                border: none;
            }
            .btn-deletar:hover {
                background-color: #b71c1c;
            }
        </style>
        <script>
            let produtos = [];
            let servicos = [];
            let choicesItem = null;

            const selectItem = document.querySelector('div.choices-container-wrapper > select[name="item"]');
            const tipoInput = document.querySelector('#formUnico input[name="tipo"]');

            function mostrarTabComissao(tab) {
                // Remover classe active de todas as abas
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                if (tab === 'unico') {
                    document.getElementById('tabUnico').classList.add('active');
                    document.getElementById('tabUnicoContent').classList.add('active');
                } else if (tab === 'multiplo') {
                    document.getElementById('tabMultiplo').classList.add('active');
                    document.getElementById('tabMultiploContent').classList.add('active');
                    
                    // Adicionar uma linha inicial se não houver nenhuma
                    const tbody = document.getElementById('linhasMultiplo');
                    if (tbody.children.length === 0) {
                        adicionarLinhaMultiplo();
                    }
                }
            }

            function preencherItens(tipo) {
                choicesItem.enable();
                let lista = tipo === 'produto' ? produtos : servicos;
                const choices = lista.map(item => ({
                    value: item.codigo,
                    label: `${item.codigo.padStart(5, '0')} - ${item.nome}`,
                    customProperties: { preco: item.preco || 0 }
                }));
                choicesItem.setChoices(choices, 'value', 'label', true);
            }
            
            function atualizarTipoUnico() {
                const tipo = tipoInput.value;
                const label = document.getElementById('labelItemUnico');
                label.innerHTML = tipo === 'produto' ? '<i class="fas fa-box"></i> Produtos' : '<i class="fas fa-cogs"></i> Serviços';
            }

            function atualizarValorVendaPorItens() {
                let soma = 0;
                const valoresSelecionados = choicesItem.getValue(true);
                const todosItens = [...produtos, ...servicos];
                
                valoresSelecionados.forEach(val => {
                    const item = todosItens.find(i => i.codigo === val);
                    if (item) {
                        soma += Number(item.preco) || 0;
                    }
                });

                const campoValorVenda = document.querySelector('#formUnico input[name="valor_venda"]');
                campoValorVenda.value = formatarMoedaBR(soma);
                campoValorVenda.dispatchEvent(new Event('input'));
            }

            function calcularComissaoUnico() {
                const form = document.getElementById('formUnico');
                const valorVenda = parseFloat(form.valor_venda.value) || 0;
                const percentual = parseFloat(form.percentual.value) || 0;
                form.valor_comissao.value = (valorVenda * percentual / 100).toFixed(2);
            }

            // Variável global para armazenar colaboradores
            let colaboradoresCache = null;
            let colaboradoresCarregando = false;
            let colaboradoresCallbacks = [];

            // Função para buscar colaboradores uma única vez
            async function buscarColaboradores() {
                if (colaboradoresCache) return colaboradoresCache;
                if (colaboradoresCarregando) {
                    // Se já está carregando, retorna uma Promise que resolve quando terminar
                    return new Promise(resolve => colaboradoresCallbacks.push(resolve));
                }
                colaboradoresCarregando = true;
                try {
                    colaboradoresCache = await api.get('/colaboradores');
                    colaboradoresCallbacks.forEach(cb => cb(colaboradoresCache));
                    colaboradoresCallbacks = [];
                    return colaboradoresCache;
                } catch (error) {
                    colaboradoresCache = [];
                    colaboradoresCallbacks.forEach(cb => cb(colaboradoresCache));
                    colaboradoresCallbacks = [];
                    return [];
                } finally {
                    colaboradoresCarregando = false;
                }
            }

            // Função para preencher o select de colaborador (layout fixo, carrega opções depois)
            function preencherSelectColaborador(selectElement) {
                // Destroi Choices anterior se existir
                if (selectElement.choicesInstance) {
                    selectElement.choicesInstance.destroy();
                    selectElement.choicesInstance = null;
                }
                // Layout fixo imediato
                selectElement.innerHTML = '<option value="">Selecione um colaborador...</option>';
                // Aplica Choices.js imediatamente e guarda a instância
                selectElement.choicesInstance = new Choices(selectElement, {
                    searchEnabled: true,
                    itemSelectText: '',
                    placeholder: true,
                    placeholderValue: 'Selecione um colaborador...'
                });
                // Carrega opções em background
                buscarColaboradores().then(colaboradores => {
                    // Destroi Choices anterior antes de atualizar opções
                    if (selectElement.choicesInstance) {
                        selectElement.choicesInstance.destroy();
                        selectElement.choicesInstance = null;
                    }
                    // Remove todas as opções exceto o placeholder
                    selectElement.innerHTML = '<option value="">Selecione um colaborador...</option>';
                    colaboradores.forEach(colaborador => {
                        const option = document.createElement('option');
                        option.value = colaborador.codigo;
                        option.textContent = `${colaborador.codigo} - ${colaborador.nome}`;
                        selectElement.appendChild(option);
                    });
                    // Reaplica Choices.js para atualizar as opções e guarda a instância
                    selectElement.choicesInstance = new Choices(selectElement, {
                        searchEnabled: true,
                        itemSelectText: '',
                        placeholder: true,
                        placeholderValue: 'Selecione um colaborador...'
                    });
                });
            }

            function adicionarLinhaMultiplo() {
                const tbody = document.getElementById('linhasMultiplo');
                const idx = tbody.children.length;
                const dataAtual = new Date().toISOString().split('T')[0];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><select name="colaborador[]" required></select></td>
                    <td><select name="tipo[]" required onchange="atualizarTipoMultiplo(this, ${idx})"><option value="">Selecione...</option><option value="produto">Produto</option><option value="servico">Serviço</option></select></td>
                    <td><select name="item[]" required disabled><option value="">Selecione o tipo primeiro</option></select></td>
                    <td><input type="number" name="valor_venda[]" step="0.01" min="0" required placeholder="0.00" oninput="calcularComissaoMultiplo(this, ${idx})"></td>
                    <td><input type="number" name="percentual[]" step="0.01" min="0" max="100" required oninput="calcularComissaoMultiplo(this, ${idx})" placeholder="0.00"></td>
                    <td><input type="number" name="valor_comissao[]" step="0.01" min="0" readonly placeholder="0.00"></td>
                    <td><input type="date" name="data[]" required value="${dataAtual}"></td>
                    <td>
                        <button type="button" class="btn-duplicar" onclick="duplicarLinhaMultiplo(this)" title="Duplicar linha"><i class="fas fa-copy"></i></button>
                        <button type="button" class="btn-deletar" onclick="removerLinhaMultiplo(this)" title="Remover linha"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
                // Preencher colaborador (layout fixo, carrega opções depois)
                const selectColaborador = tr.querySelector('select[name="colaborador[]"]');
                preencherSelectColaborador(selectColaborador);
                atualizarResumoMultiplo();
            }

            function duplicarLinhaMultiplo(btn) {
                const linhaOriginal = btn.closest('tr');
                const tbody = document.getElementById('linhasMultiplo');
                const idx = tbody.children.length;
                const dataAtual = new Date().toISOString().split('T')[0];
                const novaLinha = linhaOriginal.cloneNode(true);
                novaLinha.querySelector('select[name="item[]"]').value = '';
                novaLinha.querySelector('input[name="valor_venda[]"]').value = '';
                novaLinha.querySelector('input[name="percentual[]"]').value = '';
                novaLinha.querySelector('input[name="valor_comissao[]"]').value = '';
                novaLinha.querySelector('input[name="data[]"]').value = dataAtual;
                novaLinha.querySelector('select[name="tipo[]"]').onchange = function() { atualizarTipoMultiplo(this, idx); };
                novaLinha.querySelector('input[name="valor_venda[]"]').oninput = function() { calcularComissaoMultiplo(this, idx); };
                novaLinha.querySelector('input[name="percentual[]"]').oninput = function() { calcularComissaoMultiplo(this, idx); };
                novaLinha.querySelector('button[title="Duplicar linha"]').className = 'btn-duplicar';
                novaLinha.querySelector('button[title="Duplicar linha"]').onclick = function() { duplicarLinhaMultiplo(this); };
                novaLinha.querySelector('button[title="Remover linha"]').className = 'btn-deletar';
                novaLinha.querySelector('button[title="Remover linha"]').onclick = function() { removerLinhaMultiplo(this); };
                tbody.appendChild(novaLinha);
                // Preencher colaborador (layout fixo, carrega opções depois)
                const selectColaborador = novaLinha.querySelector('select[name="colaborador[]"]');
                preencherSelectColaborador(selectColaborador);
                atualizarResumoMultiplo();
            }

            function atualizarTipoMultiplo(select, idx) {
                const td = select.parentElement.nextElementSibling;
                const itemSelect = td.querySelector('select[name="item[]"]');
                const tipo = select.value;
                
                // Limpar e desabilitar o select de itens
                itemSelect.innerHTML = '<option value="">Carregando...</option>';
                itemSelect.disabled = true;
                
                if (!tipo) {
                    itemSelect.innerHTML = '<option value="">Selecione o tipo primeiro</option>';
                    return;
                }
                
                // Carregar produtos ou serviços baseado no tipo selecionado
                let lista = tipo === 'produto' ? produtos : servicos;
                
                if (lista && lista.length > 0) {
                    itemSelect.innerHTML = '<option value="">Selecione um ' + (tipo === 'produto' ? 'produto' : 'serviço') + '...</option>';
                    lista.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.codigo;
                        option.textContent = `${item.codigo.padStart(5, '0')} - ${item.nome}`;
                        option.setAttribute('data-preco', item.preco || 0);
                        itemSelect.appendChild(option);
                    });
                    
                    // Habilitar o select de itens
                    itemSelect.disabled = false;
                    
                    // Aplicar Choices.js no select de itens
                    new Choices(itemSelect, {
                        searchEnabled: true,
                        itemSelectText: '',
                        placeholder: true,
                        placeholderValue: 'Selecione um ' + (tipo === 'produto' ? 'produto' : 'serviço') + '...'
                    });
                    
                    // Adicionar evento para atualizar valor da venda quando item for selecionado
                    itemSelect.addEventListener('change', function() {
                        const selectedOption = this.options[this.selectedIndex];
                        if (selectedOption && selectedOption.value) {
                            const preco = parseFloat(selectedOption.getAttribute('data-preco')) || 0;
                            const valorVendaInput = select.closest('tr').querySelector('input[name="valor_venda[]"]');
                            valorVendaInput.value = preco.toFixed(2);
                            // Recalcular comissão se houver percentual
                            const percentualInput = select.closest('tr').querySelector('input[name="percentual[]"]');
                            if (percentualInput.value) {
                                calcularComissaoMultiplo(percentualInput, idx);
                            }
                        }
                    });
                } else {
                    itemSelect.innerHTML = '<option value="">Nenhum ' + (tipo === 'produto' ? 'produto' : 'serviço') + ' encontrado</option>';
                }
            }

            function calcularComissaoMultiplo(input, idx) {
                const tr = input.closest('tr');
                const valorVenda = parseFloat(tr.querySelector('input[name="valor_venda[]"]').value) || 0;
                const percentual = parseFloat(tr.querySelector('input[name="percentual[]"]').value) || 0;
                const valorComissaoInput = tr.querySelector('input[name="valor_comissao[]"]');
                
                const valorComissao = (valorVenda * percentual / 100);
                valorComissaoInput.value = valorComissao.toFixed(2);
                
                // Atualizar resumo
                atualizarResumoMultiplo();
            }
            
            function atualizarResumoMultiplo() {
                const linhas = document.querySelectorAll('#linhasMultiplo tr');
                let totalVendas = 0;
                let totalComissoes = 0;
                
                linhas.forEach(linha => {
                    const valorVenda = parseFloat(linha.querySelector('input[name="valor_venda[]"]').value) || 0;
                    const valorComissao = parseFloat(linha.querySelector('input[name="valor_comissao[]"]').value) || 0;
                    
                    totalVendas += valorVenda;
                    totalComissoes += valorComissao;
                });
                
                document.getElementById('totalLinhas').textContent = linhas.length;
                document.getElementById('valorTotalVendas').textContent = formatarMoedaBR(totalVendas);
                document.getElementById('valorTotalComissoes').textContent = formatarMoedaBR(totalComissoes);
            }

            let numeroTituloPai = 1;
            
            function adicionarColaboradorUnico() {
                const container = document.getElementById('colaboradoresVinculados');
                let blocoCount = container.querySelectorAll('.colaborador-bloco').length;
                blocoCount++;
                const div = document.createElement('div');
                div.className = 'colaborador-bloco';
                div.setAttribute('data-numero-pai', numeroTituloPai.toString().padStart(5, '0'));
                numeroTituloPai++;
                div.innerHTML = `
                    <button type="button" class="btn-excluir-bloco" title="Remover colaborador" onclick="this.closest('.colaborador-bloco').remove()"><i class="fas fa-times"></i></button>
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-user"></i> Colaborador</label>
                            <select name="colaborador[]" required></select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-align-left"></i> Descrição</label>
                            <input type="text" name="descricao_colaborador[]" maxlength="100" placeholder="Observação ou função...">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-percent"></i> % Comissão</label>
                            <input type="number" name="percentual[]" step="0.01" min="0" max="100" required oninput="calcularValorReceberUnico(this)">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-coins"></i> Valor a Receber</label>
                            <input type="number" name="valor_receber[]" step="0.01" min="0" readonly>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn-parcelado" onclick="toggleParcelado(this)">Parcelado</button>
                            <button type="button" class="btn-simular" onclick="simularTitulos(this)">Simular</button>
                        </div>
                        <div class="form-group group-parcelas" style="display:none;">
                            <label><i class="fas fa-list-ol"></i> Qtd. Parcelas</label>
                            <input type="number" name="qtd_parcelas[]" min="2" step="1" oninput="atualizaValorParcela(this)">
                        </div>
                        <div class="form-group group-valor-parcela" style="display:none;">
                            <label><i class="fas fa-money-bill-wave"></i> Valor da Parcela</label>
                            <input type="text" name="valor_parcela[]" readonly>
                        </div>
                    </div>
                    <div class="simulacao-titulos" style="display:none;">
                        <div class="simulacao-tabela"></div>
                    </div>
                `;
                container.appendChild(div);
                
                // Carregar colaboradores no select recém-criado
                const selectColaborador = div.querySelector('select[name="colaborador[]"]');
                preencherSelectColaborador(selectColaborador);
            }

            function extrairNumeroBR(valor) {
                if (!valor) return 0;
                return Number(valor.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
            }

            function calcularValorReceberUnico(input) {
                const bloco = input.closest('.colaborador-bloco');
                const percentual = parseFloat(input.value) || 0;
                const form = document.getElementById('formUnico');
                const campoValorVenda = form.querySelector('input[name="valor_venda"]');
                const valorVenda = extrairNumeroBR(campoValorVenda.value);
                const valorReceber = bloco.querySelector('input[name="valor_receber[]"]');
                valorReceber.value = (valorVenda * percentual / 100).toFixed(2);
            }

            function toggleParcelado(btn) {
                const row = btn.closest('.form-row');
                const groupParcelas = row.querySelector('.group-parcelas');
                const groupValorParcela = row.querySelector('.group-valor-parcela');
                if (groupParcelas.style.display === 'none') {
                    groupParcelas.style.display = '';
                    groupValorParcela.style.display = '';
                    btn.classList.add('active');
                } else {
                    groupParcelas.style.display = 'none';
                    groupValorParcela.style.display = 'none';
                    btn.classList.remove('active');
                    row.querySelector('input[name="qtd_parcelas[]"]').value = '';
                    row.querySelector('input[name="valor_parcela[]"]').value = '';
                }
            }

            function atualizaValorParcela(input) {
                const row = input.closest('.form-row');
                const qtd = parseInt(input.value);
                const valorReceber = parseFloat(row.querySelector('input[name="valor_receber[]"]').value.replace(',','.'));
                const valorParcelaInput = row.querySelector('input[name="valor_parcela[]"]');
                if (qtd > 1 && valorReceber > 0) {
                    const valorParcela = valorReceber / qtd;
                    valorParcelaInput.value = valorParcela.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                } else {
                    valorParcelaInput.value = '';
                }
            }

            function simularTitulos(btn) {
                const row = btn.closest('.form-row');
                const bloco = btn.closest('.colaborador-bloco');
                const numeroPai = bloco.getAttribute('data-numero-pai') || '00001';
                const qtdInput = row.querySelector('input[name="qtd_parcelas[]"]');
                const valorReceberInput = row.querySelector('input[name="valor_receber[]"]');
                const simulacaoDiv = row.parentElement.querySelector('.simulacao-titulos');
                const simulacaoTabela = simulacaoDiv.querySelector('.simulacao-tabela');
                let qtd = 1;
                if (qtdInput && qtdInput.closest('.group-parcelas') && qtdInput.closest('.group-parcelas').style.display !== 'none' && qtdInput.value && parseInt(qtdInput.value) > 1) {
                    qtd = parseInt(qtdInput.value);
                }
                const valorReceber = parseFloat(valorReceberInput.value.replace(',','.'));
                if (!valorReceber || valorReceber <= 0) {
                    simulacaoDiv.style.display = 'block';
                    simulacaoTabela.innerHTML = '<span style="color:#b71c1c;">Informe o valor a receber.</span>';
                    return;
                }
                if (qtd < 1) qtd = 1;
                let html = `<table><tr><th>Nº Título</th><th>Parcela</th><th>Valor</th><th>Data de Emissão</th><th>Data de Vencimento</th></tr>`;
                const valorParcela = valorReceber / qtd;
                const hoje = new Date();
                const dataHoje = hoje.toISOString().slice(0,10);
                for (let i = 1; i <= qtd; i++) {
                    html += `<tr><td>${numeroPai}-${i}/${qtd}</td><td>${i}</td><td>R$ ${valorParcela.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td><td><input type='date' class='simulacao-emissao-parcela' style='width:160px;' value='${dataHoje}'></td><td><input type='date' class='simulacao-vencimento-parcela' style='width:160px;'></td></tr>`;
                }
                html += '</table>';
                if (qtd > 1) {
                    html += `<div class='intervalo-vencimento-container' style='display:none; margin-top:8px;'><label style='font-weight:500;'>Intervalo entre títulos: </label> <select class='intervalo-vencimento-select' style='margin-left:6px; padding:2px 8px; border-radius:6px; border:1px solid #bbb;'><option value='' selected disabled>Selecione...</option><option value='10'>10 dias</option><option value='20'>20 dias</option><option value='30'>30 dias</option></select></div>`;
                }
                simulacaoDiv.style.display = 'block';
                simulacaoTabela.innerHTML = html;

                const vencInputs = simulacaoTabela.querySelectorAll('.simulacao-vencimento-parcela');
                const intervaloContainer = simulacaoTabela.parentElement.querySelector('.intervalo-vencimento-container');
                const intervaloSelect = simulacaoTabela.parentElement.querySelector('.intervalo-vencimento-select');
                if (vencInputs.length > 1) {
                    vencInputs[0].addEventListener('change', function() {
                        intervaloContainer.style.display = 'inline-block';
                    });
                    intervaloSelect.addEventListener('change', function() {
                        if (!this.value) return;
                        const intervalo = parseInt(this.value);
                        const primeiraData = vencInputs[0].value;
                        if (primeiraData) {
                            let data = new Date(primeiraData);
                            for (let i = 1; i < vencInputs.length; i++) {
                                data.setDate(data.getDate() + intervalo);
                                vencInputs[i].value = data.toISOString().slice(0,10);
                            }
                        }
                    });
                }

                const emissaoInputs = simulacaoTabela.querySelectorAll('.simulacao-emissao-parcela');
                if (emissaoInputs.length > 1) {
                    emissaoInputs[0].addEventListener('change', function() {
                        if (this.value) {
                            for (let i = 1; i < emissaoInputs.length; i++) {
                                if (!emissaoInputs[i].value) emissaoInputs[i].value = this.value;
                            }
                        }
                    });
                }
            }

            document.getElementById('formUnico').valor_venda.oninput = function() {
                document.querySelectorAll('.colaborador-bloco input[name="percentual[]"]').forEach(input => {
                    calcularValorReceberUnico(input);
                });
            };

            document.addEventListener('DOMContentLoaded', async function() {
                choicesItem = new Choices(selectItem, {
                    removeItemButton: true,
                    placeholder: true,
                    placeholderValue: 'Selecione um tipo primeiro',
                    searchEnabled: true,
                    itemSelectText: '',
                });
                choicesItem.disable();

                selectItem.addEventListener('change', atualizarValorVendaPorItens);

                let clientes = [];
                try {
                    clientes = await api.get('/clientes');
                    const selectCliente = document.querySelector('div.choices-container-wrapper > select[name="cliente"]');
                    selectCliente.innerHTML = '<option value="">Selecione um cliente...</option>';
                    clientes.forEach(cliente => {
                        const option = document.createElement('option');
                        option.value = cliente.codigo;
                        option.textContent = (cliente.codigo_crm ? cliente.codigo_crm + ' - ' : '') + cliente.nome;
                        selectCliente.appendChild(option);
                    });

                    new Choices(selectCliente, {
                        searchEnabled: true,
                        itemSelectText: '',
                        placeholder: true,
                        placeholderValue: 'Selecione um cliente...'
                    });

                    produtos = await api.get('/produtos');
                    servicos = await api.get('/servicos');
                    
                    const tipoToggle = document.getElementById('tipo-toggle');
                    tipoToggle.querySelectorAll('.btn-tipo').forEach(btn => {
                        btn.addEventListener('click', function() {
                            tipoToggle.querySelectorAll('.btn-tipo').forEach(b => b.classList.remove('active'));
                            this.classList.add('active');
                            tipoInput.value = this.dataset.tipo;
                            atualizarTipoUnico();
                            preencherItens(this.dataset.tipo);
                        });
                    });
                    
                } catch (e) {
                    console.error('Erro ao carregar dados:', e);
                    choicesItem.setChoices([{ value: '', label: 'Erro ao carregar', disabled: true }]);
                }
            });

            function formatarMoedaBR(valor) {
                return Number(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }

            let timeoutFormatMoeda = null;
            const campoValorVenda = document.querySelector('#formUnico input[name="valor_venda"]');
            campoValorVenda.addEventListener('input', function(e) {
                clearTimeout(timeoutFormatMoeda);
                let valor = this.value.replace(/[^\d,]/g, '').replace(',', '.');
                if (valor) {
                    valor = parseFloat(valor);
                    if (!isNaN(valor)) {
                        timeoutFormatMoeda = setTimeout(() => {
                            this.value = formatarMoedaBR(valor);
                        }, 400);
                    }
                }
                document.querySelectorAll('.colaborador-bloco input[name="percentual[]"]').forEach(input => {
                    calcularValorReceberUnico(input);
                });
            });

            const formUnico = document.getElementById('formUnico');
            // Removido o evento anterior que apenas formatava o valor
            // Agora o evento de submit está na função salvarComissaoUnica
            
            // Função para salvar comissão única
            async function salvarComissaoUnica(event) {
                event.preventDefault();
                
                const form = event.target;
                const formData = new FormData(form);
                
                // Formatar valor da venda antes de salvar
                const campoValorVenda = form.querySelector('input[name="valor_venda"]');
                campoValorVenda.value = campoValorVenda.value.replace(/[^\d,]/g, '').replace(',', '.');
                
                // Validar se há pelo menos um colaborador
                const colaboradores = document.querySelectorAll('.colaborador-bloco');
                if (colaboradores.length === 0) {
                    alert('Adicione pelo menos um colaborador antes de salvar.');
                    return;
                }
                
                // Coletar dados dos colaboradores
                const dadosColaboradores = [];
                colaboradores.forEach((bloco, index) => {
                    const colaboradorSelect = bloco.querySelector('select[name="colaborador[]"]');
                    const descricaoInput = bloco.querySelector('input[name="descricao_colaborador[]"]');
                    const percentualInput = bloco.querySelector('input[name="percentual[]"]');
                    const valorReceberInput = bloco.querySelector('input[name="valor_receber[]"]');
                    
                    if (colaboradorSelect.value && percentualInput.value) {
                        dadosColaboradores.push({
                            colaborador: colaboradorSelect.value,
                            descricao: descricaoInput.value || '',
                            percentual: parseFloat(percentualInput.value),
                            valor_receber: parseFloat(valorReceberInput.value)
                        });
                    }
                });
                
                if (dadosColaboradores.length === 0) {
                    alert('Preencha os dados de pelo menos um colaborador.');
                    return;
                }
                
                // Preparar dados para envio
                const dadosComissao = {
                    cliente: formData.get('cliente'),
                    tipo: formData.get('tipo'),
                    itens: formData.getAll('item'),
                    valor_venda: parseFloat(formData.get('valor_venda').replace(/[^\d,]/g, '').replace(',', '.')),
                    colaboradores: dadosColaboradores,
                    data_lancamento: new Date().toISOString().split('T')[0]
                };
                
                try {
                    // Aqui você faria a chamada para a API para salvar a comissão
                    console.log('Dados da comissão para salvar:', dadosComissao);
                    
                    // Simular salvamento (substitua pela chamada real da API)
                    // await api.post('/comissoes', dadosComissao);
                    
                    alert('Comissão salva com sucesso!');
                    form.reset();
                    
                    // Limpar colaboradores adicionados
                    document.getElementById('colaboradoresVinculados').innerHTML = '';
                    numeroTituloPai = 1;
                    
                } catch (error) {
                    console.error('Erro ao salvar comissão:', error);
                    alert('Erro ao salvar comissão. Tente novamente.');
                }
            }
            
            // Adicionar evento de submit ao formulário único
            document.getElementById('formUnico').addEventListener('submit', salvarComissaoUnica);
            
            // Função para salvar comissões múltiplas
            async function salvarComissoesMultiplas(event) {
                event.preventDefault();
                
                const form = event.target;
                const formData = new FormData(form);
                
                // Coletar dados das linhas
                const linhas = document.querySelectorAll('#linhasMultiplo tr');
                if (linhas.length === 0) {
                    alert('Adicione pelo menos uma linha antes de salvar.');
                    return;
                }
                
                const dadosComissoes = [];
                let dadosValidos = true;
                
                linhas.forEach((linha, index) => {
                    const colaboradorSelect = linha.querySelector('select[name="colaborador[]"]');
                    const tipoSelect = linha.querySelector('select[name="tipo[]"]');
                    const itemSelect = linha.querySelector('select[name="item[]"]');
                    const valorVendaInput = linha.querySelector('input[name="valor_venda[]"]');
                    const percentualInput = linha.querySelector('input[name="percentual[]"]');
                    const valorComissaoInput = linha.querySelector('input[name="valor_comissao[]"]');
                    const dataInput = linha.querySelector('input[name="data[]"]');
                    
                    if (!colaboradorSelect.value || !tipoSelect.value || !itemSelect.value || 
                        !valorVendaInput.value || !percentualInput.value || !dataInput.value) {
                        alert(`Preencha todos os campos da linha ${index + 1}.`);
                        dadosValidos = false;
                        return;
                    }
                    
                    dadosComissoes.push({
                        colaborador: colaboradorSelect.value,
                        tipo: tipoSelect.value,
                        item: itemSelect.value,
                        valor_venda: parseFloat(valorVendaInput.value),
                        percentual: parseFloat(percentualInput.value),
                        valor_comissao: parseFloat(valorComissaoInput.value),
                        data: dataInput.value
                    });
                });
                
                if (!dadosValidos) return;
                
                try {
                    // Aqui você faria a chamada para a API para salvar as comissões
                    console.log('Dados das comissões para salvar:', dadosComissoes);
                    
                    // Simular salvamento (substitua pela chamada real da API)
                    // await api.post('/comissoes/multiplas', dadosComissoes);
                    
                    alert(`${dadosComissoes.length} comissões salvas com sucesso!`);
                    form.reset();
                    
                    // Limpar tabela
                    document.getElementById('linhasMultiplo').innerHTML = '';
                    
                } catch (error) {
                    console.error('Erro ao salvar comissões:', error);
                    alert('Erro ao salvar comissões. Tente novamente.');
                }
            }
            
            // Adicionar evento de submit ao formulário múltiplo
            document.getElementById('formMultiplo').addEventListener('submit', salvarComissoesMultiplas);
        </script>
    </div>

    <script src="scripts/navigation.js"></script>
</body>
</html> 
