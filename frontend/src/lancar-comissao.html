<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Comissões - Lançar Comissão</title>
    <link rel="icon" type="image/png" href="assets/images/logo2.png">
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="scripts/config/api.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo" style="display: flex; align-items: center; justify-content: center; padding: 15px 0;">
            <img src="assets/images/logo2.png" alt="BlueDev Logo" style="height: 2.5em; margin-right: 10px;">
            <h1><span class="orange">e-</span><span class="highlight">Gerente</span></h1>
        </div>
        <ul class="nav-menu">
            <li><a href="index.html"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-user-plus"></i><span>Cadastros</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="colaboradores.html"><i class="fas fa-users"></i><span>Colaboradores</span></a></li>
                    <li><a href="clientes.html"><i class="fas fa-user-tie"></i><span>Clientes</span></a></li>
                    <li><a href="produtos.html"><i class="fas fa-box"></i><span>Produtos</span></a></li>
                    <li><a href="servicos.html"><i class="fas fa-cogs"></i><span>Serviços</span></a></li>
                    <li><a href="usuarios.html"><i class="fas fa-user-shield"></i><span>Usuários</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-hand-holding-usd"></i><span>Comissões</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="lancar-comissao.html" class="active"><i class="fas fa-plus-circle"></i><span>Lançar</span></a></li>
                    <li><a href="movimento-comissao.html"><i class="fas fa-exchange-alt"></i><span>Movimento</span></a></li>
                    <li><a href="consulta-comissao.html"><i class="fas fa-search"></i><span>Consulta</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-chart-bar"></i><span>Relatórios</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="recebimento.html"><i class="fas fa-money-bill-wave"></i><span>Recebimento</span></a></li>
                    <li><a href="conferencia.html"><i class="fas fa-check-circle"></i><span>Conferência</span></a></li>
                    <li><a href="dinamico.html"><i class="fas fa-chart-line"></i><span>Dinâmico</span><span class="beta-tag">beta</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-cog"></i><span>Configurações</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="manutencao-bd.html"><i class="fas fa-database"></i><span>Manutenção BD</span></a></li>
                    <li><a href="sincronizar.html"><i class="fas fa-sync"></i><span>Sincronizar</span></a></li>
                </ul>
            </li>
        </ul>
        <div class="logout-button">
            <a href="index.html"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="welcome-text">
                <h1>Lançar Comissão</h1>
                <p>Registre novas comissões no sistema</p>
            </div>
            <div class="user-info">
                <div class="notifications">
                    <i class="fas fa-bell"></i>
                    <span class="badge">3</span>
                </div>
                <div class="user-avatar">A</div>
            </div>
        </div>

        <!-- Conteúdo da página -->
        <div class="content">
            <div class="tabs-comissao">
                <button id="tabUnico" class="tab-btn active" onclick="mostrarTabComissao('unico')">Lançamento Comercial</button>
                <button id="tabMultiplo" class="tab-btn" onclick="mostrarTabComissao('multiplo')">Múltiplos Lançamentos</button>
            </div>
            <div id="tabUnicoContent" class="tab-content active">
                <form id="formUnico" class="form-comissao">
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-user-tie"></i> Cliente</label>
                            <select name="cliente" required></select>
                        </div>
                        <div class="form-group tipo-toggle-group">
                            <label><i class="fas fa-cubes"></i> Tipo</label>
                            <div id="tipo-toggle" style="display: flex; gap: 8px; flex-direction: column; width: 100%;">
                                <button type="button" class="btn-tipo active" data-tipo="produto"><i class="fas fa-box"></i> Produto</button>
                                <button type="button" class="btn-tipo" data-tipo="servico"><i class="fas fa-cogs"></i> Serviço</button>
                            </div>
                            <input type="hidden" name="tipo" value="produto">
                        </div>
                        <div class="form-group produto-servico">
                            <label id="labelItemUnico"><i class="fas fa-box"></i> Produto</label>
                            <select name="item" multiple required class="select-produto-servico"></select>
                        </div>
                        <div class="form-group valor-venda-destaque">
                            <label><i class="fas fa-dollar-sign"></i> Valor da Venda</label>
                            <input type="text" name="valor_venda" required class="valor-venda-destaque-input">
                        </div>
                    </div>
                    <div id="colaboradoresVinculados">
                        <!-- Colaboradores dinâmicos aqui -->
                    </div>
                    <div style="margin-bottom: 18px;">
                        <button type="button" class="btn-primary" onclick="adicionarColaboradorUnico()"><i class="fas fa-user-plus"></i> Adicionar Colaborador</button>
                    </div>
                    <div class="form-actions">
                        <button type="reset" class="btn-secondary"><i class="fas fa-times"></i> Cancelar</button>
                        <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Salvar</button>
                    </div>
                </form>
            </div>
            <div id="tabMultiploContent" class="tab-content">
                <form id="formMultiplo" class="form-comissao">
                    <div class="table-multiplos">
                        <table>
                            <thead>
                                <tr>
                                    <th>Colaborador</th>
                                    <th>Tipo</th>
                                    <th>Produto/Serviço</th>
                                    <th>Valor Venda</th>
                                    <th>% Comissão</th>
                                    <th>Valor Comissão</th>
                                    <th>Data</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="linhasMultiplo">
                                <!-- Linhas dinâmicas -->
                            </tbody>
                        </table>
                        <button type="button" class="btn-primary" onclick="adicionarLinhaMultiplo()"><i class="fas fa-plus"></i> Adicionar Linha</button>
                    </div>
                    <div class="form-actions">
                        <button type="reset" class="btn-secondary"><i class="fas fa-times"></i> Cancelar</button>
                        <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Salvar Todos</button>
                    </div>
                </form>
            </div>
        </div>
        <style>
            .tabs-comissao {
                display: flex;
                gap: 8px;
                margin-bottom: 24px;
            }
            .tab-btn {
                background: #f5f5f5;
                color: #333;
                border: 1px solid #ddd;
                border-radius: 6px 6px 0 0;
                padding: 10px 28px;
                font-size: 1.1em;
                font-weight: 500;
                cursor: pointer;
                transition: background 0.2s, color 0.2s;
            }
            .tab-btn.active {
                background: #2196F3;
                color: #fff;
                border-bottom: 2px solid #2196F3;
            }
            .tab-content {
                display: none;
                animation: fadeIn 0.3s;
            }
            .tab-content.active {
                display: block;
            }
            .form-comissao {
                background: #fff;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.07);
                padding: 32px 24px;
                margin-bottom: 32px;
            }
            .form-row {
                display: flex;
                gap: 20px;
                margin-bottom: 20px;
                align-items: center;
            }
            .form-group {
                flex: 1;
            }
            .form-group.tipo-toggle-group {
                flex: 0 0 130px;
                min-width: 120px;
                max-width: 150px;
                margin-right: 0;
            }
            .form-group.produto-servico {
                flex: 2;
                margin-bottom: 18px;
            }
            .form-group label {
                display: block;
                margin-bottom: 8px;
                color: #555;
                font-weight: 500;
            }
            .form-group label i {
                margin-right: 5px;
                color: #2196F3;
            }
            .form-group input,
            .form-group select {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
                transition: border-color 0.3s;
            }
            .form-group input:focus,
            .form-group select:focus {
                border-color: #2196F3;
                outline: none;
                box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
            }
            .form-group input[readonly] {
                background-color: #f5f5f5;
                cursor: not-allowed;
            }
            .form-actions {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                margin-top: 30px;
                padding-top: 20px;
                border-top: 1px solid #eee;
            }
            .btn-primary,
            .btn-secondary {
                padding: 10px 20px;
                border-radius: 4px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: all 0.3s;
            }
            .btn-primary {
                background-color: #2196F3;
                color: white;
                border: none;
            }
            .btn-primary:hover {
                background-color: #1976D2;
            }
            .btn-secondary {
                background-color: #f5f5f5;
                color: #333;
                border: 1px solid #ddd;
            }
            .btn-secondary:hover {
                background-color: #e0e0e0;
            }
            .table-multiplos table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 16px;
            }
            .table-multiplos th, .table-multiplos td {
                border: 1px solid #eee;
                padding: 8px 6px;
                text-align: center;
            }
            .table-multiplos th {
                background: #f5f5f5;
                color: #333;
                font-weight: 600;
            }
            .table-multiplos td {
                background: #fff;
            }
            .table-multiplos .btn-primary {
                margin-top: 8px;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            #colaboradoresVinculados {
                display: flex;
                flex-direction: column;
                gap: 16px;
            }
            .colaborador-bloco {
                position: relative;
                padding-top: 18px;
                padding-right: 44px;
                padding-left: 22px;
                padding-bottom: 18px;
                margin-bottom: 22px;
                border: 2.5px solid #90caf9;
                border-radius: 12px;
                background: #f7fbff;
                box-shadow: 0 2px 10px rgba(33,150,243,0.06);
                transition: border 0.2s, box-shadow 0.2s, background 0.2s;
            }
            .btn-excluir-bloco {
                position: absolute;
                top: 10px;
                right: 14px;
                background: #fff;
                border: 2px solid #e53935;
                color: #e53935;
                border-radius: 50%;
                width: 26px;
                height: 26px;
                font-size: 1.05em;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(229,57,53,0.07);
                transition: background 0.18s, border 0.18s, color 0.18s, box-shadow 0.18s;
                z-index: 2;
            }
            .btn-excluir-bloco:hover {
                background: #ffebee;
                border-color: #b71c1c;
                color: #b71c1c;
                box-shadow: 0 4px 16px rgba(229,57,53,0.13);
            }
            .colaborador-bloco .form-row {
                margin-bottom: 0;
                gap: 20px;
                align-items: flex-end;
            }
            .colaborador-bloco .form-group {
                min-width: 160px;
                flex: 1;
            }
            .colaborador-bloco .form-group .btn-secondary {
                background-color: #dc3545;
                color: #fff;
                border: none;
                padding: 6px 10px;
                border-radius: 4px;
                font-size: 14px;
                min-width: unset;
                width: 28px;
                height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background 0.2s;
            }
            .colaborador-bloco .form-group .btn-secondary:hover {
                background-color: #b71c1c;
            }
            .colaborador-bloco .form-group .btn-secondary i {
                font-size: 14px;
            }
            .form-group.valor-venda-destaque input {
                background: #e3f2fd;
                border: 2px solid #2196F3;
                font-weight: 600;
                color: #1565c0;
                box-shadow: 0 2px 8px rgba(33,150,243,0.07);
                font-size: 1.15em;
            }
            .btn-parcelado {
                background: #fffbe6;
                border: 1.5px solid #fbc02d;
                color: #b8860b;
                font-weight: 600;
                border-radius: 16px;
                padding: 3px 10px;
                margin-top: 24px;
                margin-left: 4px;
                cursor: pointer;
                font-size: 0.92em;
                transition: background 0.2s, border 0.2s, box-shadow 0.2s;
                box-shadow: 0 1px 4px rgba(251,192,45,0.08);
            }
            .btn-parcelado.active {
                background: #ffe082;
                border-color: #fbc02d;
                box-shadow: 0 2px 8px rgba(251,192,45,0.18);
            }
            .btn-parcelado:hover {
                background: #fff8e1;
                border-color: #ffd54f;
            }
            .btn-simular {
                background: #e3f2fd;
                border: 1.5px solid #2196F3;
                color: #1565c0;
                font-weight: 600;
                border-radius: 16px;
                padding: 3px 12px;
                margin-top: 24px;
                margin-left: 4px;
                cursor: pointer;
                font-size: 0.92em;
                transition: background 0.2s, border 0.2s, box-shadow 0.2s;
                box-shadow: 0 1px 4px rgba(33,150,243,0.08);
            }
            .btn-simular:hover {
                background: #bbdefb;
                border-color: #1976d2;
            }
            .simulacao-titulos {
                margin-top: 10px;
                background: #f5f5f5;
                border-radius: 8px;
                padding: 10px 16px;
                border: 1px solid #e0e0e0;
                font-size: 0.98em;
            }
            .simulacao-titulos table {
                width: 100%;
                border-collapse: collapse;
            }
            .simulacao-titulos th, .simulacao-titulos td {
                padding: 4px 8px;
                text-align: left;
            }
            .simulacao-titulos th {
                background: #e3f2fd;
                color: #1565c0;
                font-weight: 700;
            }
            .simulacao-titulos tr:nth-child(even) {
                background: #fafafa;
            }
            .group-parcelas, .group-valor-parcela {
                min-width: 120px;
                margin-left: 4px;
            }
            .valor-venda-destaque-input {
                background: #fffde7;
                border: 3px solid #fbc02d;
                font-weight: 800;
                color: #b8860b;
                box-shadow: 0 4px 16px rgba(251,192,45,0.18);
                font-size: 1.35em;
                padding: 12px 18px;
                border-radius: 8px;
                outline: none;
                transition: box-shadow 0.2s, border 0.2s;
            }
            .valor-venda-destaque-input:focus {
                box-shadow: 0 6px 24px rgba(251,192,45,0.28);
                border-color: #ffb300;
            }
            .simulacao-titulos input[type='date'] {
                border: 1.5px solid #90caf9;
                border-radius: 8px;
                background: #f7fbff;
                padding: 5px 32px 5px 10px;
                font-size: 1em;
                color: #1565c0;
                transition: box-shadow 0.18s, border 0.18s;
                box-shadow: 0 1px 4px rgba(33,150,243,0.07);
                min-width: 160px;
                width: 160px;
                box-sizing: border-box;
            }
            .simulacao-titulos input[type='date']:focus {
                border-color: #1976d2;
                box-shadow: 0 2px 8px rgba(33,150,243,0.18);
                outline: none;
            }
            .btn-tipo {
                background: #f5f5f5;
                color: #333;
                border: 1.5px solid #ddd;
                border-radius: 6px;
                padding: 6px 10px;
                font-size: 0.95em;
                font-weight: 500;
                cursor: pointer;
                transition: background 0.2s, color 0.2s, border 0.2s;
                display: flex;
                align-items: center;
                gap: 6px;
                min-width: 110px;
            }
            #tipo-toggle {
                display: flex;
                flex-direction: column;
                gap: 6px;
                width: 120px;
            }
            .btn-tipo.active {
                background: #2196F3;
                color: #fff;
                border-color: #2196F3;
            }
            .form-group.produto-servico {
                margin-bottom: 18px;
            }
            #labelItemUnico {
                font-size: 1.08em;
                font-weight: 600;
                color: #1976D2;
                margin-bottom: 6px;
                display: flex;
                align-items: center;
                gap: 6px;
            }
            .select-produto-servico {
                background: #f7fbff;
                border: 2px solid #90caf9;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(33,150,243,0.07);
                padding: 7px 12px;
                font-size: 1em;
                min-height: 44px;
                margin-top: 2px;
                margin-bottom: 2px;
                transition: border 0.2s, box-shadow 0.2s;
            }
            .select-produto-servico:focus {
                border-color: #2196F3;
                box-shadow: 0 4px 16px rgba(33,150,243,0.13);
            }
            .choices__inner {
                min-height: 44px !important;
                border-radius: 8px !important;
                background: #f7fbff !important;
                border: 2px solid #90caf9 !important;
                box-shadow: 0 2px 8px rgba(33,150,243,0.07) !important;
                font-size: 1em !important;
                padding: 7px 12px !important;
            }
            .choices__list--multiple .choices__item {
                background: #e3f2fd !important;
                color: #1976D2 !important;
                border-radius: 6px !important;
                border: 1px solid #90caf9 !important;
                margin: 2px 4px 2px 0 !important;
                padding: 3px 10px !important;
            }
        </style>
        <script>
            let produtos = [];
            let servicos = [];
            let choicesItem = null;
            const selectItem = document.querySelector('#formUnico select[name="item"]');
            const tipoInput = document.querySelector('#formUnico input[name="tipo"]');
            function mostrarTabComissao(tab) {
                document.getElementById('tabUnico').classList.remove('active');
                document.getElementById('tabMultiplo').classList.remove('active');
                document.getElementById('tabUnicoContent').classList.remove('active');
                document.getElementById('tabMultiploContent').classList.remove('active');
                if (tab === 'unico') {
                    document.getElementById('tabUnico').classList.add('active');
                    document.getElementById('tabUnicoContent').classList.add('active');
                } else {
                    document.getElementById('tabMultiplo').classList.add('active');
                    document.getElementById('tabMultiploContent').classList.add('active');
                }
            }
            function atualizarTipoUnico() {
                const tipo = tipoInput.value;
                const label = document.getElementById('labelItemUnico');
                label.innerHTML = tipo === 'produto' ? '<i class="fas fa-box"></i> Produto' : '<i class="fas fa-cogs"></i> Serviço';
            }
            function calcularComissaoUnico() {
                const form = document.getElementById('formUnico');
                const valorVenda = parseFloat(form.valor_venda.value) || 0;
                const percentual = parseFloat(form.percentual.value) || 0;
                form.valor_comissao.value = (valorVenda * percentual / 100).toFixed(2);
            }
            // Múltiplos lançamentos
            function adicionarLinhaMultiplo() {
                const tbody = document.getElementById('linhasMultiplo');
                const idx = tbody.children.length;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><select name="colaborador[]" required></select></td>
                    <td><select name="tipo[]" required onchange="atualizarTipoMultiplo(this, ${idx})"><option value="produto">Produto</option><option value="servico">Serviço</option></select></td>
                    <td><select name="item[]" required></select></td>
                    <td><input type="number" name="valor_venda[]" step="0.01" min="0" required></td>
                    <td><input type="number" name="percentual[]" step="0.01" min="0" max="100" required oninput="calcularComissaoMultiplo(this, ${idx})"></td>
                    <td><input type="number" name="valor_comissao[]" step="0.01" min="0" readonly></td>
                    <td><input type="date" name="data[]" required></td>
                    <td><button type="button" class="btn-secondary" onclick="removerLinhaMultiplo(this)"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            }
            function removerLinhaMultiplo(btn) {
                btn.closest('tr').remove();
            }
            function atualizarTipoMultiplo(select, idx) {
                const td = select.parentElement.nextElementSibling;
                const label = select.value === 'produto' ? 'Produto' : 'Serviço';
                td.querySelector('select').innerHTML = '';
            }
            function calcularComissaoMultiplo(input, idx) {
                const tr = input.closest('tr');
                const valorVenda = parseFloat(tr.querySelector('input[name="valor_venda[]"]').value) || 0;
                const percentual = parseFloat(tr.querySelector('input[name="percentual[]"]').value) || 0;
                tr.querySelector('input[name="valor_comissao[]"]').value = (valorVenda * percentual / 100).toFixed(2);
            }
            let numeroTituloPai = 1;
            function adicionarColaboradorUnico() {
                const container = document.getElementById('colaboradoresVinculados');
                let blocoCount = container.querySelectorAll('.colaborador-bloco').length;
                blocoCount++;
                const div = document.createElement('div');
                div.className = 'colaborador-bloco';
                div.setAttribute('data-numero-pai', numeroTituloPai.toString().padStart(5, '0'));
                numeroTituloPai++;
                div.innerHTML = `
                    <button type="button" class="btn-excluir-bloco" title="Remover colaborador" onclick="this.closest('.colaborador-bloco').remove()"><i class="fas fa-times"></i></button>
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-user"></i> Colaborador</label>
                            <select name="colaborador[]" required></select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-align-left"></i> Descrição</label>
                            <input type="text" name="descricao_colaborador[]" maxlength="100" placeholder="Observação ou função...">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-percent"></i> % Comissão</label>
                            <input type="number" name="percentual[]" step="0.01" min="0" max="100" required oninput="calcularValorReceberUnico(this)">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-coins"></i> Valor a Receber</label>
                            <input type="number" name="valor_receber[]" step="0.01" min="0" readonly>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn-parcelado" onclick="toggleParcelado(this)">Parcelado</button>
                            <button type="button" class="btn-simular" onclick="simularTitulos(this)">Simular</button>
                        </div>
                        <div class="form-group group-parcelas" style="display:none;">
                            <label><i class="fas fa-list-ol"></i> Qtd. Parcelas</label>
                            <input type="number" name="qtd_parcelas[]" min="2" step="1" oninput="atualizaValorParcela(this)">
                        </div>
                        <div class="form-group group-valor-parcela" style="display:none;">
                            <label><i class="fas fa-money-bill-wave"></i> Valor da Parcela</label>
                            <input type="text" name="valor_parcela[]" readonly>
                        </div>
                    </div>
                    <div class="simulacao-titulos" style="display:none;">
                        <div class="simulacao-tabela"></div>
                    </div>
                `;
                container.appendChild(div);
            }
            function extrairNumeroBR(valor) {
                if (!valor) return 0;
                return Number(valor.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
            }
            function calcularValorReceberUnico(input) {
                const bloco = input.closest('.colaborador-bloco');
                const percentual = parseFloat(input.value) || 0;
                const form = document.getElementById('formUnico');
                const campoValorVenda = form.querySelector('input[name="valor_venda"]');
                const valorVenda = extrairNumeroBR(campoValorVenda.value);
                const valorReceber = bloco.querySelector('input[name="valor_receber[]"]');
                valorReceber.value = (valorVenda * percentual / 100).toFixed(2);
            }
            function toggleParcelado(btn) {
                const row = btn.closest('.form-row');
                const groupParcelas = row.querySelector('.group-parcelas');
                const groupValorParcela = row.querySelector('.group-valor-parcela');
                if (groupParcelas.style.display === 'none') {
                    groupParcelas.style.display = '';
                    groupValorParcela.style.display = '';
                    btn.classList.add('active');
                } else {
                    groupParcelas.style.display = 'none';
                    groupValorParcela.style.display = 'none';
                    btn.classList.remove('active');
                    row.querySelector('input[name="qtd_parcelas[]"]').value = '';
                    row.querySelector('input[name="valor_parcela[]"]').value = '';
                }
            }
            function atualizaValorParcela(input) {
                const row = input.closest('.form-row');
                const qtd = parseInt(input.value);
                const valorReceber = parseFloat(row.querySelector('input[name="valor_receber[]"]').value.replace(',','.'));
                const valorParcelaInput = row.querySelector('input[name="valor_parcela[]"]');
                if (qtd > 1 && valorReceber > 0) {
                    const valorParcela = valorReceber / qtd;
                    valorParcelaInput.value = valorParcela.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                } else {
                    valorParcelaInput.value = '';
                }
            }
            function simularTitulos(btn) {
                const row = btn.closest('.form-row');
                const bloco = btn.closest('.colaborador-bloco');
                const numeroPai = bloco.getAttribute('data-numero-pai') || '00001';
                const qtdInput = row.querySelector('input[name="qtd_parcelas[]"]');
                const valorReceberInput = row.querySelector('input[name="valor_receber[]"]');
                const simulacaoDiv = row.parentElement.querySelector('.simulacao-titulos');
                const simulacaoTabela = simulacaoDiv.querySelector('.simulacao-tabela');
                let qtd = 1;
                if (qtdInput && qtdInput.closest('.group-parcelas') && qtdInput.closest('.group-parcelas').style.display !== 'none' && qtdInput.value && parseInt(qtdInput.value) > 1) {
                    qtd = parseInt(qtdInput.value);
                }
                const valorReceber = parseFloat(valorReceberInput.value.replace(',','.'));
                if (!valorReceber || valorReceber <= 0) {
                    simulacaoDiv.style.display = 'block';
                    simulacaoTabela.innerHTML = '<span style="color:#b71c1c;">Informe o valor a receber.</span>';
                    return;
                }
                if (qtd < 1) qtd = 1;
                let html = `<table><tr><th>Nº Título</th><th>Parcela</th><th>Valor</th><th>Data de Emissão</th><th>Data de Vencimento</th></tr>`;
                const valorParcela = valorReceber / qtd;
                const hoje = new Date();
                const dataHoje = hoje.toISOString().slice(0,10);
                for (let i = 1; i <= qtd; i++) {
                    html += `<tr><td>${numeroPai}-${i}/${qtd}</td><td>${i}</td><td>R$ ${valorParcela.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td><td><input type='date' class='simulacao-emissao-parcela' style='width:160px;' value='${dataHoje}'></td><td><input type='date' class='simulacao-vencimento-parcela' style='width:160px;'></td></tr>`;
                }
                html += '</table>';
                if (qtd > 1) {
                    html += `<div class='intervalo-vencimento-container' style='display:none; margin-top:8px;'><label style='font-weight:500;'>Intervalo entre títulos: </label> <select class='intervalo-vencimento-select' style='margin-left:6px; padding:2px 8px; border-radius:6px; border:1px solid #bbb;'><option value='' selected disabled>Selecione...</option><option value='10'>10 dias</option><option value='20'>20 dias</option><option value='30'>30 dias</option></select></div>`;
                }
                simulacaoDiv.style.display = 'block';
                simulacaoTabela.innerHTML = html;

                // Adiciona evento para mostrar o select de intervalo ao preencher a primeira data de vencimento
                const vencInputs = simulacaoTabela.querySelectorAll('.simulacao-vencimento-parcela');
                const intervaloContainer = simulacaoTabela.parentElement.querySelector('.intervalo-vencimento-container');
                const intervaloSelect = simulacaoTabela.parentElement.querySelector('.intervalo-vencimento-select');
                if (vencInputs.length > 1) {
                    vencInputs[0].addEventListener('change', function() {
                        intervaloContainer.style.display = 'inline-block';
                    });
                    intervaloSelect.addEventListener('change', function() {
                        if (!this.value) return;
                        const intervalo = parseInt(this.value);
                        const primeiraData = vencInputs[0].value;
                        if (primeiraData) {
                            let data = new Date(primeiraData);
                            for (let i = 1; i < vencInputs.length; i++) {
                                data.setDate(data.getDate() + intervalo);
                                vencInputs[i].value = data.toISOString().slice(0,10);
                            }
                        }
                    });
                }

                // Adiciona evento para preencher todas as datas de emissão ao preencher a primeira
                const emissaoInputs = simulacaoTabela.querySelectorAll('.simulacao-emissao-parcela');
                if (emissaoInputs.length > 1) {
                    emissaoInputs[0].addEventListener('change', function() {
                        if (this.value) {
                            for (let i = 1; i < emissaoInputs.length; i++) {
                                if (!emissaoInputs[i].value) emissaoInputs[i].value = this.value;
                            }
                        }
                    });
                }
            }
            document.getElementById('formUnico').valor_venda.oninput = function() {
                document.querySelectorAll('.colaborador-bloco input[name="percentual[]"]').forEach(input => {
                    calcularValorReceberUnico(input);
                });
            };
            document.addEventListener('DOMContentLoaded', async function() {
                let clientes = [];
                try {
                    clientes = await api.get('/clientes');
                    const selectCliente = document.querySelector('select[name="cliente"]');
                    selectCliente.innerHTML = '<option value="">Selecione um cliente...</option>';
                    clientes.forEach(cliente => {
                        const option = document.createElement('option');
                        option.value = cliente.codigo;
                        option.textContent = (cliente.codigo_crm ? cliente.codigo_crm + ' - ' : '') + cliente.nome;
                        selectCliente.appendChild(option);
                    });
                    if (window.Choices) {
                        new Choices(selectCliente, {
                            searchEnabled: true,
                            itemSelectText: '',
                            shouldSort: false,
                            placeholder: true,
                            placeholderValue: 'Selecione um cliente...'
                        });
                    }

                    // Produtos e Serviços
                    produtos = await api.get('/produtos');
                    servicos = await api.get('/servicos');
                    console.log('Produtos:', produtos);
                    console.log('Serviços:', servicos);
                    const tipoToggle = document.getElementById('tipo-toggle');
                    const tipoInput = document.querySelector('input[name="tipo"]');
                    tipoToggle.querySelectorAll('.btn-tipo').forEach(btn => {
                        btn.addEventListener('click', function() {
                            tipoToggle.querySelectorAll('.btn-tipo').forEach(b => b.classList.remove('active'));
                            this.classList.add('active');
                            tipoInput.value = this.dataset.tipo;
                            preencherItens(this.dataset.tipo);
                            atualizarTipoUnico();
                        });
                    });
                    // Após carregar produtos e serviços, já preencher com produtos e atualizar label
                    preencherItens('produto');
                    atualizarTipoUnico();
                } catch (e) {
                    console.error('Erro ao carregar clientes/produtos/serviços:', e);
                }
            });
            function preencherItens(tipo) {
                if (choicesItem) {
                    choicesItem.destroy();
                    choicesItem = null;
                }
                selectItem.style.visibility = 'hidden';
                selectItem.innerHTML = '';
                let lista = tipo === 'produto' ? produtos : servicos;
                lista.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.codigo;
                    option.textContent = (item.codigo ? item.codigo.toString().padStart(5, '0') + ' - ' : '') + item.nome;
                    option.dataset.valor = item.preco;
                    selectItem.appendChild(option);
                });
                selectItem.disabled = false;
                if (window.Choices) {
                    choicesItem = new Choices(selectItem, {
                        searchEnabled: true,
                        itemSelectText: '',
                        shouldSort: false,
                        placeholder: true,
                        placeholderValue: 'Selecione um ou mais...',
                        removeItemButton: true,
                        maxItemCount: -1,
                        duplicateItemsAllowed: false,
                        noResultsText: 'Nenhum resultado encontrado',
                        noChoicesText: 'Sem opções disponíveis'
                    });
                    selectItem.removeEventListener('change', atualizarValorVendaPorItens);
                    selectItem.addEventListener('change', atualizarValorVendaPorItens);
                }
                selectItem.style.visibility = 'visible';
            }
            function formatarMoedaBR(valor) {
                return Number(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }
            function atualizarValorVendaPorItens() {
                const tipo = tipoInput.value;
                const lista = tipo === 'produto' ? produtos : servicos;
                const selecionados = Array.from(selectItem.selectedOptions).map(opt => opt.value);
                let soma = 0;
                selecionados.forEach(cod => {
                    const item = lista.find(i => i.codigo == cod);
                    if (item && item.preco !== undefined && item.preco !== null) soma += Number(item.preco) || 0;
                });
                const campoValor = document.querySelector('#formUnico input[name="valor_venda"]');
                campoValor.value = formatarMoedaBR(soma);
            }
            // Permitir edição manual suave do campo Valor da Venda
            let timeoutFormatMoeda = null;
            const campoValorVenda = document.querySelector('#formUnico input[name="valor_venda"]');
            campoValorVenda.addEventListener('input', function(e) {
                clearTimeout(timeoutFormatMoeda);
                let valor = this.value.replace(/[^\d,]/g, '').replace(',', '.');
                if (valor) {
                    valor = parseFloat(valor);
                    if (!isNaN(valor)) {
                        // Formatar após pequeno delay para não atrapalhar digitação
                        timeoutFormatMoeda = setTimeout(() => {
                            this.value = formatarMoedaBR(valor);
                        }, 400);
                    }
                }
                // Atualizar todos os valores a receber ao editar manualmente
                document.querySelectorAll('.colaborador-bloco input[name="percentual[]"]').forEach(input => {
                    calcularValorReceberUnico(input);
                });
            });
            // Converter para número puro ao submeter
            const formUnico = document.getElementById('formUnico');
            formUnico.addEventListener('submit', function(e) {
                const campo = formUnico.querySelector('input[name="valor_venda"]');
                campo.value = campo.value.replace(/[^\d,]/g, '').replace(',', '.');
            });
        </script>
    </div>

    <script src="scripts/navigation.js"></script>
</body>
</html> 
