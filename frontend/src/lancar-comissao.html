<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Comissões - Lançar Comissão</title>
    <link rel="icon" type="image/png" href="assets/images/logo2.png">
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="scripts/config/api.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo" style="display: flex; align-items: center; justify-content: center; padding: 15px 0;">
            <img src="assets/images/logo2.png" alt="BlueDev Logo" style="height: 2.5em; margin-right: 10px;">
            <h1><span class="orange">e-</span><span class="highlight">Gerente</span></h1>
        </div>
        <ul class="nav-menu">
            <li><a href="index.html"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-user-plus"></i><span>Cadastros</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="colaboradores.html"><i class="fas fa-users"></i><span>Colaboradores</span></a></li>
                    <li><a href="clientes.html"><i class="fas fa-user-tie"></i><span>Clientes</span></a></li>
                    <li><a href="produtos.html"><i class="fas fa-box"></i><span>Produtos</span></a></li>
                    <li><a href="servicos.html"><i class="fas fa-cogs"></i><span>Serviços</span></a></li>
                    <li><a href="usuarios.html"><i class="fas fa-user-shield"></i><span>Usuários</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-hand-holding-usd"></i><span>Comissões</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="lancar-comissao.html" class="active"><i class="fas fa-plus-circle"></i><span>Lançar</span></a></li>
                    <li><a href="movimento-comissao.html"><i class="fas fa-exchange-alt"></i><span>Movimento</span></a></li>
                    <li><a href="consulta-comissao.html"><i class="fas fa-search"></i><span>Consulta</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-chart-bar"></i><span>Relatórios</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="recebimento.html"><i class="fas fa-money-bill-wave"></i><span>Recebimento</span></a></li>
                    <li><a href="conferencia.html"><i class="fas fa-check-circle"></i><span>Conferência</span></a></li>
                    <li><a href="dinamico.html"><i class="fas fa-chart-line"></i><span>Dinâmico</span><span class="beta-tag">beta</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-cog"></i><span>Configurações</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="manutencao-bd.html"><i class="fas fa-database"></i><span>Manutenção BD</span></a></li>
                    <li><a href="sincronizar.html"><i class="fas fa-sync"></i><span>Sincronizar</span></a></li>
                </ul>
            </li>
        </ul>
        <div class="logout-button">
            <a href="index.html"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="welcome-text">
                <h1>Lançar Comissão</h1>
                <p>Registre novas comissões no sistema</p>
            </div>
            <div class="user-info">
                <div class="notifications">
                    <i class="fas fa-bell"></i>
                    <span class="badge">3</span>
                </div>
                <div class="user-avatar">A</div>
            </div>
        </div>

        <!-- Conteúdo da página -->
        <div class="content">
            <div class="tabs-comissao">
                <button id="tabUnico" class="tab-btn active" onclick="mostrarTabComissao('unico')">Lançamento Comercial</button>
                <button id="tabMultiplo" class="tab-btn" onclick="mostrarTabComissao('multiplo')">Múltiplos Lançamentos</button>
                <button id="tabSimples" class="tab-btn" onclick="mostrarTabComissao('simples')">Lançamento Simples</button>
            </div>
            <div id="tabUnicoContent" class="tab-content active">
                <form id="formUnico" class="form-comissao">
                    <div class="form-row">
                        <div class="form-group" style="flex: 1.5;">
                            <label><i class="fas fa-user-tie"></i> Cliente</label>
                            <div class="choices-container-wrapper">
                                <select name="cliente" required></select>
                            </div>
                        </div>
                        <div class="form-group tipo-toggle-group" style="flex: 1;">
                            <label><i class="fas fa-cubes"></i> Tipo</label>
                            <div id="tipo-toggle">
                                <button type="button" class="btn-tipo" data-tipo="produto"><i class="fas fa-box"></i> Produto</button>
                                <button type="button" class="btn-tipo" data-tipo="servico"><i class="fas fa-cogs"></i> Serviço</button>
                            </div>
                            <input type="hidden" name="tipo" value="">
                        </div>
                        <div class="form-group produto-servico" style="flex: 2.5;">
                            <label id="labelItemUnico"><i class="fas fa-cubes"></i> Itens</label>
                            <div class="choices-container-wrapper">
                                <select name="item" multiple required></select>
                            </div>
                        </div>
                        <div class="form-group valor-venda-destaque" style="flex: 1.5;">
                            <label><i class="fas fa-dollar-sign"></i> Valor da Venda</label>
                            <input type="text" name="valor_venda" required class="valor-venda-destaque-input" placeholder="R$ 0,00" style="flex:1;">
                        </div>
                    </div>
                    <div id="colaboradoresVinculados">
                        <!-- Colaboradores dinâmicos aqui -->
                    </div>
                    <div style="margin-bottom: 18px;">
                        <button type="button" class="btn-primary" onclick="adicionarColaboradorUnico()"><i class="fas fa-user-plus"></i> Adicionar Colaborador</button>
                    </div>
                    <div class="form-actions">
                        <button type="reset" class="btn-secondary"><i class="fas fa-times"></i> Cancelar</button>
                        <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Salvar Comissão</button>
                    </div>
                </form>
            </div>
            <div id="tabMultiploContent" class="tab-content">
                <form id="formMultiplo" class="form-comissao">
                    <div class="form-row">
                        <!-- Remover campo de cliente do topo -->
                    </div>
                    <div class="table-multiplos">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 260px;">Cliente</th>
                                    <th style="width: 260px;">Colaborador</th>
                                    <th>Tipo</th>
                                    <th>Produto/Serviço</th>
                                    <th>Descrição</th>
                                    <th>Valor Venda</th>
                                    <th>% Comissão</th>
                                    <th>Valor Comissão</th>
                                    <th>Ações</th>
                                    <th style="width:70px;">Duplicar/Excluir</th>
                                </tr>
                            </thead>
                            <tbody id="linhasMultiplo">
                                <!-- Linhas dinâmicas -->
                            </tbody>
                        </table>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 16px;">
                            <button type="button" class="btn-primary" onclick="adicionarLinhaMultiplo()"><i class="fas fa-plus"></i> Adicionar Linha</button>
                            <button type="button" class="btn-secondary" onclick="limparTodasLinhas()"><i class="fas fa-trash-alt"></i> Limpar Todas</button>
                        </div>
                    </div>
                    <div class="resumo-multiplo" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;"><i class="fas fa-chart-bar"></i> Resumo</h4>
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <div>
                                <strong>Total de Linhas:</strong> <span id="totalLinhas">0</span>
                            </div>
                            <div>
                                <strong>Valor Total das Vendas:</strong> <span id="valorTotalVendas">R$ 0,00</span>
                            </div>
                            <div>
                                <strong>Valor Total das Comissões:</strong> <span id="valorTotalComissoes">R$ 0,00</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="reset" class="btn-secondary"><i class="fas fa-times"></i> Cancelar</button>
                        <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Salvar Todos</button>
                    </div>
                </form>
            </div>
            <div id="tabSimplesContent" class="tab-content">
                <form id="formSimples" class="form-comissao">
                    <div class="form-row">
                        <div class="form-group" style="flex:2;">
                            <label><i class="fas fa-user"></i> Colaborador</label>
                            <select name="colaborador" id="colaboradorSimples" required></select>
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label><i class="fas fa-coins"></i> Valor da Comissão</label>
                            <input type="number" name="valor_comissao" id="valorComissaoSimples" step="0.01" min="0" required placeholder="0.00">
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label><i class="fas fa-calendar-alt"></i> Data de Emissão</label>
                            <input type="date" name="data_emissao" id="dataEmissaoSimples" required>
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label><i class="fas fa-calendar-check"></i> Data de Vencimento</label>
                            <input type="date" name="data_vencimento" id="dataVencimentoSimples" required>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="reset" class="btn-secondary"><i class="fas fa-times"></i> Cancelar</button>
                        <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Salvar Comissão</button>
                    </div>
                </form>
            </div>
        </div>
        <style>
            .tabs-comissao {
                display: flex;
                gap: 8px;
                margin-bottom: 24px;
            }
            .tab-btn {
                background: #f5f5f5;
                color: #333;
                border: 1px solid #ddd;
                border-radius: 6px 6px 0 0;
                padding: 10px 28px;
                font-size: 1.1em;
                font-weight: 500;
                cursor: pointer;
                transition: background 0.2s, color 0.2s;
            }
            .tab-btn.active {
                background: #2196F3;
                color: #fff;
                border-bottom: 2px solid #2196F3;
            }
            .tab-content {
                display: none;
                animation: fadeIn 0.3s;
            }
            .tab-content.active {
                display: block;
            }
            .form-comissao {
                background: #fff;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.07);
                padding: 32px 24px;
                margin-bottom: 32px;
            }
            .form-row {
                display: flex;
                gap: 20px;
                margin-bottom: 20px;
                align-items: flex-start;
            }
            .form-group {
                flex: 1;
            }
            .form-group.tipo-toggle-group {
                min-width: 120px;
                max-width: 150px;
                margin-right: 0;
            }
            .form-group.produto-servico {
                margin-bottom: 18px;
            }
            .form-group label {
                display: block;
                margin-bottom: 8px;
                color: #555;
                font-weight: 500;
            }
            .form-group label i {
                margin-right: 5px;
                color: #2196F3;
            }
            .form-group input,
            .form-group select {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
                transition: border-color 0.3s;
            }
            .form-group input:focus,
            .form-group select:focus {
                border-color: #2196F3;
                outline: none;
                box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
            }
            .form-group input[readonly] {
                background-color: #f5f5f5;
                cursor: not-allowed;
            }
            .form-actions {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                margin-top: 30px;
                padding-top: 20px;
                border-top: 1px solid #eee;
            }
            .btn-primary,
            .btn-secondary {
                padding: 10px 20px;
                border-radius: 4px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: all 0.3s;
            }
            .btn-primary {
                background-color: #2196F3;
                color: white;
                border: none;
            }
            .btn-primary:hover {
                background-color: #1976D2;
            }
            .btn-secondary {
                background-color: #f5f5f5;
                color: #333;
                border: 1px solid #ddd;
            }
            .btn-secondary:hover {
                background-color: #e0e0e0;
            }
            .table-multiplos table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 16px;
            }
            .table-multiplos th, .table-multiplos td {
                border: 1px solid #eee;
                padding: 8px 6px;
                text-align: center;
            }
            .table-multiplos th {
                background: #f5f5f5;
                color: #333;
                font-weight: 600;
            }
            .table-multiplos td {
                background: #fff;
                vertical-align: middle;
                min-height: 56px;
                height: 56px;
            }
            .table-multiplos td:last-child {
                min-height: 56px;
                height: 56px;
                vertical-align: middle;
            }
            .table-multiplos .btn-primary {
                margin-top: 8px;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            #colaboradoresVinculados {
                display: flex;
                flex-direction: column;
                gap: 16px;
            }
            .colaborador-bloco {
                position: relative;
                padding-top: 18px;
                padding-right: 44px;
                padding-left: 22px;
                padding-bottom: 18px;
                margin-bottom: 22px;
                border: 2.5px solid #90caf9;
                border-radius: 12px;
                background: #f7fbff;
                box-shadow: 0 2px 10px rgba(33,150,243,0.06);
                transition: border 0.2s, box-shadow 0.2s, background 0.2s;
            }
            .btn-excluir-bloco {
                position: absolute;
                top: 10px;
                right: 14px;
                background: #fff;
                border: 2px solid #e53935;
                color: #e53935;
                border-radius: 50%;
                width: 26px;
                height: 26px;
                font-size: 1.05em;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(229,57,53,0.07);
                transition: background 0.18s, border 0.18s, color 0.18s, box-shadow 0.18s;
                z-index: 2;
            }
            .btn-excluir-bloco:hover {
                background: #ffebee;
                border-color: #b71c1c;
                color: #b71c1c;
                box-shadow: 0 4px 16px rgba(229,57,53,0.13);
            }
            .colaborador-bloco .form-row {
                margin-bottom: 0;
                gap: 20px;
                align-items: flex-end;
            }
            .colaborador-bloco .form-group {
                min-width: 160px;
                flex: 1;
            }
            .colaborador-bloco .form-group .btn-secondary {
                background-color: #dc3545;
                color: #fff;
                border: none;
                padding: 6px 10px;
                border-radius: 4px;
                font-size: 14px;
                min-width: unset;
                width: 28px;
                height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background 0.2s;
            }
            .colaborador-bloco .form-group .btn-secondary:hover {
                background-color: #b71c1c;
            }
            .colaborador-bloco .form-group .btn-secondary i {
                font-size: 14px;
            }
            .form-group.valor-venda-destaque input {
                background: #e3f2fd;
                border: 2px solid #2196F3;
                font-weight: 600;
                color: #1565c0;
                box-shadow: 0 2px 8px rgba(33,150,243,0.07);
                font-size: 1.15em;
            }
            .valor-venda-destaque-input:focus {
                box-shadow: 0 6px 24px rgba(251,192,45,0.28);
                border-color: #ffb300;
            }
            .simulacao-titulos input[type='date'] {
                border: 1.5px solid #90caf9;
                border-radius: 8px;
                background: #f7fbff;
                padding: 5px 32px 5px 10px;
                font-size: 1em;
                color: #1565c0;
                transition: box-shadow 0.18s, border 0.18s;
                box-shadow: 0 1px 4px rgba(33,150,243,0.07);
                min-width: 160px;
                width: 160px;
                box-sizing: border-box;
            }
            .simulacao-titulos input[type='date']:focus {
                border-color: #1976d2;
                box-shadow: 0 2px 8px rgba(33,150,243,0.18);
                outline: none;
            }
            .btn-tipo {
                padding: 6px 10px;
                font-size: 0.88em;
                font-weight: 500;
                gap: 5px;
                border-radius: 6px;
                border: 1.5px solid #e0e0e0;
                background: #f9f9f9;
                transition: all 0.2s ease-in-out;
            }
            .btn-tipo.active {
                background-color: #2196F3;
                border-color: #2196F3;
                color: #fff;
                box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
            }
            .form-group.produto-servico {
                margin-bottom: 18px;
            }
            #labelItemUnico {
                font-size: 1.08em;
                font-weight: 600;
                color: #1976D2;
                margin-bottom: 6px;
                display: flex;
                align-items: center;
                gap: 6px;
            }
            select option[value=""] {
                color: #757575;
            }
            .choices__inner {
                min-height: 44px !important;
                border-radius: 8px !important;
                background: #fff !important;
                border: 2px solid #2196F3 !important;
                box-shadow: 0 2px 8px rgba(33,150,243,0.07) !important;
                font-size: 1em !important;
                padding: 7px 12px !important;
            }
            #tipo-toggle {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }
            .valor-venda-destaque {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 12px;
                text-align: center;
                height: 100%;
                box-sizing: border-box;
            }
            .valor-venda-destaque .valor-venda-destaque-input {
                font-size: 1.9em;
                font-weight: 700;
                color: #1565c0;
                text-align: center;
                background: transparent;
                border: none;
                padding: 10px 0 0 0;
                height: auto;
                box-shadow: none;
            }
            /* Botão duplicar azul */
            .btn-duplicar {
                background-color: #2196F3;
                color: #fff;
                border: none;
                margin-right: 4px;
            }
            .btn-duplicar:hover {
                background-color: #1976D2;
            }
            /* Botão deletar vermelho */
            .btn-deletar {
                background-color: #e53935;
                color: #fff;
                border: none;
            }
            .btn-deletar:hover {
                background-color: #b71c1c;
            }
            .btn-parcelado {
                background: #fffbe6;
                border: 1.5px solid #fbc02d;
                color: #b8860b;
                font-weight: 600;
                border-radius: 16px;
                padding: 3px 10px;
                margin-top: 24px;
                margin-left: 4px;
                cursor: pointer;
                font-size: 0.92em;
                transition: background 0.2s, border 0.2s, box-shadow 0.2s;
                box-shadow: 0 1px 4px rgba(251,192,45,0.08);
            }
            .btn-parcelado.active {
                background: #ffe082;
                border-color: #fbc02d;
                box-shadow: 0 2px 8px rgba(251,192,45,0.18);
            }
            .btn-parcelado:hover {
                background: #fff8e1;
                border-color: #ffd54f;
            }
            .btn-simular {
                background: #e3f2fd;
                border: 1.5px solid #2196F3;
                color: #1565c0;
                font-weight: 600;
                border-radius: 16px;
                padding: 3px 12px;
                margin-top: 24px;
                margin-left: 4px;
                cursor: pointer;
                font-size: 0.92em;
                transition: background 0.2s, border 0.2s, box-shadow 0.2s;
                box-shadow: 0 1px 4px rgba(33,150,243,0.08);
            }
            .btn-simular:hover {
                background: #bbdefb;
                border-color: #1976d2;
            }
            /* Ajuste visual dos campos da tabela múltiplos lançamentos para igualar ao campo colaborador */
            .table-multiplos select.input-colaborador,
            .table-multiplos select.input-item,
            .table-multiplos input.input-valor,
            .table-multiplos input.input-percentual,
            .table-multiplos input.input-comissao {
                width: 110px !important;
                min-width: 80px !important;
                max-width: 110px !important;
                box-sizing: border-box;
                text-align: center;
                border: 2px solid #2196F3 !important;
                border-radius: 8px !important;
                background: #fff !important;
                color: #1565c0 !important;
                font-size: 14px !important;
                transition: border-color 0.3s, box-shadow 0.3s;
                box-shadow: 0 2px 8px rgba(33,150,243,0.07) !important;
                height: 49.22px !important;
                line-height: 49.22px !important;
                padding-top: 0 !important;
                padding-bottom: 0 !important;
            }
            .table-multiplos select.input-colaborador:focus,
            .table-multiplos select.input-item:focus,
            .table-multiplos input.input-valor:focus,
            .table-multiplos input.input-percentual:focus,
            .table-multiplos input.input-comissao:focus {
                border-color: #1976D2 !important;
                outline: none !important;
                box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.13) !important;
            }
            /* Ajuste visual do campo descrição na tabela múltiplos lançamentos */
            .table-multiplos input.input-descricao {
                border: 2px solid #2196F3 !important;
                border-radius: 8px !important;
                background: #fff !important;
                color: #1565c0 !important;
                font-size: 14px !important;
                transition: border-color 0.3s, box-shadow 0.3s;
                box-shadow: 0 2px 8px rgba(33,150,243,0.07) !important;
                height: 49.22px !important;
                line-height: 49.22px !important;
                padding-top: 0 !important;
                padding-bottom: 0 !important;
            }
            .table-multiplos input.input-descricao:focus {
                border-color: #1976D2 !important;
                outline: none !important;
                box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.13) !important;
            }
            .table-multiplos .btn-multiplos-acao {
                width: 110px;
                min-width: 110px;
                max-width: 110px;
                box-sizing: border-box;
                margin-top: 0 !important;
                margin-bottom: 0 !important;
            }
            /* Ajuste visual dos botões Produto/Serviço na tabela múltiplos lançamentos */
            .table-multiplos .tipo-toggle-multiplo {
                display: flex !important;
                flex-direction: column !important;
                gap: 4px !important;
                align-items: center;
                justify-content: center;
            }
            /* CSS para alinhar botões em coluna e campos ao lado */
            .table-multiplos .acoes-multiplos-botoes {
                display: flex;
                flex-direction: column;
                gap: 4px;
                align-items: center;
                justify-content: center;
            }
            .table-multiplos .acoes-multiplos-parcelas {
                display: none;
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
                justify-content: center;
                height: 100%;
            }
            .table-multiplos .group-parcelas,
            .table-multiplos .group-valor-parcela {
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 4px;
            }
            .simulacao-titulos-multiplo .intervalo-vencimento-container label {
                color: #222;
            }
            .simulacao-titulos-multiplo .intervalo-vencimento-select {
                color: #222 !important;
            }
            /* CSS para botões flutuantes ao lado da linha múltiplos lançamentos */
            .botoes-flutuantes-multiplos {
                position: absolute;
                right: -60px;
                top: 50%;
                transform: translateY(-50%);
                display: flex;
                flex-direction: column;
                gap: 6px;
                z-index: 2;
            }
            @media (max-width: 1200px) {
                .botoes-flutuantes-multiplos {
                    right: -40px;
                }
            }
            .table-multiplos .acoes-multiplos-wrapper {
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: center;
                gap: 12px;
                width: 100%;
                height: 100%;
            }
            .table-multiplos .acoes-multiplos-botoes {
                display: flex;
                flex-direction: column;
                gap: 4px;
                align-items: center;
                justify-content: center;
            }
            .table-multiplos .acoes-multiplos-parcelas {
                display: none;
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
                justify-content: center;
                height: 100%;
            }
            .duplicar-excluir-multiplos .btn-duplicar, .duplicar-excluir-multiplos .btn-deletar {
                width: 32px;
                height: 32px;
                border-radius: 6px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-size: 1.1em;
                border: none;
                margin: 0 2px;
                transition: background 0.18s;
            }
            .duplicar-excluir-multiplos .btn-duplicar { background: #e3f2fd; color: #1976d2; }
            .duplicar-excluir-multiplos .btn-duplicar:hover { background: #bbdefb; }
            .duplicar-excluir-multiplos .btn-deletar { background: #ffebee; color: #c62828; }
            .duplicar-excluir-multiplos .btn-deletar:hover { background: #ffcdd2; }
            #tabSimplesContent input[type='number'],
            #tabSimplesContent input[type='date'] {
                border: 1.5px solid #90caf9;
                border-radius: 8px;
                background: #f4faff;
                color: #1565c0;
                font-size: 14px;
                padding: 10px;
                box-shadow: 0 1px 4px rgba(33,150,243,0.04);
                text-align: center;
                transition: border-color 0.2s, box-shadow 0.2s;
            }
            #tabSimplesContent input[type='number']:focus,
            #tabSimplesContent input[type='date']:focus {
                border-color: #2196F3 !important;
                outline: none;
                box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.13);
            }
            #tabSimplesContent .form-group label {
                color: #555;
                font-weight: 500;
                margin-bottom: 6px;
            }
            #tabSimplesContent .form-row {
                gap: 18px;
                align-items: flex-end;
            }
            .table-multiplos select.input-cliente,
            .table-multiplos select.input-colaborador {
                min-width: 220px;
                max-width: 100%;
                width: 100% !important;
                box-sizing: border-box;
            }
            .table-multiplos .choices.input-cliente,
            .table-multiplos .choices.input-colaborador,
            .table-multiplos .choices__inner {
                min-width: 220px !important;
                max-width: 100% !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            .table-multiplos td > .choices {
                min-width: 220px !important;
                max-width: 100% !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            .table-multiplos td > .choices,
            .table-multiplos .choices__inner {
                width: 310px !important;
                min-width: 310px !important;
                max-width: 310px !important;
                box-sizing: border-box !important;
            }
            .table-multiplos .choices__placeholder {
                text-overflow: ellipsis !important;
                overflow: hidden !important;
                white-space: nowrap !important;
                width: 100% !important;
                display: block !important;
            }
            .table-multiplos .choices__item--selectable {
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                max-width: 100% !important;
                display: block !important;
            }
        </style>
        <!-- Modal de feedback -->
        <div id="modalFeedback" class="modal-feedback" style="display:none;">
          <div class="modal-content">
            <div id="modalLoading" style="display:flex;flex-direction:column;align-items:center;">
              <div class="doc-loader">
                <svg class="doc-svg" viewBox="0 0 80 80">
                  <rect class="doc-paper" x="18" y="14" width="44" height="52" rx="6"/>
                  <line class="doc-line" x1="26" y1="28" x2="54" y2="28"/>
                  <line class="doc-line" x1="26" y1="36" x2="54" y2="36"/>
                  <line class="doc-line" x1="26" y1="44" x2="54" y2="44"/>
                  <rect class="doc-stamp" x="32" y="54" width="16" height="10" rx="3"/>
                </svg>
              </div>
              <span id="modalLoadingMsg" style="margin-top:12px;">Salvando comissão...</span>
            </div>
            <div id="modalSuccess" style="display:none;flex-direction:column;align-items:center;">
              <div class="doc-success">
                <svg class="doc-svg" viewBox="0 0 80 80">
                  <rect class="doc-paper" x="18" y="14" width="44" height="52" rx="6"/>
                  <line class="doc-line" x1="26" y1="28" x2="54" y2="28"/>
                  <line class="doc-line" x1="26" y1="36" x2="54" y2="36"/>
                  <line class="doc-line" x1="26" y1="44" x2="54" y2="44"/>
                  <rect class="doc-stamp" x="32" y="54" width="16" height="10" rx="3"/>
                  <path class="doc-check" d="M36 59 l5 5 l10 -10"/>
                  <rect class="doc-shine" x="18" y="14" width="44" height="52" rx="6"/>
                </svg>
              </div>
              <span id="modalSuccessMsg" style="margin-top:12px;font-size:1.2em;"></span>
              <button class="btn-primary" style="margin-top:18px;" onclick="fecharModalFeedback()">OK</button>
            </div>
          </div>
        </div>
        <style>
        .modal-feedback {
          position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
          background: rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: center; z-index: 9999;
        }
        .modal-feedback .modal-content {
          background: #fff; border-radius: 12px; padding: 38px 36px; min-width: 320px; box-shadow: 0 8px 32px rgba(33,150,243,0.13);
          display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 220px;
        }
        .doc-loader, .doc-success {
          display: flex; align-items: center; justify-content: center; height: 120px; margin-bottom: 8px;
          width: 100%;
        }
        .doc-svg {
          width: 80px; height: 80px; display: block; margin: 0 auto;
        }
        .doc-paper {
          stroke: #2196F3; stroke-width: 2.5; fill: #fff; stroke-dasharray: 200; stroke-dashoffset: 200;
          animation: docDraw 1.1s cubic-bezier(0.65,0,0.45,1) forwards;
        }
        .doc-line {
          stroke: #90caf9; stroke-width: 2; stroke-linecap: round; stroke-dasharray: 28; stroke-dashoffset: 28;
          animation: docLineDraw 0.5s cubic-bezier(0.65,0,0.45,1) forwards;
        }
        .doc-line:nth-of-type(2) { animation-delay: 0.3s; }
        .doc-line:nth-of-type(3) { animation-delay: 0.5s; }
        .doc-line:nth-of-type(4) { animation-delay: 0.7s; }
        .doc-stamp {
          stroke: #1976D2; stroke-width: 2; fill: #e3f2fd; stroke-dasharray: 60; stroke-dashoffset: 60;
          animation: docStampDraw 0.6s 0.8s cubic-bezier(0.65,0,0.45,1) forwards;
        }
        @keyframes docDraw {
          to { stroke-dashoffset: 0; }
        }
        @keyframes docLineDraw {
          to { stroke-dashoffset: 0; }
        }
        @keyframes docStampDraw {
          to { stroke-dashoffset: 0; }
        }
        .doc-success .doc-check {
          stroke: #43a047; stroke-width: 3.5; stroke-linecap: round; stroke-linejoin: round;
          fill: none; stroke-dasharray: 22; stroke-dashoffset: 22; opacity: 0;
          animation: docCheckDraw 0.5s 1.1s cubic-bezier(0.65,0,0.45,1) forwards, docCheckBounce 0.4s 1.6s cubic-bezier(0.34,1.56,0.64,1) forwards;
        }
        @keyframes docCheckDraw {
          to { stroke-dashoffset: 0; opacity: 1; }
        }
        @keyframes docCheckBounce {
          0% { transform: scale(1); }
          50% { transform: scale(1.18); }
          100% { transform: scale(1); }
        }
        .doc-success .doc-shine {
          stroke: none;
          fill: linear-gradient(90deg, #fff 0%, #e3f2fd 100%);
          opacity: 0.7;
          animation: docShineAnim 1.2s 1.2s linear forwards;
        }
        @keyframes docShineAnim {
          0% { opacity: 0.7; }
          100% { opacity: 0; }
        }
        </style>
        <svg width="0" height="0">
          <defs>
            <linearGradient id="progress-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#2196F3"/>
              <stop offset="100%" stop-color="#21CBF3"/>
            </linearGradient>
          </defs>
        </svg>
        <script>
        function mostrarModalFeedbackCarregando() {
          document.getElementById('modalFeedback').style.display = 'flex';
          document.getElementById('modalLoading').style.display = 'flex';
          document.getElementById('modalSuccess').style.display = 'none';
          document.getElementById('modalLoadingMsg').textContent = 'Salvando comissão...';
        }
        function mostrarModalFeedbackSucesso(msg) {
          document.getElementById('modalLoading').style.display = 'none';
          document.getElementById('modalSuccess').style.display = 'flex';
          document.getElementById('modalSuccessMsg').textContent = msg || 'Títulos gerados com sucesso!';
        }
        function fecharModalFeedback() {
          document.getElementById('modalFeedback').style.display = 'none';
        }
        </script>
        <script>
            let produtos = [];
            let servicos = [];
            let choicesItem = null;

            // Torna clientes global
            window.clientes = [];

            const selectItem = document.querySelector('div.choices-container-wrapper > select[name="item"]');
            const tipoInput = document.querySelector('#formUnico input[name="tipo"]');

            function mostrarTabComissao(tab) {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                if (tab === 'unico') {
                    document.getElementById('tabUnico').classList.add('active');
                    document.getElementById('tabUnicoContent').classList.add('active');
                } else if (tab === 'multiplo') {
                    document.getElementById('tabMultiplo').classList.add('active');
                    document.getElementById('tabMultiploContent').classList.add('active');
                    const tbody = document.getElementById('linhasMultiplo');
                    if (tbody.children.length === 0) {
                        adicionarLinhaMultiplo();
                    }
                } else if (tab === 'simples') {
                    document.getElementById('tabSimples').classList.add('active');
                    document.getElementById('tabSimplesContent').classList.add('active');
                }
            }

            function preencherItens(tipo) {
                choicesItem.enable();
                let lista = tipo === 'produto' ? produtos : servicos;
                const choices = lista.map(item => ({
                    value: item.codigo,
                    label: `${item.codigo.padStart(5, '0')} - ${item.nome}`,
                    customProperties: { preco: item.preco || 0 }
                }));
                choicesItem.setChoices(choices, 'value', 'label', true);
            }
            
            function atualizarTipoUnico() {
                const tipo = tipoInput.value;
                const label = document.getElementById('labelItemUnico');
                label.innerHTML = tipo === 'produto' ? '<i class="fas fa-box"></i> Produtos' : '<i class="fas fa-cogs"></i> Serviços';
            }

            function atualizarValorVendaPorItens() {
                let soma = 0;
                const valoresSelecionados = choicesItem.getValue(true);
                const todosItens = [...produtos, ...servicos];
                valoresSelecionados.forEach(val => {
                    const item = todosItens.find(i => i.codigo === val);
                    if (item) {
                        soma += Number(item.preco) || 0;
                    }
                });
                const campoValorVenda = document.querySelector('#formUnico input[name="valor_venda"]');
                campoValorVenda.value = formatarMoedaBR(soma);
                campoValorVenda.dispatchEvent(new Event('input'));
            }

            function calcularComissaoUnico() {
                const form = document.getElementById('formUnico');
                const valorVenda = parseFloat(form.valor_venda.value) || 0;
                const percentual = parseFloat(form.percentual.value) || 0;
                form.valor_comissao.value = (valorVenda * percentual / 100).toFixed(2);
            }

            // Variável global para armazenar colaboradores
            let colaboradoresCache = null;
            let colaboradoresCarregando = false;
            let colaboradoresCallbacks = [];

            // Função para buscar colaboradores uma única vez
            async function buscarColaboradores() {
                if (colaboradoresCache) return colaboradoresCache;
                if (colaboradoresCarregando) {
                    // Se já está carregando, retorna uma Promise que resolve quando terminar
                    return new Promise(resolve => colaboradoresCallbacks.push(resolve));
                }
                colaboradoresCarregando = true;
                try {
                    colaboradoresCache = await api.get('/colaboradores');
                    colaboradoresCallbacks.forEach(cb => cb(colaboradoresCache));
                    colaboradoresCallbacks = [];
                    return colaboradoresCache;
                } catch (error) {
                    colaboradoresCache = [];
                    colaboradoresCallbacks.forEach(cb => cb(colaboradoresCache));
                    colaboradoresCallbacks = [];
                    return [];
                } finally {
                    colaboradoresCarregando = false;
                }
            }

            // Função para preencher o select de colaborador (layout fixo, carrega opções depois)
            function preencherSelectColaborador(selectElement) {
                if (selectElement.choicesInstance) {
                    selectElement.choicesInstance.destroy();
                    selectElement.choicesInstance = null;
                }
                selectElement.innerHTML = '<option value="">Selecione...</option>';
                buscarColaboradores().then(colaboradores => {
                    if (selectElement.choicesInstance) {
                        selectElement.choicesInstance.destroy();
                        selectElement.choicesInstance = null;
                    }
                    selectElement.innerHTML = '<option value="">Selecione...</option>';
                    colaboradores.forEach(colaborador => {
                        const option = document.createElement('option');
                        option.value = colaborador.codigo;
                        option.textContent = `${colaborador.codigo} - ${colaborador.nome}`;
                        selectElement.appendChild(option);
                    });
                    selectElement.choicesInstance = new Choices(selectElement, {
                        searchEnabled: true,
                        itemSelectText: '',
                        placeholder: true,
                        placeholderValue: 'Selecione...'
                    });
                });
            }

            let numeroTituloPaiMultiplo = 1;

            function adicionarLinhaMultiplo(valores = null) {
                const tbody = document.getElementById('linhasMultiplo');
                const idx = tbody.children.length;
                const numeroPai = numeroTituloPaiMultiplo.toString().padStart(6, '0');
                numeroTituloPaiMultiplo++;
                const tr = document.createElement('tr');
                tr.setAttribute('data-numero-pai', numeroPai);
                tr.innerHTML = `
                    <td style="width: 260px;"><select name="cliente[]" required class="input-cliente" style="width: 100%; min-width:220px;"></select></td>
                    <td style="width: 260px;"><select name="colaborador[]" required class="input-colaborador" style="width: 100%; min-width:220px;"></select></td>
                    <td>
                        <div class="tipo-toggle-multiplo" style="display:flex; gap:6px; justify-content:center;">
                            <button type="button" class="btn-tipo" data-tipo="produto" onclick="toggleTipoMultiplo(this, ${idx})"><i class="fas fa-box"></i> Produto</button>
                            <button type="button" class="btn-tipo" data-tipo="servico" onclick="toggleTipoMultiplo(this, ${idx})"><i class="fas fa-cogs"></i> Serviço</button>
                            <input type="hidden" name="tipo[]" value="">
                        </div>
                    </td>
                    <td><select name="item[]" required disabled class="input-item"><option value="">Selecione o tipo primeiro</option></select></td>
                    <td><input type="text" name="descricao[]" maxlength="100" placeholder="Descrição" class="input-descricao"></td>
                    <td><input type="number" name="valor_venda[]" step="0.01" min="0" required placeholder="0.00" class="input-valor" oninput="calcularComissaoMultiplo(this, ${idx})"></td>
                    <td><input type="number" name="percentual[]" step="0.01" min="0" max="100" required placeholder="0.00" class="input-percentual" oninput="calcularComissaoMultiplo(this, ${idx})"></td>
                    <td><input type="number" name="valor_comissao[]" step="0.01" min="0" readonly placeholder="0.00" class="input-comissao"></td>
                    <td class="acao-multiplos">
                        <div class="acoes-multiplos-wrapper">
                            <div class="acoes-multiplos-botoes" style="display:flex;flex-direction:column;gap:4px;align-items:center;justify-content:center;">
                                <button type="button" class="btn-parcelado btn-multiplos-acao" onclick="toggleParceladoMultiploLinha(this)">Parcelado</button>
                                <button type="button" class="btn-simular btn-multiplos-acao" onclick="simularTitulosMultiploLinha(this)">Simular</button>
                            </div>
                            <div class="acoes-multiplos-parcelas" style="display:none;">
                                <div class="group-parcelas">
                                    <label style="font-size:0.95em;"><i class='fas fa-list-ol'></i></label>
                                    <input type='number' min='2' step='1' class='input-qtd-parcelas' style='width:60px;margin-left:2px;' oninput='atualizaValorParcelaMultiplo(this)'>
                                </div>
                                <div class="group-valor-parcela">
                                    <label style="font-size:0.95em;"><i class='fas fa-money-bill-wave'></i></label>
                                    <input type='text' class='input-valor-parcela' style='width:80px;margin-left:2px;' readonly>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="duplicar-excluir-multiplos" style="text-align:center;vertical-align:middle;">
                        <button type="button" class="btn-duplicar btn-multiplos-acao" title="Duplicar linha" onclick="duplicarLinhaMultiplo(this)"><i class="fas fa-copy"></i></button>
                        <button type="button" class="btn-deletar btn-multiplos-acao" title="Excluir linha" onclick="excluirLinhaMultiplo(this)"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
                // Adiciona linha para simulação (abaixo)
                const trSimulacao = document.createElement('tr');
                trSimulacao.className = 'linha-simulacao-multiplo';
                trSimulacao.style.display = 'none';
                trSimulacao.innerHTML = `<td colspan="9"><div class="simulacao-titulos-multiplo"></div></td>`;
                tbody.appendChild(trSimulacao);
                // Preencher colaborador (layout fixo, carrega opções depois)
                const selectColaborador = tr.querySelector('select[name="colaborador[]"]');
                preencherSelectColaborador(selectColaborador);
                // Inicializar Choices.js no campo Produto/Serviço ao criar a linha
                const selectItem = tr.querySelector('select[name="item[]"]');
                if (selectItem.choicesInstance) {
                    selectItem.choicesInstance.destroy();
                    selectItem.choicesInstance = null;
                }
                selectItem.choicesInstance = new Choices(selectItem, {
                    searchEnabled: true,
                    itemSelectText: '',
                    placeholder: true,
                    placeholderValue: 'Selecione o tipo primeiro',
                    removeItemButton: false,
                    maxItemCount: 1,
                    shouldSort: false,
                    duplicateItemsAllowed: false
                });
                // Se valores foram passados (duplicação), preencher os campos
                if (valores) {
                    tr.querySelector('input[name="descricao[]"]').value = valores.descricao || '';
                    tr.querySelector('input[name="valor_venda[]"]').value = valores.valor_venda || '';
                    tr.querySelector('input[name="percentual[]"]').value = valores.percentual || '';
                    tr.querySelector('input[name="valor_comissao[]"]').value = valores.valor_comissao || '';
                    // Preencher selects após carregamento
                    setTimeout(() => {
                        if (valores.colaborador) selectColaborador.value = valores.colaborador;
                        if (valores.tipo) {
                            const tipoBtn = tr.querySelector(`.btn-tipo[data-tipo='${valores.tipo}']`);
                            if (tipoBtn) tipoBtn.click();
                        }
                        setTimeout(() => {
                            if (valores.item) {
                                const selectItem = tr.querySelector('select[name="item[]"]');
                                selectItem.value = valores.item;
                            }
                        }, 200);
                    }, 200);
                }
                atualizarResumoMultiplo();
                // Adicione esta função no <script> principal, junto das outras funções auxiliares:
                function preencherSelectClienteMultiplo(selectElement) {
                    if (selectElement.choicesInstance) {
                        selectElement.choicesInstance.destroy();
                        selectElement.choicesInstance = null;
                    }
                    selectElement.innerHTML = '<option value="">Selecione...</option>';
                    if (window.clientes && window.clientes.length > 0) {
                        window.clientes.forEach(cliente => {
                            const option = document.createElement('option');
                            option.value = cliente.id || cliente.codigo;
                            option.textContent = (cliente.codigo_crm ? cliente.codigo_crm + ' - ' : '') + cliente.nome;
                            selectElement.appendChild(option);
                        });
                    }
                    selectElement.choicesInstance = new Choices(selectElement, {
                        searchEnabled: true,
                        itemSelectText: '',
                        placeholder: true,
                        placeholderValue: 'Selecione...'
                    });
                }
                // ... existing code ...
                // Dentro da função adicionarLinhaMultiplo, logo após criar a linha (tr):
                // ... existing code ...
                const selectCliente = tr.querySelector('select[name="cliente[]"]');
                preencherSelectClienteMultiplo(selectCliente);
                // ... existing code ...
                // Adiciona verificação de colaborador duplicado nas linhas de múltiplos lançamentos
                function verificarColaboradorDuplicadoMultiplo(select) {
                    const valorSelecionado = select.value;
                    if (!valorSelecionado) return;
                    const todosSelects = Array.from(document.querySelectorAll('select[name="colaborador[]"]'));
                    const repetidos = todosSelects.filter(s => s !== select && s.value === valorSelecionado);
                    if (repetidos.length > 0) {
                        mostrarModalAlerta('Colaborador já informado no lançamento');
                        select.value = '';
                        // Se estiver usando Choices.js, atualizar Choices também
                        if (select.choicesInstance) {
                            select.choicesInstance.setChoiceByValue('');
                        }
                    }
                }
                // Adiciona o evento ao criar cada linha de múltiplos lançamentos
                const originalAdicionarLinhaMultiplo = adicionarLinhaMultiplo;
                adicionarLinhaMultiplo = function(valores = null) {
                    originalAdicionarLinhaMultiplo(valores);
                    // Após adicionar a linha, adiciona o evento de verificação
                    const tbody = document.getElementById('linhasMultiplo');
                    const tr = tbody.querySelector('tr:last-of-type');
                    const selectColaborador = tr.querySelector('select[name="colaborador[]"]');
                    if (selectColaborador) {
                        selectColaborador.addEventListener('change', function() {
                            verificarColaboradorDuplicadoMultiplo(this);
                        });
                    }
                };
            }

            function duplicarLinhaMultiplo(btn) {
                const tr = btn.closest('tr');
                const valores = {
                    colaborador: tr.querySelector('select[name="colaborador[]"]').value,
                    tipo: tr.querySelector('input[name="tipo[]"]').value,
                    item: tr.querySelector('select[name="item[]"]').value,
                    descricao: tr.querySelector('input[name="descricao[]"]').value,
                    valor_venda: tr.querySelector('input[name="valor_venda[]"]').value,
                    percentual: tr.querySelector('input[name="percentual[]"]').value,
                    valor_comissao: tr.querySelector('input[name="valor_comissao[]"]').value
                };
                adicionarLinhaMultiplo(valores);
            }

            function excluirLinhaMultiplo(btn) {
                const tr = btn.closest('tr');
                const trSimulacao = tr.nextElementSibling;
                tr.remove();
                if (trSimulacao && trSimulacao.classList.contains('linha-simulacao-multiplo')) {
                    trSimulacao.remove();
                }
                atualizarResumoMultiplo();
            }

            // Função toggle dos botões de tipo na tabela múltiplos
            function toggleTipoMultiplo(btn, idx) {
                const container = btn.parentElement;
                const buttons = container.querySelectorAll('.btn-tipo');
                buttons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const tipo = btn.getAttribute('data-tipo');
                container.querySelector('input[name="tipo[]"]').value = tipo;
                // Atualizar select de itens
                const tr = btn.closest('tr');
                atualizarTipoMultiplo({ value: tipo, parentElement: () => btn.closest('td'), closest: tr.closest.bind(tr) }, idx);
            }

            function atualizarTipoMultiplo(select, idx) {
                // Suporte para chamada via botão (objeto customizado)
                let td, itemSelect, tipo;
                if (select instanceof HTMLElement || (select && select.tagName)) {
                    td = select.parentElement.nextElementSibling;
                    itemSelect = td.querySelector('select[name="item[]"]');
                    tipo = select.value;
                } else {
                    // chamada via toggleTipoMultiplo
                    td = select.parentElement().nextElementSibling;
                    itemSelect = td.querySelector('select[name="item[]"]');
                    tipo = select.value;
                }
                // Limpar e desabilitar o select de itens
                itemSelect.innerHTML = '<option value="">Carregando...</option>';
                itemSelect.disabled = true;
                // Destroi Choices anterior se existir
                if (itemSelect.choicesInstance) {
                    itemSelect.choicesInstance.destroy();
                    itemSelect.choicesInstance = null;
                }
                if (!tipo) {
                    itemSelect.innerHTML = '<option value="">Selecione o tipo primeiro</option>';
                    // Aplica Choices.js para manter padrão visual
                    itemSelect.choicesInstance = new Choices(itemSelect, {
                        searchEnabled: true,
                        itemSelectText: '',
                        placeholder: true,
                        placeholderValue: 'Selecione o tipo primeiro'
                    });
                    return;
                }
                // Carregar produtos ou serviços baseado no tipo selecionado
                let lista = tipo === 'produto' ? produtos : servicos;
                if (lista && lista.length > 0) {
                    itemSelect.innerHTML = '<option value="">Selecione u' + (tipo === 'produto' ? 'produto' : 'serviço') + '...</option>';
                    lista.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.codigo;
                        option.textContent = `${item.codigo.padStart(5, '0')} - ${item.nome}`;
                        option.setAttribute('data-preco', item.preco || 0);
                        itemSelect.appendChild(option);
                    });
                    // Habilitar o select de itens
                    itemSelect.disabled = false;
                    // Aplicar Choices.js no select de itens
                    itemSelect.choicesInstance = new Choices(itemSelect, {
                        searchEnabled: true,
                        itemSelectText: '',
                        placeholder: true,
                        placeholderValue: 'Selecione um ' + (tipo === 'produto' ? 'produto' : 'serviço') + '...',
                        removeItemButton: true,
                        maxItemCount: -1,
                        shouldSort: false,
                        duplicateItemsAllowed: false
                        // Removido: multiple: true
                    });
                    // Adicionar evento para atualizar valor da venda quando item for selecionado
                    itemSelect.addEventListener('change', function() {
                        const selectedOptions = Array.from(this.selectedOptions).filter(opt => opt.value);
                        let soma = 0;
                        selectedOptions.forEach(opt => {
                            soma += parseFloat(opt.getAttribute('data-preco')) || 0;
                        });
                        const valorVendaInput = td.parentElement.querySelector('input[name="valor_venda[]"]');
                        valorVendaInput.value = soma.toFixed(2);
                        // Recalcular comissão se houver percentual
                        const percentualInput = td.parentElement.querySelector('input[name="percentual[]"]');
                        if (percentualInput.value) {
                            calcularComissaoMultiplo(percentualInput, idx);
                        }
                    });
                } else {
                    itemSelect.innerHTML = '<option value="">Nenhum ' + (tipo === 'produto' ? 'produto' : 'serviço') + ' encontrado</option>';
                    // Aplica Choices.js para manter padrão visual
                    itemSelect.choicesInstance = new Choices(itemSelect, {
                        searchEnabled: true,
                        itemSelectText: '',
                        placeholder: true,
                        placeholderValue: 'Nenhum ' + (tipo === 'produto' ? 'produto' : 'serviço') + ' encontrado'
                    });
                }
            }

            function calcularComissaoMultiplo(input, idx) {
                const tr = input.closest('tr');
                const valorVenda = parseFloat(tr.querySelector('input[name="valor_venda[]"]').value) || 0;
                const percentual = parseFloat(tr.querySelector('input[name="percentual[]"]').value) || 0;
                const valorComissaoInput = tr.querySelector('input[name="valor_comissao[]"]');
                
                const valorComissao = (valorVenda * percentual / 100);
                valorComissaoInput.value = valorComissao.toFixed(2);
                
                // Atualizar resumo
                atualizarResumoMultiplo();
            }
            
            function atualizarResumoMultiplo() {
                const linhas = document.querySelectorAll('#linhasMultiplo tr:not(.linha-simulacao-multiplo)');
                let totalVendas = 0;
                let totalComissoes = 0;
                
                linhas.forEach(linha => {
                    const inputValorVenda = linha.querySelector('input[name="valor_venda[]"]');
                    const inputValorComissao = linha.querySelector('input[name="valor_comissao[]"]');
                    const valorVenda = inputValorVenda ? parseFloat(inputValorVenda.value) || 0 : 0;
                    const valorComissao = inputValorComissao ? parseFloat(inputValorComissao.value) || 0 : 0;
                    
                    totalVendas += valorVenda;
                    totalComissoes += valorComissao;
                });
                
                document.getElementById('totalLinhas').textContent = linhas.length;
                document.getElementById('valorTotalVendas').textContent = formatarMoedaBR(totalVendas);
                document.getElementById('valorTotalComissoes').textContent = formatarMoedaBR(totalComissoes);
            }

            let numeroTituloPai = 1;
            
            async function buscarNumeroBaseColaborador(div, colaboradorId) {
                let numeroBase = 1;
                try {
                    // Busca todos os títulos do colaborador
                    const titulosColab = await window.api.get(`/movimento_comissoes?colaborador_id=eq.${colaboradorId}`);
                    let maioresBases = titulosColab
                        .map(t => {
                            const match = (t.numero_titulo || '').match(/^(\d{5})/);
                            return match ? parseInt(match[1], 10) : 0;
                        })
                        .filter(n => n > 0);
                    if (maioresBases.length > 0) {
                        numeroBase = Math.max(...maioresBases) + 1;
                    }
                } catch (e) {
                    numeroBase = 1;
                }
                // Verifica se já existe outro bloco para o mesmo colaborador na tela
                const container = document.getElementById('colaboradoresVinculados');
                const outrosBlocos = Array.from(container.querySelectorAll('.colaborador-bloco'))
                    .filter(b => b !== div && b.querySelector('select[name="colaborador[]"]').value === colaboradorId);
                if (outrosBlocos.length > 0) {
                    numeroBase += outrosBlocos.length;
                }
                div.setAttribute('data-numero-base', numeroBase.toString().padStart(5, '0'));
            }

            function adicionarColaboradorUnico() {
                const container = document.getElementById('colaboradoresVinculados');
                // Bloquear se já existe bloco para o mesmo colaborador
                const selects = container.querySelectorAll('select[name="colaborador[]"]');
                const colaboradoresExistentes = Array.from(selects).map(s => s.value).filter(Boolean);
                // Cria o bloco normalmente
                let blocoCount = container.querySelectorAll('.colaborador-bloco').length;
                blocoCount++;
                const div = document.createElement('div');
                div.className = 'colaborador-bloco';
                div.setAttribute('data-numero-pai', numeroTituloPai.toString().padStart(5, '0'));
                numeroTituloPai++;
                div.innerHTML = `
                    <button type="button" class="btn-excluir-bloco" title="Remover colaborador" onclick="this.closest('.colaborador-bloco').remove()"><i class="fas fa-times"></i></button>
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-user"></i> Colaborador</label>
                            <select name="colaborador[]" required></select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-align-left"></i> Descrição</label>
                            <input type="text" name="descricao_colaborador[]" maxlength="100" placeholder="Observação ou função...">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-percent"></i> % Comissão</label>
                            <input type="number" name="percentual[]" step="0.01" min="0" max="100" required oninput="calcularValorReceberUnico(this)">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-coins"></i> Valor a Receber</label>
                            <input type="number" name="valor_receber[]" step="0.01" min="0" readonly>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn-parcelado" onclick="toggleParcelado(this)">Parcelado</button>
                            <button type="button" class="btn-simular" onclick="simularTitulos(this)">Simular</button>
                        </div>
                        <div class="form-group group-parcelas" style="display:none;">
                            <label><i class="fas fa-list-ol"></i> Qtd. Parcelas</label>
                            <input type="number" name="qtd_parcelas[]" min="2" step="1" oninput="atualizaValorParcela(this)">
                        </div>
                        <div class="form-group group-valor-parcela" style="display:none;">
                            <label><i class="fas fa-money-bill-wave"></i> Valor da Parcela</label>
                            <input type="text" name="valor_parcela[]" readonly>
                        </div>
                    </div>
                    <div class="simulacao-titulos" style="display:none;">
                        <div class="simulacao-tabela"></div>
                    </div>
                `;
                container.appendChild(div);
                
                // Carregar colaboradores no select recém-criado
                const selectColaborador = div.querySelector('select[name="colaborador[]"]');
                preencherSelectColaborador(selectColaborador);
                selectColaborador.addEventListener('change', function() {
                    // Bloquear se já existe bloco para o mesmo colaborador
                    if (this.value && colaboradoresExistentes.includes(this.value)) {
                        mostrarModalAlerta('O colaborador ja foi adicionado nesse lançamento');
                        div.remove();
                        return;
                    }
                    if (this.value) buscarNumeroBaseColaborador(div, this.value);
                });
                // Se já tem valor ao criar, buscar imediatamente
                if (selectColaborador.value) buscarNumeroBaseColaborador(div, selectColaborador.value);
            }

            function extrairNumeroBR(valor) {
                if (!valor) return 0;
                return Number(valor.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
            }

            function calcularValorReceberUnico(input) {
                const bloco = input.closest('.colaborador-bloco');
                const percentual = parseFloat(input.value) || 0;
                const form = document.getElementById('formUnico');
                const campoValorVenda = form.querySelector('input[name="valor_venda"]');
                const valorVenda = extrairNumeroBR(campoValorVenda.value);
                const valorReceber = bloco.querySelector('input[name="valor_receber[]"]');
                valorReceber.value = (valorVenda * percentual / 100).toFixed(2);
            }

            function toggleParcelado(btn) {
                const row = btn.closest('.form-row');
                const groupParcelas = row.querySelector('.group-parcelas');
                const groupValorParcela = row.querySelector('.group-valor-parcela');
                if (groupParcelas.style.display === 'none') {
                    groupParcelas.style.display = '';
                    groupValorParcela.style.display = '';
                    btn.classList.add('active');
                } else {
                    groupParcelas.style.display = 'none';
                    groupValorParcela.style.display = 'none';
                    btn.classList.remove('active');
                    row.querySelector('input[name="qtd_parcelas[]"]').value = '';
                    row.querySelector('input[name="valor_parcela[]"]').value = '';
                }
            }

            function atualizaValorParcela(input) {
                const row = input.closest('.form-row');
                const qtd = parseInt(input.value);
                const valorReceber = parseFloat(row.querySelector('input[name="valor_receber[]"]').value.replace(',','.'));
                const valorParcelaInput = row.querySelector('input[name="valor_parcela[]"]');
                if (qtd > 1 && valorReceber > 0) {
                    const valorParcela = valorReceber / qtd;
                    valorParcelaInput.value = valorParcela.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                } else {
                    valorParcelaInput.value = '';
                }
            }

            async function simularTitulos(btn) {
                const row = btn.closest('.form-row');
                const bloco = btn.closest('.colaborador-bloco');
                const colaboradorSelect = bloco.querySelector('select[name="colaborador[]"]');
                const colaboradorId = colaboradorSelect ? colaboradorSelect.value : null;
                const qtdInput = row.querySelector('input[name="qtd_parcelas[]"]');
                const valorReceberInput = row.querySelector('input[name="valor_receber[]"]');
                const simulacaoDiv = row.parentElement.querySelector('.simulacao-titulos');
                const simulacaoTabela = simulacaoDiv.querySelector('.simulacao-tabela');
                let qtd = 1;
                if (qtdInput && qtdInput.closest('.group-parcelas') && qtdInput.closest('.group-parcelas').style.display !== 'none' && qtdInput.value && parseInt(qtdInput.value) > 1) {
                    qtd = parseInt(qtdInput.value);
                }
                const valorReceber = parseFloat(valorReceberInput.value.replace(',', '.'));
                if (!valorReceber || valorReceber <= 0) {
                    simulacaoDiv.style.display = 'block';
                    simulacaoTabela.innerHTML = '<span style="color:#b71c1c;">Informe o valor a receber.</span>';
                    return;
                }
                if (!colaboradorId) {
                    simulacaoDiv.style.display = 'block';
                    simulacaoTabela.innerHTML = '<span style="color:#b71c1c;">Selecione o colaborador.</span>';
                    return;
                }
                // Exibir número simulado
                if (qtd < 1) qtd = 1;
                let html = `<table><tr><th>Nº Título</th><th>Parcela</th><th>Valor</th><th>Data de Emissão</th><th>Data de Vencimento</th></tr>`;
                const valorParcela = valorReceber / qtd;
                const hoje = new Date();
                const dataHoje = hoje.toISOString().slice(0,10);
                for (let i = 1; i <= qtd; i++) {
                    html += `<tr><td>Simulado-${i}/${qtd}</td><td>${i}</td><td>R$ ${valorParcela.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td><td><input type='date' class='simulacao-emissao-parcela' style='width:160px;' value='${dataHoje}'></td><td><input type='date' class='simulacao-vencimento-parcela' style='width:160px;'></td></tr>`;
                }
                html += '</table>';
                if (qtd > 1) {
                    html += `<div class='intervalo-vencimento-container' style='display:none; margin-top:8px;'><label style='font-weight:500;'>Intervalo entre títulos: </label> <select class='intervalo-vencimento-select' style='margin-left:6px; padding:2px 8px; border-radius:6px; border:1px solid #bbb;'><option value='' selected disabled>Selecione...</option><option value='10'>10 dias</option><option value='20'>20 dias</option><option value='30'>30 dias</option></select></div>`;
                }
                simulacaoDiv.style.display = 'block';
                simulacaoTabela.innerHTML = html;
                // Restaurar eventos para intervalo e datas
                const vencInputs = simulacaoTabela.querySelectorAll('.simulacao-vencimento-parcela');
                const intervaloContainer = simulacaoTabela.parentElement.querySelector('.intervalo-vencimento-container');
                const intervaloSelect = simulacaoTabela.parentElement.querySelector('.intervalo-vencimento-select');
                if (vencInputs.length > 1 && intervaloContainer && intervaloSelect) {
                    vencInputs[0].addEventListener('change', function() {
                        intervaloContainer.style.display = 'block';
                    });
                    intervaloSelect.addEventListener('change', function() {
                        if (!this.value) return;
                        const intervalo = parseInt(this.value);
                        const primeiraData = vencInputs[0].value;
                        if (primeiraData) {
                            let data = new Date(primeiraData);
                            for (let i = 1; i < vencInputs.length; i++) {
                                data.setDate(data.getDate() + intervalo);
                                vencInputs[i].value = data.toISOString().slice(0,10);
                            }
                        }
                    });
                }
                const emissaoInputs = simulacaoTabela.querySelectorAll('.simulacao-emissao-parcela');
                if (emissaoInputs.length > 1) {
                    emissaoInputs[0].addEventListener('change', function() {
                        if (this.value) {
                            for (let i = 1; i < emissaoInputs.length; i++) {
                                if (!emissaoInputs[i].value) emissaoInputs[i].value = this.value;
                            }
                        }
                    });
                }
            }

            document.getElementById('formUnico').valor_venda.oninput = function() {
                document.querySelectorAll('.colaborador-bloco input[name="percentual[]"]').forEach(input => {
                    calcularValorReceberUnico(input);
                });
            };

            document.addEventListener('DOMContentLoaded', async function() {
                choicesItem = new Choices(selectItem, {
                    removeItemButton: true,
                    placeholder: true,
                    placeholderValue: 'Selecione um tipo primeiro',
                    searchEnabled: true,
                    itemSelectText: '',
                });
                choicesItem.disable();

                selectItem.addEventListener('change', atualizarValorVendaPorItens);

                try {
                    // Carrega clientes globalmente
                    window.clientes = await api.get('/clientes');
                    const selectCliente = document.querySelector('div.choices-container-wrapper > select[name="cliente"]');
                    selectCliente.innerHTML = '<option value="">Selecione um cliente...</option>';
                    window.clientes.forEach(cliente => {
                        const option = document.createElement('option');
                        option.value = cliente.id || cliente.codigo;
                        option.textContent = (cliente.codigo_crm ? cliente.codigo_crm + ' - ' : '') + cliente.nome;
                        selectCliente.appendChild(option);
                    });
                    new Choices(selectCliente, {
                        searchEnabled: true,
                        itemSelectText: '',
                        placeholder: true,
                        placeholderValue: 'Selecione um cliente...'
                    });

                    produtos = await api.get('/produtos');
                    servicos = await api.get('/servicos');
                    
                    const tipoToggle = document.getElementById('tipo-toggle');
                    tipoToggle.querySelectorAll('.btn-tipo').forEach(btn => {
                        btn.addEventListener('click', function() {
                            tipoToggle.querySelectorAll('.btn-tipo').forEach(b => b.classList.remove('active'));
                            this.classList.add('active');
                            tipoInput.value = this.dataset.tipo;
                            atualizarTipoUnico();
                            preencherItens(this.dataset.tipo);
                        });
                    });
                    
                } catch (e) {
                    console.error('Erro ao carregar dados:', e);
                    choicesItem.setChoices([{ value: '', label: 'Erro ao carregar', disabled: true }]);
                }

                const btnSugere = document.getElementById('btnSugereValorVenda');
                if (btnSugere) {
                    btnSugere.addEventListener('click', function() {
                        const campoValorVenda = document.querySelector('#formUnico input[name="valor_venda"]');
                        if (window.valorVendaSugerido !== undefined) {
                            campoValorVenda.value = formatarMoedaBR(window.valorVendaSugerido);
                            campoValorVenda.dispatchEvent(new Event('input'));
                        }
                    });
                }
            });

            function formatarMoedaBR(valor) {
                return Number(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }

            let timeoutFormatMoeda = null;
            const campoValorVenda = document.querySelector('#formUnico input[name="valor_venda"]');
            campoValorVenda.addEventListener('input', function(e) {
                clearTimeout(timeoutFormatMoeda);
                let valor = this.value.replace(/[^\d,]/g, '').replace(',', '.');
                if (valor) {
                    valor = parseFloat(valor);
                    if (!isNaN(valor)) {
                        timeoutFormatMoeda = setTimeout(() => {
                            this.value = formatarMoedaBR(valor);
                        }, 400);
                    }
                }
                document.querySelectorAll('.colaborador-bloco input[name="percentual[]"]').forEach(input => {
                    calcularValorReceberUnico(input);
                });
            });

            const formUnico = document.getElementById('formUnico');
            // Removido o evento anterior que apenas formatava o valor
            // Agora o evento de submit está na função salvarComissaoUnica
            
            // Função para salvar comissão única
            async function salvarComissaoUnica(event) {
                event.preventDefault();
                mostrarModalFeedbackCarregando();
                
                const form = event.target;
                const formData = new FormData(form);
                
                // Formatar valor da venda antes de salvar
                const campoValorVenda = form.querySelector('input[name="valor_venda"]');
                campoValorVenda.value = campoValorVenda.value.replace(/[^\d,]/g, '').replace(',', '.');
                
                // Validar se há pelo menos um colaborador
                const colaboradores = document.querySelectorAll('.colaborador-bloco');
                if (colaboradores.length === 0) {
                    alert('Adicione pelo menos um colaborador antes de salvar.');
                    return;
                }
                
                // Buscar o último numero_titulo existente GLOBAL
                let ultimoNumero = 0;
                try {
                    const ultimos = await window.api.get('/movimento_comissoes?order=numero_titulo.desc&limit=1');
                    if (ultimos && ultimos.length > 0) {
                        const match = (ultimos[0].numero_titulo || '').match(/^(\d{5})/);
                        if (match) {
                            ultimoNumero = parseInt(match[1], 10);
                        }
                    }
                } catch (e) {
                    // Se der erro, começa do zero
                    ultimoNumero = 0;
                }
                // Reservar faixa de números para todos os colaboradores
                const numeroBases = [];
                for (let i = 0; i < colaboradores.length; i++) {
                    numeroBases.push((ultimoNumero + 1 + i).toString().padStart(5, '0'));
                }
                let sucesso = 0;
                let erro = 0;
                const listaComissoes = [];
                for (let i = 0; i < colaboradores.length; i++) {
                    const bloco = colaboradores[i];
                    const colaboradorSelect = bloco.querySelector('select[name="colaborador[]"]');
                    const percentualInput = bloco.querySelector('input[name="percentual[]"]');
                    const valorReceberInput = bloco.querySelector('input[name="valor_receber[]"]');
                    const descricaoInput = bloco.querySelector('input[name="descricao_colaborador[]"]');
                    const qtdParcelasInput = bloco.querySelector('input[name="qtd_parcelas[]"]');
                    let qtdParcelas = 1;
                    if (qtdParcelasInput && qtdParcelasInput.value && parseInt(qtdParcelasInput.value) > 1) {
                        qtdParcelas = parseInt(qtdParcelasInput.value);
                    }
                    if (colaboradorSelect.value && percentualInput.value) {
                        let usuarioLancamento = 'admin';
                        if (window.usuarioLogado) {
                            usuarioLancamento = window.usuarioLogado;
                        } else if (localStorage.getItem('usuarioLogado')) {
                            usuarioLancamento = localStorage.getItem('usuarioLogado');
                        }
                        // Capturar datas da simulação de títulos (se houver)
                        const simulacaoDiv = bloco.querySelector('.simulacao-titulos');
                        const emissaoInputs = simulacaoDiv ? simulacaoDiv.querySelectorAll('.simulacao-emissao-parcela') : null;
                        const vencimentoInputs = simulacaoDiv ? simulacaoDiv.querySelectorAll('.simulacao-vencimento-parcela') : null;
                        // Montar item_id como codigo-nome para todos os itens selecionados
                        const valoresSelecionados = choicesItem.getValue(true);
                        const todosItens = [...produtos, ...servicos];
                        const itensSelecionados = valoresSelecionados.map(val => {
                            const item = todosItens.find(i => i.codigo === val);
                            return item ? `${item.codigo.padStart(5, '0')}-${item.nome}` : '';
                        }).filter(Boolean);
                        const item_id = itensSelecionados.join(',');
                        for (let parcela = 0; parcela < qtdParcelas; parcela++) {
                            const dataGeracao = (emissaoInputs && emissaoInputs[parcela]) ? emissaoInputs[parcela].value : new Date().toISOString().split('T')[0];
                            const dataVencimento = (vencimentoInputs && vencimentoInputs[parcela]) ? vencimentoInputs[parcela].value : new Date().toISOString().split('T')[0];
                            const dadosComissao = {
                                cliente_id: formData.get('cliente'),
                                colaborador_id: colaboradorSelect.value,
                                item_id: item_id,
                                tipo: formData.get('tipo'),
                                valor_venda: parseFloat(formData.get('valor_venda').replace(/[^\d,]/g, '').replace(',', '.')),
                                percentual_comissao: parseFloat(percentualInput.value),
                                valor: parseFloat(valorReceberInput.value) / qtdParcelas,
                                data_geracao: dataGeracao,
                                data_vencimento: dataVencimento,
                                status: 'PENDENTE',
                                usuario_lancamento: usuarioLancamento,
                                descricao: descricaoInput ? descricaoInput.value : ''
                            };
                            listaComissoes.push(dadosComissao);
                        }
                    }
                }
                if (listaComissoes.length > 0) {
                    try {
                        await window.api.post('/movimento_comissoes', listaComissoes);
                        sucesso = listaComissoes.length;
                    } catch (error) {
                        erro = listaComissoes.length;
                        console.error('Erro ao salvar comissão:', error);
                    }
                }
                if (sucesso > 0) {
                    mostrarModalFeedbackSucesso(`Comissão lançada com sucesso para ${sucesso} colaborador(es)!`);
                    setTimeout(fecharModalFeedback, 2500);
                    form.reset();
                    document.getElementById('colaboradoresVinculados').innerHTML = '';
                    numeroTituloPai = 1;
                } else {
                    fecharModalFeedback();
                    alert('Erro ao salvar comissão. Tente novamente.');
                }
            }
            
            // Adicionar evento de submit ao formulário único
            document.getElementById('formUnico').addEventListener('submit', salvarComissaoUnica);
            
            // Função para salvar comissões múltiplas
            async function salvarComissoesMultiplas(event) {
                event.preventDefault();
                // Exibir feedback visual de carregamento (opcional)
                if (typeof mostrarModalFeedbackCarregando === 'function') mostrarModalFeedbackCarregando();

                const form = event.target;
                // Coletar dados das linhas
                const linhas = document.querySelectorAll('#linhasMultiplo tr:not(.linha-simulacao-multiplo)');
                if (linhas.length === 0) {
                    alert('Adicione pelo menos uma linha antes de salvar.');
                    if (typeof fecharModalFeedback === 'function') fecharModalFeedback();
                    return;
                }

                // Buscar o último numero_titulo existente GLOBAL
                let ultimoNumero = 0;
                try {
                    const ultimos = await window.api.get('/movimento_comissoes?order=numero_titulo.desc&limit=1');
                    if (ultimos && ultimos.length > 0) {
                        const match = (ultimos[0].numero_titulo || '').match(/^(\d{5})/);
                        if (match) {
                            ultimoNumero = parseInt(match[1], 10);
                        }
                    }
                } catch (e) {
                    ultimoNumero = 0;
                }
                // Reservar faixa de números para todas as linhas
                const numeroBases = [];
                for (let i = 0; i < linhas.length; i++) {
                    numeroBases.push((ultimoNumero + 1 + i).toString().padStart(5, '0'));
                }
                let sucesso = 0;
                let erro = 0;
                const listaComissoes = [];
                for (let i = 0; i < linhas.length; i++) {
                    const linha = linhas[i];
                    const clienteSelect = linha.querySelector('select[name="cliente[]"]');
                    const colaboradorSelect = linha.querySelector('select[name="colaborador[]"]');
                    const tipoInput = linha.querySelector('input[name="tipo[]"]');
                    const itemSelect = linha.querySelector('select[name="item[]"]');
                    const valorVendaInput = linha.querySelector('input[name="valor_venda[]"]');
                    const percentualInput = linha.querySelector('input[name="percentual[]"]');
                    const valorComissaoInput = linha.querySelector('input[name="valor_comissao[]"]');
                    const descricaoInput = linha.querySelector('input[name="descricao[]"]');
                    // Parcelamento
                    let qtdParcelas = 1;
                    const tdAcoes = linha.querySelector('.acao-multiplos');
                    if (tdAcoes) {
                        const divParcelas = tdAcoes.querySelector('.acoes-multiplos-parcelas');
                        if (divParcelas && divParcelas.style.display !== 'none') {
                            const qtdInput = divParcelas.querySelector('.input-qtd-parcelas');
                            if (qtdInput && parseInt(qtdInput.value) > 1) {
                                qtdParcelas = parseInt(qtdInput.value);
                            }
                        }
                    }
                    // Buscar datas da simulação (linha seguinte)
                    const trSimulacao = linha.nextElementSibling;
                    let emissaoInputs = null;
                    let vencimentoInputs = null;
                    if (trSimulacao && trSimulacao.classList.contains('linha-simulacao-multiplo')) {
                        emissaoInputs = trSimulacao.querySelectorAll('input.simulacao-emissao-parcela');
                        vencimentoInputs = trSimulacao.querySelectorAll('input.simulacao-vencimento-parcela');
                    }
                    // Validação ANTES de acessar propriedades
                    if (
                        !clienteSelect || !clienteSelect.value ||
                        !colaboradorSelect || !colaboradorSelect.value ||
                        !tipoInput || !tipoInput.value ||
                        !itemSelect || !itemSelect.choicesInstance ||
                        !valorVendaInput || !valorVendaInput.value ||
                        !percentualInput || !percentualInput.value ||
                        !valorComissaoInput || !valorComissaoInput.value
                    ) {
                        erro++;
                        continue;
                    }
                    // Coletar itens selecionados via Choices.js (mais seguro)
                    let valoresSelecionados = itemSelect.choicesInstance.getValue(true);
                    if (!Array.isArray(valoresSelecionados)) {
                        valoresSelecionados = valoresSelecionados ? [valoresSelecionados] : [];
                    }
                    const lista = tipoInput.value === 'produto' ? produtos : servicos;
                    const itensSelecionados = valoresSelecionados.map(val => {
                        const item = lista.find(i => i.codigo === val);
                        return item ? `${item.codigo.padStart(5, '0')}-${item.nome}` : '';
                    }).filter(Boolean);
                    const item_id = itensSelecionados.join(',');
                    for (let parcela = 0; parcela < qtdParcelas; parcela++) {
                        let dataGeracao = new Date().toISOString().split('T')[0];
                        let dataVencimento = new Date().toISOString().split('T')[0];
                        if (emissaoInputs && emissaoInputs[parcela] && emissaoInputs[parcela].value) {
                            dataGeracao = emissaoInputs[parcela].value;
                        }
                        if (vencimentoInputs && vencimentoInputs[parcela] && vencimentoInputs[parcela].value) {
                            dataVencimento = vencimentoInputs[parcela].value;
                        }
                        let usuarioLancamento = 'admin';
                        if (window.usuarioLogado) {
                            usuarioLancamento = window.usuarioLogado;
                        } else if (localStorage.getItem('usuarioLogado')) {
                            usuarioLancamento = localStorage.getItem('usuarioLogado');
                        }
                        listaComissoes.push({
                            cliente_id: clienteSelect.value,
                            colaborador_id: colaboradorSelect.value,
                            tipo: tipoInput.value,
                            item_id: item_id,
                            valor_venda: parseFloat(valorVendaInput.value),
                            percentual_comissao: parseFloat(percentualInput.value),
                            valor: parseFloat(valorComissaoInput.value) / qtdParcelas,
                            data_geracao: dataGeracao,
                            data_vencimento: dataVencimento,
                            status: 'PENDENTE',
                            usuario_lancamento: usuarioLancamento,
                            descricao: descricaoInput ? descricaoInput.value : '',
                            numero_titulo: numeroBases[i] + (qtdParcelas > 1 ? `-${(parcela+1).toString().padStart(2,'0')}` : '')
                        });
                    }
                }
                if (listaComissoes.length > 0) {
                    try {
                        await window.api.post('/movimento_comissoes', listaComissoes);
                        sucesso = listaComissoes.length;
                    } catch (error) {
                        erro = listaComissoes.length;
                        console.error('Erro ao salvar comissão:', error);
                    }
                }
                if (sucesso > 0) {
                    if (typeof mostrarModalFeedbackSucesso === 'function') mostrarModalFeedbackSucesso(`Comissão lançada com sucesso para ${sucesso} lançamento(s)!`);
                    setTimeout(() => { if (typeof fecharModalFeedback === 'function') fecharModalFeedback(); }, 2500);
                    form.reset();
                    document.getElementById('linhasMultiplo').innerHTML = '';
                } else {
                    if (typeof fecharModalFeedback === 'function') fecharModalFeedback();
                    alert('Erro ao salvar comissão. Tente novamente.');
                }
            }
            
            // Adicionar evento de submit ao formulário múltiplo
            document.getElementById('formMultiplo').addEventListener('submit', salvarComissoesMultiplas);

            // Função para alternar exibição dos campos de parcelas e valor da parcela na linha de múltiplos lançamentos
            function toggleParceladoMultiploLinha(btn) {
                const td = btn.closest('td');
                const divParcelas = td.querySelector('.acoes-multiplos-parcelas');
                if (divParcelas.style.display === 'none' || divParcelas.style.display === '') {
                    divParcelas.style.display = 'flex';
                    btn.classList.add('active');
                } else {
                    divParcelas.style.display = 'none';
                    btn.classList.remove('active');
                    divParcelas.querySelector('.input-qtd-parcelas').value = '';
                    divParcelas.querySelector('.input-valor-parcela').value = '';
                }
            }

            // Função para atualizar valor da parcela na linha de múltiplos lançamentos
            function atualizaValorParcelaMultiplo(input) {
                const td = input.closest('td');
                const tr = td.closest('tr');
                const qtd = parseInt(input.value);
                const valorComissaoInput = tr.querySelector('input[name="valor_comissao[]"]');
                const valorComissao = parseFloat(valorComissaoInput.value.replace(',','.'));
                const valorParcelaInput = td.querySelector('.input-valor-parcela');
                if (qtd > 1 && valorComissao > 0) {
                    const valorParcela = valorComissao / qtd;
                    valorParcelaInput.value = valorParcela.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                } else {
                    valorParcelaInput.value = '';
                }
            }

            // Função para simular títulos na linha de múltiplos lançamentos
            function simularTitulosMultiploLinha(btn) {
                const td = btn.closest('td');
                const tr = td.closest('tr');
                const trSimulacao = tr.nextElementSibling;
                const groupParcelas = td.querySelector('.acoes-multiplos-parcelas');
                let qtd = 1;
                if (groupParcelas && groupParcelas.style.display !== 'none') {
                    const qtdInput = groupParcelas.querySelector('input');
                    if (qtdInput && parseInt(qtdInput.value) > 1) {
                        qtd = parseInt(qtdInput.value);
                    }
                }
                const valorComissaoInput = tr.querySelector('input[name="valor_comissao[]"]');
                const valorComissao = parseFloat(valorComissaoInput.value.replace(',','.'));
                const simulacaoDiv = trSimulacao.querySelector('.simulacao-titulos-multiplo');
                if (!valorComissao || valorComissao <= 0) {
                    simulacaoDiv.innerHTML = '<span style="color:#b71c1c;">Informe o valor da comissão.</span>';
                    trSimulacao.style.display = '';
                    return;
                }
                if (qtd < 1) qtd = 1;
                let html = `<table><tr><th>Nº Título</th><th>Parcela</th><th>Valor</th><th>Data de Emissão</th><th>Data de Vencimento</th></tr>`;
                const valorParcela = valorComissao / qtd;
                const hoje = new Date();
                const dataHoje = hoje.toISOString().slice(0,10);
                for (let i = 1; i <= qtd; i++) {
                    html += `<tr><td>Simulado-${i}/${qtd}</td><td>${i}</td><td>R$ ${valorParcela.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td><td><input type='date' class='simulacao-emissao-parcela' style='width:120px;' value='${dataHoje}'></td><td><input type='date' class='simulacao-vencimento-parcela' style='width:120px;'></td></tr>`;
                }
                html += '</table>';
                if (qtd > 1) {
                    html += `<tr class='linha-intervalo-vencimento'><td colspan='5' style='text-align:left;'><div class='intervalo-vencimento-container' style='display:none; margin-top:8px;'><label style='font-weight:500;'>Intervalo entre títulos: </label><select class='intervalo-vencimento-select' style='margin-left:6px; padding:2px 8px; border-radius:6px; border:1px solid #bbb;'><option value='' selected disabled>Selecione...</option><option value='10'>10 dias</option><option value='20'>20 dias</option><option value='30'>30 dias</option></select></div></td></tr>`;
                }
                simulacaoDiv.innerHTML = html;
                trSimulacao.style.display = '';
                // Eventos para intervalos e datas
                const vencInputs2 = simulacaoDiv.querySelectorAll('.simulacao-vencimento-parcela');
                const intervaloContainer2 = simulacaoDiv.querySelector('.intervalo-vencimento-container');
                const intervaloSelect2 = simulacaoDiv.querySelector('.intervalo-vencimento-select');
                if (vencInputs2.length > 1 && intervaloContainer2 && intervaloSelect2) {
                    vencInputs2[0].addEventListener('change', function() {
                        intervaloContainer2.style.display = 'block';
                    });
                    intervaloSelect2.addEventListener('change', function() {
                        if (!this.value) return;
                        const intervalo = parseInt(this.value);
                        const primeiraData = vencInputs2[0].value;
                        if (primeiraData) {
                            let data = new Date(primeiraData);
                            for (let i = 1; i < vencInputs2.length; i++) {
                                data.setDate(data.getDate() + intervalo);
                                vencInputs2[i].value = data.toISOString().slice(0,10);
                            }
                        }
                    });
                }
                const emissaoInputs2 = simulacaoDiv.querySelectorAll('.simulacao-emissao-parcela');
                if (emissaoInputs2.length > 1) {
                    emissaoInputs2[0].addEventListener('change', function() {
                        if (this.value) {
                            for (let i = 1; i < emissaoInputs2.length; i++) {
                                if (!emissaoInputs2[i].value) emissaoInputs2[i].value = this.value;
                            }
                        }
                    });
                }
            }

            // Preencher select de colaborador na aba simples
            function preencherSelectColaboradorSimples() {
                const select = document.getElementById('colaboradorSimples');
                if (!select) return;
                select.innerHTML = '<option value="">Selecione um colaborador...</option>';
                buscarColaboradores().then(colaboradores => {
                    colaboradores.forEach(colaborador => {
                        const option = document.createElement('option');
                        option.value = colaborador.codigo;
                        option.textContent = `${colaborador.codigo} - ${colaborador.nome}`;
                        select.appendChild(option);
                    });
                    // Choices.js para visual padrão
                    if (select.choicesInstance) {
                        select.choicesInstance.destroy();
                        select.choicesInstance = null;
                    }
                    select.choicesInstance = new Choices(select, {
                        searchEnabled: true,
                        itemSelectText: '',
                        placeholder: true,
                        placeholderValue: 'Selecione um colaborador...'
                    });
                });
            }

            document.addEventListener('DOMContentLoaded', preencherSelectColaboradorSimples);

            // Salvar comissão simples
            async function salvarComissaoSimples(event) {
                event.preventDefault();
                const form = event.target;
                const colaborador = form.colaborador.value;
                const valorComissao = form.valor_comissao.value;
                if (!colaborador || !valorComissao) {
                    alert('Preencha todos os campos.');
                    return;
                }
                // Aqui você pode enviar para a API
                alert('Comissão lançada com sucesso!');
                form.reset();
            }

            document.getElementById('formSimples').addEventListener('submit', salvarComissaoSimples);

            // Função para exibir modal de alerta customizado
            function mostrarModalAlerta(msg) {
              let modal = document.getElementById('modalAlertaCustom');
              if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modalAlertaCustom';
                modal.innerHTML = `
                  <div class="modal-alerta-content">
                    <span id="modalAlertaMsg"></span>
                    <button class="btn-primary" id="btnFecharModalAlerta" style="margin-top:18px;">OK</button>
                  </div>
                `;
                Object.assign(modal.style, {
                  position: 'fixed', left: 0, top: 0, width: '100vw', height: '100vh',
                  background: 'rgba(0,0,0,0.25)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 10000
                });
                const content = modal.querySelector('.modal-alerta-content');
                Object.assign(content.style, {
                  background: '#fff', borderRadius: '12px', padding: '38px 36px', minWidth: '320px', boxShadow: '0 8px 32px rgba(33,150,243,0.13)',
                  display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', minHeight: '120px', fontSize: '1.15em', fontWeight: 500
                });
                document.body.appendChild(modal);
                modal.querySelector('#btnFecharModalAlerta').onclick = function() {
                  modal.style.display = 'none';
                };
              }
              document.getElementById('modalAlertaMsg').textContent = msg;
              modal.style.display = 'flex';
            }

            // ... existing code ...
            // Substituir alert por modal customizado na verificação de colaborador duplicado
            function verificarColaboradorDuplicadoMultiplo(select) {
                const valorSelecionado = select.value;
                if (!valorSelecionado) return;
                const todosSelects = Array.from(document.querySelectorAll('select[name="colaborador[]"]'));
                const repetidos = todosSelects.filter(s => s !== select && s.value === valorSelecionado);
                if (repetidos.length > 0) {
                    mostrarModalAlerta('Colaborador já informado no lançamento');
                    select.value = '';
                    // Se estiver usando Choices.js, atualizar Choices também
                    if (select.choicesInstance) {
                        select.choicesInstance.setChoiceByValue('');
                    }
                }
            }
            // ... existing code ...
        </script>
    </div>

    <script src="scripts/navigation.js"></script>
</body>
</html>  
