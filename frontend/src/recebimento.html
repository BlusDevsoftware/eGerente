<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Comissões - Recebimento</title>
    <link rel="icon" type="image/png" href="assets/images/logo2.png">
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="styles/login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* Estilos seguindo o padrão do sistema */
        .main-content {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding-bottom: 80px; /* Igual à aba movimento comissões */
        }

        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .card {
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.06);
            padding: 20px 24px;
            border: 1px solid #eef2f7;
        }

        .card.clickable { cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .card.clickable:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(33,150,243,0.15); }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .card-header h3 {
            margin: 0;
            color: #2b2f36;
            font-size: 0.95em;
            font-weight: 600;
        }

        .card-header i {
            color: #0d6efd;
            font-size: 1.1em;
            background: #eaf2ff;
            border-radius: 50%;
            padding: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .card-value {
            font-size: 1.7em;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 6px;
        }

        .card-change {
            font-size: 0.85em;
            color: #10b981;
            font-weight: 500;
        }

        .filters-container {
            display: flex;
            gap: 18px;
            align-items: center;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(33,150,243,0.08);
            padding: 18px 24px;
            margin-bottom: 24px;
            width: 100%;
            box-sizing: border-box;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: #f4faff;
            border: 1.5px solid #90caf9;
            border-radius: 8px;
            padding: 6px 14px;
            color: #1565c0;
            font-size: 1em;
            box-shadow: 0 1px 4px rgba(33,150,243,0.04);
        }

        .search-box input[type='text'] {
            border: none;
            background: transparent;
            color: #1565c0;
            font-size: 1em;
            outline: none;
            margin-left: 8px;
            width: 220px;
            min-width: 160px;
            max-width: 100%;
        }

        .filter-options {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-options select,
        .filter-options input[type='date'] {
            border: 1.5px solid #90caf9;
            border-radius: 8px;
            background: #f4faff;
            color: #1565c0;
            font-size: 1em;
            padding: 7px 12px;
            box-shadow: 0 1px 4px rgba(33,150,243,0.04);
            transition: border-color 0.2s, box-shadow 0.2s;
            width: 180px;
            min-width: 140px;
        }

        .filter-options select:focus,
        .filter-options input[type='date']:focus {
            outline: none;
            border-color: #1976D2;
            box-shadow: 0 2px 8px rgba(33,150,243,0.15);
        }

        .btn-filter {
            background: #1976D2;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9em;
        }

        .btn-filter:hover {
            background: #1565c0;
        }

        .btn-secondary {
            background: #fff;
            color: #1976D2;
            border: 1.5px solid #2196F3;
        }

        .btn-secondary:hover {
            background: #f4faff;
        }

        .titulos-grid-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }





        .titulos-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            align-content: start;
            justify-content: start;
        }

        .titulos-grid-container {
            max-height: 85vh;
            width: 100%;
            height: 96.5%;
            overflow-y: auto;
            position: relative;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(33,150,243,0.07);
            background: #fff;
            margin-bottom: 16px;
            padding-bottom: 24px; /* espaço inferior consistente */
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
        }

        .titulos-grid-container::-webkit-scrollbar {
            width: 8px;
        }

        .titulos-grid-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .titulos-grid-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .titulos-grid-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .titulo-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(33,150,243,0.07);
            border: 1px solid #e3f2fd;
            padding: 10px;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            min-width: 0;
            width: auto;
            height: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-height: 160px;
        }

        .titulo-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(33,150,243,0.15);
        }

        .titulo-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #90caf9;
        }

        .titulo-card.PENDENTE::before { background: #FF9800; }
        .titulo-card.VENCIDO::before { background: #f44336; }
        .titulo-card.PAGO::before { background: #4CAF50; }
        .titulo-card.CLIENTE-NÃO-PAGOU::before { background: #f57c00; }
        .titulo-card.AGLUTINADO::before { background: #7b1fa2; }

        .titulo-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .titulo-cliente {
            font-weight: 600;
            color: #1565c0;
            font-size: 1em;
            margin: 0;
            line-height: 1.2;
        }

        .titulo-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .titulo-status.pendente {
            background: #fff3cd;
            color: #856404;
        }

        .titulo-status.atrasado {
            background: #f8d7da;
            color: #721c24;
        }

        .titulo-status.recebido {
            background: #d4edda;
            color: #155724;
        }

        .titulo-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 6px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .info-value {
            font-size: 1em;
            color: #333;
            font-weight: 600;
        }

        .titulo-valor {
            font-size: 1em;
            font-weight: 700;
            color: #1976D2;
            text-align: center;
            margin: 6px 0;
            padding: 6px;
            background: #f4faff;
            border-radius: 6px;
            border: 1px solid #e3f2fd;
        }

        .titulo-observacoes {
            font-size: 0.75em;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.25;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-clamp: 2;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .titulo-acoes {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .btn-acao {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-visualizar {
            background: #e3f2fd;
            color: #1976D2;
        }

        .btn-visualizar:hover {
            background: #bbdefb;
        }

        .btn-editar {
            background: #fff3e0;
            color: #f57c00;
        }

        .btn-editar:hover {
            background: #ffe0b2;
        }

        .btn-comprovante { background-color: #198754 !important; color: #fff !important; }
        .btn-comprovante i { color: #fff !important; }
        .btn-comprovante:hover { opacity: 0.9; }

        .comprovante-btn { background-color: #198754 !important; color: #fff !important; }
        .comprovante-btn i { color: #fff !important; }
        .comprovante-btn:hover { opacity: 0.9; }

        .timeline-btn {
            min-width: 28px;
            width: 28px;
            height: 28px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,152,0,0.15);
            color: #ff9800;
            border: 1.5px solid #ffcc80;
            font-weight: 500;
            margin: 0 auto;
            transition: background 0.18s, border 0.18s, color 0.18s;
            border-radius: 4px;
        }
        .timeline-btn i { font-size: 1em; color: #ff9800; }
        .timeline-btn:hover {
            background: rgba(255,152,0,0.28);
            border-color: #ff9800;
            color: #e65100;
        }

        .table-scroll {
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(33,150,243,0.07);
            background: #fff;
            margin-bottom: 16px;
            padding-bottom: 24px;
            flex: 1 1 auto;
        }

        .table-scroll table {
            width: 100%;
            border-collapse: collapse;
        }

        .table-scroll th, .table-scroll td {
            border: 1px solid #eee;
            padding: 10px 8px;
            text-align: center;
            font-size: 1em;
        }

        .table-scroll th {
            background: #e3f2fd;
            color: #1565c0;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .table-scroll td {
            background: #fff;
            color: #333;
        }

        .table-scroll tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-PAGO {
            background: #d4edda;
            color: #155724;
        }

        .status-PENDENTE {
            background: #fff3cd;
            color: #856404;
        }

        .status-VENCIDO {
            background: #f8d7da;
            color: #721c24;
        }

        .status-CLIENTE-NÃO-PAGOU {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-AGLUTINADO {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            margin: 0 2px;
            border-radius: 6px;
            transition: all 0.2s ease;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover { opacity: 0.8; }
        .action-btn i { font-size: 14px; }

        .view-btn { background-color: #0d6efd; color: white; }

        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 0;
            background: transparent;
            border-radius: 0;
            box-shadow: none;
            margin-top: 0;
        }

        .pagination button {
            padding: 6px 10px;
            border: 1px solid #90caf9;
            background: #fff;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            color: #1565c0;
            font-weight: 500;
            font-size: 0.9em;
        }

        .pagination button:hover {
            background: #f4faff;
            border-color: #1976D2;
        }

        .pagination button.active {
            background: #1976D2;
            color: white;
            border-color: #1976D2;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .filter-options {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-options select,
            .filter-options input[type='date'] {
                width: 100%;
            }
            
            #barraInferior {
                left: 0; /* Em mobile, a sidebar pode estar oculta */
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo" style="display: flex; align-items: center; justify-content: center; padding: 15px 0;">
            <img src="assets/images/logo2.png" alt="BlueDev Logo" style="height: 2.5em; margin-right: 10px;"><h1><span class="orange">e-</span><span class="highlight">Gerente</span></h1>
        </div>
        <ul class="nav-menu">
            <li><a href="index.html"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-user-plus"></i><span>Cadastros</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="colaboradores.html"><i class="fas fa-users"></i><span>Colaboradores</span></a></li>
                    <li><a href="clientes.html"><i class="fas fa-user-tie"></i><span>Clientes</span></a></li>
                    <li><a href="produtos.html"><i class="fas fa-box"></i><span>Produtos</span></a></li>
                    <li><a href="servicos.html"><i class="fas fa-cogs"></i><span>Serviços</span></a></li>
                    <li><a href="usuarios.html"><i class="fas fa-user-shield"></i><span>Usuários</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-hand-holding-usd"></i><span>Comissões</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="lancar-comissao.html"><i class="fas fa-plus-circle"></i><span>Lançar</span></a></li>
                    <li><a href="movimento-comissao.html"><i class="fas fa-exchange-alt"></i><span>Movimento</span></a></li>
                    <li><a href="consulta-comissao.html"><i class="fas fa-search"></i><span>Consulta</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-chart-bar"></i><span>Relatórios</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="recebimento.html" class="active"><i class="fas fa-money-bill-wave"></i><span>Recebimento</span></a></li>
                    <li><a href="conferencia.html"><i class="fas fa-check-circle"></i><span>Conferência</span></a></li>
                    <li><a href="dinamico.html"><i class="fas fa-chart-line"></i><span>Dinâmico</span><span class="beta-tag">beta</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-cog"></i><span>Configurações</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="manutencao-bd.html"><i class="fas fa-database"></i><span>Manutenção BD</span></a></li>
                    <li><a href="sincronizar.html"><i class="fas fa-sync"></i><span>Sincronizar</span></a></li>
                </ul>
            </li>
        </ul>
        <div class="logout-button">
            <a href="index.html"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="welcome-text">
                <h1>Relatório de Recebimento</h1>
                <p>Meu Dashboard Financeiro - Acompanhe sua situação financeira</p>
            </div>
            <div class="user-info">
                <div class="notifications">
                    <i class="fas fa-bell"></i>
                    <span class="badge">3</span>
                </div>
                <div class="user-avatar">A</div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="dashboard-cards">
            <div class="card clickable" id="cardTotalRecebido" onclick="filtrarPorCard('PAGO')">
                <div class="card-header">
                    <h3>Total Recebido</h3>
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="card-value" id="totalRecebido">R$ 0,00</div>
                <div class="card-change" id="totalRecebidoChange">&nbsp;</div>
            </div>
            <div class="card clickable" id="cardPendente" onclick="filtrarPorCard('PENDENTE')">
                <div class="card-header">
                    <h3>Pendentes</h3>
                    <i class="fas fa-clock"></i>
                </div>
                <div class="card-value" id="totalPendente">R$ 0,00</div>
                <div class="card-change" id="totalPendenteChange">&nbsp;</div>
            </div>
            <div class="card clickable" id="cardClienteNaoPagou" onclick="filtrarPorCard('CLIENTE NÃO PAGOU')">
                <div class="card-header">
                    <h3>Cliente Não Pagou</h3>
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="card-value" id="totalAtrasado">R$ 0,00</div>
                <div class="card-change" id="totalAtrasadoChange">&nbsp;</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3>Média Mensal</h3>
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="card-value" id="mediaMensal">R$ 0,00</div>
                <div class="card-change" id="mediaMensalChange">&nbsp;</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-container">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input id="busca" type="text" placeholder="Buscar títulos...">
            </div>
            <div class="filter-options">
                <select id="periodo">
                    <option value="mes_atual">Mês Atual</option>
                    <option value="ultimos_3_meses">Últimos 3 Meses</option>
                    <option value="ultimos_6_meses">Últimos 6 Meses</option>
                    <option value="ano_atual">Ano Atual</option>
                    <option value="personalizado">Personalizado</option>
                </select>
                <select id="status">
                    <option value="">Todos os Status</option>
                    <option value="PENDENTE">Pendente</option>
                    <option value="PAGO">Pago</option>
                    <option value="VENCIDO">Vencido</option>
                    <option value="CLIENTE NÃO PAGOU">Cliente não pagou</option>
                    <option value="AGLUTINADO">Aglutinado</option>
                </select>
                <select id="colaborador">
                    <option value="">Todos os Colaboradores</option>
                    <option value="cliente1">Cliente A</option>
                    <option value="cliente2">Cliente B</option>
                    <option value="cliente3">Cliente C</option>
                </select>
                <input type="date" id="data_inicial" placeholder="Data inicial">
                <span style="margin: 0 6px; color: #1976D2; font-weight: bold;">até</span>
                <input type="date" id="data_final" placeholder="Data final">
                <button class="btn-filter" onclick="aplicarFiltros()">
                    <i class="fas fa-filter"></i>
                    Aplicar
                </button>
                <button class="btn-filter btn-secondary" onclick="limparFiltros()">
                    <i class="fas fa-times"></i>
                    Limpar
                </button>
            </div>
        </div>



        <!-- Grid de Títulos a Receber -->
        <div class="titulos-grid-section">
            <div class="titulos-grid-container">
                <div class="titulos-grid" id="titulosGrid">
                    <!-- Cards de títulos serão inseridos dinamicamente -->
                </div>
            </div>
        </div>

        <!-- Commissions Table -->
        <div class="table-scroll">
            <table id="recebimentoTable">
                <thead>
                    <tr>
                        <th style="width:40px;"></th>
                        <th>Nº Título</th>
                        <th>Data da Geração</th>
                        <th>Data de Vencimento</th>
                        <th>Colaborador</th>
                        <th>Tipo</th>
                        <th>Descrição</th>
                        <th>Valor</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="recebimentoTableBody">
                    <!-- Dados serão carregados dinamicamente -->
                </tbody>
            </table>
        </div>

        <!-- Paginação e Ações -->
        <div class="filters-container" id="barraInferior" style="position: fixed; bottom: 20px; left: 250px; z-index: 1000; background: #fff; border-top: 1px solid #e3f2fd; justify-content: space-between; padding: 8px 24px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); height: 60px; box-sizing: border-box; margin: 0 24px; border-radius: 10px; border: 1px solid #e3f2fd;">
            <div>
                <button class="btn-filter btn-secondary" onclick="alternarVisualizacao(this)" style="padding: 6px 12px; font-size: 0.85em;">
                    <i class="fas fa-list"></i>
                    Ver Tabela
                </button>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <label for="exibirQtd" style="color:#1565c0; font-weight:600;">Exibir</label>
                <select id="exibirQtd" onchange="aplicarPaginacaoQuantidade()" style="border: 1.5px solid #90caf9; border-radius: 8px; background: #f4faff; color: #1565c0; padding: 5px 10px;">
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="todos">Todos</option>
                </select>
                <span id="contadorTitulos" style="color:#1565c0; font-weight:600;">Títulos: 0</span>
            </div>
        </div>
    </div>

    <script>
        // Toggle submenu
        document.querySelectorAll('.submenu-trigger').forEach(trigger => {
            trigger.addEventListener('click', function(e) {
                e.preventDefault();
                this.parentElement.classList.toggle('active');
            });
        });

        // Variáveis globais para dados
        let todosTitulos = [];
        let titulosFiltrados = [];
        let mapaColaboradores = {};
        let limiteExibicao = 20; // padrão

        // Função para carregar colaboradores
        async function carregarColaboradores() {
            try {
                const colaboradores = await window.api.get('/colaboradores');
                if (Array.isArray(colaboradores)) {
                    colaboradores.forEach(colab => {
                        mapaColaboradores[colab.codigo] = colab.nome;
                    });
                    // Preencher filtro de colaborador
                    const selectColab = document.getElementById('colaborador');
                    if (selectColab) {
                        selectColab.innerHTML = '<option value="">Todos os Colaboradores</option>';
                        colaboradores.forEach(colab => {
                            selectColab.innerHTML += `<option value="${colab.nome}">${colab.nome}</option>`;
                        });
                    }
                }
            } catch (e) {
                console.error('Erro ao carregar colaboradores:', e);
            }
        }

        // Função para carregar títulos da API
        async function carregarTitulos() {
            try {
                // Garante estado zerado antes de iniciar fetch
                zerarCards();
                await carregarColaboradores();
                const data = await window.api.get('/movimento_comissoes');

                // Atualizar status para VENCIDO quando vencimento < hoje e não pago
                const todayStr = new Date().toISOString().split('T')[0];
                const atualizacoes = [];
                const titulos = Array.isArray(data) ? data : [];
                
                titulos.forEach(t => {
                    const statusAtual = (t.status || '').toUpperCase();
                    const venc = t.data_vencimento;
                    const naoPago = statusAtual !== 'PAGO';
                    const naoAglutinado = statusAtual !== 'AGLUTINADO';
                    
                    if (naoPago && naoAglutinado && venc && typeof venc === 'string' && venc < todayStr && statusAtual !== 'VENCIDO') {
                        t.status = 'VENCIDO';
                        atualizacoes.push(
                            window.api.put(`/movimento_comissoes/${t.id}`, { status: 'VENCIDO' }).catch(() => {})
                        );
                    }

                    // Normalizar colaborador para exibir nome
                    // Considera possíveis formas vindas da API: codigo em t.colaborador ou t.colaborador_codigo
                    if (t && mapaColaboradores) {
                        const possivelCodigo = t.colaborador_codigo || t.colaborador_codigo_id || t.colaborador_id || t.colaborador;
                        if (possivelCodigo && mapaColaboradores[possivelCodigo]) {
                            t.colaborador = mapaColaboradores[possivelCodigo];
                        }
                    }
                });

                // Disparar atualizações em background
                if (atualizacoes.length) {
                    Promise.allSettled(atualizacoes).catch(() => {});
                }

                todosTitulos = titulos;
                titulosFiltrados = [...todosTitulos];
                
                // Atualizar cards totalizadores com animação após pequeno delay para garantir zeros iniciais
                setTimeout(() => {
                    atualizarCardsTotalizadores();
                    atualizarCardsComAnimacao();
                }, 50);
                
                // Carregar visualizações
                carregarGridTitulos();
                carregarTabela();
                // Sincronizar após conteúdo dinâmico ser inserido
                requestAnimationFrame(sincronizarAlturaConteudo);
                
            } catch (e) {
                console.error('Erro ao carregar títulos:', e);
                // Fallback para dados mockados em caso de erro
                todosTitulos = [
                    {
                        id: 1,
                        numero_titulo: 'TIT-001',
                        data_geracao: '2024-02-20',
                        data_vencimento: '2024-03-20',
                        colaborador: 'João Silva',
                        tipo: 'Comissão',
                        descricao: 'Comissão referente a venda #123',
                        valor: 1500.00,
                        status: 'PAGO',
                        observacoes: 'Pagamento referente a venda #123'
                    }
                ];
                titulosFiltrados = [...todosTitulos];
                carregarGridTitulos();
                carregarTabela();
                setTimeout(() => {
                    atualizarCardsTotalizadores();
                    atualizarCardsComAnimacao();
                }, 50);
                requestAnimationFrame(sincronizarAlturaConteudo);
            }
        }

        // Função para atualizar cards totalizadores
        function atualizarCardsTotalizadores() {
            const pagos = todosTitulos.filter(t => t.status === 'PAGO');
            const totalRecebido = pagos.reduce((sum, t) => sum + parseFloat(t.valor || 0), 0);
            
            const pendentes = todosTitulos.filter(t => t.status === 'PENDENTE');
            const totalPendente = pendentes.reduce((sum, t) => sum + parseFloat(t.valor || 0), 0);
            
            const inadimplentes = todosTitulos.filter(t => t.status === 'CLIENTE NÃO PAGOU');
            const totalClienteNaoPagou = inadimplentes.reduce((sum, t) => sum + parseFloat(t.valor || 0), 0);
            
            const mediaMensal = totalRecebido / 6; // Simplificado para demonstração

            document.getElementById('totalRecebido').textContent = `R$ ${totalRecebido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('totalPendente').textContent = `R$ ${totalPendente.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('totalAtrasado').textContent = `R$ ${totalClienteNaoPagou.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('mediaMensal').textContent = `R$ ${mediaMensal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;

            // Quantidades como na aba de movimento de comissão
            const recebidosQtd = pagos.length;
            const pendentesQtd = pendentes.length;
            const inadimplentesQtd = inadimplentes.length;

            const plural = (n) => n === 1 ? 'título' : 'títulos';
            const setText = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt; };
            setText('totalRecebidoChange', `${recebidosQtd} ${plural(recebidosQtd)}`);
            setText('totalPendenteChange', `${pendentesQtd} ${plural(pendentesQtd)}`);
            setText('totalAtrasadoChange', `${inadimplentesQtd} ${plural(inadimplentesQtd)}`);
            setText('mediaMensalChange', 'Últimos 6 meses');
        }

        // Anima a contagem de valores nos cards
        function animarNumero(elemento, valorFinal) {
            const el = typeof elemento === 'string' ? document.getElementById(elemento) : elemento;
            if (!el) return;
            // Garante que começamos do zero e com prefixo consistente
            const prefixo = 'R$ ';
            el.textContent = `${prefixo}0,00`;
            const duracao = 600;
            const inicio = performance.now();
            const startVal = 0;
            function frame(now) {
                const p = Math.min(1, (now - inicio) / duracao);
                const eased = p < 0.5 ? 2*p*p : -1 + (4 - 2*p)*p; // easeInOutQuad
                const atual = Math.round(eased * valorFinal);
                el.textContent = `${prefixo}${atual.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                if (p < 1) requestAnimationFrame(frame);
            }
            requestAnimationFrame(frame);
        }

        function zerarCards() {
            const ids = ['totalRecebido', 'totalPendente', 'totalAtrasado', 'mediaMensal'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = 'R$ 0,00';
            });
            const changes = ['totalRecebidoChange','totalPendenteChange','totalAtrasadoChange','mediaMensalChange'];
            changes.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '&nbsp;';
            });
        }

        function atualizarCardsComAnimacao() {
            const pagos = todosTitulos.filter(t => t.status === 'PAGO');
            const pendentes = todosTitulos.filter(t => t.status === 'PENDENTE');
            const inadimplentes = todosTitulos.filter(t => t.status === 'CLIENTE NÃO PAGOU');
            const totalRecebido = pagos.reduce((s, t) => s + parseFloat(t.valor || 0), 0);
            const totalPendente = pendentes.reduce((s, t) => s + parseFloat(t.valor || 0), 0);
            const totalClienteNaoPagou = inadimplentes.reduce((s, t) => s + parseFloat(t.valor || 0), 0);
            const mediaMensal = totalRecebido / 6;
            animarNumero('totalRecebido', Math.floor(totalRecebido));
            animarNumero('totalPendente', Math.floor(totalPendente));
            animarNumero('totalAtrasado', Math.floor(totalClienteNaoPagou));
            animarNumero('mediaMensal', Math.floor(mediaMensal));

            const plural = (n) => n === 1 ? 'título' : 'títulos';
            const setText = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt; };
            setText('totalRecebidoChange', `${pagos.length} ${plural(pagos.length)}`);
            setText('totalPendenteChange', `${pendentes.length} ${plural(pendentes.length)}`);
            setText('totalAtrasadoChange', `${inadimplentes.length} ${plural(inadimplentes.length)}`);
            setText('mediaMensalChange', 'Últimos 6 meses');
        }

        function filtrarPorCard(status) {
            // Aplica o status e recarrega
            const sel = document.getElementById('status');
            if (sel) sel.value = status === 'PAGO' ? 'PAGO' : status;
            aplicarFiltros();
            // Garante que cards fiquem visíveis após filtro
            const btnToggle = document.querySelector('#barraInferior button');
            if (btnToggle && document.querySelector('.titulos-grid-section').style.display === 'none') {
                btnToggle.click();
            }
        }

        // Carregar grid de títulos
        function carregarGridTitulos() {
            const grid = document.getElementById('titulosGrid');
            grid.innerHTML = '';

            const lista = limitarListaParaExibicao(titulosFiltrados);
            lista.forEach(titulo => {
                const card = document.createElement('div');
                card.className = `titulo-card ${titulo.status.replace(/\s+/g, '-')}`;
                card.onclick = () => visualizarTitulo(titulo.numero_titulo);
                
                // Sanitização básica para evitar HTML indesejado em strings
                const esc = (s) => String(s || '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
                const nomeColab = mapaColaboradores[titulo.colaborador] || mapaColaboradores[titulo.colaborador_codigo] || titulo.colaborador || '';

                card.innerHTML = `
                    <div class="titulo-header">
                        <h4 class="titulo-cliente">${esc(titulo.numero_titulo)}</h4>
                        <span class="titulo-status ${titulo.status.replace(/\s+/g, '-')}">${getStatusText(titulo.status)}</span>
                    </div>
                    
                    <div class="titulo-info">
                        <div class="info-item">
                            <span class="info-label">Colaborador</span>
                            <span class="info-value">${esc(nomeColab)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Tipo</span>
                            <span class="info-value">${esc(titulo.tipo)}</span>
                        </div>
                    </div>
                    
                    <div class="titulo-info">
                        <div class="info-item">
                            <span class="info-label">Geração</span>
                            <span class="info-value">${formatarData(titulo.data_geracao)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Vencimento</span>
                            <span class="info-value">${formatarData(titulo.data_vencimento)}</span>
                        </div>
                    </div>
                    
                    <div class="titulo-valor">
                        R$ ${titulo.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                    </div>
                    
                    <div class="titulo-observacoes">
                        ${esc(titulo.descricao)}
                    </div>
                    
                                <div class="titulo-acoes">
                <button class="timeline-btn" onclick="event.stopPropagation(); abrirTimeline('${titulo.numero_titulo}')" title="Linha do Tempo">
                    <i class="fas fa-clock"></i>
                </button>
                <button class="btn-acao btn-visualizar" onclick="event.stopPropagation(); visualizarTitulo('${titulo.numero_titulo}')">
                    <i class="fas fa-eye"></i>
                    Visualizar
                </button>
                <button class="btn-acao btn-comprovante" onclick="event.stopPropagation(); visualizarComprovante('${titulo.numero_titulo}')">
                    <i class="fas fa-file-invoice"></i>
                    Comprovante
                </button>
            </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // Carregar tabela com dados
        function carregarTabela() {
            const tbody = document.getElementById('recebimentoTableBody');
            tbody.innerHTML = '';

            const lista = limitarListaParaExibicao(titulosFiltrados);
            lista.forEach((titulo, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><button class="timeline-btn" title="Linha do Tempo" onclick="abrirTimeline('${titulo.numero_titulo}')">
                        <i class="fas fa-clock"></i>
                    </button></td>
                    <td>${titulo.numero_titulo}</td>
                    <td>${formatarData(titulo.data_geracao)}</td>
                    <td>${formatarData(titulo.data_vencimento)}</td>
                    <td>${titulo.colaborador}</td>
                    <td>${titulo.tipo}</td>
                    <td>${titulo.descricao}</td>
                    <td>R$ ${titulo.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td><span class="status-badge status-${titulo.status.replace(/\s+/g, '-')}">${getStatusText(titulo.status)}</span></td>
                    <td>
                        <button class="action-btn view-btn" title="Visualizar" onclick="visualizarTitulo('${titulo.numero_titulo}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn comprovante-btn" title="Visualizar Comprovante" onclick="visualizarComprovante('${titulo.numero_titulo}')">
                            <i class="fas fa-file-invoice"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function limitarListaParaExibicao(lista) {
            const contador = document.getElementById('contadorTitulos');
            if (contador) {
                contador.textContent = `Títulos: ${lista.length}`;
            }
            if (String(limiteExibicao) === 'todos') return lista;
            const limite = parseInt(limiteExibicao, 10);
            if (!isNaN(limite)) return lista.slice(0, limite);
            return lista;
        }

        function aplicarPaginacaoQuantidade() {
            const sel = document.getElementById('exibirQtd');
            if (!sel) return;
            limiteExibicao = sel.value;
            carregarGridTitulos();
            carregarTabela();
            requestAnimationFrame(sincronizarAlturaConteudo);
        }

        // Funções auxiliares
        function formatarData(data) {
            return new Date(data).toLocaleDateString('pt-BR');
        }

        function getStatusText(status) {
            const statusMap = {
                'PAGO': 'Pago',
                'PENDENTE': 'Pendente',
                'VENCIDO': 'Vencido',
                'CLIENTE NÃO PAGOU': 'Cliente não pagou',
                'AGLUTINADO': 'Aglutinado'
            };
            return statusMap[status] || status;
        }

        function aplicarFiltros() {
            const status = document.getElementById('status').value;
            const colaborador = document.getElementById('colaborador').value;
            const dataInicial = document.getElementById('data_inicial').value;
            const dataFinal = document.getElementById('data_final').value;
            const periodo = document.getElementById('periodo').value;
            const busca = (document.getElementById('busca')?.value || '').trim().toLowerCase();

            // Aplicar filtros
            titulosFiltrados = todosTitulos.filter(titulo => {
                let passa = true;

                // Filtro por status
                if (status && titulo.status !== status) {
                    passa = false;
                }

                // Filtro por colaborador
                if (colaborador && titulo.colaborador !== colaborador) {
                    passa = false;
                }

                // Filtro por período
                if (dataInicial && titulo.data_geracao < dataInicial) {
                    passa = false;
                }

                if (dataFinal && titulo.data_geracao > dataFinal) {
                    passa = false;
                }

                // Filtro por busca livre (nº título, colaborador, descrição)
                if (busca) {
                    const texto = `${String(titulo.numero_titulo || '')} ${String(titulo.colaborador || '')} ${String(titulo.descricao || '')}`.toLowerCase();
                    if (!texto.includes(busca)) {
                        passa = false;
                    }
                }

                return passa;
            });

            // Atualizar visualizações
            carregarGridTitulos();
            carregarTabela();
            aplicarPaginacaoQuantidade();
        }

        function limparFiltros() {
            document.getElementById('periodo').value = 'mes_atual';
            document.getElementById('status').value = '';
            const colabSel = document.getElementById('colaborador');
            if (colabSel) colabSel.value = '';
            document.getElementById('data_inicial').value = '';
            document.getElementById('data_final').value = '';
            const buscaInput = document.getElementById('busca');
            if (buscaInput) buscaInput.value = '';
            
            // Resetar filtros
            titulosFiltrados = [...todosTitulos];
            carregarGridTitulos();
            carregarTabela();
            aplicarPaginacaoQuantidade();
        }

        function exportarDados() {
            alert('Exportando dados...');
            // Implementar exportação para Excel/PDF
        }

        function atualizarDados() {
            alert('Atualizando dados...');
            // Implementar atualização em tempo real
        }

        function mudarPagina(pagina) {
            alert(`Mudando para página: ${pagina}`);
            // Implementar paginação
        }

        function visualizarTitulo(cliente) {
            alert(`Visualizando título do cliente: ${cliente}`);
            // Implementar modal de visualização
        }

        function editarTitulo(cliente) {
            alert(`Editando título do cliente: ${cliente}`);
            // Implementar modal de edição
        }

        function visualizarComprovante(numeroTitulo) {
            console.log('Visualizar comprovante do título:', numeroTitulo);
            // Buscar o título nos dados reais
            const titulo = todosTitulos.find(t => t.numero_titulo === numeroTitulo);
            if (titulo) {
                // Simular modal de comprovante
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0,0,0,0.5);
                    z-index: 4000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;

                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 24px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    position: relative;
                `;

                modalContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-file-invoice" style="color: #2e7d32;"></i>
                            Comprovante - ${titulo.numero_titulo}
                        </h2>
                        <button onclick="this.closest('.modal').remove()" style="
                            background: none;
                            border: none;
                            font-size: 1.5em;
                            color: #666;
                            cursor: pointer;
                            padding: 5px;
                        ">&times;</button>
                    </div>
                    <div style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 20px; background: #fafafa;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h3 style="color: #2e7d32; margin: 0;">COMPROVANTE DE PAGAMENTO</h3>
                            <p style="color: #666; margin: 5px 0;">Título: ${titulo.numero_titulo}</p>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <strong>Colaborador:</strong><br>
                                ${titulo.colaborador}
                            </div>
                            <div>
                                <strong>Tipo:</strong><br>
                                ${titulo.tipo}
                            </div>
                            <div>
                                <strong>Data de Geração:</strong><br>
                                ${formatarData(titulo.data_geracao)}
                            </div>
                            <div>
                                <strong>Data de Vencimento:</strong><br>
                                ${formatarData(titulo.data_vencimento)}
                            </div>
                        </div>
                        <div style="text-align: center; margin: 20px 0; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                            <div style="font-size: 0.9em; color: #666;">Valor Total</div>
                            <div style="font-size: 1.8em; font-weight: bold; color: #2e7d32;">
                                R$ ${titulo.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                            </div>
                        </div>
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                            <div style="font-size: 0.9em; color: #666;">
                                <strong>Status:</strong> ${getStatusText(titulo.status)}
                            </div>
                            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                <strong>Observações:</strong> ${titulo.observacoes}
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="window.print()" style="
                            background: #2e7d32;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-weight: 500;
                        ">Imprimir Comprovante</button>
                    </div>
                `;

                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                // Fechar modal ao clicar fora
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
        }

        function abrirTimeline(numeroTitulo) {
            console.log('Abrir timeline do título:', numeroTitulo);
            // Buscar o título nos dados reais
            const titulo = todosTitulos.find(t => t.numero_titulo === numeroTitulo);
            if (titulo) {
                // Simular dados de timeline para demonstração
                const eventosTimeline = [
                    {
                        data: titulo.data_geracao,
                        evento: 'Título Gerado',
                        descricao: `Título ${numeroTitulo} foi criado com valor de R$ ${titulo.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`
                    },
                    {
                        data: titulo.data_vencimento,
                        evento: 'Data de Vencimento',
                        descricao: `Vencimento previsto para ${formatarData(titulo.data_vencimento)}`
                    }
                ];

                // Se o título for PAGO, adicionar evento de pagamento
                if (titulo.status === 'PAGO') {
                    eventosTimeline.push({
                        data: titulo.data_vencimento,
                        evento: 'Título Pago',
                        descricao: `Pagamento realizado no valor de R$ ${titulo.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`
                    });
                }

                // Se o título for VENCIDO, adicionar evento de vencimento
                if (titulo.status === 'VENCIDO') {
                    eventosTimeline.push({
                        data: titulo.data_vencimento,
                        evento: 'Título Vencido',
                        descricao: `Título vencido em ${formatarData(titulo.data_vencimento)}`
                    });
                }

                // Mostrar modal com timeline
                mostrarModalTimeline(titulo, eventosTimeline);
            }
        }

        function mostrarModalTimeline(titulo, eventos) {
            // Criar modal de timeline
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0,0,0,0.5);
                z-index: 4000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 24px;
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
            `;

            let eventosHTML = '';
            eventos.forEach((evento, index) => {
                eventosHTML += `
                    <div style="display: flex; margin-bottom: 20px; position: relative;">
                        <div style="
                            width: 12px;
                            height: 12px;
                            background: #ff9800;
                            border-radius: 50%;
                            margin-right: 16px;
                            margin-top: 4px;
                            flex-shrink: 0;
                        "></div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 4px;">
                                ${evento.evento}
                            </div>
                            <div style="color: #666; font-size: 0.9em; margin-bottom: 4px;">
                                ${formatarData(evento.data)}
                            </div>
                            <div style="color: #555; font-size: 0.95em;">
                                ${evento.descricao}
                            </div>
                        </div>
                        ${index < eventos.length - 1 ? `
                            <div style="
                                position: absolute;
                                left: 5px;
                                top: 16px;
                                width: 2px;
                                height: 20px;
                                background: #e0e0e0;
                            "></div>
                        ` : ''}
                    </div>
                `;
            });

            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #333; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-clock" style="color: #ff9800;"></i>
                        Linha do Tempo - ${titulo.numero_titulo}
                    </h2>
                    <button onclick="this.closest('.modal').remove()" style="
                        background: none;
                        border: none;
                        font-size: 1.5em;
                        color: #666;
                        cursor: pointer;
                        padding: 5px;
                    ">&times;</button>
                </div>
                <div style="margin-bottom: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px;">
                    <div style="font-weight: 600; color: #333; margin-bottom: 4px;">
                        ${titulo.numero_titulo} - ${titulo.colaborador}
                    </div>
                    <div style="color: #666; font-size: 0.9em;">
                        Valor: R$ ${titulo.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})} | Status: ${getStatusText(titulo.status)}
                    </div>
                </div>
                <div style="padding-left: 8px;">
                    ${eventosHTML}
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Fechar modal ao clicar fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function mostrarApenasGrid() {
            const gridSection = document.querySelector('.titulos-grid-section');
            const tableSection = document.querySelector('.table-scroll');
            const paginationSection = document.querySelector('.filters-container:last-of-type');
            
            // Mostrar apenas a grid
            gridSection.style.display = 'block';
            tableSection.style.display = 'none';
            paginationSection.style.display = 'flex';
        }

        function alternarVisualizacao(btn) {
            const gridSection = document.querySelector('.titulos-grid-section');
            const tableSection = document.querySelector('.table-scroll');
            const paginationSection = document.querySelector('.filters-container:last-of-type');
            
            if (gridSection.style.display === 'none') {
                // Mostrar grid, esconder tabela
                gridSection.style.display = 'block';
                tableSection.style.display = 'none';
                paginationSection.style.display = 'flex';
                
                // Atualizar texto do botão
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-list"></i> Ver Tabela';
                }
            } else {
                // Mostrar tabela, esconder grid
                gridSection.style.display = 'none';
                tableSection.style.display = 'block';
                paginationSection.style.display = 'flex';
                
                // Atualizar texto do botão
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-th-large"></i> Ver Cards';
                }
            }

            // Sincronizar altura após alternar
            requestAnimationFrame(sincronizarAlturaConteudo);
            setTimeout(sincronizarAlturaConteudo, 60);
        }

        // Calcula e aplica a mesma altura máxima para grid e tabela (evita sobrepor a barra inferior)
        function sincronizarAlturaConteudo() {
            try {
                const barra = document.getElementById('barraInferior');
                const gridContainer = document.querySelector('.titulos-grid-container');
                const tableContainer = document.querySelector('.table-scroll');
                if (!gridContainer || !tableContainer) return;

                const topGrid = gridContainer.getBoundingClientRect().top;
                const topTable = tableContainer.getBoundingClientRect().top;
                const limiteInferior = barra ? barra.getBoundingClientRect().top : window.innerHeight;
                const folga = 20; // folga para manter espaçamento inferior igual ao superior da grid

                const disponivelGrid = Math.max(200, Math.floor(limiteInferior - topGrid - folga));
                const disponivelTable = Math.max(200, Math.floor(limiteInferior - topTable - folga));

                gridContainer.style.maxHeight = disponivelGrid + 'px';
                gridContainer.style.height = disponivelGrid + 'px';
                tableContainer.style.maxHeight = disponivelTable + 'px';
                tableContainer.style.height = disponivelTable + 'px';
            } catch (_) {}
        }

        // Inicializar quando a página carregar
        window.addEventListener('DOMContentLoaded', function() {
            // Zerar cards antes de qualquer carregamento para evitar flash
            zerarCards();
            // Carregar dados da API
            carregarTitulos();
            
            // Iniciar mostrando apenas os cards (grid)
            mostrarApenasGrid();

            // Sincronizar altura após montar layout inicial
            setTimeout(() => {
                ajustarBarraInferior();
                sincronizarAlturaConteudo();
            }, 50);
        });

        // Atualizar dados a cada 5 minutos
        setInterval(function() {
            // Aqui você pode implementar atualização automática
            console.log('Verificando atualizações...');
        }, 300000);

        // Ajustar posição da barra inferior quando necessário
        function ajustarBarraInferior() {
            const barra = document.getElementById('barraInferior');
            const sidebar = document.querySelector('.sidebar');
            
            if (barra && sidebar) {
                const sidebarWidth = sidebar.offsetWidth;
                const margin = 48; // 24px de cada lado
                barra.style.left = sidebarWidth + 'px';
                barra.style.width = `calc(100vw - ${sidebarWidth}px - ${margin}px)`;
            }
        }

        // Ajustar quando a janela for redimensionada
        window.addEventListener('resize', function() {
            ajustarBarraInferior();
            sincronizarAlturaConteudo();
        });
        
        // Ajustar quando a sidebar for expandida/recolhida
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(ajustarBarraInferior, 100);
        });
    </script>
    <script src="scripts/config/api.js"></script>
    <script src="scripts/navigation.js"></script>
    <script>
    window.addEventListener('DOMContentLoaded', function() {
        if (typeof initializeMenu === 'function') {
            initializeMenu();
        }
        document.querySelectorAll('.nav-menu a').forEach(function(link) {
            link.addEventListener('click', function() {
                var modais = ['paymentModal', 'viewModal', 'baixaModal'];
                modais.forEach(function(id) {
                    var modal = document.getElementById(id);
                    if (modal) modal.style.display = 'none';
                });
            });
        });
    });
    </script>
</body>
</html> 
