<!-- ========================================
     MODAIS DE EXCLUSÃO E CANCELAMENTO DE BAIXA
     Sistema de Movimento de Comissões
     ======================================== -->

<!-- Modal de Confirmação de Exclusão -->
<div id="modalConfirmExclusao" class="modal" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.18); z-index: 4000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
  <div class="modal-content" style="background: #fff; border-radius: 16px; max-width: 520px; width: 98%; min-height: auto; max-height: 90vh; box-shadow: 0 8px 32px rgba(33,150,243,0.13); padding: 0; margin: auto; overflow: hidden; display: flex; flex-direction: column;">
    <div class="modal-header" style="padding: 28px 40px 0 40px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;">
      <h2 style="margin: 0; font-size: 1.35em; color: #e53935; display: flex; align-items: center; gap: 10px; font-weight: 700;"><i class="fas fa-exclamation-triangle"></i> Confirmar Exclusão</h2>
      <button class="close-modal" onclick="fecharModalConfirmExclusao()" style="background: none; border: none; font-size: 1.3em; color: #666; cursor: pointer; padding: 5px; transition: color 0.3s;">&times;</button>
    </div>
    <div class="modal-body" style="padding: 32px 40px 0 40px; text-align: center; flex: 1; overflow-y: auto; min-height: 0;">
      <i class="fas fa-exclamation-triangle" style="font-size: 2.5em; color: #e53935; margin-bottom: 12px;"></i>
      <div style="font-size: 1.15em; font-weight: 500; margin-bottom: 8px;">Tem certeza que deseja excluir este título?</div>
      <div style="font-size: 1em; color: #888; margin-bottom: 18px;">Esta ação não pode ser desfeita.</div>
      
      <!-- Opções de exclusão para parcelamentos -->
      <div id="opcoesExclusaoParcelamento" style="display: none; background: #f5f5f5; border-radius: 8px; padding: 16px; margin-bottom: 18px; text-align: left;">
        <div style="font-weight: 500; margin-bottom: 12px; color: #333;">Opções de exclusão:</div>
        <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
          <input type="radio" name="exclusaoParcelamento" value="unico" checked style="margin-right: 8px;">
          <span>Excluir apenas este título</span>
        </label>
        <label style="display: flex; align-items: center; cursor: pointer;">
          <input type="radio" name="exclusaoParcelamento" value="todos" style="margin-right: 8px;">
          <span>Excluir todos os títulos do parcelamento</span>
        </label>
      </div>
      
      <!-- Lista de títulos parciais -->
      <div id="listaTitulosParciais" style="display: none; background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 18px; text-align: left;">
        <div style="font-weight: 500; margin-bottom: 8px; color: #333;">Títulos relacionados:</div>
        <div id="titulosParciaisLista" style="max-height: 100px; overflow-y: auto; font-size: 0.9em;"></div>
      </div>
      
      <!-- Seção de animação de exclusão -->
      <div id="animacaoExclusaoDiv" style="display: none; margin: 20px 0; text-align: center; background: #f8f9fa; border-radius: 12px; padding: 20px; border: 1px solid #e9ecef;">
        <div style="font-weight: 600; color: #1976D2; margin-bottom: 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
          <i class="fas fa-spinner fa-spin" style="font-size: 1.2em;"></i>
          <span id="textoProgressoExclusao">Iniciando exclusão...</span>
        </div>
        <div style="width: 100%; background-color: #e3f2fd; border-radius: 8px; height: 12px; overflow: hidden; margin-bottom: 12px;">
          <div id="barraProgressoExclusao" style="width: 0%; height: 100%; background: linear-gradient(90deg, #1976D2, #42a5f5); border-radius: 8px; transition: width 0.5s ease; box-shadow: 0 2px 4px rgba(25, 118, 210, 0.3);"></div>
        </div>
        <div style="font-size: 0.9em; color: #666; font-style: italic;">
          Processando exclusão...
        </div>
      </div>
    </div>
    <div class="modal-footer" id="footerExclusaoBtns" style="display: flex; justify-content: flex-end; gap: 10px; padding: 24px 40px 32px 40px; border-top: 1px solid #eee; flex-shrink: 0;">
      <button id="btnCancelarExclusao" class="btn-secondary" style="padding: 10px 20px; border-radius: 4px; font-size: 15px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; background-color: #fff; color: #333; border: 1px solid #ddd;"><i class="fas fa-times"></i> Cancelar</button>
      <button id="btnConfirmarExclusao" class="btn-danger" style="padding: 10px 20px; border-radius: 4px; font-size: 15px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; background-color: #e53935; color: white; border: none;"><i class="fas fa-trash"></i> Excluir</button>
    </div>
  </div>
</div>

<!-- Modal de Sucesso de Exclusão -->
<div id="modalSucessoExclusao" class="modal" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.18); z-index: 5000; align-items: center; justify-content: center;">
  <div class="modal-content" style="background: #fff; border-radius: 12px; max-width: 370px; width: 96%; box-shadow: 0 8px 32px rgba(33,150,243,0.13); padding: 0;">
    <div class="modal-header" style="padding: 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between;">
      <h2 style="margin: 0; font-size: 1.2em; color: #43a047; display: flex; align-items: center; gap: 10px; font-weight: 700;"><i class="fas fa-check-circle"></i> Título excluído com sucesso!</h2>
      <button class="close-modal" onclick="fecharModalSucessoExclusao()" style="background: none; border: none; font-size: 1.3em; color: #666; cursor: pointer; padding: 5px; transition: color 0.3s;">&times;</button>
    </div>
    <div class="modal-body" style="padding: 24px 32px 0 32px; text-align: center;">
      <i class="fas fa-check-circle" style="font-size: 2.5em; color: #43a047; margin-bottom: 12px;"></i>
      <div style="font-size: 1.1em; font-weight: 500; margin-bottom: 8px;">O título foi removido do sistema.</div>
    </div>
    <div class="modal-footer" style="display: flex; justify-content: center; gap: 10px; padding: 18px 32px 24px 32px; border-top: 1px solid #eee;">
      <button id="btnOkSucessoExclusao" class="btn-success" style="padding: 10px 32px; border-radius: 4px; font-size: 15px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; background-color: #43a047; color: white; border: none;"><i class="fas fa-check"></i> OK</button>
    </div>
  </div>
</div>

<!-- Modal de Confirmação de Cancelar Baixa -->
<div id="modalConfirmCancelarBaixa" class="modal" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.18); z-index: 3000; align-items: center; justify-content: center;">
  <div class="modal-content" style="background: #fff; border-radius: 16px; max-width: 480px; width: 98%; box-shadow: 0 8px 32px rgba(255,152,0,0.13); padding: 0;">
    <div class="modal-header" style="padding: 28px 40px 0 40px; display: flex; align-items: center; justify-content: space-between;">
      <h2 style="margin: 0; font-size: 1.35em; color: #ff9800; display: flex; align-items: center; gap: 10px; font-weight: 700;"><i class="fas fa-exclamation-triangle"></i> Confirmar Cancelamento de Baixa</h2>
      <button class="close-modal" onclick="fecharModalConfirmCancelarBaixa()" style="background: none; border: none; font-size: 1.3em; color: #666; cursor: pointer; padding: 5px; transition: color 0.3s;">&times;</button>
    </div>
    <div class="modal-body" style="padding: 32px 40px 0 40px; text-align: center;">
      <i class="fas fa-undo" style="font-size: 2.5em; color: #ff9800; margin-bottom: 12px;"></i>
      <div style="font-size: 1.15em; font-weight: 500; margin-bottom: 8px;">Tem certeza que deseja cancelar a baixa deste título?</div>
      <div style="font-size: 1em; color: #888; margin-bottom: 18px;">Esta ação irá:</div>
      <div style="text-align: left; background: #fff3e0; border: 1px solid #ffcc02; border-radius: 8px; padding: 16px; margin-bottom: 18px;">
        <ul style="margin: 0; padding-left: 20px; color: #e65100;">
          <li>Alterar o status para "PENDENTE"</li>
          <li>Zerar o valor pago</li>
          <li>Limpar a data de pagamento</li>
          <li>Remover o comprovante (se existir)</li>
        </ul>
      </div>
      <div style="font-size: 0.95em; color: #666; font-style: italic;">Esta ação pode ser desfeita editando o título novamente.</div>
    </div>
    <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; padding: 24px 40px 32px 40px; border-top: 1px solid #eee;">
      <button id="btnCancelarConfirmacao" class="btn-secondary" onclick="fecharModalConfirmCancelarBaixa()" style="padding: 10px 20px; border-radius: 4px; font-size: 15px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; background-color: #fff; color: #333; border: 1px solid #ddd;"><i class="fas fa-times"></i> Cancelar</button>
      <button id="btnConfirmarCancelarBaixa" class="btn-warning" onclick="executarCancelarBaixa()" style="padding: 10px 20px; border-radius: 4px; font-size: 15px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; background-color: #ff9800; color: white; border: none;"><i class="fas fa-undo"></i> Confirmar Cancelamento</button>
    </div>
  </div>
</div>

<!-- Modal de Sucesso de Cancelamento de Baixa -->
<div id="modalSucessoCancelarBaixa" class="modal" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.18); z-index: 3000; align-items: center; justify-content: center;">
  <div class="modal-content" style="background: #fff; border-radius: 12px; max-width: 400px; width: 96%; box-shadow: 0 8px 32px rgba(255,152,0,0.13); padding: 0;">
    <div class="modal-header" style="padding: 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between;">
      <h2 style="margin: 0; font-size: 1.2em; color: #ff9800; display: flex; align-items: center; gap: 10px; font-weight: 700;"><i class="fas fa-check-circle"></i> Baixa cancelada com sucesso!</h2>
      <button class="close-modal" onclick="fecharModalSucessoCancelarBaixa()" style="background: none; border: none; font-size: 1.3em; color: #666; cursor: pointer; padding: 5px; transition: color 0.3s;">&times;</button>
    </div>
    <div class="modal-body" style="padding: 24px 32px 0 32px; text-align: center;">
      <i class="fas fa-undo" style="font-size: 2.5em; color: #ff9800; margin-bottom: 12px;"></i>
      <div style="font-size: 1.1em; font-weight: 500; margin-bottom: 8px;">A baixa do título foi cancelada.</div>
      <div style="font-size: 0.95em; color: #666; margin-bottom: 8px;">O título agora está com status "PENDENTE".</div>
    </div>
    <div class="modal-footer" style="display: flex; justify-content: center; gap: 10px; padding: 18px 32px 24px 32px; border-top: 1px solid #eee;">
      <button id="btnOkSucessoCancelarBaixa" class="btn-warning" style="padding: 10px 32px; border-radius: 4px; font-size: 15px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; background-color: #ff9800; color: white; border: none;"><i class="fas fa-check"></i> OK</button>
    </div>
  </div>
</div>

<!-- Modal de Sucesso de Baixa Múltipla -->
<div id="modalSucessoBaixaMultipla" class="modal" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.18); z-index: 3000; align-items: center; justify-content: center;">
  <div class="modal-content" style="background: #fff; border-radius: 16px; max-width: 480px; width: 96%; box-shadow: 0 8px 32px rgba(76,175,80,0.13); padding: 0;">
    <div class="modal-header" style="padding: 28px 40px 0 40px; display: flex; align-items: center; justify-content: space-between;">
      <h2 style="margin: 0; font-size: 1.35em; color: #4CAF50; display: flex; align-items: center; gap: 10px; font-weight: 700;"><i class="fas fa-check-circle"></i> Baixa Múltipla Realizada!</h2>
      <button class="close-modal" onclick="fecharModalSucessoBaixaMultipla()" style="background: none; border: none; font-size: 1.3em; color: #666; cursor: pointer; padding: 5px; transition: color 0.3s;">&times;</button>
    </div>
    <div class="modal-body" style="padding: 32px 40px 0 40px; text-align: center;">
      <div style="background: #e8f5e8; border-radius: 50%; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px auto;">
        <i class="fas fa-check-double" style="font-size: 2.5em; color: #4CAF50;"></i>
      </div>
      
      <div style="font-size: 1.2em; font-weight: 600; margin-bottom: 8px; color: #333;">Baixa múltipla concluída com sucesso!</div>
      <div style="font-size: 1em; color: #666; margin-bottom: 24px;">
        Todos os títulos selecionados foram processados e atualizados no sistema.
      </div>
      
      <!-- Resumo da operação -->
      <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 12px; padding: 20px; margin-bottom: 24px; text-align: left;">
        <div style="font-weight: 600; color: #333; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-info-circle" style="color: #1976D2;"></i>
          Resumo da Operação
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.95em;">
          <div style="background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;">
            <div style="font-weight: 500; color: #1976D2; margin-bottom: 4px;">Títulos Processados</div>
            <div id="quantidadeTitulosSucesso" style="color: #333; font-weight: 600;"></div>
          </div>
          
          <div style="background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;">
            <div style="font-weight: 500; color: #1976D2; margin-bottom: 4px;">Data do Pagamento</div>
            <div id="dataPagamentoSucesso" style="color: #333; font-weight: 600;"></div>
          </div>
          
          <div style="background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;">
            <div style="font-weight: 500; color: #1976D2; margin-bottom: 4px;">Status Aplicado</div>
            <div id="statusAplicadoSucesso" style="color: #4CAF50; font-weight: 600;"></div>
          </div>
          
          <div style="background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;">
            <div style="font-weight: 500; color: #1976D2; margin-bottom: 4px;">Comprovante</div>
            <div id="comprovanteSucesso" style="color: #333; font-weight: 600;"></div>
          </div>
        </div>
      </div>
      
      <!-- Mensagem de confirmação -->
      <div style="background: #e8f5e8; border: 1px solid #4CAF50; border-radius: 12px; padding: 16px; margin-bottom: 24px;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <i class="fas fa-check-circle" style="color: #4CAF50; font-size: 1.2em;"></i>
          <div style="text-align: left;">
            <div style="font-weight: 600; color: #2e7d32; margin-bottom: 4px;">Operação Concluída!</div>
            <div style="font-size: 0.95em; color: #2e7d32;">
              Todos os títulos foram atualizados com sucesso no sistema.
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer" style="display: flex; justify-content: center; gap: 12px; padding: 24px 40px 32px 40px; border-top: 1px solid #eee;">
      <button id="btnOkSucessoBaixaMultipla" class="btn-success" style="padding: 12px 28px; border-radius: 8px; font-size: 15px; font-weight: 500; cursor: pointer; background-color: #4CAF50; color: white; border: none; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;">
        <i class="fas fa-check"></i>
        OK
      </button>
    </div>
  </div>
</div>

<!-- Modal de Título Pago Não Pode Excluir -->
<div id="modalTituloPagoNaoPodeExcluir" class="modal" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.18); z-index: 4000; align-items: center; justify-content: center;">
  <div class="modal-content" style="background: #fff; border-radius: 16px; max-width: 480px; width: 96%; box-shadow: 0 8px 32px rgba(255,152,0,0.13); padding: 0;">
    <div class="modal-header" style="padding: 28px 40px 0 40px; display: flex; align-items: center; justify-content: space-between;">
      <h2 style="margin: 0; font-size: 1.35em; color: #4CAF50; display: flex; align-items: center; gap: 10px; font-weight: 700;"><i class="fas fa-check-circle"></i> Título Já Pago</h2>
      <button class="close-modal" onclick="fecharModalTituloPagoNaoPodeExcluir()" style="background: none; border: none; font-size: 1.3em; color: #666; cursor: pointer; padding: 5px; transition: color 0.3s;">&times;</button>
    </div>
    <div class="modal-body" style="padding: 32px 40px 0 40px; text-align: center;">
      <div style="background: #e8f5e8; border-radius: 50%; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px auto;">
        <i class="fas fa-check-circle" style="font-size: 2.5em; color: #4CAF50;"></i>
      </div>
      
      <div style="font-size: 1.2em; font-weight: 600; margin-bottom: 8px; color: #333;">Este título já foi pago!</div>
      <div style="font-size: 1em; color: #666; margin-bottom: 24px;">
        O título <strong id="numeroTituloPago" style="color: #1976D2;"></strong> já possui status <strong style="color: #4CAF50;">PAGO</strong> e não pode ser excluído.
      </div>
      
      <!-- Informações detalhadas do título -->
      <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 12px; padding: 20px; margin-bottom: 24px; text-align: left;">
        <div style="font-weight: 600; color: #333; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-info-circle" style="color: #1976D2;"></i>
          Detalhes do Pagamento
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.95em;">
          <div style="background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;">
            <div style="font-weight: 500; color: #1976D2; margin-bottom: 4px;">Data do Pagamento</div>
            <div id="dataPagamentoTitulo" style="color: #333; font-weight: 600;"></div>
          </div>
          
          <div style="background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;">
            <div style="font-weight: 500; color: #1976D2; margin-bottom: 4px;">Valor Pago</div>
            <div id="valorPagoTitulo" style="color: #333; font-weight: 600;"></div>
          </div>
          
          <div style="background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;">
            <div style="font-weight: 500; color: #1976D2; margin-bottom: 4px;">Colaborador</div>
            <div id="colaboradorTituloPago" style="color: #333; font-weight: 600;"></div>
          </div>
          
          <div style="background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;">
            <div style="font-weight: 500; color: #1976D2; margin-bottom: 4px;">Status</div>
            <div style="color: #4CAF50; font-weight: 600; display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-check-circle"></i>
              PAGO
            </div>
          </div>
        </div>
        
        <div id="observacoesTitulo" style="display: none; margin-top: 12px;">
          <div style="background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;">
            <div style="font-weight: 500; color: #1976D2; margin-bottom: 4px;">Observações</div>
            <div id="textoObservacoesTitulo" style="color: #333; font-style: italic;"></div>
          </div>
        </div>
      </div>
      
      <!-- Aviso sobre como proceder -->
      <div style="background: #fff3e0; border: 1px solid #ffcc02; border-radius: 12px; padding: 16px; margin-bottom: 24px;">
        <div style="display: flex; align-items: flex-start; gap: 12px;">
          <i class="fas fa-lightbulb" style="color: #ff9800; font-size: 1.2em; margin-top: 2px;"></i>
          <div style="text-align: left;">
            <div style="font-weight: 600; color: #e65100; margin-bottom: 6px;">Como proceder?</div>
            <div style="font-size: 0.95em; color: #e65100;">
              Para excluir este título, você deve primeiro <strong>cancelar a baixa</strong> através da opção "Cancelar Baixa" no menu de ações do título.
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer" style="display: flex; justify-content: center; gap: 12px; padding: 24px 40px 32px 40px; border-top: 1px solid #eee;">
      <button class="btn-secondary" onclick="fecharModalTituloPagoNaoPodeExcluir()" style="padding: 12px 28px; border-radius: 8px; font-size: 15px; font-weight: 500; cursor: pointer; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;">
        <i class="fas fa-times"></i>
        Entendi
      </button>
    </div>
  </div>
</div>

<!-- NOVO: Modal de Aglutinação de Títulos -->
<div id="modalAglutinacaoTitulos" class="modal" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.18); z-index: 4500; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
  <div class="modal-content" style="background: #fff; border-radius: 16px; max-width: 680px; width: 98%; min-height: auto; max-height: 90vh; box-shadow: 0 8px 32px rgba(33,150,243,0.13); padding: 0; margin: auto; overflow: hidden; display: flex; flex-direction: column;">
    <div class="modal-header" style="padding: 28px 40px 0 40px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;">
      <h2 style="margin: 0; font-size: 1.35em; color: #ff9800; display: flex; align-items: center; gap: 10px; font-weight: 700;"><i class="fas fa-object-group"></i> Aglutinar Títulos</h2>
      <button class="close-modal" onclick="fecharModalAglutinacao()" style="background: none; border: none; font-size: 1.3em; color: #666; cursor: pointer; padding: 5px; transition: color 0.3s;">&times;</button>
    </div>
    <div class="modal-body" style="padding: 24px 40px 0 40px; text-align: left; flex: 1; overflow-y: auto; min-height: 0;">
      <div style="font-size: 1.05em; color: #555; margin-bottom: 12px;">Foram selecionados <strong id="quantidadeTitulosAglutinar" style="color:#ff9800;">0</strong> título(s) para aglutinação.</div>

      <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
        <div style="font-weight: 600; color: #333; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-list" style="color:#1976D2;"></i>
          Títulos Selecionados
        </div>
        <div id="listaTitulosAglutinacao" style="max-height: 260px; overflow-y: auto; font-size: 0.95em;">
          <!-- preenchido dinamicamente -->
        </div>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div style="background:#fff; border:1px solid #e3f2fd; border-radius:8px; padding:12px;">
          <div style="font-weight:500; color:#1976D2; margin-bottom:4px;">Total dos Valores</div>
          <div id="valorTotalAglutinar" style="color:#333; font-weight:700;">R$ 0,00</div>
        </div>
        <div style="background:#fff; border:1px solid #e3f2fd; border-radius:8px; padding:12px;">
          <div style="font-weight:500; color:#1976D2; margin-bottom:4px;">Colaborador</div>
          <div id="colaboradorAglutinacao" style="color:#333; font-weight:700;">-</div>
        </div>
      </div>

      <!-- NOVO: Simulação do novo título aglutinado -->
      <div id="simulacaoAglutinacao" style="margin-top:12px; background:#e3f2fd; border:2px solid #1976D2; border-radius:12px; padding:16px;">
        <!-- preenchido dinamicamente em abrirModalAglutinacao -->
      </div>

      <!-- NOVO: Campo de Observação / Motivo da Aglutinação -->
      <div style="margin-top:12px; background:#fff; border:1px solid #e3f2fd; border-radius:8px; padding:12px;">
        <div style="font-weight:500; color:#1976D2; margin-bottom:6px;">Observação / Motivo da Aglutinação</div>
        <textarea id="observacaoAglutinacaoInput" placeholder="Descreva o motivo da aglutinação..." maxlength="500" style="width:100%; min-height:96px; border:1px solid #e0e0e0; border-radius:8px; padding:10px; font-size:0.95em; resize:vertical;"></textarea>
        <div id="observacaoAglutinacaoCount" style="text-align:right; color:#888; font-size:0.85em; margin-top:6px;">0/500</div>
      </div>

      <div style="margin-top:16px; background:#fff3e0; border:1px solid #ffcc02; border-radius:8px; padding:12px; color:#e65100;">
        <i class="fas fa-info-circle"></i>
        <span style="margin-left:8px;">Nesta etapa apenas revisamos os dados. A confirmação da aglutinação será implementada em seguida.</span>
      </div>
    </div>
    <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; padding: 20px 40px 28px 40px; border-top: 1px solid #eee; flex-shrink: 0;">
      <button class="btn-secondary" onclick="fecharModalAglutinacao()" style="padding: 10px 20px; border-radius: 4px; font-size: 15px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; background-color: #fff; color: #333; border: 1px solid #ddd;"><i class="fas fa-times"></i> Cancelar</button>
      <button class="btn-warning" onclick="confirmarAglutinacao()" style="padding: 10px 20px; border-radius: 4px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; background-color: #ff9800; color: white; border: none;"><i class="fas fa-object-group"></i> Confirmar Aglutinação</button>
    </div>
  </div>
</div>

<!-- NOVO: Modal de Bloqueio de Aglutinação (Títulos Pagos) -->
<div id="modalBloqueioAglutinacaoPago" class="modal" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.22); z-index: 5500; align-items: center; justify-content: center;">
  <div class="modal-content" style="background: #fff; border-radius: 16px; max-width: 560px; width: 96%; box-shadow: 0 8px 32px rgba(229,57,53,0.18); padding: 0;">
    <div class="modal-header" style="padding: 24px 32px 0 32px; display: flex; align-items: center; justify-content: space-between;">
      <h2 style="margin: 0; font-size: 1.28em; color: #e53935; display: flex; align-items: center; gap: 10px; font-weight: 700;"><i class="fas fa-ban"></i> Aglutinação não permitida</h2>
      <button class="close-modal" onclick="fecharModalBloqueioAglutinacao()" style="background: none; border: none; font-size: 1.3em; color: #666; cursor: pointer; padding: 5px; transition: color 0.3s;">&times;</button>
    </div>
    <div class="modal-body" style="padding: 20px 32px 0 32px;">
      <div style="background:#ffebee; border:1px solid #ffcdd2; color:#c62828; border-radius:8px; padding:12px; margin-bottom:14px; display:flex; align-items:flex-start; gap:10px;">
        <i class="fas fa-exclamation-triangle" style="margin-top:2px;"></i>
        <div>
          <div style="font-weight:600;">Não é possível aglutinar títulos com status PAGO.</div>
          <div id="qtdeTitulosPagosAglutinacao" style="font-size:0.95em; margin-top:4px;">Há títulos pagos na seleção.</div>
        </div>
      </div>
      <div style="font-weight:600; color:#333; margin-bottom:8px; display:flex; align-items:center; gap:8px;"><i class="fas fa-list"></i> Títulos pagos selecionados</div>
      <div id="listaTitulosPagosAglutinacao" style="max-height:220px; overflow:auto; border:1px solid #e9ecef; border-radius:8px; padding:8px; background:#fff;"></div>
      <div style="margin-top:12px; font-size:0.92em; color:#666;">Remova os títulos pagos da seleção e tente novamente.</div>
    </div>
    <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:10px; padding: 20px 32px 28px 32px; border-top: 1px solid #eee;">
      <button class="btn-secondary" onclick="fecharModalBloqueioAglutinacao()" style="padding: 10px 20px; border-radius: 6px; font-size: 15px; font-weight: 500; cursor: pointer; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; display:flex; align-items:center; gap:8px;"><i class="fas fa-check"></i> Entendi</button>
    </div>
  </div>
</div>

<!-- ========================================
     JAVASCRIPT DOS MODAIS
     ======================================== -->

<script>
// Variáveis globais para os modais
let tituloParaExcluir = null;
let tituloParaCancelarBaixa = null;
let modoExclusaoParcelamento = 'unico';
let titulosParaExcluirAnimacao = [];
// NOVO: títulos selecionados para aglutinação
let titulosParaAglutinar = [];
// NOVO: observação digitada no modal de aglutinação
let observacaoAglutinacaoTexto = '';

// NOVO: helper para normalizar valores numéricos em pt-BR
function parseValorBr(valor) {
  if (valor == null) return 0;
  if (typeof valor === 'number') return isNaN(valor) ? 0 : valor;
  if (typeof valor === 'string') {
    const limpo = valor.replace(/\./g, '').replace(',', '.').trim();
    const num = parseFloat(limpo);
    return isNaN(num) ? 0 : num;
  }
  const n = Number(valor);
  return isNaN(n) ? 0 : n;
}

// ========================================
// FUNÇÕES DE EXCLUSÃO
// ========================================

// Função para confirmar exclusão de título
async function confirmarExclusao(modo) {
  if (!tituloParaExcluir || !tituloParaExcluir.titulo) {
    console.error('Nenhum título para excluir');
    return;
  }
  
  const titulo = tituloParaExcluir.titulo;
  console.log('Executando exclusão do título:', titulo.numero_titulo, 'modo:', modo);
  
  // Verificar se há títulos pagos antes de excluir múltiplos
  if (modo === 'todos') {
    const prefixo = (titulo.numero_titulo || '').split('-')[0];
    const titulosDoGrupo = todosTitulos.filter(t => (t.numero_titulo || '').startsWith(prefixo + '-'));
    
    // Verificar se algum título está pago
    const titulosPagos = titulosDoGrupo.filter(t => t.status && t.status.toUpperCase() === 'PAGO');
    
    if (titulosPagos.length > 0) {
      console.log('Encontrados títulos pagos no grupo:', titulosPagos);
      
      // Fechar modal de confirmação
      fecharModalConfirmExclusao();
      
      // Mostrar modal de aviso para o primeiro título pago encontrado
      const primeiroTituloPago = titulosPagos[0];
      mostrarModalTituloPagoNaoPodeExcluir(primeiroTituloPago);
      
      // Adicionar informação sobre quantos títulos estão pagos
      const avisoDiv = document.querySelector('#modalTituloPagoNaoPodeExcluir .modal-body div[style*="background: #fff3e0"]');
      if (avisoDiv) {
        avisoDiv.innerHTML = `
          <div style="display: flex; align-items: flex-start; gap: 12px;">
            <i class="fas fa-exclamation-triangle" style="color: #e53935; font-size: 1.2em; margin-top: 2px;"></i>
            <div style="text-align: left;">
              <div style="font-weight: 600; color: #e53935; margin-bottom: 6px;">Atenção: Grupo de Títulos com Pagamentos!</div>
              <div style="font-size: 0.95em; color: #e53935;">
                Este grupo possui <strong>${titulosPagos.length} título(s) já pago(s)</strong> que não podem ser excluídos.
                <br><br>
                Para excluir o grupo completo, você deve primeiro <strong>cancelar a baixa</strong> de todos os títulos pagos através da opção "Cancelar Baixa" no menu de ações de cada título.
              </div>
            </div>
          </div>
        `;
      }
      
      return; // Parar a execução
    }
  }
  
  // Mostrar animação de exclusão
  const animacaoDiv = document.getElementById('animacaoExclusaoDiv');
  const footerBtns = document.getElementById('footerExclusaoBtns');
  const barraProgresso = document.getElementById('barraProgressoExclusao');
  const textoProgresso = document.getElementById('textoProgressoExclusao');
  
  if (animacaoDiv) animacaoDiv.style.display = 'block';
  if (footerBtns) footerBtns.style.display = 'none';
  if (barraProgresso) barraProgresso.style.width = '0%';
  if (textoProgresso) textoProgresso.textContent = 'Iniciando exclusão...';
  
  try {
    if (modo === 'unico') {
      // Excluir apenas o título atual
      console.log('Excluindo título único:', titulo.id);
      
      // Atualizar progresso
      if (barraProgresso) barraProgresso.style.width = '50%';
      if (textoProgresso) textoProgresso.textContent = 'Excluindo título...';
      
      await window.api.delete(`/movimento_comissoes/${titulo.id}`);
      
      // Atualizar progresso
      if (barraProgresso) barraProgresso.style.width = '100%';
      if (textoProgresso) textoProgresso.textContent = 'Título excluído com sucesso!';
      
      // Aguardar um pouco para mostrar o progresso completo
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Atualizar arrays locais
      todosTitulos = todosTitulos.filter(t => t.id !== titulo.id);
      titulosFiltrados = titulosFiltrados.filter(t => t.id !== titulo.id);
      
      // Atualizar interface
      atualizarTabelaComFiltros();
      atualizarCardsTotalizadores();
      
      fecharModalConfirmExclusao();
      abrirModalSucessoExclusao();
      
    } else if (modo === 'todos') {
      // Excluir todos os títulos do parcelamento
      const prefixo = (titulo.numero_titulo || '').split('-')[0];
      const titulosDoGrupo = todosTitulos.filter(t => (t.numero_titulo || '').startsWith(prefixo + '-'));
      
      console.log('Excluindo parcelamento completo:', titulosDoGrupo.length, 'títulos');
      
      // Calcular progresso por título
      const progressoPorTitulo = 100 / titulosDoGrupo.length;
      
      for (let i = 0; i < titulosDoGrupo.length; i++) {
        const t = titulosDoGrupo[i];
        
        // Atualizar progresso
        const progressoAtual = (i + 1) * progressoPorTitulo;
        if (barraProgresso) barraProgresso.style.width = progressoAtual + '%';
        if (textoProgresso) textoProgresso.textContent = `Excluindo título ${i + 1} de ${titulosDoGrupo.length}...`;
        
        await window.api.delete(`/movimento_comissoes/${t.id}`);
        
        // Pequeno delay para mostrar o progresso
        await new Promise(resolve => setTimeout(resolve, 200));
      }
      
      if (textoProgresso) textoProgresso.textContent = 'Todos os títulos excluídos com sucesso!';
      
      // Aguardar um pouco para mostrar o progresso completo
      await new Promise(resolve => setTimeout(resolve, 500));
      
      todosTitulos = todosTitulos.filter(t => !(t.numero_titulo || '').startsWith(prefixo + '-'));
      titulosFiltrados = titulosFiltrados.filter(t => !(t.numero_titulo || '').startsWith(prefixo + '-'));
      
      atualizarTabelaComFiltros();
      atualizarCardsTotalizadores();
      
      fecharModalConfirmExclusao();
      abrirModalSucessoExclusao();
    }
    
  } catch (error) {
    console.error('Erro ao excluir título:', error);
    
    // Mostrar erro no progresso
    if (textoProgresso) textoProgresso.textContent = 'Erro ao excluir título!';
    if (barraProgresso) barraProgresso.style.backgroundColor = '#e53935';
    
    // Aguardar um pouco e mostrar alerta
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // Melhorar mensagem de erro
    let mensagemErro = 'Erro desconhecido ao excluir título';
    if (error && error.message) {
      mensagemErro = error.message;
    } else if (error && typeof error === 'string') {
      mensagemErro = error;
    }
    
    alert(`Erro ao excluir título: ${mensagemErro}`);
    
    // Restaurar botões
    if (footerBtns) footerBtns.style.display = 'flex';
    if (animacaoDiv) animacaoDiv.style.display = 'none';
  }
}

function abrirModalConfirmExclusao(titulo, onConfirm) {
  console.log('abrirModalConfirmExclusao chamada com:', titulo);
  
  // Verificar se o título está com status PAGO
  if (titulo.status && titulo.status.toUpperCase() === 'PAGO') {
    console.log('Título está pago, mostrando modal de aviso...');
    mostrarModalTituloPagoNaoPodeExcluir(titulo);
    return;
  }
  
  // Verificar se as funções necessárias estão disponíveis
  if (typeof todosTitulos === 'undefined' || !Array.isArray(todosTitulos)) {
    console.error('Lista de títulos não está disponível ou não é um array');
    alert('Erro: Lista de títulos não está disponível. Por favor, atualize a página.');
    return;
  }
  
  // Verificar se o título ainda existe na lista atualizada
  const tituloAtualizado = todosTitulos.find(t => t.id === titulo.id);
  if (!tituloAtualizado) {
    console.error('Título não encontrado na lista atualizada');
    alert('Erro: Título não encontrado. Por favor, atualize a página.');
    return;
  }
  
  // Usar o título atualizado da lista
  const tituloParaUsar = tituloAtualizado;
  console.log('Usando título atualizado da lista:', tituloParaUsar);
  
  // Resetar estado anterior do modal para evitar conflitos
  tituloParaExcluir = null;
  modoExclusaoParcelamento = 'unico';
  
  // Definir novo título para exclusão
  tituloParaExcluir = { titulo: tituloParaUsar, onConfirm };
  console.log('tituloParaExcluir definido como:', tituloParaExcluir);
  
  // Resetar e configurar elementos do modal
  const animacaoDiv = document.getElementById('animacaoExclusaoDiv');
  const footerBtns = document.getElementById('footerExclusaoBtns');
  const opcoesDiv = document.getElementById('opcoesExclusaoParcelamento');
  const listaTitulosParciais = document.getElementById('listaTitulosParciais');
  
  // Resetar animação
  if (animacaoDiv) {
    animacaoDiv.style.display = 'none';
  }
  
  // Mostrar botões
  if (footerBtns) {
    footerBtns.style.display = 'flex';
  }
  
  // Resetar opções de parcelamento
  if (opcoesDiv) {
    opcoesDiv.style.display = 'none';
  }
  
  // Resetar lista de títulos parciais
  if (listaTitulosParciais) {
    listaTitulosParciais.style.display = 'none';
  }
  
  // Preencher informações do título no modal com verificações de segurança
  const numeroElement = document.getElementById('numeroTituloExclusao');
  const colaboradorElement = document.getElementById('colaboradorTituloExclusao');
  const valorElement = document.getElementById('valorTituloExclusao');
  const statusElement = document.getElementById('statusTituloExclusao');
  
  if (numeroElement) {
    numeroElement.textContent = tituloParaUsar.numero_titulo || '';
  } else {
    console.warn('Elemento numeroTituloExclusao não encontrado');
  }
  
  if (colaboradorElement) {
    // Verificar se mapaColaboradores existe antes de usar
    if (typeof mapaColaboradores !== 'undefined' && mapaColaboradores) {
      colaboradorElement.textContent = mapaColaboradores[tituloParaUsar.colaborador_id] || tituloParaUsar.colaborador_id || '';
    } else {
      colaboradorElement.textContent = tituloParaUsar.colaborador_id || '';
    }
  } else {
    console.warn('Elemento colaboradorTituloExclusao não encontrado');
  }
  
  if (valorElement) {
    // Verificar se formatarValorLocal existe antes de usar
    if (typeof formatarValorLocal === 'function') {
      valorElement.textContent = formatarValorLocal(tituloParaUsar.valor);
    } else {
      // Fallback se a função não estiver disponível
      valorElement.textContent = tituloParaUsar.valor ? `R$ ${parseFloat(tituloParaUsar.valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}` : '';
    }
  } else {
    console.warn('Elemento valorTituloExclusao não encontrado');
  }
  
  if (statusElement) {
    statusElement.textContent = tituloParaUsar.status || '';
  } else {
    console.warn('Elemento statusTituloExclusao não encontrado');
  }
  
  // Detecta se é parcelado pelo padrão do número do título
  const match = (tituloParaUsar.numero_titulo || '').match(/^(\d+)-\d+\/\d+$/);
  if (match && opcoesDiv) {
    console.log('Título é parcelado, mostrando opções...');
    opcoesDiv.style.display = 'block';
    const radioUnico = document.querySelector('input[name="exclusaoParcelamento"][value="unico"]');
    if (radioUnico) radioUnico.checked = true;
    modoExclusaoParcelamento = 'unico';
  } else if (opcoesDiv) {
    console.log('Título não é parcelado, ocultando opções...');
    opcoesDiv.style.display = 'none';
    modoExclusaoParcelamento = 'unico';
  }
  
  // Configurar event listeners para as opções de parcelamento
  document.getElementsByName('exclusaoParcelamento').forEach(radio => {
    radio.onchange = function() {
      modoExclusaoParcelamento = this.value;
      console.log('Modo de exclusão alterado para:', modoExclusaoParcelamento);
    };
  });
  
  // Abrir modal
  const modal = document.getElementById('modalConfirmExclusao');
  if (modal) {
    console.log('Abrindo modal de confirmação de exclusão...');
    modal.style.display = 'flex';
  } else {
    console.error('Modal modalConfirmExclusao não encontrado!');
  }
}

function fecharModalConfirmExclusao() {
  console.log('Executando fecharModalConfirmExclusao...');
  const modal = document.getElementById('modalConfirmExclusao');
  console.log('Modal encontrado:', modal);
  if (modal) {
    console.log('Display antes de fechar:', modal.style.display);
    modal.style.display = 'none';
    console.log('Display após fechar:', modal.style.display);
    console.log('Modal de confirmação fechado com sucesso');
  } else {
    console.log('Modal de confirmação não encontrado');
  }
  
  // Resetar campos com segurança
  const confirmacaoDiv = document.getElementById('confirmacaoExclusaoDiv');
  if (confirmacaoDiv) confirmacaoDiv.style.display = 'none';
  const inputConfirmo = document.getElementById('inputConfirmoExclusao');
  if (inputConfirmo) inputConfirmo.value = '';
  const erroConfirmo = document.getElementById('erroConfirmoExclusao');
  if (erroConfirmo) erroConfirmo.style.display = 'none';
}

function abrirModalSucessoExclusao() {
  const modal = document.getElementById('modalSucessoExclusao');
  if (modal) modal.style.display = 'flex';
}

function fecharModalSucessoExclusao() {
  const modal = document.getElementById('modalSucessoExclusao');
  if (modal) modal.style.display = 'none';
}

// ========================================
// FUNÇÕES DE CANCELAMENTO DE BAIXA
// ========================================

function abrirModalConfirmCancelarBaixa(titulo) {
  tituloParaCancelarBaixa = titulo;
  
  // Verificar se há títulos parciais relacionados
  const titulosParciais = todosTitulos.filter(t => t.id_titulo_origem === tituloParaCancelarBaixa.id);
  const isBaixaParcial = titulosParciais.length > 0;
  
  // Atualizar o modal de confirmação com informações específicas
  const modalBody = document.querySelector('#modalConfirmCancelarBaixa .modal-body');
  const listaAcoes = modalBody.querySelector('ul');
  
  if (isBaixaParcial) {
    // Adicionar item sobre exclusão de títulos parciais
    const itemParciais = document.createElement('li');
    itemParciais.textContent = `Excluir ${titulosParciais.length} título(s) parcial(is) gerado(s)`;
    itemParciais.style.color = '#e65100';
    itemParciais.style.fontWeight = 'bold';
    listaAcoes.appendChild(itemParciais);
    
    // Atualizar mensagem de aviso
    const avisoDiv = modalBody.querySelector('div[style*="font-style: italic"]');
    if (avisoDiv) {
      avisoDiv.innerHTML = '<strong>Atenção:</strong> Esta ação irá excluir permanentemente os títulos parciais. Esta ação não pode ser desfeita.';
      avisoDiv.style.color = '#e53935';
      avisoDiv.style.fontWeight = 'bold';
    }
  }
  
  // Abrir modal de confirmação
  document.getElementById('modalConfirmCancelarBaixa').style.display = 'flex';
}

function fecharModalConfirmCancelarBaixa() {
  document.getElementById('modalConfirmCancelarBaixa').style.display = 'none';
  // Não resetar tituloParaCancelarBaixa aqui, pois pode ser necessário para executarCancelarBaixa
  // A variável será resetada apenas após o cancelamento ser executado com sucesso
}

function fecharModalSucessoCancelarBaixa() {
  const modal = document.getElementById('modalSucessoCancelarBaixa');
  if (modal) {
    modal.style.display = 'none';
  }
  // Fechar também o modal de visualização/edição, se estiver aberto
  const modalTitulo = document.getElementById('modalTitulo');
  if (modalTitulo) {
    modalTitulo.style.display = 'none';
  }
  const viewModal = document.getElementById('viewModal');
  if (viewModal) {
    viewModal.style.display = 'none';
  }
}

// Função para mostrar modal de sucesso de baixa múltipla
function mostrarModalSucessoBaixaMultipla(dados) {
  // Preencher informações no modal
  document.getElementById('quantidadeTitulosSucesso').textContent = dados.quantidade;
  document.getElementById('dataPagamentoSucesso').textContent = dados.dataPagamento;
  document.getElementById('statusAplicadoSucesso').textContent = dados.status;
  document.getElementById('comprovanteSucesso').textContent = dados.comprovante ? 'Sim' : 'Não';
  
  // Mostrar o modal
  const modal = document.getElementById('modalSucessoBaixaMultipla');
  if (modal) {
    modal.style.display = 'flex';
  }
}

// Função para fechar modal de sucesso de baixa múltipla
function fecharModalSucessoBaixaMultipla() {
  const modal = document.getElementById('modalSucessoBaixaMultipla');
  if (modal) {
    modal.style.display = 'none';
  }
}

// ========================================
// FUNÇÕES AUXILIARES
// ========================================

function mostrarModalTituloPagoNaoPodeExcluir(titulo) {
  const modal = document.getElementById('modalTituloPagoNaoPodeExcluir');
  if (modal) {
    // Preencher informações do título com verificações de segurança
    const numeroElement = document.getElementById('numeroTituloPago');
    const dataPagamentoElement = document.getElementById('dataPagamentoTitulo');
    const valorPagoElement = document.getElementById('valorPagoTitulo');
    const colaboradorElement = document.getElementById('colaboradorTituloPago');
    
    if (numeroElement) {
      numeroElement.textContent = titulo.numero_titulo || '';
    }
    
    if (dataPagamentoElement) {
      // Verificar se formatarDataLocal existe antes de usar
      if (typeof formatarDataLocal === 'function') {
        dataPagamentoElement.textContent = formatarDataLocal(titulo.data_pagamento) || 'Não informada';
      } else {
        dataPagamentoElement.textContent = titulo.data_pagamento || 'Não informada';
      }
    }
    
    if (valorPagoElement) {
      // Verificar se formatarValorLocal existe antes de usar
      if (typeof formatarValorLocal === 'function') {
        valorPagoElement.textContent = formatarValorLocal(titulo.valor_pago) || 'Não informado';
      } else {
        // Fallback se a função não estiver disponível
        valorPagoElement.textContent = titulo.valor_pago ? `R$ ${parseFloat(titulo.valor_pago).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}` : 'Não informado';
      }
    }
    
    if (colaboradorElement) {
      // Verificar se mapaColaboradores existe antes de usar
      if (typeof mapaColaboradores !== 'undefined' && mapaColaboradores) {
        colaboradorElement.textContent = mapaColaboradores[titulo.colaborador_id] || titulo.colaborador_id || '';
      } else {
        colaboradorElement.textContent = titulo.colaborador_id || '';
      }
    }
    
    // Mostrar observações se existirem
    const observacoesDiv = document.getElementById('observacoesTitulo');
    const observacoesTexto = document.getElementById('textoObservacoesTitulo');
    if (titulo.observacoes && titulo.observacoes.trim()) {
      observacoesTexto.textContent = titulo.observacoes;
      observacoesDiv.style.display = 'block';
    } else {
      observacoesDiv.style.display = 'none';
    }
    
    modal.style.display = 'flex';
  }
}

function fecharModalTituloPagoNaoPodeExcluir() {
  const modal = document.getElementById('modalTituloPagoNaoPodeExcluir');
  if (modal) modal.style.display = 'none';
}

// NOVO: FUNÇÕES DE AGLUTINAÇÃO (abrir/fechar)
function abrirModalAglutinacao(titulos) {
  try {
    titulosParaAglutinar = Array.isArray(titulos) ? titulos : [];
    observacaoAglutinacaoTexto = '';
    const modal = document.getElementById('modalAglutinacaoTitulos');
    const qtdEl = document.getElementById('quantidadeTitulosAglutinar');
    const listaEl = document.getElementById('listaTitulosAglutinacao');
    const totalEl = document.getElementById('valorTotalAglutinar');
    const colabEl = document.getElementById('colaboradorAglutinacao');
    const obsInput = document.getElementById('observacaoAglutinacaoInput');
    const obsCount = document.getElementById('observacaoAglutinacaoCount');
    const simulacaoEl = document.getElementById('simulacaoAglutinacao');

    if (qtdEl) qtdEl.textContent = titulosParaAglutinar.length;

    if (listaEl) {
      listaEl.innerHTML = '';
      titulosParaAglutinar.forEach((t, idx) => {
        const numero = (t.numero_titulo || '').toString();
        const valorNum = parseValorBr(t.valor ?? t.valor_total ?? t.valor_titulo ?? 0);
        const valorFmt = (typeof formatarValorLocal === 'function')
          ? formatarValorLocal(valorNum)
          : `R$ ${valorNum.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        const dtVenc = t.data_vencimento ? (typeof formatarData === 'function' ? formatarData(t.data_vencimento) : t.data_vencimento) : '-';
        const linha = document.createElement('div');
        linha.style.cssText = 'display:flex; justify-content:space-between; align-items:center; background:#fff; border:1px solid #e3f2fd; border-radius:8px; padding:10px 12px; margin-bottom:8px; gap:10px;';
        linha.innerHTML = `
          <div style=\"display:flex; align-items:center; gap:8px;\">
            <span style=\"background:#e3f2fd; color:#1976D2; padding:2px 8px; border-radius:12px; font-weight:600;\">${idx+1}</span>
            <div style=\"display:flex; flex-direction:column;\">
              <span style=\"font-weight:600; color:#333;\">${numero}</span>
              <span style=\"color:#666; font-size:0.85em;\">Vencimento: ${dtVenc}</span>
            </div>
          </div>
          <div style=\"display:flex; align-items:center; gap:8px;\">
            <div style=\"font-weight:700; color:#333;\">${valorFmt}</div>
            <button type=\"button\" class=\"btn-visualizar-titulo\" data-id=\"${t.id}\" style=\"padding:6px 10px; border-radius:6px; border:1px solid #1976D2; background:#e3f2fd; color:#1976D2; cursor:pointer; font-weight:600;\"><i class=\"fas fa-eye\"></i> Visualizar</button>
            <button type=\"button\" class=\"btn-remover-titulo\" data-id=\"${t.id}\" style=\"padding:6px 10px; border-radius:6px; border:1px solid #e53935; background:#ffebee; color:#e53935; cursor:pointer; font-weight:600;\"><i class=\"fas fa-times\"></i> Remover</button>
          </div>
        `;
        listaEl.appendChild(linha);
      });

      // Bind dos botões Visualizar
      const botoes = listaEl.querySelectorAll('button.btn-visualizar-titulo');
      botoes.forEach(btn => {
        btn.onclick = function() {
          const id = this.getAttribute('data-id');
          const titulo = titulosParaAglutinar.find(x => String(x.id) === String(id));
          if (!titulo) return;
          if (typeof abrirModalTitulo === 'function') {
            abrirModalTitulo(titulo, 'visualizar');
          } else if (typeof openViewModal === 'function') {
            openViewModal(titulo);
          } else {
            alert('Função de visualização não disponível.');
            return;
          }
          // Garantir que o modal de visualização fique acima do modal de aglutinação
          setTimeout(() => {
            const viewModalEl = document.getElementById('viewModal');
            const modalTituloEl = document.getElementById('modalTitulo');
            if (viewModalEl) viewModalEl.style.zIndex = '6000';
            if (modalTituloEl) modalTituloEl.style.zIndex = '6000';
          }, 0);
        };
      });

      // NOVO: Bind dos botões Remover
      const botoesRemover = listaEl.querySelectorAll('button.btn-remover-titulo');
      botoesRemover.forEach(btn => {
        btn.onclick = function() {
          const id = this.getAttribute('data-id');
          // Remover do array local
          titulosParaAglutinar = titulosParaAglutinar.filter(x => String(x.id) !== String(id));
          
          // Desmarcar seleção na grid principal, se existir
          try {
            if (typeof linhasSelecionadas !== 'undefined' && Array.isArray(linhasSelecionadas)) {
              const idx = linhasSelecionadas.indexOf(String(id));
              if (idx !== -1) linhasSelecionadas.splice(idx, 1);
              const tr = document.querySelector(`#movimentoComissoesTableBody tr[data-id="${id}"]`);
              if (tr) tr.classList.remove('tr-selected');
            }
          } catch (e) { /* noop */ }
          
          // Recalcular quantidade, totals, colaborador e simulação
          const qtdEl = document.getElementById('quantidadeTitulosAglutinar');
          const totalEl = document.getElementById('valorTotalAglutinar');
          const colabEl = document.getElementById('colaboradorAglutinacao');
          const simulacaoEl = document.getElementById('simulacaoAglutinacao');
          if (qtdEl) qtdEl.textContent = titulosParaAglutinar.length;
          
          // Re-renderizar lista
          listaEl.innerHTML = '';
          titulosParaAglutinar.forEach((t, idx2) => {
            const numero = (t.numero_titulo || '').toString();
            const valorNum = parseValorBr(t.valor ?? t.valor_total ?? t.valor_titulo ?? 0);
            const valorFmt = (typeof formatarValorLocal === 'function') ? formatarValorLocal(valorNum) : `R$ ${valorNum.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            const dtVenc = t.data_vencimento ? (typeof formatarData === 'function' ? formatarData(t.data_vencimento) : t.data_vencimento) : '-';
            const linha2 = document.createElement('div');
            linha2.style.cssText = 'display:flex; justify-content:space-between; align-items:center; background:#fff; border:1px solid #e3f2fd; border-radius:8px; padding:10px 12px; margin-bottom:8px; gap:10px;';
            linha2.innerHTML = `
              <div style=\"display:flex; align-items:center; gap:8px;\">
                <span style=\"background:#e3f2fd; color:#1976D2; padding:2px 8px; border-radius:12px; font-weight:600;\">${idx2+1}</span>
                <div style=\"display:flex; flex-direction:column;\">
                  <span style=\"font-weight:600; color:#333;\">${numero}</span>
                  <span style=\"color:#666; font-size:0.85em;\">Vencimento: ${dtVenc}</span>
                </div>
              </div>
              <div style=\"display:flex; align-items:center; gap:8px;\">
                <div style=\"font-weight:700; color:#333;\">${valorFmt}</div>
                <button type=\"button\" class=\"btn-visualizar-titulo\" data-id=\"${t.id}\" style=\"padding:6px 10px; border-radius:6px; border:1px solid #1976D2; background:#e3f2fd; color:#1976D2; cursor:pointer; font-weight:600;\"><i class=\"fas fa-eye\"></i> Visualizar</button>
                <button type=\"button\" class=\"btn-remover-titulo\" data-id=\"${t.id}\" style=\"padding:6px 10px; border-radius:6px; border:1px solid #e53935; background:#ffebee; color:#e53935; cursor:pointer; font-weight:600;\"><i class=\"fas fa-times\"></i> Remover</button>
              </div>
            `;
            listaEl.appendChild(linha2);
          });
          
          // Rebind dos botões após re-renderização
          const reBotoesVer = listaEl.querySelectorAll('button.btn-visualizar-titulo');
          reBotoesVer.forEach(b => b.onclick = (ev2) => {
            const id2 = ev2.currentTarget.getAttribute('data-id');
            const titulo2 = titulosParaAglutinar.find(x => String(x.id) === String(id2));
            if (!titulo2) return;
            if (typeof abrirModalTitulo === 'function') abrirModalTitulo(titulo2, 'visualizar');
            else if (typeof openViewModal === 'function') openViewModal(titulo2);
            setTimeout(() => {
              const viewModalEl = document.getElementById('viewModal');
              const modalTituloEl = document.getElementById('modalTitulo');
              if (viewModalEl) viewModalEl.style.zIndex = '6000';
              if (modalTituloEl) modalTituloEl.style.zIndex = '6000';
            }, 0);
          });
          const reBotoesRem = listaEl.querySelectorAll('button.btn-remover-titulo');
          reBotoesRem.forEach(b => b.onclick = handleRemoverTituloClick);
          
          // Totais e colaborador
          const total = titulosParaAglutinar.reduce((acc, t) => acc + (parseFloat(t.valor || t.valor_total || 0) || 0), 0);
          const totalNum = titulosParaAglutinar.reduce((acc, t) => acc + parseValorBr(t.valor ?? t.valor_total ?? t.valor_titulo ?? 0), 0);
          const totalFmt = (typeof formatarValorLocal === 'function') ? formatarValorLocal(totalNum) : `R$ ${totalNum.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
          if (totalEl) totalEl.textContent = totalFmt;
          if (colabEl) {
            const primeiro = titulosParaAglutinar[0];
            const colabId = primeiro ? primeiro.colaborador_id : '';
            colabEl.textContent = (typeof mapaColaboradores !== 'undefined' && mapaColaboradores && colabId) ? (mapaColaboradores[colabId] || colabId) : (colabId || '-');
          }
          
          // Atualizar simulação
          if (simulacaoEl) {
            if (titulosParaAglutinar.length === 0) {
              simulacaoEl.innerHTML = '';
            } else {
              const hoje = new Date();
              const ano = hoje.getFullYear();
              const mes = String(hoje.getMonth() + 1).padStart(2, '0');
              const dia = String(hoje.getDate()).padStart(2, '0');
              const dataHoje = `${ano}-${mes}-${dia}`;
              const exemplos = titulosParaAglutinar.slice(0, 3).map(t => (t.numero_titulo || '')).filter(Boolean);
              const origemResumo = titulosParaAglutinar.length > 3
                ? `${titulosParaAglutinar.length} títulos (ex.: ${exemplos.join(', ')}...)`
                : (exemplos.join(', ') || `${titulosParaAglutinar.length} título(s)`);
              simulacaoEl.innerHTML = `
                <div style=\"display: flex; align-items: center; gap: 10px; margin-bottom: 12px;\">
                  <i class=\"fas fa-receipt\" style=\"font-size: 1.3em; color: #1976D2;\"></i>
                  <h3 style=\"margin: 0; font-size: 1.1em; color: #1976D2; font-weight: 700;\">Novo Título Aglutinado (Simulação)</h3>
                </div>
                <div style=\"display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px;\">
                  <div style=\"background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;\">
                    <div style=\"font-weight: 600; color: #1976D2; margin-bottom: 4px;\">Nº Título</div>
                    <div style=\"color: #333;\">Simulado-AGL-1/1</div>
                  </div>
                  <div style=\"background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;\">
                    <div style=\"font-weight: 600; color: #1976D2; margin-bottom: 4px;\">Origem</div>
                    <div style=\"color: #333;\">${origemResumo}</div>
                  </div>
                  <div style=\"background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;\">
                    <div style=\"font-weight: 600; color: #1976D2; margin-bottom: 4px;\">Colaborador</div>
                    <div style=\"color: #333;\">${colabEl ? colabEl.textContent : '-'}\n                    </div>
                  </div>
                  <div style=\"background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;\">
                    <div style=\"font-weight: 600; color: #1976D2; margin-bottom: 4px;\">Valor</div>
                    <div style=\"color: #333; font-weight: 700;\">${totalFmt}</div>
                  </div>
                  <div style=\"background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;\">
                    <div style=\"font-weight: 600; color: #1976D2; margin-bottom: 4px;\">Status</div>
                    <div style=\"color: #333;\">PENDENTE</div>
                  </div>
                  <div style=\"background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;\">
                    <div style=\"font-weight: 600; color: #1976D2; margin-bottom: 4px;\">Vencimento</div>
                    <input type=\"date\" id=\"vencimentoTituloAglutinado\" value=\"${dataHoje}\" style=\"padding: 6px; border-radius: 4px; border: 1px solid #1976D2; background: #fff; color: #1976D2; font-size: 0.9em; width: 100%;\">
                  </div>
                </div>
                <div style=\"margin-top: 12px; background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;\">
                  <div style=\"font-weight: 600; color: #1976D2; margin-bottom: 4px;\">Descrição</div>
                  <div style=\"color: #333;\">Aglutinação de ${titulosParaAglutinar.length} título(s)</div>
                </div>
              `;
            }
          }
        };
      });
    }

    if (obsInput && obsCount) {
      obsInput.value = '';
      obsCount.textContent = '0/500';
      obsInput.oninput = function() {
        const len = this.value.length;
        if (len > 500) this.value = this.value.substring(0, 500);
        const atual = Math.min(this.value.length, 500);
        obsCount.textContent = `${atual}/500`;
      };
    }

    // Garantir que a simulação esteja renderizada ao abrir
    try { atualizarSimulacaoAglutinacaoUI(); } catch(_) {}

    if (modal) modal.style.display = 'flex';
  } catch (e) {
    console.warn('Erro ao abrir modal de aglutinação:', e);
    alert('Não foi possível abrir o modal de aglutinação.');
  }
}

function fecharModalAglutinacao() {
  const modal = document.getElementById('modalAglutinacaoTitulos');
  if (modal) modal.style.display = 'none';
  const listaEl = document.getElementById('listaTitulosAglutinacao');
  if (listaEl) listaEl.innerHTML = '';
  const obsInput = document.getElementById('observacaoAglutinacaoInput');
  const obsCount = document.getElementById('observacaoAglutinacaoCount');
  const simulacaoEl = document.getElementById('simulacaoAglutinacao');
  if (obsInput) obsInput.value = '';
  if (obsCount) obsCount.textContent = '0/500';
  if (simulacaoEl) simulacaoEl.innerHTML = '';
  observacaoAglutinacaoTexto = '';
  titulosParaAglutinar = [];
}

// NOVO: (Re)renderiza quantidade, lista, totais, colaborador e simulação com base no estado atual
function renderAglutinacaoUIFromState() {
  const qtdEl = document.getElementById('quantidadeTitulosAglutinar');
  const totalEl = document.getElementById('valorTotalAglutinar');
  const colabEl = document.getElementById('colaboradorAglutinacao');
  const listaEl = document.getElementById('listaTitulosAglutinacao');

  if (qtdEl) qtdEl.textContent = Array.isArray(titulosParaAglutinar) ? titulosParaAglutinar.length : 0;

  if (listaEl) {
    listaEl.innerHTML = '';
    (titulosParaAglutinar || []).forEach((t, idx) => {
      const numero = (t.numero_titulo || '').toString();
      const valorNum = parseValorBr(t.valor ?? t.valor_total ?? t.valor_titulo ?? 0);
      const valorFmt = (typeof formatarValorLocal === 'function') ? formatarValorLocal(valorNum) : `R$ ${valorNum.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
      const dtVenc = t.data_vencimento ? (typeof formatarData === 'function' ? formatarData(t.data_vencimento) : t.data_vencimento) : '-';
      const linha = document.createElement('div');
      linha.style.cssText = 'display:flex; justify-content:space-between; align-items:center; background:#fff; border:1px solid #e3f2fd; border-radius:8px; padding:10px 12px; margin-bottom:8px; gap:10px;';
      linha.innerHTML = `
        <div style="display:flex; align-items:center; gap:8px;">
          <span style="background:#e3f2fd; color:#1976D2; padding:2px 8px; border-radius:12px; font-weight:600;">${idx+1}</span>
          <div style="display:flex; flex-direction:column;">
            <span style="font-weight:600; color:#333;">${numero}</span>
            <span style="color:#666; font-size:0.85em;">Vencimento: ${dtVenc}</span>
          </div>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
          <div style="font-weight:700; color:#333;">${valorFmt}</div>
          <button type="button" class="btn-visualizar-titulo" data-id="${t.id}" style="padding:6px 10px; border-radius:6px; border:1px solid #1976D2; background:#e3f2fd; color:#1976D2; cursor:pointer; font-weight:600;"><i class="fas fa-eye"></i> Visualizar</button>
          <button type="button" class="btn-remover-titulo" data-id="${t.id}" style="padding:6px 10px; border-radius:6px; border:1px solid #e53935; background:#ffebee; color:#e53935; cursor:pointer; font-weight:600;"><i class="fas fa-times"></i> Remover</button>
        </div>
      `;
      listaEl.appendChild(linha);
    });

    // Binds
    const verBtns = listaEl.querySelectorAll('button.btn-visualizar-titulo');
    verBtns.forEach(b => b.onclick = function(ev) {
      const id = ev.currentTarget.getAttribute('data-id');
      const titulo = (titulosParaAglutinar || []).find(x => String(x.id) === String(id));
      if (!titulo) return;
      if (typeof abrirModalTitulo === 'function') abrirModalTitulo(titulo, 'visualizar');
      else if (typeof openViewModal === 'function') openViewModal(titulo);
      setTimeout(() => {
        const viewModalEl = document.getElementById('viewModal');
        const modalTituloEl = document.getElementById('modalTitulo');
        if (viewModalEl) viewModalEl.style.zIndex = '6000';
        if (modalTituloEl) modalTituloEl.style.zIndex = '6000';
      }, 0);
    });
    const remBtns = listaEl.querySelectorAll('button.btn-remover-titulo');
    remBtns.forEach(b => b.onclick = handleRemoverTituloClick);
  }

  // Totais e colaborador
  const totalNum = (titulosParaAglutinar || []).reduce((acc, t) => acc + parseValorBr(t.valor ?? t.valor_total ?? t.valor_titulo ?? 0), 0);
  const totalFmt = (typeof formatarValorLocal === 'function') ? formatarValorLocal(totalNum) : `R$ ${totalNum.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
  if (totalEl) totalEl.textContent = totalFmt;
  if (colabEl) {
    const primeiro = (titulosParaAglutinar || [])[0];
    const colabId = primeiro ? primeiro.colaborador_id : '';
    colabEl.textContent = (typeof mapaColaboradores !== 'undefined' && mapaColaboradores && colabId) ? (mapaColaboradores[colabId] || colabId) : (colabId || '-');
  }

  // Simulação
  atualizarSimulacaoAglutinacaoUI();
}

// NOVO: Handler reutilizável para remover título da lista do modal
function handleRemoverTituloClick(ev) {
  const btn = ev.currentTarget;
  const id = btn.getAttribute('data-id');
  // Remover do array local
  titulosParaAglutinar = titulosParaAglutinar.filter(x => String(x.id) !== String(id));

  // Desmarcar seleção na grid principal, se existir
  try {
    if (typeof linhasSelecionadas !== 'undefined' && Array.isArray(linhasSelecionadas)) {
      const idx = linhasSelecionadas.indexOf(String(id));
      if (idx !== -1) linhasSelecionadas.splice(idx, 1);
      const tr = document.querySelector(`#movimentoComissoesTableBody tr[data-id="${id}"]`);
      if (tr) tr.classList.remove('tr-selected');
    }
  } catch (_) {}

  // Atualizar cabeçalho (quantidade, total, colaborador)
  const qtdEl = document.getElementById('quantidadeTitulosAglutinar');
  const totalEl = document.getElementById('valorTotalAglutinar');
  const colabEl = document.getElementById('colaboradorAglutinacao');
  const listaEl = document.getElementById('listaTitulosAglutinacao');
  if (qtdEl) qtdEl.textContent = titulosParaAglutinar.length;

  // Re-renderizar lista compacta
  if (listaEl) {
    listaEl.innerHTML = '';
    titulosParaAglutinar.forEach((t, idx2) => {
      const numero = (t.numero_titulo || '').toString();
      const valorNum = parseValorBr(t.valor ?? t.valor_total ?? t.valor_titulo ?? 0);
      const valorFmt = (typeof formatarValorLocal === 'function') ? formatarValorLocal(valorNum) : `R$ ${valorNum.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
      const dtVenc = t.data_vencimento ? (typeof formatarData === 'function' ? formatarData(t.data_vencimento) : t.data_vencimento) : '-';
      const linha2 = document.createElement('div');
      linha2.style.cssText = 'display:flex; justify-content:space-between; align-items:center; background:#fff; border:1px solid #e3f2fd; border-radius:8px; padding:10px 12px; margin-bottom:8px; gap:10px;';
      linha2.innerHTML = `
        <div style="display:flex; align-items:center; gap:8px;">
          <span style="background:#e3f2fd; color:#1976D2; padding:2px 8px; border-radius:12px; font-weight:600;">${idx2+1}</span>
          <div style="display:flex; flex-direction:column;">
            <span style="font-weight:600; color:#333;">${numero}</span>
            <span style="color:#666; font-size:0.85em;">Vencimento: ${dtVenc}</span>
          </div>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
          <div style="font-weight:700; color:#333;">${valorFmt}</div>
          <button type="button" class="btn-visualizar-titulo" data-id="${t.id}" style="padding:6px 10px; border-radius:6px; border:1px solid #1976D2; background:#e3f2fd; color:#1976D2; cursor:pointer; font-weight:600;"><i class="fas fa-eye"></i> Visualizar</button>
          <button type="button" class="btn-remover-titulo" data-id="${t.id}" style="padding:6px 10px; border-radius:6px; border:1px solid #e53935; background:#ffebee; color:#e53935; cursor:pointer; font-weight:600;"><i class="fas fa-times"></i> Remover</button>
        </div>
      `;
      listaEl.appendChild(linha2);
    });

    // Rebind dos botões após re-renderização
    const reBotoesVer = listaEl.querySelectorAll('button.btn-visualizar-titulo');
    reBotoesVer.forEach(b => b.onclick = function(ev2) {
      const id2 = ev2.currentTarget.getAttribute('data-id');
      const titulo2 = titulosParaAglutinar.find(x => String(x.id) === String(id2));
      if (!titulo2) return;
      if (typeof abrirModalTitulo === 'function') abrirModalTitulo(titulo2, 'visualizar');
      else if (typeof openViewModal === 'function') openViewModal(titulo2);
      setTimeout(() => {
        const viewModalEl = document.getElementById('viewModal');
        const modalTituloEl = document.getElementById('modalTitulo');
        if (viewModalEl) viewModalEl.style.zIndex = '6000';
        if (modalTituloEl) modalTituloEl.style.zIndex = '6000';
      }, 0);
    });
    const reBotoesRem = listaEl.querySelectorAll('button.btn-remover-titulo');
    reBotoesRem.forEach(b => b.onclick = handleRemoverTituloClick);
  }

  // Totais e colaborador
  const total = titulosParaAglutinar.reduce((acc, t) => acc + (parseFloat(t.valor || t.valor_total || 0) || 0), 0);
  const totalNum = titulosParaAglutinar.reduce((acc, t) => acc + parseValorBr(t.valor ?? t.valor_total ?? t.valor_titulo ?? 0), 0);
  const totalFmt = (typeof formatarValorLocal === 'function') ? formatarValorLocal(totalNum) : `R$ ${totalNum.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
  if (totalEl) totalEl.textContent = totalFmt;
  if (colabEl) {
    const primeiro = titulosParaAglutinar[0];
    const colabId = primeiro ? primeiro.colaborador_id : '';
    colabEl.textContent = (typeof mapaColaboradores !== 'undefined' && mapaColaboradores && colabId) ? (mapaColaboradores[colabId] || colabId) : (colabId || '-');
  }

  // Atualizar simulação
  atualizarSimulacaoAglutinacaoUI();
}

// NOVO: utilitário para (re)construir a simulação do novo título
function atualizarSimulacaoAglutinacaoUI() {
  try {
    const simulacaoEl = document.getElementById('simulacaoAglutinacao');
    const colabEl = document.getElementById('colaboradorAglutinacao');
    if (!simulacaoEl) return;
    if (!Array.isArray(titulosParaAglutinar)) return;
    if (titulosParaAglutinar.length === 0) {
      simulacaoEl.innerHTML = '';
      return;
    }

    const total = titulosParaAglutinar.reduce((acc, t) => acc + (parseFloat(t.valor || t.valor_total || 0) || 0), 0);
    const totalNum = titulosParaAglutinar.reduce((acc, t) => acc + parseValorBr(t.valor ?? t.valor_total ?? t.valor_titulo ?? 0), 0);
    const totalFmt = (typeof formatarValorLocal === 'function') ? formatarValorLocal(totalNum) : `R$ ${totalNum.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
    const hoje = new Date();
    const ano = hoje.getFullYear();
    const mes = String(hoje.getMonth() + 1).padStart(2, '0');
    const dia = String(hoje.getDate()).padStart(2, '0');
    const dataHoje = `${ano}-${mes}-${dia}`;
    const exemplos = titulosParaAglutinar.slice(0, 3).map(t => (t.numero_titulo || '')).filter(Boolean);
    const origemResumo = titulosParaAglutinar.length > 3
      ? `${titulosParaAglutinar.length} títulos (ex.: ${exemplos.join(', ')}...)`
      : (exemplos.join(', ') || `${titulosParaAglutinar.length} título(s)`);

    simulacaoEl.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
        <i class="fas fa-receipt" style="font-size: 1.3em; color: #1976D2;"></i>
        <h3 style="margin: 0; font-size: 1.1em; color: #1976D2; font-weight: 700;">Novo Título Aglutinado (Simulação)</h3>
      </div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px;">
        <div style="background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;">
          <div style="font-weight: 600; color: #1976D2; margin-bottom: 4px;">Nº Título</div>
          <div style="color: #333;">Simulado-AGL-1/1</div>
        </div>
        <div style="background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;">
          <div style="font-weight: 600; color: #1976D2; margin-bottom: 4px;">Origem</div>
          <div style="color: #333;">${origemResumo}</div>
        </div>
        <div style="background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;">
          <div style="font-weight: 600; color: #1976D2; margin-bottom: 4px;">Colaborador</div>
          <div style="color: #333;">${colabEl ? colabEl.textContent : '-'}</div>
        </div>
        <div style="background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;">
          <div style="font-weight: 600; color: #1976D2; margin-bottom: 4px;">Valor</div>
          <div style="color: #333; font-weight: 700;">${totalFmt}</div>
        </div>
        <div style="background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;">
          <div style="font-weight: 600; color: #1976D2; margin-bottom: 4px;">Status</div>
          <div style="color: #333;">PENDENTE</div>
        </div>
        <div style="background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;">
          <div style="font-weight: 600; color: #1976D2; margin-bottom: 4px;">Vencimento</div>
          <input type="date" id="vencimentoTituloAglutinado" value="${dataHoje}" style="padding: 6px; border-radius: 4px; border: 1px solid #1976D2; background: #fff; color: #1976D2; font-size: 0.9em; width: 100%;">
        </div>
      </div>
      <div style="margin-top: 12px; background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e3f2fd;">
        <div style="font-weight: 600; color: #1976D2; margin-bottom: 4px;">Descrição</div>
        <div style="color: #333;">Aglutinação de ${titulosParaAglutinar.length} título(s)</div>
      </div>
    `;
  } catch (e) {
    console.warn('Falha ao atualizar simulação de aglutinação:', e);
  }
}

// NOVO: Confirmar aglutinação (ainda sem integração backend)
function confirmarAglutinacao() {
  const obsInput = document.getElementById('observacaoAglutinacaoInput');
  const dtInput = document.getElementById('vencimentoTituloAglutinado');
  observacaoAglutinacaoTexto = obsInput ? obsInput.value.trim() : '';
  const dataVencimento = dtInput && dtInput.value ? dtInput.value : new Date().toISOString().split('T')[0];
  // Placeholder: aqui futuramente chamaremos a API passando titulosParaAglutinar, observacaoAglutinacaoTexto e dataVencimento
  alert(`Aglutinação preparada com ${titulosParaAglutinar.length} título(s).\nVencimento: ${dataVencimento}\nObservação: ${observacaoAglutinacaoTexto || '—'}`);
}

// Função para fechar todos os modais relacionados ao cancelamento de baixa
function fecharTodosModaisCancelamento() {
  console.log('Fechando todos os modais de cancelamento...');
  
  // Lista de todos os modais que podem estar abertos
  const modaisParaFechar = [
    'modalConfirmCancelarBaixa',
    'modalConfirmExclusao',
    'modalSucessoExclusao',
    'modalSucessoCancelarBaixa',
    'modalSucessoBaixaMultipla',
    'modalTituloPagoNaoPodeExcluir',
    'modalTitulo',
    'viewModal'
  ];
  
  modaisParaFechar.forEach(modalId => {
    const modal = document.getElementById(modalId);
    if (modal && modal.style.display !== 'none') {
      console.log(`Fechando modal: ${modalId}`);
      modal.style.display = 'none';
    }
  });
  
  // Resetar TODAS as variáveis globais para evitar conflitos
  tituloParaCancelarBaixa = null;
  tituloParaExcluir = null;
  modoExclusaoParcelamento = 'unico';
  titulosParaExcluirAnimacao = [];
  
  // Resetar elementos de animação se existirem
  const animacaoExclusaoDiv = document.getElementById('animacaoExclusaoDiv');
  if (animacaoExclusaoDiv) {
    animacaoExclusaoDiv.style.display = 'none';
  }
  
  const footerExclusaoBtns = document.getElementById('footerExclusaoBtns');
  if (footerExclusaoBtns) {
    footerExclusaoBtns.style.display = 'flex';
  }
  
  // Resetar opções de parcelamento se existirem
  const opcoesExclusaoParcelamento = document.getElementById('opcoesExclusaoParcelamento');
  if (opcoesExclusaoParcelamento) {
    opcoesExclusaoParcelamento.style.display = 'none';
  }
  
  // Resetar lista de títulos parciais se existir
  const listaTitulosParciais = document.getElementById('listaTitulosParciais');
  if (listaTitulosParciais) {
    listaTitulosParciais.style.display = 'none';
  }
  
  // ATUALIZAR LISTA DE TÍTULOS APÓS CANCELAMENTO DE BAIXA
  // Isso garante que a exclusão múltipla funcione com o status atualizado
  if (typeof atualizarTabelaComFiltros === 'function') {
    console.log('Atualizando tabela e lista de títulos após cancelamento...');
    try {
      // Atualizar a tabela para refletir as mudanças
      atualizarTabelaComFiltros();
      
      // Atualizar os cards totalizadores
      if (typeof atualizarCardsTotalizadores === 'function') {
        atualizarCardsTotalizadores();
      }
      
      console.log('Tabela e títulos atualizados com sucesso após cancelamento');
    } catch (error) {
      console.warn('Erro ao atualizar tabela após cancelamento:', error);
    }
  } else {
    console.warn('Função atualizarTabelaComFiltros não está disponível');
  }
  
  console.log('Todos os modais de cancelamento foram fechados, variáveis resetadas e títulos atualizados');
}

// ========================================
// EVENT LISTENERS
// ========================================

// Event listeners serão configurados no arquivo principal após carregamento dos modais
// Removidos para evitar duplicação e conflitos

  // Configurar botão OK do modal de sucesso de cancelamento de baixa
  const btnOkSucessoCancelarBaixa = document.getElementById('btnOkSucessoCancelarBaixa');
  if (btnOkSucessoCancelarBaixa) {
    btnOkSucessoCancelarBaixa.addEventListener('click', fecharModalSucessoCancelarBaixa);
  }
  
  // Configurar botão OK do modal de sucesso de baixa múltipla
  const btnOkSucessoBaixaMultipla = document.getElementById('btnOkSucessoBaixaMultipla');
  if (btnOkSucessoBaixaMultipla) {
    btnOkSucessoBaixaMultipla.addEventListener('click', fecharModalSucessoBaixaMultipla);
  }

// Garantir renderização inicial da simulação após montar o modal
setTimeout(() => {
  try { renderAglutinacaoUIFromState(); } catch(_) {}
}, 0);

// NOVO: Handler reutilizável para remover título da lista do modal
function handleRemoverTituloClick(ev) {
  const btn = ev.currentTarget;
  const id = btn.getAttribute('data-id');
  // Remover do array local
  titulosParaAglutinar = titulosParaAglutinar.filter(x => String(x.id) !== String(id));

  // Desmarcar seleção na grid principal, se existir
  try {
    if (typeof linhasSelecionadas !== 'undefined' && Array.isArray(linhasSelecionadas)) {
      const idx = linhasSelecionadas.indexOf(String(id));
      if (idx !== -1) linhasSelecionadas.splice(idx, 1);
      const tr = document.querySelector(`#movimentoComissoesTableBody tr[data-id="${id}"]`);
      if (tr) tr.classList.remove('tr-selected');
    }
  } catch (_) {}

  // Atualizar cabeçalho (quantidade, total, colaborador)
  const qtdEl = document.getElementById('quantidadeTitulosAglutinar');
  const totalEl = document.getElementById('valorTotalAglutinar');
  const colabEl = document.getElementById('colaboradorAglutinacao');
  const listaEl = document.getElementById('listaTitulosAglutinacao');
  if (qtdEl) qtdEl.textContent = titulosParaAglutinar.length;

  // Re-renderizar lista compacta
  if (listaEl) {
    listaEl.innerHTML = '';
    titulosParaAglutinar.forEach((t, idx2) => {
      const numero = (t.numero_titulo || '').toString();
      const valorNum = parseValorBr(t.valor ?? t.valor_total ?? t.valor_titulo ?? 0);
      const valorFmt = (typeof formatarValorLocal === 'function') ? formatarValorLocal(valorNum) : `R$ ${valorNum.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
      const dtVenc = t.data_vencimento ? (typeof formatarData === 'function' ? formatarData(t.data_vencimento) : t.data_vencimento) : '-';
      const linha2 = document.createElement('div');
      linha2.style.cssText = 'display:flex; justify-content:space-between; align-items:center; background:#fff; border:1px solid #e3f2fd; border-radius:8px; padding:10px 12px; margin-bottom:8px; gap:10px;';
      linha2.innerHTML = `
        <div style="display:flex; align-items:center; gap:8px;">
          <span style="background:#e3f2fd; color:#1976D2; padding:2px 8px; border-radius:12px; font-weight:600;">${idx2+1}</span>
          <div style="display:flex; flex-direction:column;">
            <span style="font-weight:600; color:#333;">${numero}</span>
            <span style="color:#666; font-size:0.85em;">Vencimento: ${dtVenc}</span>
          </div>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
          <div style="font-weight:700; color:#333;">${valorFmt}</div>
          <button type="button" class="btn-visualizar-titulo" data-id="${t.id}" style="padding:6px 10px; border-radius:6px; border:1px solid #1976D2; background:#e3f2fd; color:#1976D2; cursor:pointer; font-weight:600;"><i class="fas fa-eye"></i> Visualizar</button>
          <button type="button" class="btn-remover-titulo" data-id="${t.id}" style="padding:6px 10px; border-radius:6px; border:1px solid #e53935; background:#ffebee; color:#e53935; cursor:pointer; font-weight:600;"><i class="fas fa-times"></i> Remover</button>
        </div>
      `;
      listaEl.appendChild(linha2);
    });

    // Rebind dos botões após re-renderização
    const reBotoesVer = listaEl.querySelectorAll('button.btn-visualizar-titulo');
    reBotoesVer.forEach(b => b.onclick = function(ev2) {
      const id2 = ev2.currentTarget.getAttribute('data-id');
      const titulo2 = titulosParaAglutinar.find(x => String(x.id) === String(id2));
      if (!titulo2) return;
      if (typeof abrirModalTitulo === 'function') abrirModalTitulo(titulo2, 'visualizar');
      else if (typeof openViewModal === 'function') openViewModal(titulo2);
      setTimeout(() => {
        const viewModalEl = document.getElementById('viewModal');
        const modalTituloEl = document.getElementById('modalTitulo');
        if (viewModalEl) viewModalEl.style.zIndex = '6000';
        if (modalTituloEl) modalTituloEl.style.zIndex = '6000';
      }, 0);
    });
    const reBotoesRem = listaEl.querySelectorAll('button.btn-remover-titulo');
    reBotoesRem.forEach(b => b.onclick = handleRemoverTituloClick);
  }

  // Totais e colaborador
  const total = titulosParaAglutinar.reduce((acc, t) => acc + (parseFloat(t.valor || t.valor_total || 0) || 0), 0);
  const totalNum = titulosParaAglutinar.reduce((acc, t) => acc + parseValorBr(t.valor ?? t.valor_total ?? t.valor_titulo ?? 0), 0);
  const totalFmt = (typeof formatarValorLocal === 'function') ? formatarValorLocal(totalNum) : `R$ ${totalNum.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
  if (totalEl) totalEl.textContent = totalFmt;
  if (colabEl) {
    const primeiro = titulosParaAglutinar[0];
    const colabId = primeiro ? primeiro.colaborador_id : '';
    colabEl.textContent = (typeof mapaColaboradores !== 'undefined' && mapaColaboradores && colabId) ? (mapaColaboradores[colabId] || colabId) : (colabId || '-');
  }

  // Atualizar simulação
  atualizarSimulacaoAglutinacaoUI();
}

// NOVO: Funções do modal de bloqueio de aglutinação
function abrirModalBloqueioAglutinacao(titulosPagos) {
  try {
    const modal = document.getElementById('modalBloqueioAglutinacaoPago');
    const lista = document.getElementById('listaTitulosPagosAglutinacao');
    const qtde = document.getElementById('qtdeTitulosPagosAglutinacao');

    if (qtde) qtde.textContent = `Você selecionou ${titulosPagos.length} título(s) com status PAGO.`;

    if (lista) {
      lista.innerHTML = '';
      titulosPagos.forEach((t, i) => {
        const num = t.numero_titulo || t.id || '-';
        const colab = (typeof mapaColaboradores !== 'undefined' && mapaColaboradores && t.colaborador_id) ? (mapaColaboradores[t.colaborador_id] || t.colaborador_id) : (t.colaborador_id || '-');
        const venc = t.data_vencimento ? (typeof formatarData === 'function' ? formatarData(t.data_vencimento) : t.data_vencimento) : '-';
        const row = document.createElement('div');
        row.style.cssText = 'display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px; border:1px solid #e9ecef; border-radius:8px; margin-bottom:8px; background:#fff;';
        row.innerHTML = `
          <div style="display:flex; align-items:center; gap:10px;">
            <span style="background:#ffcdd2; color:#c62828; padding:2px 8px; border-radius:12px; font-weight:700;">${i+1}</span>
            <div style="display:flex; flex-direction:column;">
              <span style="font-weight:600; color:#333;">${num}</span>
              <span style="color:#666; font-size:0.85em;">Vencimento: ${venc}</span>
              <span style="color:#666; font-size:0.85em;">Colaborador: ${colab}</span>
            </div>
          </div>
          <div style="color:#c62828; font-weight:700;">PAGO</div>
        `;
        lista.appendChild(row);
      });
    }

    if (modal) modal.style.display = 'flex';
  } catch (e) {
    console.warn('Erro ao abrir modal de bloqueio de aglutinação:', e);
    alert('Não é possível aglutinar títulos pagos.');
  }
}

function fecharModalBloqueioAglutinacao() {
  const modal = document.getElementById('modalBloqueioAglutinacaoPago');
  if (modal) modal.style.display = 'none';
}
</script> 