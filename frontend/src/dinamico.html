<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Comissões - Relatório Dinâmico</title>
    <link rel="icon" type="image/png" href="assets/images/logo2.png">
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="styles/login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        /* Correção de crescimento dos gráficos */
        .chart-card { position: relative; }
        .chart-card canvas { max-height: 320px; height: 320px !important; }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo" style="display: flex; align-items: center; justify-content: center; padding: 15px 0;">
            <img src="assets/images/logo2.png" alt="BlueDev Logo" style="height: 2.5em; margin-right: 10px;">
            <h1><span class="orange">e-</span><span class="highlight">Gerente</span></h1>
        </div>
        <ul class="nav-menu">
            <li><a href="index.html"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-user-plus"></i><span>Cadastros</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="colaboradores.html"><i class="fas fa-users"></i><span>Colaboradores</span></a></li>
                    <li><a href="clientes.html"><i class="fas fa-user-tie"></i><span>Clientes</span></a></li>
                    <li><a href="produtos.html"><i class="fas fa-box"></i><span>Produtos</span></a></li>
                    <li><a href="servicos.html"><i class="fas fa-cogs"></i><span>Serviços</span></a></li>
                    <li><a href="usuarios.html"><i class="fas fa-user-shield"></i><span>Usuários</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-hand-holding-usd"></i><span>Comissões</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="lancar-comissao.html"><i class="fas fa-plus-circle"></i><span>Lançar</span></a></li>
                    <li><a href="movimento-comissao.html"><i class="fas fa-exchange-alt"></i><span>Movimento</span></a></li>
                    <li><a href="consulta-comissao.html"><i class="fas fa-search"></i><span>Consulta</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-chart-bar"></i><span>Relatórios</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="recebimento.html"><i class="fas fa-money-bill-wave"></i><span>Recebimento</span></a></li>
                    <li><a href="conferencia.html"><i class="fas fa-check-circle"></i><span>Conferência</span></a></li>
                    <li><a href="dinamico.html" class="active"><i class="fas fa-chart-line"></i><span>Dinâmico</span><span class="beta-tag">beta</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-cog"></i><span>Configurações</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="manutencao-bd.html"><i class="fas fa-database"></i><span>Manutenção BD</span></a></li>
                    <li><a href="sincronizar.html"><i class="fas fa-sync"></i><span>Sincronizar</span></a></li>
                </ul>
            </li>
        </ul>
        <div class="logout-button">
            <a href="index.html"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" style="position: relative; height: 100vh; overflow: auto;">
        <!-- Header -->
        <div class="header">
            <div class="welcome-text">
                <h1>Relatório Dinâmico</h1>
                <p>Análise personalizada de dados e métricas</p>
            </div>
            <div class="user-info">
                <div class="notifications">
                    <i class="fas fa-bell"></i>
                    <span class="badge">3</span>
                </div>
                <div class="user-avatar">A</div>
            </div>
        </div>

        <!-- Advanced Filters -->
        <div class="advanced-filters">
            <div class="filter-group">
                <div class="date-range">
                    <label>Período</label>
                    <input type="date" placeholder="Data Inicial">
                    <input type="date" placeholder="Data Final">
                </div>
                <select>
                    <option value="">Colaborador</option>
                    <option value="todos">Todos</option>
                </select>
                <select>
                    <option value="">Tipo</option>
                    <option value="produtos">Produtos</option>
                    <option value="servicos">Serviços</option>
                    <option value="ambos">Ambos</option>
                </select>
                <select>
                    <option value="">Status</option>
                    <option value="PAGO">Pago</option>
                    <option value="PENDENTE">Pendente</option>
                    <option value="VENCIDO">Vencido</option>
                    <option value="CLIENTE NÃO PAGOU">Cliente não pagou</option>
                    <option value="AGLUTINADO">Aglutinado</option>
                    <option value="CANCELADO">Cancelado</option>
                </select>
                <div class="value-range">
                    <label>Faixa de Valor</label>
                    <input type="number" placeholder="Mínimo">
                    <input type="number" placeholder="Máximo">
                </div>
            </div>
            <button class="btn-primary">
                <i class="fas fa-search"></i>
                Gerar Relatório
            </button>
        </div>

        <!-- Spinner de Carregamento -->
        <div id="loader-dinamico" style="display: flex; position: absolute; inset: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 9; justify-content: center; align-items: center;">
            <div style="text-align: center;">
                <div class="spinner" style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #1976D2; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <p style="color: #1976D2; font-weight: 600;">Carregando dados...</p>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="dashboard-cards" style="margin-top: 10px; margin-bottom: 20px;">
            <div class="card">
                <div class="card-icon" style="background:#1976D21a; color:#1976D2;">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="card-info">
                    <h3>Total (R$)</h3>
                    <p id="kpi-total">-</p>
                </div>
            </div>
            <div class="card">
                <div class="card-icon" style="background:#28a7451a; color:#28a745;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="card-info">
                    <h3>Pago (R$)</h3>
                    <p id="kpi-pago">-</p>
                </div>
            </div>
            <div class="card">
                <div class="card-icon" style="background:#ffc1071a; color:#ff9800;">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="card-info">
                    <h3>Pendente (R$)</h3>
                    <p id="kpi-pendente">-</p>
                </div>
            </div>
            <div class="card">
                <div class="card-icon" style="background:#dc35451a; color:#dc3545;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="card-info">
                    <h3>Vencido (R$)</h3>
                    <p id="kpi-vencido">-</p>
                </div>
            </div>
        </div>

        <!-- Charts Container -->
        <div class="charts-container">
            <div class="chart-card">
                <h3>Comissões por Status</h3>
                <canvas id="statusChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Top 5 Colaboradores</h3>
                <canvas id="colaboradoresChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Evolução Mensal</h3>
                <canvas id="evolucaoChart"></canvas>
            </div>
        </div>

        <!-- Results Table -->
        <div class="table-container">
            <div class="table-header">
                <h2>Resultados</h2>
                <div class="table-actions">
                    <button class="btn-secondary" onclick="exportarRelatorio()">
                        <i class="fas fa-download"></i>
                        Exportar
                    </button>
                    <button class="btn-secondary" onclick="imprimirRelatorio()">
                        <i class="fas fa-print"></i>
                        Imprimir
                    </button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Colaborador</th>
                        <th>Tipo</th>
                        <th>Valor</th>
                        <th>Comissão</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dados serão carregados dinamicamente -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="scripts/config/api.js"></script>
    <script>
        // Variáveis globais
        let mapaColaboradores = {};
        let mapaClientes = {};
        let dadosRelatorio = [];
        let charts = {};

        // Toggle submenu
        document.querySelectorAll('.submenu-trigger').forEach(trigger => {
            trigger.addEventListener('click', function(e) {
                e.preventDefault();
                this.parentElement.classList.toggle('active');
            });
        });

        // Carregar colaboradores
        async function carregarColaboradores() {
            try {
                const colaboradores = await window.api.get('/colaboradores');
                mapaColaboradores = {};
                const selectColaborador = document.querySelector('.advanced-filters select:nth-of-type(1)');
                
                // Limpar opções existentes (exceto a primeira)
                selectColaborador.innerHTML = '<option value="">Colaborador</option><option value="todos">Todos</option>';
                
                colaboradores.forEach(colaborador => {
                    mapaColaboradores[colaborador.id] = colaborador.nome;
                    const option = document.createElement('option');
                    option.value = colaborador.id;
                    option.textContent = colaborador.nome;
                    selectColaborador.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar colaboradores:', error);
            }
        }

        // Carregar clientes
        async function carregarClientes() {
            try {
                const clientes = await window.api.get('/clientes');
                mapaClientes = {};
                clientes.forEach(cliente => {
                    mapaClientes[cliente.id] = cliente.nome;
                });
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }

        // Carregar dados do relatório
        async function carregarDadosRelatorio() {
            try {
                mostrarSpinner();
                const movimentoComissoes = await window.api.get('/movimento_comissoes');
                dadosRelatorio = movimentoComissoes;
                console.log('Dados carregados:', dadosRelatorio.length, 'registros');
                ocultarSpinner();
            } catch (error) {
                console.error('Erro ao carregar dados do relatório:', error);
                ocultarSpinner();
            }
        }

        // Aplicar filtros
        function aplicarFiltros() {
            const dataInicial = document.querySelector('.date-range input[type="date"]:first-of-type').value;
            const dataFinal = document.querySelector('.date-range input[type="date"]:last-of-type').value;
            const colaboradorId = document.querySelector('.advanced-filters select:nth-of-type(1)').value;
            const tipo = document.querySelector('.advanced-filters select:nth-of-type(2)').value;
            const status = document.querySelector('.advanced-filters select:nth-of-type(3)').value;
            const valorMinimo = document.querySelector('.value-range input:first-of-type').value;
            const valorMaximo = document.querySelector('.value-range input:last-of-type').value;

            let dadosFiltrados = [...dadosRelatorio];

            // Filtro por data
            if (dataInicial) {
                dadosFiltrados = dadosFiltrados.filter(item => 
                    new Date(item.data_geracao) >= new Date(dataInicial)
                );
            }
            if (dataFinal) {
                dadosFiltrados = dadosFiltrados.filter(item => 
                    new Date(item.data_geracao) <= new Date(dataFinal)
                );
            }

            // Filtro por colaborador
            if (colaboradorId && colaboradorId !== 'todos') {
                dadosFiltrados = dadosFiltrados.filter(item => 
                    item.colaborador_id === colaboradorId
                );
            }

            // Filtro por tipo
            if (tipo) {
                if (tipo === 'produtos') {
                    dadosFiltrados = dadosFiltrados.filter(item => 
                        item.tipo === 'PRODUTO'
                    );
                } else if (tipo === 'servicos') {
                    dadosFiltrados = dadosFiltrados.filter(item => 
                        item.tipo === 'SERVICO'
                    );
                }
            }

            // Filtro por status
            if (status) {
                dadosFiltrados = dadosFiltrados.filter(item => 
                    item.status === status.toUpperCase()
                );
            }

            // Filtro por valor
            if (valorMinimo) {
                dadosFiltrados = dadosFiltrados.filter(item => 
                    Number(item.valor) >= Number(valorMinimo)
                );
            }
            if (valorMaximo) {
                dadosFiltrados = dadosFiltrados.filter(item => 
                    Number(item.valor) <= Number(valorMaximo)
                );
            }

            console.log('Dados filtrados:', dadosFiltrados.length, 'registros');
            return dadosFiltrados;
        }

        // Atualizar KPIs
        function atualizarKPIs(dados) {
            const formatBRL = v => Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            const soma = (arr, pred) => arr.filter(pred).reduce((acc, i) => acc + Number(i.valor||0), 0);

            const total = soma(dados, () => true);
            const pago = soma(dados, i => i.status === 'PAGO');
            const pendente = soma(dados, i => i.status === 'PENDENTE');
            const vencido = soma(dados, i => i.status === 'VENCIDO');

            const el = id => document.getElementById(id);
            if (el('kpi-total')) el('kpi-total').textContent = formatBRL(total);
            if (el('kpi-pago')) el('kpi-pago').textContent = formatBRL(pago);
            if (el('kpi-pendente')) el('kpi-pendente').textContent = formatBRL(pendente);
            if (el('kpi-vencido')) el('kpi-vencido').textContent = formatBRL(vencido);
        }

        // Gerar relatório
        async function gerarRelatorio() {
            try {
                mostrarSpinner();
                const dadosFiltrados = aplicarFiltros();
                atualizarKPIs(dadosFiltrados);
                atualizarGraficos(dadosFiltrados);
                atualizarTabela(dadosFiltrados);
                ocultarSpinner();
            } catch (error) {
                console.error('Erro ao gerar relatório:', error);
                ocultarSpinner();
            }
        }

        // Mostrar spinner
        function mostrarSpinner() {
            const spinner = document.getElementById('loader-dinamico');
            if (spinner) {
                spinner.style.display = 'flex';
            }
        }

        // Ocultar spinner
        function ocultarSpinner() {
            const spinner = document.getElementById('loader-dinamico');
            if (spinner) {
                spinner.style.display = 'none';
            }
        }

        // Inicializar página
        async function inicializarPagina() {
            await carregarColaboradores();
            await carregarClientes();
            await carregarDadosRelatorio();
            
            // Gerar relatório inicial
            gerarRelatorio();
        }

        // Atualizar gráficos com dados reais
        function atualizarGraficos(dados) {
            atualizarGraficoStatus(dados);
            atualizarGraficoColaboradores(dados);
            atualizarGraficoEvolucao(dados);
        }

        // Atualizar gráfico de status
        function atualizarGraficoStatus(dados) {
            const statusCount = {};
            dados.forEach(item => {
                const status = item.status || 'PENDENTE';
                statusCount[status] = (statusCount[status] || 0) + 1;
            });

            const labels = Object.keys(statusCount);
            const values = Object.values(statusCount);
            const colors = {
                'PAGO': '#28a745',
                'PENDENTE': '#ffc107',
                'VENCIDO': '#dc3545',
                'CLIENTE NÃO PAGOU': '#6c757d',
                'AGLUTINADO': '#17a2b8'
            };

            const backgroundColors = labels.map(label => colors[label] || '#6c757d');

            if (charts.statusChart) {
                charts.statusChart.destroy();
            }

            const ctx = document.getElementById('statusChart').getContext('2d');
            charts.statusChart = new Chart(ctx, {
            type: 'pie',
            data: {
                    labels: labels,
                datasets: [{
                        data: values,
                        backgroundColor: backgroundColors
                }]
            },
            options: {
                responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Atualizar gráfico de colaboradores
        function atualizarGraficoColaboradores(dados) {
            const colaboradorTotais = {};
            dados.forEach(item => {
                const colaboradorId = item.colaborador_id;
                const colaboradorNome = mapaColaboradores[colaboradorId] || `ID: ${colaboradorId}`;
                const valor = Number(item.valor) || 0;
                colaboradorTotais[colaboradorNome] = (colaboradorTotais[colaboradorNome] || 0) + valor;
            });

            // Ordenar e pegar top 5
            const sortedColaboradores = Object.entries(colaboradorTotais)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const labels = sortedColaboradores.map(([nome]) => nome);
            const values = sortedColaboradores.map(([, valor]) => valor);

            if (charts.colaboradoresChart) {
                charts.colaboradoresChart.destroy();
            }

            const ctx = document.getElementById('colaboradoresChart').getContext('2d');
            charts.colaboradoresChart = new Chart(ctx, {
            type: 'bar',
            data: {
                    labels: labels,
                datasets: [{
                        label: 'Valor Total (R$)',
                        data: values,
                    backgroundColor: '#007bff'
                }]
            },
            options: {
                responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.2,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    }
                }
            });
        }

        // Atualizar gráfico de evolução
        function atualizarGraficoEvolucao(dados) {
            const evolucaoMensal = {};
            dados.forEach(item => {
                const data = new Date(item.data_geracao);
                const mesAno = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
                const valor = Number(item.valor) || 0;
                evolucaoMensal[mesAno] = (evolucaoMensal[mesAno] || 0) + valor;
            });

            // Ordenar por data
            const sortedEvolucao = Object.entries(evolucaoMensal)
                .sort(([a], [b]) => a.localeCompare(b));

            const labels = sortedEvolucao.map(([mesAno]) => {
                const [ano, mes] = mesAno.split('-');
                const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                return `${meses[parseInt(mes) - 1]}/${ano}`;
            });
            const values = sortedEvolucao.map(([, valor]) => valor);

            if (charts.evolucaoChart) {
                charts.evolucaoChart.destroy();
            }

            const ctx = document.getElementById('evolucaoChart').getContext('2d');
            charts.evolucaoChart = new Chart(ctx, {
            type: 'line',
            data: {
                    labels: labels,
                datasets: [{
                        label: 'Valor Total (R$)',
                        data: values,
                    borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.1,
                        fill: true
                }]
            },
            options: {
                responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.2,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    }
                }
            });
        }

        // Atualizar tabela de resultados
        function atualizarTabela(dados) {
            const tbody = document.querySelector('.table-container tbody');
            tbody.innerHTML = '';

            if (dados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #666;">Nenhum resultado encontrado</td></tr>';
                return;
            }

            dados.forEach(item => {
                const row = document.createElement('tr');
                const dataFormatada = new Date(item.data_geracao).toLocaleDateString('pt-BR');
                const colaboradorNome = mapaColaboradores[item.colaborador_id] || `ID: ${item.colaborador_id}`;
                const valorFormatado = Number(item.valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                const comissaoFormatada = Number(item.comissao || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                
                // Status com cor
                let statusClass = 'pending';
                let statusText = item.status || 'PENDENTE';
                if (item.status === 'PAGO') statusClass = 'paid';
                if (item.status === 'VENCIDO') statusClass = 'overdue';

                row.innerHTML = `
                    <td>${dataFormatada}</td>
                    <td>${colaboradorNome}</td>
                    <td>${item.tipo || ''}</td>
                    <td>${valorFormatado}</td>
                    <td>${comissaoFormatada}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="action-btn view-btn" title="Visualizar" onclick="visualizarItem('${item.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Visualizar item (placeholder)
        function visualizarItem(id) {
            console.log('Visualizar item:', id);
            // Implementar modal de visualização se necessário
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            inicializarPagina();

            // Botão gerar relatório
            document.querySelector('.btn-primary').addEventListener('click', gerarRelatorio);

            // Autoatualização ao mudar filtros
            const filtroContainer = document.querySelector('.advanced-filters');
            filtroContainer.addEventListener('change', function(e) {
                if (e.target.matches('input, select')) {
                    gerarRelatorio();
                }
            });

            // Atualiza ao digitar valores numéricos (debounce simples)
            let debounce;
            filtroContainer.addEventListener('input', function(e) {
                if (e.target.matches('.value-range input')) {
                    clearTimeout(debounce);
                    debounce = setTimeout(() => gerarRelatorio(), 400);
                }
            });
        });

        // Exportar relatório
        function exportarRelatorio() {
            const dadosFiltrados = aplicarFiltros();
            if (dadosFiltrados.length === 0) {
                alert('Nenhum dado para exportar. Aplique filtros e gere o relatório primeiro.');
                return;
            }

            // Criar CSV
            let csv = 'Data,Colaborador,Tipo,Valor,Comissão,Status\n';
            dadosFiltrados.forEach(item => {
                const dataFormatada = new Date(item.data_geracao).toLocaleDateString('pt-BR');
                const colaboradorNome = mapaColaboradores[item.colaborador_id] || `ID: ${item.colaborador_id}`;
                const valorFormatado = Number(item.valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                const comissaoFormatada = Number(item.comissao || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                
                csv += `${dataFormatada},"${colaboradorNome}","${item.tipo || ''}","${valorFormatado}","${comissaoFormatada}","${item.status || 'PENDENTE'}"\n`;
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `relatorio_dinamico_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Imprimir relatório
        function imprimirRelatorio() {
            const dadosFiltrados = aplicarFiltros();
            if (dadosFiltrados.length === 0) {
                alert('Nenhum dado para imprimir. Aplique filtros e gere o relatório primeiro.');
                return;
            }

            // Criar conteúdo para impressão
            let conteudo = `
                <html>
                <head>
                    <title>Relatório Dinâmico - ${new Date().toLocaleDateString('pt-BR')}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #1976D2; text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .status { padding: 4px 8px; border-radius: 4px; color: white; }
                        .paid { background-color: #28a745; }
                        .pending { background-color: #ffc107; color: black; }
                        .overdue { background-color: #dc3545; }
                    </style>
                </head>
                <body>
                    <h1>Relatório Dinâmico de Comissões</h1>
                    <p><strong>Data de geração:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
                    <p><strong>Total de registros:</strong> ${dadosFiltrados.length}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Colaborador</th>
                                <th>Tipo</th>
                                <th>Valor</th>
                                <th>Comissão</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            dadosFiltrados.forEach(item => {
                const dataFormatada = new Date(item.data_geracao).toLocaleDateString('pt-BR');
                const colaboradorNome = mapaColaboradores[item.colaborador_id] || `ID: ${item.colaborador_id}`;
                const valorFormatado = Number(item.valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                const comissaoFormatada = Number(item.comissao || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                
                let statusClass = 'pending';
                if (item.status === 'PAGO') statusClass = 'paid';
                if (item.status === 'VENCIDO') statusClass = 'overdue';

                conteudo += `
                    <tr>
                        <td>${dataFormatada}</td>
                        <td>${colaboradorNome}</td>
                        <td>${item.tipo || ''}</td>
                        <td>${valorFormatado}</td>
                        <td>${comissaoFormatada}</td>
                        <td><span class="status ${statusClass}">${item.status || 'PENDENTE'}</span></td>
                    </tr>
                `;
            });

            conteudo += `
                        </tbody>
                    </table>
                </body>
                </html>
            `;

            // Abrir janela de impressão
            const janelaImpressao = window.open('', '_blank');
            janelaImpressao.document.write(conteudo);
            janelaImpressao.document.close();
            janelaImpressao.print();
        }
    </script>
    <script src="scripts/navigation.js"></script>
    <script>
    window.addEventListener('DOMContentLoaded', function() {
        if (typeof initializeMenu === 'function') {
            initializeMenu();
        }
        document.querySelectorAll('.nav-menu a').forEach(function(link) {
            link.addEventListener('click', function() {
                var modais = ['paymentModal', 'viewModal', 'baixaModal'];
                modais.forEach(function(id) {
                    var modal = document.getElementById(id);
                    if (modal) modal.style.display = 'none';
                });
            });
        });
    });
    </script>
</body>
</html> 
