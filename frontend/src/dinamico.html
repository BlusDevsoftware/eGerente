<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Comissões - Relatório Dinâmico</title>
    <link rel="icon" type="image/png" href="assets/images/logo2.png">
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="styles/login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        /* Correção de crescimento dos gráficos */
        .chart-card { position: relative; }
        .chart-card canvas { max-height: 320px; height: 320px !important; }
        /* Scroll na grade de resultados com cabeçalho fixo */
        .table-scroll {
            max-height: 420px;
            overflow: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
        }
        .table-scroll table {
            width: 100%;
            border-collapse: collapse;
        }
        .table-scroll thead th {
            position: sticky;
            top: 0;
            background: #f7f9fc;
            z-index: 1;
        }
        /* Status - idêntico à aba movimento de comissão */
        .status.paid {
            background: #e3f9e5;
            color: #388e3c;
            border-radius: 8px;
            padding: 4px 12px;
            font-weight: 600;
        }
        .status.pending {
            background: #fffbe6;
            color: #b8860b;
            border-radius: 8px;
            padding: 4px 12px;
            font-weight: 600;
        }
        .status.vencido {
            background: #ffeaea;
            color: #d32f2f;
            border-radius: 8px;
            padding: 4px 12px;
            font-weight: 600;
        }
        .status.nao-pago {
            background: #fff3e0 !important;
            color: #f57c00 !important;
            border-radius: 8px;
            padding: 4px 12px;
            font-weight: 600;
        }
        .status.aglutinado {
            background: #f3e5f5;
            color: #7b1fa2;
            border-radius: 8px;
            padding: 4px 12px;
            font-weight: 600;
        }
        
        /* Drag and Drop para cards de gráfico */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .chart-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(33,150,243,0.07);
            border: 1px solid #e3f2fd;
            cursor: grab;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .chart-card:hover {
            box-shadow: 0 4px 16px rgba(33,150,243,0.12);
            transform: translateY(-2px);
        }
        
        .chart-card:active {
            cursor: grabbing;
        }
        
        .chart-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            z-index: 1000;
        }
        
        .chart-card.drag-over {
            border: 2px dashed #1976D2;
            background: #f8fbff;
        }
        
        .chart-card h3 {
            margin: 0 0 15px 0;
            color: #1976D2;
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chart-card h3::after {
            content: "⋮⋮";
            color: #90caf9;
            font-size: 0.8em;
            cursor: grab;
        }
        
        .chart-card h3:active::after {
            cursor: grabbing;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo" style="display: flex; align-items: center; justify-content: center; padding: 15px 0;">
            <img src="assets/images/logo2.png" alt="BlueDev Logo" style="height: 2.5em; margin-right: 10px;">
            <h1><span class="orange">e-</span><span class="highlight">Gerente</span></h1>
        </div>
        <ul class="nav-menu">
            <li><a href="index.html"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-user-plus"></i><span>Cadastros</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="colaboradores.html"><i class="fas fa-users"></i><span>Colaboradores</span></a></li>
                    <li><a href="clientes.html"><i class="fas fa-user-tie"></i><span>Clientes</span></a></li>
                    <li><a href="produtos.html"><i class="fas fa-box"></i><span>Produtos</span></a></li>
                    <li><a href="servicos.html"><i class="fas fa-cogs"></i><span>Serviços</span></a></li>
                    <li><a href="perfil.html"><i class="fas fa-user-shield"></i><span>Perfil</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-hand-holding-usd"></i><span>Comissões</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="lancar-comissao.html"><i class="fas fa-plus-circle"></i><span>Lançar</span></a></li>
                    <li><a href="movimento-comissao.html"><i class="fas fa-exchange-alt"></i><span>Movimento</span></a></li>
                    <li><a href="consulta-comissao.html"><i class="fas fa-search"></i><span>Consulta</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-chart-bar"></i><span>Relatórios</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="recebimento.html"><i class="fas fa-money-bill-wave"></i><span>Recebimento</span></a></li>
                    <li><a href="conferencia.html"><i class="fas fa-check-circle"></i><span>Conferência</span></a></li>
                    <li><a href="dinamico.html" class="active"><i class="fas fa-chart-line"></i><span>Dinâmico</span><span class="beta-tag">beta</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-cog"></i><span>Configurações</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="manutencao-bd.html"><i class="fas fa-database"></i><span>Manutenção BD</span></a></li>
                    <li><a href="sincronizar.html"><i class="fas fa-sync"></i><span>Sincronizar</span></a></li>
                </ul>
            </li>
        </ul>
        <div class="logout-button">
            <a href="index.html"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" style="position: relative; height: 100vh; overflow: auto;">
        <!-- Header -->
        <div class="header">
            <div class="welcome-text">
                <h1>Relatório Dinâmico</h1>
                <p>Análise personalizada de dados e métricas</p>
            </div>
            <div class="user-info">
                <div class="notifications">
                    <i class="fas fa-bell"></i>
                    <span class="badge">3</span>
                </div>
                <div class="user-avatar">A</div>
            </div>
        </div>

        <!-- Advanced Filters -->
        <div class="advanced-filters" style="grid-template-columns: 1fr auto; align-items: end; gap: 12px;">
            <div class="filter-group" style="display:grid; grid-template-columns: 1.1fr 1.1fr 0.5fr 1.3fr; gap: 12px; align-items: end;">
                <div class="form-group" style="display:flex; flex-direction:column; gap:6px;">
                    <label style="color:#1976D2; font-weight:600;">Colaborador</label>
                    <select id="filtroColaborador" style="height:32px; line-height:32px; padding:0 10px; border:1.5px solid #90caf9; border-radius:8px; background:#f4faff; color:#1565c0; font-size:0.9em; width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                        <option value="">Selecionar</option>
                        <option value="todos">Todos</option>
                    </select>
                </div>
                <div class="form-group" style="display:flex; flex-direction:column; gap:6px;">
                    <label style="color:#1976D2; font-weight:600;">Tipo</label>
                    <select id="filtroTipo" style="height:32px; line-height:32px; padding:0 10px; border:1.5px solid #90caf9; border-radius:8px; background:#f4faff; color:#1565c0; font-size:0.9em; width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                        <option value="">Selecionar</option>
                    <option value="produtos">Produtos</option>
                    <option value="servicos">Serviços</option>
                    <option value="ambos">Ambos</option>
                </select>
                </div>
                <div class="form-group" style="display:flex; flex-direction:column; gap:6px;">
                    <label style="color:#1976D2; font-weight:600;">Status</label>
                    <select id="filtroStatus" style="height:32px; line-height:32px; padding:0 10px; border:1.5px solid #90caf9; border-radius:8px; background:#f4faff; color:#1565c0; font-size:0.9em; width:250px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                        <option value="">Selecionar</option>
                        <option value="PAGO">Pago</option>
                        <option value="PENDENTE">Pendente</option>
                        <option value="VENCIDO">Vencido</option>
                        <option value="CLIENTE NÃO PAGOU">Cliente não pagou</option>
                        <option value="AGLUTINADO">Aglutinado</option>
                        <option value="CANCELADO">Cancelado</option>
                </select>
                </div>
                <div class="form-group" style="display:flex; flex-direction:column; gap:6px;">
                    <label style="color:#1976D2; font-weight:600;">Período</label>
                    <div style="display:flex; gap:6px; align-items:center; flex-wrap:nowrap; justify-content:flex-start; flex:1;">
                        <input id="dataInicial" type="date" placeholder="Data Inicial" style="height:32px; padding:0 10px; border:1.5px solid #90caf9; border-radius:8px; background:#f4faff; color:#1565c0; font-size:0.9em; width:140px;">
                        <input id="dataFinal" type="date" placeholder="Data Final" style="height:32px; padding:0 10px; border:1.5px solid #90caf9; border-radius:8px; background:#f4faff; color:#1565c0; font-size:0.9em; width:140px;">
                        <button id="btnDataGeracao" type="button" title="Filtrar por Data de Geração" style="height:32px; width:120px; padding:0 10px; border:1.5px solid #90caf9; border-radius:6px; background:#1976D2; color:#fff; font-size:0.9em; cursor:pointer;">Geração</button>
                        <button id="btnDataVencimento" type="button" title="Filtrar por Data de Vencimento" style="height:32px; width:120px; padding:0 10px; border:1.5px solid #90caf9; border-radius:6px; background:#f4faff; color:#1565c0; font-size:0.9em; cursor:pointer;">Vencimento</button>
                        <button id="btnLimparFiltros" class="btn-secondary" style="height:32px; width:120px; padding:0 12px; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; font-weight:600; font-size:0.9em; background:#e9ecef; color:#1565c0; border:1px solid #cfd8dc;">
                            <i class="fas fa-eraser" style="margin-right:6px;"></i>
                            Limpar
                        </button>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- Spinner de Carregamento -->
        <div id="loader-dinamico" style="display: flex; position: absolute; inset: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 9; justify-content: center; align-items: center;">
            <div style="text-align: center;">
                <div class="spinner" style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #1976D2; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <p style="color: #1976D2; font-weight: 600;">Carregando dados...</p>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="dashboard-cards" style="margin-top: 10px; margin-bottom: 20px;">
            <div class="card">
                <div class="card-icon" style="background:transparent; color:#1976D2;">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="card-info">
                    <h3>Total (R$)</h3>
                    <p id="kpi-total">-</p>
                </div>
            </div>
            <div class="card">
                <div class="card-icon" style="background:transparent; color:#28a745;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="card-info">
                    <h3>Pago (R$)</h3>
                    <p id="kpi-pago">-</p>
                </div>
            </div>
            <div class="card">
                <div class="card-icon" style="background:transparent; color:#ff9800;">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="card-info">
                    <h3>Pendente (R$)</h3>
                    <p id="kpi-pendente">-</p>
                </div>
            </div>
            <div class="card">
                <div class="card-icon" style="background:transparent; color:#dc3545;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="card-info">
                    <h3>Vencido (R$)</h3>
                    <p id="kpi-vencido">-</p>
                </div>
            </div>
        </div>

        <!-- Charts Container -->
        <div class="charts-container" id="chartsContainer">
            <div class="chart-card" draggable="true" data-chart-id="statusChart">
                <h3>Comissões por Status</h3>
                <canvas id="statusChart"></canvas>
            </div>
            <div class="chart-card" draggable="true" data-chart-id="colaboradoresChart">
                <h3>Top 5 Colaboradores</h3>
                <canvas id="colaboradoresChart"></canvas>
            </div>
            <div class="chart-card" draggable="true" data-chart-id="evolucaoChart">
                <h3>Evolução Mensal</h3>
                <canvas id="evolucaoChart"></canvas>
            </div>
        </div>

        <!-- Results Table -->
        <div class="table-container">
            <div class="table-header">
                <h2>Resultados</h2>
                <div class="table-actions" style="display:flex; align-items:center; gap:8px;">
                    <label for="pageSizeSelect" style="margin-right:6px; color:#1976D2; font-weight:700;">Exibir</label>
                    <select id="pageSizeSelect" title="Quantidade de títulos a exibir" 
                        style="height:32px; width:80px; padding:0 8px; border:1.5px solid #1976D2; border-radius:8px; margin-right:6px; font-size:0.95em; color:#1976D2; background:#fff;">
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="all">Todos</option>
                    </select>
                    <span style="margin-right:10px; color:#1976D2; font-weight:700;">Títulos</span>
                    <button class="btn-secondary" onclick="exportarRelatorio()">
                        <i class="fas fa-download"></i>
                        Exportar
                    </button>
                    <button class="btn-secondary" onclick="imprimirRelatorio()">
                        <i class="fas fa-print"></i>
                        Imprimir
                    </button>
                </div>
            </div>
            <div class="table-scroll">
                <table>
                                    <thead>
                    <tr>
                        <th>Geração</th>
                        <th>Vencimento</th>
                        <th>Nº Título</th>
                        <th>Colaborador</th>
                        <th>Tipo</th>
                        <th>Valor</th>
                        <th>Status</th>
                    </tr>
                </thead>
                    <tbody>
                        <!-- Dados serão carregados dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="scripts/config/api.js"></script>
    <script>
        // Variáveis globais
        let mapaColaboradores = {};
        let dadosRelatorio = [];
        let charts = {};

        // Persistência desativada a pedido do usuário
        function salvarEstadoFiltros() {}
        function restaurarEstadoFiltros() { return ''; }

        function resolverNomeColaboradorPorId(id) {
            if (id === undefined || id === null) return '';
            const raw = String(id).trim();
            const asNumber = raw !== '' && !Number.isNaN(Number(raw)) ? String(Number(raw)) : '';
            // Alguns IDs podem vir com zeros à esquerda; tente ambos
            return (
                mapaColaboradores[raw] ||
                (asNumber && mapaColaboradores[asNumber]) ||
                ''
            );
        }

        function obterNomeColaboradorPorItem(item) {
            const candidatosCodigo = [
                item.colaborador_id,
                item.colaborador_codigo,
                item.colaborador_codigo_id,
                item.codigo_colaborador,
                item.colaborador
            ];
            for (const cod of candidatosCodigo) {
                const nome = resolverNomeColaboradorPorId(cod);
                if (nome) return nome;
            }
            const candidatosNome = [item.colaborador_nome, item.nome_colaborador, item.colaborador];
            for (const n of candidatosNome) {
                if (n && String(n).trim() !== '') return String(n).trim();
            }
            const id = item.colaborador_id || item.colaborador || item.colaborador_codigo;
            return id ? `ID: ${id}` : 'Não informado';
        }

        // Toggle submenu
        document.querySelectorAll('.submenu-trigger').forEach(trigger => {
            trigger.addEventListener('click', function(e) {
                e.preventDefault();
                this.parentElement.classList.toggle('active');
            });
        });

        // Carregar colaboradores
        async function carregarColaboradores() {
            try {
                const colaboradores = await window.api.get('/colaboradores');
                mapaColaboradores = {};
                const selectColaborador = document.getElementById('filtroColaborador');
                if (!selectColaborador) return;

                // Limpar opções existentes
                selectColaborador.innerHTML = '<option value="">Selecionar</option><option value="todos">Todos</option>';

                colaboradores.forEach(colaborador => {
                    let nome = (colaborador.nome || colaborador.nome_colaborador || colaborador.descricao || '').toString().trim();
                    const nomeDisplay = nome && nome.length > 1 ? nome : (`ID: ${colaborador.id || colaborador.codigo || ''}`);
                    const primaryId = [
                        colaborador.id,
                        colaborador.codigo,
                        colaborador.codigo_colaborador,
                        colaborador.colaborador_id,
                        colaborador.colaborador_codigo
                    ].find(v => v !== undefined && v !== null && String(v).trim() !== '');
                    const possiveisChaves = [
                        colaborador.id,
                        colaborador.codigo,
                        colaborador.codigo_colaborador,
                        colaborador.colaborador_id,
                        colaborador.colaborador_codigo
                    ].filter(v => v !== undefined && v !== null && String(v).trim() !== '');

                    possiveisChaves.forEach(ch => {
                        mapaColaboradores[String(ch).trim()] = nomeDisplay;
                        const asNumber = !Number.isNaN(Number(ch)) ? String(Number(ch)) : '';
                        if (asNumber) {
                            mapaColaboradores[asNumber] = nomeDisplay;
                        }
                    });

                    const option = document.createElement('option');
                    option.value = primaryId !== undefined && primaryId !== null ? String(primaryId).trim() : nomeDisplay;
                    option.textContent = nomeDisplay;
                    if (primaryId !== undefined && primaryId !== null) {
                        option.setAttribute('data-id', String(primaryId).trim());
                    }
                    selectColaborador.appendChild(option);
                });

                // Persistência desativada, não restaurar valor salvo
            } catch (error) {
                console.error('Erro ao carregar colaboradores:', error);
            }
        }

        // Carregar dados do relatório
        async function carregarDadosRelatorio() {
            try {
                mostrarSpinner();
                const movimentoComissoes = await window.api.get('/movimento_comissoes');
                dadosRelatorio = movimentoComissoes;
                console.log('Dados carregados:', dadosRelatorio.length, 'registros');
                ocultarSpinner();
            } catch (error) {
                console.error('Erro ao carregar dados do relatório:', error);
                ocultarSpinner();
            }
        }

        // Aplicar filtros
        function aplicarFiltros() {
            const dataInicial = (document.getElementById('dataInicial')||{}).value || '';
            const dataFinal = (document.getElementById('dataFinal')||{}).value || '';
            const colaboradorIdSelecionado = (document.getElementById('filtroColaborador')||{}).value || '';
            const tipo = (document.getElementById('filtroTipo')||{}).value || '';
            const status = (document.getElementById('filtroStatus')||{}).value || '';
            const modoData = window.modoFiltroData || 'geracao'; // 'geracao' | 'vencimento'
            const termoBusca = '';

            let dadosFiltrados = [...dadosRelatorio];

            // Filtro por data
            if (dataInicial) {
                dadosFiltrados = dadosFiltrados.filter(item => {
                    const base = modoData === 'vencimento' ? item.data_vencimento : item.data_geracao;
                    return base ? new Date(base) >= new Date(dataInicial) : true;
                });
            }
            if (dataFinal) {
                dadosFiltrados = dadosFiltrados.filter(item => {
                    const base = modoData === 'vencimento' ? item.data_vencimento : item.data_geracao;
                    return base ? new Date(base) <= new Date(dataFinal) : true;
                });
            }

            // Filtro por colaborador (por ID, robusto a zeros à esquerda)
            if (colaboradorIdSelecionado && colaboradorIdSelecionado !== 'todos') {
                const alvoRaw = String(colaboradorIdSelecionado).trim();
                const alvoNum = !Number.isNaN(Number(alvoRaw)) ? String(Number(alvoRaw)) : '';
                dadosFiltrados = dadosFiltrados.filter(item => {
                    const candidatos = [
                        item.colaborador_id,
                        item.colaborador_codigo,
                        item.colaborador_codigo_id,
                        item.codigo_colaborador,
                        item.colaborador
                    ].filter(v => v !== undefined && v !== null);
                    for (const c of candidatos) {
                        const raw = String(c).trim();
                        const asNum = !Number.isNaN(Number(raw)) ? String(Number(raw)) : '';
                        if (raw === alvoRaw || (alvoNum && asNum && alvoNum === asNum)) {
                            return true;
                        }
                    }
                    return false;
                });
            }

            // Filtro por tipo
            if (tipo) {
                if (tipo === 'produtos') {
                    dadosFiltrados = dadosFiltrados.filter(item => 
                        item.tipo === 'PRODUTO'
                    );
                } else if (tipo === 'servicos') {
                    dadosFiltrados = dadosFiltrados.filter(item => 
                        item.tipo === 'SERVICO'
                    );
                }
            }

            // Filtro por status
            if (status) {
                dadosFiltrados = dadosFiltrados.filter(item => 
                    item.status === status.toUpperCase()
                );
            }

            // Filtro por valor removido (faixa de valor não está mais presente)

            // Filtro por termo de busca (livre)
            if (termoBusca && termoBusca.trim() !== '') {
                const q = termoBusca.trim().toLowerCase();
                dadosFiltrados = dadosFiltrados.filter(item => {
                    const nome = obterNomeColaboradorPorItem(item).toString().toLowerCase();
                    const tipoTxt = (item.tipo || '').toString().toLowerCase();
                    const statusTxt = (item.status || '').toString().toLowerCase();
                    const valorTxt = Number(item.valor||0).toLocaleString('pt-BR');
                    const dataGer = item.data_geracao ? new Date(item.data_geracao).toLocaleDateString('pt-BR') : '';
                    const dataVen = item.data_vencimento ? new Date(item.data_vencimento).toLocaleDateString('pt-BR') : '';
                    return (
                        nome.includes(q) ||
                        tipoTxt.includes(q) ||
                        statusTxt.includes(q) ||
                        valorTxt.includes(q) ||
                        dataGer.includes(q) ||
                        dataVen.includes(q)
                    );
                });
            }

            console.log('Dados filtrados:', dadosFiltrados.length, 'registros');
            return dadosFiltrados;
        }

        // Atualizar KPIs
        function atualizarKPIs(dados) {
            const formatBRL = v => Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            const soma = (arr, pred) => arr.filter(pred).reduce((acc, i) => acc + Number(i.valor||0), 0);

            const total = soma(dados, () => true);
            const pago = soma(dados, i => i.status === 'PAGO');
            const pendente = soma(dados, i => i.status === 'PENDENTE');
            const vencido = soma(dados, i => i.status === 'VENCIDO');

            const el = id => document.getElementById(id);
            if (el('kpi-total')) el('kpi-total').textContent = formatBRL(total);
            if (el('kpi-pago')) el('kpi-pago').textContent = formatBRL(pago);
            if (el('kpi-pendente')) el('kpi-pendente').textContent = formatBRL(pendente);
            if (el('kpi-vencido')) el('kpi-vencido').textContent = formatBRL(vencido);
        }

        // Gerar relatório
        async function gerarRelatorio() {
            try {
                mostrarSpinner();
                const dadosFiltrados = aplicarFiltros();
                atualizarKPIs(dadosFiltrados);
                atualizarGraficos(dadosFiltrados);
                atualizarTabela(dadosFiltrados);
                ocultarSpinner();
            } catch (error) {
                console.error('Erro ao gerar relatório:', error);
                ocultarSpinner();
            }
        }

        // Mostrar spinner
        function mostrarSpinner() {
            const spinner = document.getElementById('loader-dinamico');
            if (spinner) {
                spinner.style.display = 'flex';
            }
        }

        // Ocultar spinner
        function ocultarSpinner() {
            const spinner = document.getElementById('loader-dinamico');
            if (spinner) {
                spinner.style.display = 'none';
            }
        }

        // Inicializar página
        async function inicializarPagina() {
            try {
                await carregarColaboradores();
                await carregarDadosRelatorio();
                // Carregar ordem salva dos gráficos
                carregarOrdemGraficos();
                // Inicializar drag and drop
                inicializarDragAndDrop();
                // Gerar relatório inicial
                gerarRelatorio();
            } catch (error) {
                console.error('Falha ao inicializar a página Dinâmico:', error);
                if (typeof mostrarToast === 'function') {
                    mostrarToast('Erro ao inicializar a página de Relatório Dinâmico.', 'error');
                } else {
                    alert('Erro ao inicializar a página de Relatório Dinâmico.');
                }
                ocultarSpinner();
            }
        }

        // Atualizar gráficos com dados reais
        function atualizarGraficos(dados) {
            atualizarGraficoStatus(dados);
            atualizarGraficoColaboradores(dados);
            atualizarGraficoEvolucao(dados);
        }

        // Atualizar gráfico de status
        function atualizarGraficoStatus(dados) {
            const statusCount = {};
            dados.forEach(item => {
                const status = item.status || 'PENDENTE';
                statusCount[status] = (statusCount[status] || 0) + 1;
            });

            const labels = Object.keys(statusCount);
            const values = Object.values(statusCount);
            const colors = {
                'PAGO': '#388e3c',
                'PENDENTE': '#b8860b',
                'VENCIDO': '#d32f2f',
                'CLIENTE NÃO PAGOU': '#f57c00',
                'AGLUTINADO': '#7b1fa2'
            };

            const backgroundColors = labels.map(label => colors[label] || '#6c757d');

            if (charts.statusChart) {
                charts.statusChart.destroy();
            }

            const ctx = document.getElementById('statusChart').getContext('2d');
            charts.statusChart = new Chart(ctx, {
            type: 'pie',
            data: {
                    labels: labels,
                datasets: [{
                        data: values,
                        backgroundColor: backgroundColors
                }]
            },
            options: {
                responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Atualizar gráfico de colaboradores
        function atualizarGraficoColaboradores(dados) {
            const colaboradorTotais = {};
            dados.forEach(item => {
                const colaboradorNome = obterNomeColaboradorPorItem(item);
                const valor = Number(item.valor) || 0;
                colaboradorTotais[colaboradorNome] = (colaboradorTotais[colaboradorNome] || 0) + valor;
            });

            // Ordenar e pegar top 5
            const sortedColaboradores = Object.entries(colaboradorTotais)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const labels = sortedColaboradores.map(([nome]) => nome);
            const values = sortedColaboradores.map(([, valor]) => valor);

            if (charts.colaboradoresChart) {
                charts.colaboradoresChart.destroy();
            }

            const ctx = document.getElementById('colaboradoresChart').getContext('2d');
            charts.colaboradoresChart = new Chart(ctx, {
            type: 'bar',
            data: {
                    labels: labels,
                datasets: [{
                        label: 'Valor Total (R$)',
                        data: values,
                    backgroundColor: '#007bff'
                }]
            },
            options: {
                responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.2,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    }
                }
            });
        }

        // Atualizar gráfico de evolução
        function atualizarGraficoEvolucao(dados) {
            const evolucaoMensal = {};
            dados.forEach(item => {
                const base = (window.modoFiltroData === 'vencimento') ? item.data_vencimento : item.data_geracao;
                if (!base) return;
                const data = new Date(base);
                const mesAno = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
                const valor = Number(item.valor) || 0;
                evolucaoMensal[mesAno] = (evolucaoMensal[mesAno] || 0) + valor;
            });

            // Ordenar por data
            const sortedEvolucao = Object.entries(evolucaoMensal)
                .sort(([a], [b]) => a.localeCompare(b));

            const labels = sortedEvolucao.map(([mesAno]) => {
                const [ano, mes] = mesAno.split('-');
                const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                return `${meses[parseInt(mes) - 1]}/${ano}`;
            });
            const values = sortedEvolucao.map(([, valor]) => valor);

            if (charts.evolucaoChart) {
                charts.evolucaoChart.destroy();
            }

            const ctx = document.getElementById('evolucaoChart').getContext('2d');
            charts.evolucaoChart = new Chart(ctx, {
            type: 'line',
            data: {
                    labels: labels,
                datasets: [{
                        label: 'Valor Total (R$)',
                        data: values,
                    borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.1,
                        fill: true
                }]
            },
            options: {
                responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.2,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    }
                }
            });
        }

        // Atualizar tabela de resultados
        function atualizarTabela(dados) {
            const tbody = document.querySelector('.table-container tbody');
            const pageSizeSelect = document.getElementById('pageSizeSelect');

            tbody.innerHTML = '';

            const total = dados.length;
            let limitar = total;
            if (pageSizeSelect) {
                const val = pageSizeSelect.value;
                if (val !== 'all') {
                    const n = parseInt(val, 10);
                    if (!Number.isNaN(n) && n > 0) limitar = Math.min(n, total);
                }
            }

            if (total === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #666;">Nenhum resultado encontrado</td></tr>';
                return;
            }

            dados.slice(0, limitar).forEach(item => {
                const row = document.createElement('tr');
                const geracao = item.data_geracao ? new Date(item.data_geracao).toLocaleDateString('pt-BR') : '';
                const vencimento = item.data_vencimento ? new Date(item.data_vencimento).toLocaleDateString('pt-BR') : '';
                const colaboradorNome = obterNomeColaboradorPorItem(item);
                const valorFormatado = Number(item.valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                
                        // Status com cor - idêntico à aba movimento de comissão
        let statusClassValue = statusClass(item.status);
        let statusText = item.status || 'PENDENTE';

                row.innerHTML = `
                    <td>${geracao}</td>
                    <td>${vencimento}</td>
                    <td>${item.numero_titulo || ''}</td>
                    <td>${colaboradorNome}</td>
                    <td>${item.tipo || ''}</td>
                    <td>${valorFormatado}</td>
                    <td><span class="status ${statusClassValue}">${statusText}</span></td>
                `;
                tbody.appendChild(row);
            });

        }

        // Visualizar item (placeholder)
        function visualizarItem(id) {
            console.log('Visualizar item:', id);
            // Implementar modal de visualização se necessário
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            inicializarPagina();

            // Botão limpar filtros
            const btnLimpar = document.getElementById('btnLimparFiltros');
            if (btnLimpar) {
                btnLimpar.addEventListener('click', () => {
                    const ids = ['filtroColaborador','filtroTipo','filtroStatus','dataInicial','dataFinal'];
                    ids.forEach(id => { const el = document.getElementById(id); if (el) el.value=''; });
                    window.modoFiltroData = 'geracao';
                    // resetar estilo dos botões
                    const evt = new Event('click');
                    const btnGeracao = document.getElementById('btnDataGeracao');
                    if (btnGeracao) btnGeracao.dispatchEvent(evt);
                    gerarRelatorio();
                });
            }

            // Autoatualização ao mudar filtros
            const filtroContainer = document.querySelector('.advanced-filters');
            filtroContainer.addEventListener('change', function(e) {
                if (e.target.matches('#dataInicial, #dataFinal, #filtroColaborador, #filtroTipo, #filtroStatus')) {
                    gerarRelatorio();
                }
            });

            // Botões de modo de data
            window.modoFiltroData = 'geracao';
            const btnGeracao = document.getElementById('btnDataGeracao');
            const btnVenc = document.getElementById('btnDataVencimento');
            function atualizarBotoesModo() {
                if (btnGeracao && btnVenc) {
                    const ativo = 'height:32px; width:120px; padding:0 10px; border:1.5px solid #90caf9; border-radius:6px; background:#1976D2; color:#fff; font-size:0.9em; cursor:pointer;';
                    const inativo = 'height:32px; width:120px; padding:0 10px; border:1.5px solid #90caf9; border-radius:6px; background:#f4faff; color:#1565c0; font-size:0.9em; cursor:pointer;';
                    btnGeracao.setAttribute('style', window.modoFiltroData==='geracao' ? ativo : inativo);
                    btnVenc.setAttribute('style', window.modoFiltroData==='vencimento' ? ativo : inativo);
                }
            }
            if (btnGeracao) btnGeracao.addEventListener('click', () => { window.modoFiltroData='geracao'; atualizarBotoesModo(); gerarRelatorio(); });
            if (btnVenc) btnVenc.addEventListener('click', () => { window.modoFiltroData='vencimento'; atualizarBotoesModo(); gerarRelatorio(); });
            atualizarBotoesModo();

            // Garantir que o select mostre o texto clicado imediatamente (especialmente em navegadores móveis)
            ['filtroColaborador','filtroTipo','filtroStatus'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', () => {});
                }
            });

            // Atualiza ao digitar valores numéricos (debounce simples)
            let debounce;
            filtroContainer.addEventListener('input', function(e) {
                if (e.target.matches('#dataInicial, #dataFinal')) {
                    clearTimeout(debounce);
                    debounce = setTimeout(() => gerarRelatorio(), 400);
                }
            });

            // Busca livre removida

            // Mudança do page size
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            if (pageSizeSelect) {
                pageSizeSelect.addEventListener('change', () => gerarRelatorio());
            }
        });

        // Exportar relatório
        function exportarRelatorio() {
            const dadosFiltrados = aplicarFiltros();
            if (dadosFiltrados.length === 0) {
                alert('Nenhum dado para exportar. Aplique filtros e gere o relatório primeiro.');
                return;
            }

            // Criar CSV
            const modoData = window.modoFiltroData === 'vencimento' ? 'Vencimento' : 'Geração';
            let csv = `${modoData},Nº Título,Colaborador,Tipo,Valor,Status\n`;
            dadosFiltrados.forEach(item => {
                const base = (window.modoFiltroData === 'vencimento') ? item.data_vencimento : item.data_geracao;
                const dataFormatada = base ? new Date(base).toLocaleDateString('pt-BR') : '';
                const colaboradorNome = obterNomeColaboradorPorItem(item);
                const valorFormatado = Number(item.valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                
                csv += `${dataFormatada},"${item.numero_titulo || ''}","${colaboradorNome}","${item.tipo || ''}","${valorFormatado}","${item.status || 'PENDENTE'}"\n`;
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `relatorio_dinamico_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Imprimir relatório
        function imprimirRelatorio() {
            const dadosFiltrados = aplicarFiltros();
            if (dadosFiltrados.length === 0) {
                alert('Nenhum dado para imprimir. Aplique filtros e gere o relatório primeiro.');
                return;
            }

            // Criar conteúdo para impressão de relatorio
            let conteudo = `
                <html>
                <head>
                    <title>Relatório Dinâmico - ${new Date().toLocaleDateString('pt-BR')}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #1976D2; text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .status { padding: 4px 12px; border-radius: 8px; font-weight: 600; }
                        .paid { background-color: #e3f9e5; color: #388e3c; }
                        .pending { background-color: #fffbe6; color: #b8860b; }
                        .vencido { background-color: #ffeaea; color: #d32f2f; }
                        .nao-pago { background-color: #fff3e0; color: #f57c00; }
                        .aglutinado { background-color: #f3e5f5; color: #7b1fa2; }
                    </style>
                </head>
                <body>
                    <h1>Relatório Dinâmico de Comissões</h1>
                    <p><strong>Data de geração:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
                    <p><strong>Modo de data:</strong> ${window.modoFiltroData === 'vencimento' ? 'Vencimento' : 'Geração'}</p>
                    <p><strong>Total de registros:</strong> ${dadosFiltrados.length}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>${window.modoFiltroData === 'vencimento' ? 'Vencimento' : 'Geração'}</th>
                                <th>Nº Título</th>
                                <th>Colaborador</th>
                                <th>Tipo</th>
                                <th>Valor</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            dadosFiltrados.forEach(item => {
                const base = (window.modoFiltroData === 'vencimento') ? item.data_vencimento : item.data_geracao;
                const dataFormatada = base ? new Date(base).toLocaleDateString('pt-BR') : '';
                const colaboradorNome = obterNomeColaboradorPorItem(item);
                const valorFormatado = Number(item.valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                
                            let statusClassValue = statusClass(item.status);

                conteudo += `
                    <tr>
                        <td>${dataFormatada}</td>
                        <td>${item.numero_titulo || ''}</td>
                        <td>${colaboradorNome}</td>
                        <td>${item.tipo || ''}</td>
                        <td>${valorFormatado}</td>
                        <td><span class="status ${statusClassValue}">${item.status || 'PENDENTE'}</span></td>
                    </tr>
                `;
            });

            conteudo += `
                        </tbody>
                    </table>
                </body>
                </html>
            `;

            // Abrir janela de impressão
            const janelaImpressao = window.open('', '_blank');
            janelaImpressao.document.write(conteudo);
            janelaImpressao.document.close();
            janelaImpressao.print();
        }
        
        // Função statusClass - idêntica à aba movimento de comissão
        function statusClass(status) {
            if (!status) return 'pending';
            const s = status.toLowerCase();
            if (s.includes('não pagou') || s.includes('nao pagou')) return 'nao-pago';
            if (s.includes('pendente')) return 'pending';
            if (s.includes('vencido')) return 'vencido';
            if (s.includes('pago')) return 'paid';
            if (s.includes('aglutinado')) return 'aglutinado';
            return 'pending';
        }
        
        // Drag and Drop para cards de gráfico
        function inicializarDragAndDrop() {
            const chartCards = document.querySelectorAll('.chart-card');
            const container = document.getElementById('chartsContainer');
            
            chartCards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragenter', handleDragEnter);
                card.addEventListener('dragleave', handleDragLeave);
            });
        }
        
        function handleDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.outerHTML);
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.chart-card').forEach(card => {
                card.classList.remove('drag-over');
            });
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        function handleDragEnter(e) {
            e.preventDefault();
            if (e.target.closest('.chart-card') && !e.target.closest('.chart-card').classList.contains('dragging')) {
                e.target.closest('.chart-card').classList.add('drag-over');
            }
        }
        
        function handleDragLeave(e) {
            if (e.target.closest('.chart-card')) {
                e.target.closest('.chart-card').classList.remove('drag-over');
            }
        }
        
        function handleDrop(e) {
            e.preventDefault();
            const draggingCard = document.querySelector('.dragging');
            const targetCard = e.target.closest('.chart-card');
            
            if (draggingCard && targetCard && draggingCard !== targetCard) {
                const container = document.getElementById('chartsContainer');
                const cards = Array.from(container.querySelectorAll('.chart-card'));
                const draggingIndex = cards.indexOf(draggingCard);
                const targetIndex = cards.indexOf(targetCard);
                
                // Reordenar os cards
                if (draggingIndex < targetIndex) {
                    targetCard.parentNode.insertBefore(draggingCard, targetCard.nextSibling);
                } else {
                    targetCard.parentNode.insertBefore(draggingCard, targetCard);
                }
                
                // Salvar a nova ordem no localStorage
                salvarOrdemGraficos();
            }
            
            // Limpar classes
            document.querySelectorAll('.chart-card').forEach(card => {
                card.classList.remove('drag-over');
            });
        }
        
        function salvarOrdemGraficos() {
            const container = document.getElementById('chartsContainer');
            const cards = Array.from(container.querySelectorAll('.chart-card'));
            const ordem = cards.map(card => card.getAttribute('data-chart-id'));
            localStorage.setItem('ordemGraficosDinamico', JSON.stringify(ordem));
        }
        
        function carregarOrdemGraficos() {
            const ordemSalva = localStorage.getItem('ordemGraficosDinamico');
            if (ordemSalva) {
                const ordem = JSON.parse(ordemSalva);
                const container = document.getElementById('chartsContainer');
                
                ordem.forEach(chartId => {
                    const card = container.querySelector(`[data-chart-id="${chartId}"]`);
                    if (card) {
                        container.appendChild(card);
                    }
                });
            }
        }
    </script>
    <script src="scripts/navigation.js"></script>
    <script>
    window.addEventListener('DOMContentLoaded', function() {
        if (typeof initializeMenu === 'function') {
            initializeMenu();
        }
        document.querySelectorAll('.nav-menu a').forEach(function(link) {
            link.addEventListener('click', function() {
                var modais = ['paymentModal', 'viewModal', 'baixaModal'];
                modais.forEach(function(id) {
                    var modal = document.getElementById(id);
                    if (modal) modal.style.display = 'none';
                });
            });
        });
    });
    </script>
</body>
</html> 
