<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colaboradores - Gestor de Comissões</title>
    <link rel="icon" type="image/png" href="../Imagens/bluedev-logo.png">
    <link rel="stylesheet" href="../Paginas_CSS/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="api-config.js"></script>
    <style>
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            margin-bottom: 10px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            min-width: 300px;
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast i {
            margin-right: 10px;
            font-size: 20px;
        }

        .toast.success {
            border-left: 4px solid #4CAF50;
        }

        .toast.error {
            border-left: 4px solid #f44336;
        }

        .toast.info {
            border-left: 4px solid #2196F3;
        }

        .toast button {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 20px;
            margin-left: auto;
            padding: 0 5px;
        }

        .toast button:hover {
            color: #333;
        }

        .view-details {
            padding: 20px;
        }
        
        .detail-row {
            margin-bottom: 15px;
            display: flex;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .detail-row strong {
            width: 200px;
            color: #666;
        }
        
        .detail-row span {
            flex: 1;
            color: #333;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            margin: 0 2px;
            border-radius: 4px;
            transition: all 0.2s ease;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .view-btn {
            background-color: #0d6efd;
            color: white;
        }

        .edit-btn {
            background-color: #198754;
            color: white;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.8;
        }

        .action-btn i {
            font-size: 14px;
        }

        .actions {
            white-space: nowrap;
        }

        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .status.ativo {
            background-color: #e8f5e9;
            color: #4CAF50;
        }

        .status.inativo {
            background-color: #ffebee;
            color: #f44336;
        }

        .delete-confirmation {
            max-width: 400px;
        }

        .delete-icon {
            text-align: center;
            font-size: 48px;
            color: #dc3545;
            margin: 20px 0;
        }

        .delete-message {
            text-align: center;
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }

        .delete-warning {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .modal-content.delete-confirmation .form-actions {
            justify-content: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo" style="display: flex; align-items: center; justify-content: center; padding: 15px 0;">
            <img src="../Imagens/bluedev-logo.png" alt="BlueDev Logo" style="height: 2.5em; margin-right: 10px;">
            <h1><span class="orange">Blue</span><span class="highlight">Manager</span></h1>
        </div>
        <ul class="nav-menu">
            <li><a href="index.html"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-user-plus"></i><span>Cadastros</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="colaboradores.html" class="active"><i class="fas fa-users"></i><span>Colaboradores</span></a></li>
                    <li><a href="clientes.html"><i class="fas fa-user-tie"></i><span>Clientes</span></a></li>
                    <li><a href="produtos.html"><i class="fas fa-box"></i><span>Produtos</span></a></li>
                    <li><a href="servicos.html"><i class="fas fa-cogs"></i><span>Serviços</span></a></li>
                    <li><a href="usuarios.html"><i class="fas fa-user-shield"></i><span>Usuários</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-hand-holding-usd"></i><span>Comissões</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="lancar-comissao.html"><i class="fas fa-plus-circle"></i><span>Lançar</span></a></li>
                    <li><a href="movimento-comissao.html"><i class="fas fa-exchange-alt"></i><span>Movimento</span></a></li>
                    <li><a href="consulta-comissao.html"><i class="fas fa-search"></i><span>Consulta</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-chart-bar"></i><span>Relatórios</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="recebimento.html"><i class="fas fa-money-bill-wave"></i><span>Recebimento</span></a></li>
                    <li><a href="conferencia.html"><i class="fas fa-check-circle"></i><span>Conferência</span></a></li>
                    <li><a href="dinamico.html"><i class="fas fa-chart-line"></i><span>Dinâmico</span><span class="beta-tag">beta</span></a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#" class="submenu-trigger"><i class="fas fa-cog"></i><span>Configurações</span><i class="fas fa-chevron-down submenu-icon"></i></a>
                <ul class="submenu">
                    <li><a href="manutencao-bd.html"><i class="fas fa-database"></i><span>Manutenção BD</span></a></li>
                    <li><a href="sincronizar.html"><i class="fas fa-sync"></i><span>Sincronizar</span></a></li>
                </ul>
            </li>
        </ul>
        <div class="logout-button">
            <a href="index.html"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="welcome-text">
                <h1>Colaboradores</h1>
                <p>Gerencie os colaboradores do sistema</p>
            </div>
            <div class="user-info">
                <div class="notifications">
                    <i class="fas fa-bell"></i>
                    <span class="badge">3</span>
                </div>
                <div class="user-avatar">A</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-container">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Buscar colaborador...">
            </div>
            <div class="filter-options">
                <select>
                    <option value="">Status</option>
                    <option value="ativo">Ativo</option>
                    <option value="inativo">Inativo</option>
                </select>
            </div>
            <button class="btn-primary" onclick="openModal()">
                <i class="fas fa-plus"></i>
                Novo Colaborador
            </button>
        </div>

        <!-- Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Telefone</th>
                        <th>Cargo</th>
                        <th>Data Admissão</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dados serão carregados dinamicamente via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="colaboradorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Novo Colaborador</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="colaboradorForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Código</label>
                            <input type="text" name="codigo" readonly disabled>
                            <small class="form-text text-muted">Gerado automaticamente</small>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select name="status" required>
                                <option value="ativo">Ativo</option>
                                <option value="inativo">Inativo</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nome Completo</label>
                            <input type="text" name="nome" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" name="email" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Telefone</label>
                            <input type="text" name="telefone" required>
                        </div>
                        <div class="form-group">
                            <label>Cargo</label>
                            <input type="text" name="cargo" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Data de Admissão</label>
                            <input type="date" name="data_admissao" required>
                        </div>
                        <div class="form-group">
                            <label>Usuário Vinculado</label>
                            <select name="usuario_vinculado" id="usuario_select">
                                <option value="">Selecione um usuário</option>
                                <!-- Opções serão carregadas dinamicamente -->
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn-primary">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Visualização -->
    <div class="modal" id="viewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalhes do Colaborador</h2>
                <button class="close-modal" onclick="closeViewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="view-details">
                    <div class="detail-row">
                        <strong>Código:</strong>
                        <span id="view-codigo"></span>
                    </div>
                    <div class="detail-row">
                        <strong>Nome:</strong>
                        <span id="view-nome"></span>
                    </div>
                    <div class="detail-row">
                        <strong>Email:</strong>
                        <span id="view-email"></span>
                    </div>
                    <div class="detail-row">
                        <strong>Telefone:</strong>
                        <span id="view-telefone"></span>
                    </div>
                    <div class="detail-row">
                        <strong>Cargo:</strong>
                        <span id="view-cargo"></span>
                    </div>
                    <div class="detail-row">
                        <strong>Data de Admissão:</strong>
                        <span id="view-data-admissao"></span>
                    </div>
                    <div class="detail-row">
                        <strong>Status:</strong>
                        <span id="view-status"></span>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeViewModal()">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div class="modal" id="deleteModal">
        <div class="modal-content delete-confirmation">
            <div class="modal-header">
                <h2>Confirmar Exclusão</h2>
                <button class="close-modal" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="delete-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <p class="delete-message">Tem certeza que deseja excluir o colaborador <span id="deleteItemName"></span>?</p>
                <p class="delete-warning">Esta ação não poderá ser desfeita.</p>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeDeleteModal()">Cancelar</button>
                    <button type="button" class="btn-danger" onclick="confirmDelete()">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <script>
        // Fallback para ColaboradoresApi caso api-config.js não tenha carregado
        if (typeof ColaboradoresApi === 'undefined') {
            console.warn('ColaboradoresApi não encontrado no api-config.js. Usando versão de fallback.');
            
            const API_BASE_URL = 'https://auth-api-BlueManager.vercel.app/api';
            
            // Obtém o token JWT do localStorage
            const getToken = () => {
                const token = localStorage.getItem('authToken');
                return token;
            };
            
            // Cabeçalhos HTTP padrão com autenticação
            const getHeaders = () => {
                const token = getToken();
                return {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : '',
                    'Accept': 'application/json',
                    'Origin': window.location.origin
                };
            };
            
            // Define o objeto ColaboradoresApi
            window.ColaboradoresApi = {
                // Obtém a lista de colaboradores
                getColaboradores: async () => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/colaboradores`, {
                            method: 'GET',
                            headers: getHeaders()
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                        }
                        return await response.json();
                    } catch (error) {
                        console.error('Erro ao obter colaboradores:', error);
                        return { error: `Erro ao conectar com o servidor: ${error.message}` };
                    }
                },
                
                // Obtém um colaborador pelo ID
                getColaborador: async (id) => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/colaboradores/${id}`, {
                            method: 'GET',
                            headers: getHeaders()
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                        }
                        return await response.json();
                    } catch (error) {
                        console.error('Erro ao obter colaborador:', error);
                        return { error: `Erro ao conectar com o servidor: ${error.message}` };
                    }
                },
                
                // Cria um novo colaborador
                createColaborador: async (data) => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/colaboradores`, {
                            method: 'POST',
                            headers: getHeaders(),
                            body: JSON.stringify(data)
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                        }
                        return await response.json();
                    } catch (error) {
                        console.error('Erro ao criar colaborador:', error);
                        return { error: `Erro ao conectar com o servidor: ${error.message}` };
                    }
                },
                
                // Atualiza um colaborador existente
                updateColaborador: async (id, data) => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/colaboradores/${id}`, {
                            method: 'PUT',
                            headers: getHeaders(),
                            body: JSON.stringify(data)
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                        }
                        return await response.json();
                    } catch (error) {
                        console.error('Erro ao atualizar colaborador:', error);
                        return { error: `Erro ao conectar com o servidor: ${error.message}` };
                    }
                },
                
                // Exclui um colaborador
                deleteColaborador: async (id) => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/colaboradores/${id}`, {
                            method: 'DELETE',
                            headers: getHeaders()
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                        }
                        return await response.json();
                    } catch (error) {
                        console.error('Erro ao excluir colaborador:', error);
                        return { error: `Erro ao conectar com o servidor: ${error.message}` };
                    }
                }
            };
        }
        
        // Toggle submenu
        document.querySelectorAll('.submenu-trigger').forEach(trigger => {
            trigger.addEventListener('click', function(e) {
                e.preventDefault();
                this.parentElement.classList.toggle('active');
            });
        });

        // Modal functions
        function openModal() {
            const form = document.getElementById('colaboradorForm');
            form.reset();
            form.removeAttribute('data-id');
            document.querySelector('.modal-header h2').textContent = 'Novo Colaborador';
            document.getElementById('colaboradorModal').style.display = 'flex';
            
            // Carregar a lista de usuários disponíveis
            loadUsuariosSelect();
        }

        function closeModal() {
            document.getElementById('colaboradorModal').style.display = 'none';
            // Limpar o formulário incluindo o dataset.id para evitar problemas na próxima abertura
            const form = document.getElementById('colaboradorForm');
            form.reset();
            delete form.dataset.id;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('colaboradorModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // Toast notification system
        function showToast(message, type = 'success') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = document.createElement('i');
            icon.className = type === 'success' ? 'fas fa-check-circle' : 
                           type === 'error' ? 'fas fa-times-circle' : 
                           'fas fa-exclamation-circle';
            
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = () => toast.remove();
            
            toast.appendChild(icon);
            toast.appendChild(messageSpan);
            toast.appendChild(closeBtn);
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
            }, 100);
        }

        // Função para carregar os usuários no select
        async function loadUsuariosSelect() {
            try {
                const usuarios = await UserApi.getUsers();
                
                if (usuarios.error) {
                    console.error('Erro ao carregar usuários:', usuarios.error);
                    return;
                }
                
                const usuarioSelect = document.getElementById('usuario_select');
                
                // Limpar opções atuais, mantendo apenas a opção padrão
                while (usuarioSelect.options.length > 1) {
                    usuarioSelect.remove(1);
                }
                
                // Adicionar os usuários como opções
                usuarios.forEach(usuario => {
                    const option = document.createElement('option');
                    option.value = usuario.id;
                    option.textContent = usuario.email;
                    usuarioSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
            }
        }

        // Form submission
        document.getElementById('colaboradorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                nome: this.nome.value,
                email: this.email.value,
                telefone: this.telefone.value,
                cargo: this.cargo.value,
                data_admissao: this.data_admissao.value,
                status: this.status.value
            };

            console.log("Dados do formulário:", formData);

            try {
                const isEdit = !!this.dataset.id;
                const id = this.dataset.id;
                
                let result;
                if (isEdit) {
                    // Para edição, primeiro obtemos os dados atuais
                    const currentData = await ColaboradoresApi.getColaborador(id);
                    if (currentData.error) {
                        throw new Error(currentData.error);
                    }
                    
                    // Atualizamos apenas os campos que mudaram
                    const updatedData = {
                        ...currentData,
                        ...formData
                    };
                    
                    // Remover campos que não devem ser atualizados
                    delete updatedData.id;
                    delete updatedData.codigo;
                    
                    console.log("Dados para atualização:", updatedData);
                    result = await ColaboradoresApi.updateColaborador(id, updatedData);
                } else {
                    console.log("Dados para criação:", formData);
                    result = await ColaboradoresApi.createColaborador(formData);
                }

                if (!result.error && !result.message) {
                    const colaboradorId = isEdit ? id : result.id;
                    
                    showToast(
                        isEdit
                            ? 'Colaborador atualizado com sucesso!' 
                            : 'Colaborador cadastrado com sucesso!', 
                        'success'
                    );
                    closeModal();
                    loadColaboradores();
                } else {
                    console.error("Erro retornado pela API:", result);
                    showToast(result.error || result.message || 'Erro ao salvar colaborador', 'error');
                }
            } catch (error) {
                console.error('Erro completo:', error);
                showToast('Erro ao conectar com o servidor: ' + error.message, 'error');
            }
        });

        // Verificação de autenticação
        function checkAuth() {
            const token = AuthService.token;
            if (!token) {
                window.location.href = 'index.html';
                return false;
            }
            return token;
        }

        // Load colaboradores
        async function loadColaboradores() {
            const token = checkAuth();
            if (!token) return;

            try {
                const data = await ColaboradoresApi.getColaboradores();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                const tbody = document.querySelector('tbody');
                tbody.innerHTML = '';

                // Mapear os colaboradores para gerar números sequenciais
                let sequenciaIds = {};
                try {
                    sequenciaIds = JSON.parse(localStorage.getItem('sequenciaColaboradoresIds') || '{}');
                } catch (e) {
                    console.warn('Erro ao carregar sequência de IDs:', e);
                }
                
                // Ordenar os colaboradores por data de admissão ou outro campo
                const colaboradoresOrdenados = [...data].sort((a, b) => {
                    // Se houver data de admissão, ordenar por ela
                    if (a.data_admissao && b.data_admissao) {
                        return new Date(a.data_admissao) - new Date(b.data_admissao);
                    }
                    // Caso contrário, usar ID para consistência
                    return a.id.localeCompare(b.id);
                });
                
                // Atribuir códigos sequenciais se ainda não existirem
                colaboradoresOrdenados.forEach((colaborador, index) => {
                    if (!sequenciaIds[colaborador.id]) {
                        sequenciaIds[colaborador.id] = index + 1;
                    }
                });
                
                // Salvar a sequência atualizada
                localStorage.setItem('sequenciaColaboradoresIds', JSON.stringify(sequenciaIds));

                // Adicionar o cabeçalho da coluna de código à tabela
                if (!document.querySelector('thead tr th:first-child')?.textContent.includes('Código')) {
                    const headerRow = document.querySelector('thead tr');
                    const codeHeader = document.createElement('th');
                    codeHeader.textContent = 'Código';
                    headerRow.insertBefore(codeHeader, headerRow.firstChild);
                }

                colaboradoresOrdenados.forEach(colaborador => {
                    // Obter o código sequencial do colaborador e formatá-lo
                    const codigoSequencial = sequenciaIds[colaborador.id] || 0;
                    const codigoFormatado = String(codigoSequencial).padStart(5, '0');
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${codigoFormatado}</td>
                        <td>${colaborador.nome}</td>
                        <td>${colaborador.email}</td>
                        <td>${colaborador.telefone}</td>
                        <td>${colaborador.cargo}</td>
                        <td>${new Date(colaborador.data_admissao).toLocaleDateString('pt-BR')}</td>
                        <td><span class="status ${colaborador.status}">${colaborador.status}</span></td>
                        <td class="actions">
                            <button class="action-btn view-btn" title="Visualizar" onclick="viewColaborador('${colaborador.id}', '${codigoFormatado}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit-btn" title="Editar" onclick="editColaborador('${colaborador.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" title="Excluir" onclick="deleteColaborador('${colaborador.id}', '${codigoFormatado}', '${colaborador.nome}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Erro ao carregar colaboradores:', error);
                showToast('Erro ao carregar colaboradores: ' + error.message, 'error');
            }
        }

        // View colaborador
        async function viewColaborador(id, codigoFormatado) {
            try {
                const data = await ColaboradoresApi.getColaborador(id);
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // Obter o código sequencial se não foi fornecido
                let codigo = codigoFormatado;
                if (!codigo) {
                    let sequenciaIds = {};
                    try {
                        sequenciaIds = JSON.parse(localStorage.getItem('sequenciaColaboradoresIds') || '{}');
                        const codigoSequencial = sequenciaIds[id] || 0;
                        codigo = String(codigoSequencial).padStart(5, '0');
                    } catch (e) {
                        console.warn('Erro ao carregar sequência de IDs:', e);
                        codigo = 'N/A';
                    }
                }

                // Obter o ID do usuário vinculado do banco de dados e localStorage
                const dbUsuarioId = data.usuario_vinculado;
                const localUsuarioId = getUserIdForColaborador(id);
                
                // Para diagnóstico
                console.log("Colaborador ID:", id);
                console.log("Usuário vinculado - Banco de dados:", dbUsuarioId);
                console.log("Usuário vinculado - LocalStorage:", localUsuarioId);

                // Preferir o usuário do banco, mas usar o do localStorage como fallback
                const usuarioId = dbUsuarioId || localUsuarioId;

                // Se tiver ID de usuário, buscar os detalhes do usuário
                let usuarioInfo = 'Não vinculado';
                let fonte = '';
                
                if (usuarioId) {
                    try {
                        const usuario = await UserApi.getUser(usuarioId);
                        if (!usuario.error) {
                            usuarioInfo = usuario.email || 'ID: ' + usuarioId;
                            fonte = dbUsuarioId ? ' (Banco)' : ' (Local)';
                        }
                    } catch (e) {
                        console.warn('Erro ao carregar dados do usuário:', e);
                    }
                }
                
                    // Preencher os dados no modal de visualização
                document.getElementById('view-codigo').textContent = codigo;
                    document.getElementById('view-nome').textContent = data.nome;
                    document.getElementById('view-email').textContent = data.email;
                    document.getElementById('view-telefone').textContent = data.telefone;
                    document.getElementById('view-cargo').textContent = data.cargo;
                    document.getElementById('view-data-admissao').textContent = new Date(data.data_admissao).toLocaleDateString('pt-BR');
                    document.getElementById('view-status').textContent = data.status;
                
                // Se o elemento para mostrar usuário vinculado não existir, criá-lo
                if (!document.getElementById('view-usuario-vinculado')) {
                    const viewDetails = document.querySelector('.view-details');
                    const newDetailRow = document.createElement('div');
                    newDetailRow.className = 'detail-row';
                    newDetailRow.innerHTML = `
                        <strong>Usuário Vinculado:</strong>
                        <span id="view-usuario-vinculado"></span>
                    `;
                    viewDetails.appendChild(newDetailRow);
                }
                
                // Exibir informações do usuário vinculado
                document.getElementById('view-usuario-vinculado').textContent = `${usuarioInfo} ${fonte}`;

                    // Abrir o modal de visualização
                    document.getElementById('viewModal').style.display = 'flex';
            } catch (error) {
                showToast('Erro ao conectar com o servidor: ' + error.message, 'error');
                console.error('Erro:', error);
            }
        }

        function closeViewModal() {
            document.getElementById('viewModal').style.display = 'none';
        }

        // Close view modal when clicking outside
        window.onclick = function(event) {
            const viewModal = document.getElementById('viewModal');
            const colaboradorModal = document.getElementById('colaboradorModal');
            const deleteModal = document.getElementById('deleteModal');
            
            if (event.target == viewModal) {
                closeViewModal();
            }
            if (event.target == colaboradorModal) {
                closeModal();
            }
            if (event.target == deleteModal) {
                closeDeleteModal();
            }
        }

        // Edit colaborador
        async function editColaborador(id) {
            try {
                console.log(`Carregando dados do colaborador ID: ${id}`);
                
                const data = await ColaboradoresApi.getColaborador(id);
                
                if (data.error) {
                    throw new Error(data.error);
                }

                console.log("Dados recebidos do banco:", data);

                    const form = document.getElementById('colaboradorForm');
                    form.codigo.value = data.codigo;
                    form.nome.value = data.nome;
                    form.email.value = data.email;
                    form.telefone.value = data.telefone;
                    form.cargo.value = data.cargo;
                    form.data_admissao.value = data.data_admissao;
                    form.status.value = data.status;

                    // Alterar título do modal
                    document.querySelector('.modal-header h2').textContent = 'Editar Colaborador';

                    // Adicionar ID do colaborador ao formulário
                    form.dataset.id = id;
                console.log(`Form dataset.id definido como: ${form.dataset.id}`);

                    // Abrir o modal
                    document.getElementById('colaboradorModal').style.display = 'flex';
            } catch (error) {
                showToast('Erro ao carregar dados do colaborador: ' + error.message, 'error');
                console.error('Erro:', error);
            }
        }

        let deleteCallback = null;

        function showDeleteModal(callback) {
            deleteCallback = callback;
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            deleteCallback = null;
        }

        function confirmDelete() {
            if (deleteCallback) {
                deleteCallback();
            }
            closeDeleteModal();
        }

        // Delete colaborador
        async function deleteColaborador(id, codigoFormatado, nome) {
            // Atualizar o texto do modal de confirmação
            if (codigoFormatado && nome) {
                document.getElementById('deleteItemName').textContent = `${codigoFormatado} - ${nome}`;
            }
            
            showDeleteModal(async () => {
                try {
                    const result = await ColaboradoresApi.deleteColaborador(id);
                    
                    if (result.error) {
                        throw new Error(result.error);
                    }

                        showToast('Colaborador excluído com sucesso!', 'success');
                    
                    // Remover o colaborador da sequência de IDs local
                    try {
                        let sequenciaIds = JSON.parse(localStorage.getItem('sequenciaColaboradoresIds') || '{}');
                        if (sequenciaIds[id]) {
                            delete sequenciaIds[id];
                            localStorage.setItem('sequenciaColaboradoresIds', JSON.stringify(sequenciaIds));
                        }
                    } catch (e) {
                        console.warn('Erro ao atualizar sequência de IDs:', e);
                    }
                    
                    loadColaboradores();
                } catch (error) {
                    showToast('Erro ao excluir colaborador: ' + error.message, 'error');
                    console.error('Erro:', error);
                }
            });
        }

        // Função para salvar a relação entre colaborador e usuário no localStorage (apenas como backup)
        function saveUserColaboradorLink(colaboradorId, usuarioId) {
            if (!colaboradorId) return;
            
            try {
                let userColaboradorLinks = JSON.parse(localStorage.getItem('userColaboradorLinks') || '{}');
                
                if (usuarioId) {
                    userColaboradorLinks[colaboradorId] = usuarioId;
                } else {
                    if (userColaboradorLinks[colaboradorId]) {
                        delete userColaboradorLinks[colaboradorId];
                    }
                }
                
                localStorage.setItem('userColaboradorLinks', JSON.stringify(userColaboradorLinks));
            } catch (e) {
                console.error('Erro ao salvar vínculo colaborador-usuário no localStorage:', e);
            }
        }
    
        // Função para obter o ID do usuário vinculado a um colaborador do localStorage
        function getUserIdForColaborador(colaboradorId) {
            try {
                const userColaboradorLinks = JSON.parse(localStorage.getItem('userColaboradorLinks') || '{}');
                return userColaboradorLinks[colaboradorId] || null;
            } catch (e) {
                console.error('Erro ao obter vínculo colaborador-usuário:', e);
                return null;
            }
        }

        // Load colaboradores on page load
        document.addEventListener('DOMContentLoaded', () => {
            const token = checkAuth();
            if (!token) return;
            loadColaboradores();
        });
    </script>
</body>
</html> 
